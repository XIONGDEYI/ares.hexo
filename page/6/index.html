<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>ARESXIONG</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="ARESXIONG">
<meta property="og:url" content="http://yoursite.com/page/6/index.html">
<meta property="og:site_name" content="ARESXIONG">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ARESXIONG">
  
    <link rel="alternate" href="/atom.xml" title="ARESXIONG" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">ARESXIONG</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-android_animation_svg2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/11/19/android_animation_svg2/" class="article-date">
  <time datetime="2015-11-19T11:48:29.000Z" itemprop="datePublished">2015-11-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/android/">android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/19/android_animation_svg2/">Android之SVG图像详解(二)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在<a href="http://aresxiong.com/2015/11/19/coding_android_animation_svg/" target="_blank" rel="external">Android之SVG图像详解(一)</a>中已经简单介绍了SVG图像的概念和基本使用技巧，下面就实际使用更进一步的探索和学习。</p>
<h2 id="场景分析"><a href="#场景分析" class="headerlink" title="场景分析"></a>场景分析</h2><p>效果图：<br><img src="http://img.blog.csdn.net/20150330001521473?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdGlhbmppYW40NTky/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""></p>
<p>这个效果我们需要考虑以下几个问题：</p>
<ul>
<li>这是图片还是文字；</li>
<li>如果是图片该如何拿到图形的边沿线坐标，如果是文字呢？</li>
<li>如果拿到了边沿线坐标，如何让光线沿着路径跑动；</li>
<li>怎么处理过程的衔接；</li>
</ul>
<p>首先背景是图片，普通的jpg或png图，但文字则是SVG格式的矢量图，接下来从SVG图中我们可以拿到我们想要的所有数据，让一条线沿着路径跑起来。毋庸置疑，我们需要用到path；根据效果的需要，设置几个绘制过程，进行绘制。</p>
<h2 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h2><p>既然SVG是公认的xml文件格式定义的，那么我们则可以通过解析xml文件拿到对应SVG图的所有数据，我们先看下 path 类型的SVG 数据：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" standalone="no"?&gt;  </div><div class="line"><span class="meta">&lt;!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"   </span></div><div class="line">"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"&gt;  </div><div class="line">  </div><div class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">width</span>=<span class="string">"100%"</span> <span class="attr">height</span>=<span class="string">"100%"</span> <span class="attr">version</span>=<span class="string">"1.1"</span>  </span></div><div class="line">     <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span>&gt;  </div><div class="line">     <span class="tag">&lt;<span class="name">path</span> <span class="attr">d</span>=<span class="string">"M250 150 L150 350 L350 350 Z"</span> /&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></div></pre></td></tr></table></figure>
<p>上面有一个path 标签，里面用到了 M 和 Z 指令，M 就相当于 android Path 里的moveTo(),Z 则相当于 Path 里的close();</p>
<p>我们先看下SVG 里关于path 有哪些指令：</p>
<ul>
<li>M = moveto   相当于 android Path 里的moveTo(),用于移动起始点  </li>
<li>L = lineto   相当于 android Path 里的lineTo()，用于画线  </li>
<li>H = horizontal lineto     用于画水平线  </li>
<li>V = vertical lineto       用于画竖直线  </li>
<li>C = curveto               相当于cubicTo(),三次贝塞尔曲线  </li>
<li>S = smooth curveto        同样三次贝塞尔曲线，更平滑  </li>
<li>Q = quadratic Belzier curve             quadTo()，二次贝塞尔曲线  </li>
<li>T = smooth quadratic Belzier curveto    同样二次贝塞尔曲线，更平滑  </li>
<li>A = elliptical Arc   相当于arcTo()，用于画弧  </li>
<li>Z = closepath     相当于closeTo(),关闭path  </li>
</ul>
<p>了解了以上path相关的指令，就可以看懂path构成的SVG图的数据了，除此之外，SVG里还定义了一些基本的图形和效果。<br>更多介绍和使用大家可以看 <a href="http://www.w3school.com.cn/svg/svg_intro.asp" target="_blank" rel="external">W3School</a></p>
<p>好，以上内容，我们已经知道 SVG 图是通过 Xml 格式定义的，并且里面用到了一些基本的指令对数据进行组装，构成基本图形或复杂的路径；</p>
<h2 id="获取SVG的xml数据"><a href="#获取SVG的xml数据" class="headerlink" title="获取SVG的xml数据"></a>获取SVG的xml数据</h2><p>1.我们根据最后要做的效果，利用PS等作图软件设计制作出想要的图形。</p>
<p>2.使用 GIMP 之类的矢量图软件导出图片的SVG数据，方法如下：<br><img src="http://img.blog.csdn.net/20150330203733227?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdGlhbmppYW40NTky/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""></p>
<p>3.先使用魔棒工具快速建立选区：<br><img src="http://img.blog.csdn.net/20150330204359921?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdGlhbmppYW40NTky/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""></p>
<p>4.然后将选区导出为path：<br><img src="http://img.blog.csdn.net/20150330204546403?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdGlhbmppYW40NTky/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""></p>
<p>5.这个时候在软件的右边栏就可以看见生成的路径了，然后将路径导出：<br><img src="http://img.blog.csdn.net/20150330204731535?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdGlhbmppYW40NTky/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""></p>
<p>经过以上几步，我们就拿到了我们自己设计的文字或图形SVG图的Path数据，上面图片的SVG信息如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;  </div><div class="line"><span class="meta">&lt;!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN"  </span></div><div class="line">              "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd"&gt;  </div><div class="line">  </div><div class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span>  </span></div><div class="line">     <span class="attr">width</span>=<span class="string">"6.95746in"</span> <span class="attr">height</span>=<span class="string">"1.82269in"</span>  </div><div class="line">     <span class="attr">viewBox</span>=<span class="string">"0 0 668 175"</span>&gt;  </div><div class="line">  <span class="tag">&lt;<span class="name">path</span> <span class="attr">id</span>=<span class="string">"Selection"</span>  </span></div><div class="line">        <span class="attr">fill</span>=<span class="string">"none"</span> <span class="attr">stroke</span>=<span class="string">"black"</span> <span class="attr">stroke-width</span>=<span class="string">"1"</span>  </div><div class="line">        <span class="attr">d</span>=<span class="string">"M 530.00,34.00  </span></div><div class="line">           C 530.00,34.00 526.08,59.00 526.08,59.00  </div><div class="line">             526.08,59.00 518.00,105.00 518.00,105.00  </div><div class="line">             518.00,105.00 515.42,119.00 515.42,119.00  </div><div class="line">             515.42,119.00 513.26,125.01 513.26,125.01  </div><div class="line">             513.26,125.01 506.00,126.00 506.00,126.00  </div><div class="line">             506.00,126.00 496.00,126.00 496.00,126.00  </div><div class="line">             496.00,126.00 496.00,120.00 496.00,120.00  </div><div class="line">             490.87,124.16 486.71,126.42 480.00,126.91  </div><div class="line">             475.71,127.22 471.06,126.94 467.00,125.44  </div><div class="line">             454.13,120.68 451.86,110.19 452.00,98.00  </div><div class="line">             452.22,79.34 465.14,64.55 484.00,63.18  </div><div class="line">             492.14,62.59 498.96,65.71 504.00,72.00  </div><div class="line">             504.00,72.00 510.00,34.00 510.00,34.00  </div><div class="line">             510.00,34.00 530.00,34.00 530.00,34.00 Z  </div><div class="line">           M 551.00,56.89  </div><div class="line">           C 539.01,55.86 537.45,39.82 551.00,35.55  </div><div class="line">             568.60,33.45 567.67,58.33 551.00,56.89 Z</div></pre></td></tr></table></figure></p>
<p> 中间段省略<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">M 263.00,134.00  </div><div class="line">          C 263.00,134.00 263.00,145.00 263.00,145.00  </div><div class="line">            263.00,145.00 202.00,145.00 202.00,145.00  </div><div class="line">            202.00,145.00 202.00,134.00 202.00,134.00  </div><div class="line">            202.00,134.00 263.00,134.00 263.00,134.00 Z" /&gt;  </div><div class="line">lt;/svg&gt;</div></pre></td></tr></table></figure></p>
<p>根据图形路径的复杂度，生成的path数据复杂度也不一样，但格式也算是非常的清楚，即采用一定的指令把数据点进行拼接；</p>
<p>现在有了这些数据点，我们需要做的则是对数据进行解析，封装成我们要的Path；</p>
<h2 id="数据解析"><a href="#数据解析" class="headerlink" title="数据解析"></a>数据解析</h2><p>解析的过程也无非是 遇到指令则采用android Path 里的对应方法进行置换，解析方式如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Path <span class="title">parsePath</span><span class="params">(String s)</span> <span class="keyword">throws</span> ParseException </span>&#123;  </div><div class="line">        mCurrentPoint.set(Float.NaN, Float.NaN);  </div><div class="line">        mPathString = s;  </div><div class="line">        mIndex = <span class="number">0</span>;  </div><div class="line">        mLength = mPathString.length();  </div><div class="line">  </div><div class="line">        PointF tempPoint1 = <span class="keyword">new</span> PointF();  </div><div class="line">        PointF tempPoint2 = <span class="keyword">new</span> PointF();  </div><div class="line">        PointF tempPoint3 = <span class="keyword">new</span> PointF();  </div><div class="line">  </div><div class="line">        Path p = <span class="keyword">new</span> Path();  </div><div class="line">        p.setFillType(Path.FillType.WINDING);  </div><div class="line">  </div><div class="line">        <span class="keyword">boolean</span> firstMove = <span class="keyword">true</span>;  </div><div class="line">        <span class="keyword">while</span> (mIndex &lt; mLength) &#123;  </div><div class="line">            <span class="keyword">char</span> command = consumeCommand();  </div><div class="line">            <span class="keyword">boolean</span> relative = (mCurrentToken == TOKEN_RELATIVE_COMMAND);  </div><div class="line">            <span class="keyword">switch</span> (command) &#123;  </div><div class="line">                <span class="keyword">case</span> <span class="string">'M'</span>:  </div><div class="line">                <span class="keyword">case</span> <span class="string">'m'</span>: &#123;  </div><div class="line">                    <span class="comment">// m指令，相当于android 里的 moveTo()  </span></div><div class="line">                    <span class="keyword">boolean</span> firstPoint = <span class="keyword">true</span>;  </div><div class="line">                    <span class="keyword">while</span> (advanceToNextToken() == TOKEN_VALUE) &#123;  </div><div class="line">                        consumeAndTransformPoint(tempPoint1,  </div><div class="line">                                relative &amp;&amp; mCurrentPoint.x != Float.NaN);  </div><div class="line">                        <span class="keyword">if</span> (firstPoint) &#123;  </div><div class="line">                            p.moveTo(tempPoint1.x, tempPoint1.y);  </div><div class="line">                            firstPoint = <span class="keyword">false</span>;  </div><div class="line">                            <span class="keyword">if</span> (firstMove) &#123;  </div><div class="line">                                mCurrentPoint.set(tempPoint1);  </div><div class="line">                                firstMove = <span class="keyword">false</span>;  </div><div class="line">                            &#125;  </div><div class="line">                        &#125; <span class="keyword">else</span> &#123;  </div><div class="line">                            p.lineTo(tempPoint1.x, tempPoint1.y);  </div><div class="line">                        &#125;  </div><div class="line">                    &#125;  </div><div class="line">                    mCurrentPoint.set(tempPoint1);  </div><div class="line">                    <span class="keyword">break</span>;  </div><div class="line">                &#125;  </div><div class="line">  </div><div class="line">                <span class="keyword">case</span> <span class="string">'C'</span>:  </div><div class="line">                <span class="keyword">case</span> <span class="string">'c'</span>: &#123;  </div><div class="line">                    <span class="comment">// c指令，相当于android 里的 cubicTo()  </span></div><div class="line">                    <span class="keyword">if</span> (mCurrentPoint.x == Float.NaN) &#123;  </div><div class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> ParseException(<span class="string">"Relative commands require current point"</span>, mIndex);  </div><div class="line">                    &#125;  </div><div class="line">  </div><div class="line">                    <span class="keyword">while</span> (advanceToNextToken() == TOKEN_VALUE) &#123;  </div><div class="line">                        consumeAndTransformPoint(tempPoint1, relative);  </div><div class="line">                        consumeAndTransformPoint(tempPoint2, relative);  </div><div class="line">                        consumeAndTransformPoint(tempPoint3, relative);  </div><div class="line">                        p.cubicTo(tempPoint1.x, tempPoint1.y, tempPoint2.x, tempPoint2.y,  </div><div class="line">                                tempPoint3.x, tempPoint3.y);  </div><div class="line">                    &#125;  </div><div class="line">                    mCurrentPoint.set(tempPoint3);  </div><div class="line">                    <span class="keyword">break</span>;  </div><div class="line">                &#125;  </div><div class="line">  </div><div class="line">                <span class="keyword">case</span> <span class="string">'L'</span>:  </div><div class="line">                <span class="keyword">case</span> <span class="string">'l'</span>: &#123;  </div><div class="line">                    <span class="comment">// 相当于lineTo()进行画直线  </span></div><div class="line">                    <span class="keyword">if</span> (mCurrentPoint.x == Float.NaN) &#123;  </div><div class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> ParseException(<span class="string">"Relative commands require current point"</span>, mIndex);  </div><div class="line">                    &#125;  </div><div class="line">  </div><div class="line">                    <span class="keyword">while</span> (advanceToNextToken() == TOKEN_VALUE) &#123;  </div><div class="line">                        consumeAndTransformPoint(tempPoint1, relative);  </div><div class="line">                        p.lineTo(tempPoint1.x, tempPoint1.y);  </div><div class="line">                    &#125;  </div><div class="line">                    mCurrentPoint.set(tempPoint1);  </div><div class="line">                    <span class="keyword">break</span>;  </div><div class="line">                &#125;  </div><div class="line">  </div><div class="line">                <span class="keyword">case</span> <span class="string">'H'</span>:  </div><div class="line">                <span class="keyword">case</span> <span class="string">'h'</span>: &#123;  </div><div class="line">                    <span class="comment">// 画水平直线  </span></div><div class="line">                    <span class="keyword">if</span> (mCurrentPoint.x == Float.NaN) &#123;  </div><div class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> ParseException(<span class="string">"Relative commands require current point"</span>, mIndex);  </div><div class="line">                    &#125;  </div><div class="line">  </div><div class="line">                    <span class="keyword">while</span> (advanceToNextToken() == TOKEN_VALUE) &#123;  </div><div class="line">                        <span class="keyword">float</span> x = transformX(consumeValue());  </div><div class="line">                        <span class="keyword">if</span> (relative) &#123;  </div><div class="line">                            x += mCurrentPoint.x;  </div><div class="line">                        &#125;  </div><div class="line">                        p.lineTo(x, mCurrentPoint.y);  </div><div class="line">                    &#125;  </div><div class="line">                    mCurrentPoint.set(tempPoint1);  </div><div class="line">                    <span class="keyword">break</span>;  </div><div class="line">                &#125;  </div><div class="line">  </div><div class="line">                <span class="keyword">case</span> <span class="string">'V'</span>:  </div><div class="line">                <span class="keyword">case</span> <span class="string">'v'</span>: &#123;  </div><div class="line">                    <span class="comment">// 画竖直直线  </span></div><div class="line">                    <span class="keyword">if</span> (mCurrentPoint.x == Float.NaN) &#123;  </div><div class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> ParseException(<span class="string">"Relative commands require current point"</span>, mIndex);  </div><div class="line">                    &#125;  </div><div class="line">  </div><div class="line">                    <span class="keyword">while</span> (advanceToNextToken() == TOKEN_VALUE) &#123;  </div><div class="line">                        <span class="keyword">float</span> y = transformY(consumeValue());  </div><div class="line">                        <span class="keyword">if</span> (relative) &#123;  </div><div class="line">                            y += mCurrentPoint.y;  </div><div class="line">                        &#125;  </div><div class="line">                        p.lineTo(mCurrentPoint.x, y);  </div><div class="line">                    &#125;  </div><div class="line">                    mCurrentPoint.set(tempPoint1);  </div><div class="line">                    <span class="keyword">break</span>;  </div><div class="line">                &#125;  </div><div class="line">  </div><div class="line">                <span class="keyword">case</span> <span class="string">'Z'</span>:  </div><div class="line">                <span class="keyword">case</span> <span class="string">'z'</span>: &#123;  </div><div class="line">                    <span class="comment">// 封闭path  </span></div><div class="line">                    p.close();  </div><div class="line">                    <span class="keyword">break</span>;  </div><div class="line">                &#125;  </div><div class="line">            &#125;  </div><div class="line">  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        <span class="keyword">return</span> p;  </div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>有了图形对应的path，我们只需要按照我们想要的效果进行绘制即可，具体过程不再细讲，大家看代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span>  </div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;  </div><div class="line">        <span class="keyword">super</span>.onDraw(canvas);  </div><div class="line">        <span class="keyword">if</span> (mState == STATE_NOT_STARTED || mGlyphData == <span class="keyword">null</span>) &#123;  </div><div class="line">            <span class="keyword">return</span>;  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        <span class="keyword">long</span> t = System.currentTimeMillis() - mStartTime;  </div><div class="line">  </div><div class="line">        <span class="comment">// 绘制出现前的边沿线和跑动过程  </span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mGlyphData.length; i++) &#123;  </div><div class="line">            <span class="keyword">float</span> phase = MathUtil.constrain(<span class="number">0</span>, <span class="number">1</span>,  </div><div class="line">                    (t - (mTraceTime - mTraceTimePerGlyph) * i * <span class="number">1f</span> / mGlyphData.length)  </div><div class="line">                            * <span class="number">1f</span> / mTraceTimePerGlyph);  </div><div class="line">            <span class="keyword">float</span> distance = INTERPOLATOR.getInterpolation(phase) * mGlyphData[i].length;  </div><div class="line">            mGlyphData[i].paint.setColor(mTraceResidueColors[i]);  </div><div class="line">            mGlyphData[i].paint.setPathEffect(<span class="keyword">new</span> DashPathEffect(  </div><div class="line">                    <span class="keyword">new</span> <span class="keyword">float</span>[] &#123;  </div><div class="line">                            distance, mGlyphData[i].length  </div><div class="line">                    &#125;, <span class="number">0</span>));  </div><div class="line">            canvas.drawPath(mGlyphData[i].path, mGlyphData[i].paint);  </div><div class="line">  </div><div class="line">            mGlyphData[i].paint.setColor(mTraceColors[i]);  </div><div class="line">            mGlyphData[i].paint.setPathEffect(<span class="keyword">new</span> DashPathEffect(  </div><div class="line">                    <span class="keyword">new</span> <span class="keyword">float</span>[] &#123;  </div><div class="line">                            <span class="number">0</span>, distance, phase &gt; <span class="number">0</span> ? mMarkerLength : <span class="number">0</span>,  </div><div class="line">                            mGlyphData[i].length  </div><div class="line">                    &#125;, <span class="number">0</span>));  </div><div class="line">            canvas.drawPath(mGlyphData[i].path, mGlyphData[i].paint);  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        <span class="keyword">if</span> (t &gt; mFillStart) &#123;  </div><div class="line">            <span class="keyword">if</span> (mState &lt; STATE_FILL_STARTED) &#123;  </div><div class="line">                changeState(STATE_FILL_STARTED);  </div><div class="line">            &#125;  </div><div class="line">  </div><div class="line">            <span class="comment">// 绘制渐变出现的过程，即改变alpha过程  </span></div><div class="line">            <span class="keyword">float</span> phase = MathUtil.constrain(<span class="number">0</span>, <span class="number">1</span>, (t - mFillStart) * <span class="number">1f</span> / mFillTime);  </div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mGlyphData.length; i++) &#123;  </div><div class="line">                GlyphData glyphData = mGlyphData[i];  </div><div class="line">                mFillPaint.setARGB((<span class="keyword">int</span>) (phase * ((<span class="keyword">float</span>) mFillAlphas[i] / (<span class="keyword">float</span>) <span class="number">255</span>) * <span class="number">255</span>),  </div><div class="line">                        mFillReds[i],  </div><div class="line">                        mFillGreens[i],  </div><div class="line">                        mFillBlues[i]);  </div><div class="line">                canvas.drawPath(glyphData.path, mFillPaint);  </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        <span class="keyword">if</span> (t &lt; mFillStart + mFillTime) &#123;  </div><div class="line">            ViewCompat.postInvalidateOnAnimation(<span class="keyword">this</span>);  </div><div class="line">        &#125; <span class="keyword">else</span> &#123;  </div><div class="line">            changeState(STATE_FINISHED);  </div><div class="line">        &#125;  </div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>本文整理自Ajian_studio的博客，原文链接见<a href="http://blog.csdn.net/tianjian4592/article/details/44733123" target="_blank" rel="external">Android使用SVG矢量图打造酷炫动效</a>。</p>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul>
<li><a href="http://blog.csdn.net/tianjian4592/article/details/44733123" target="_blank" rel="external">Android使用SVG矢量图打造酷炫动效</a></li>
<li><a href="http://lvable.com/?p=104" target="_blank" rel="external">SVG图像——Android 5.0新特性介绍</a></li>
<li><a href="http://willowtreeapps.com/blog/muzei-esque-animated-svg-drawing-for-android/" target="_blank" rel="external">Muzei-esque Animated SVG Drawing for Android</a></li>
<li><a href="http://pan.baidu.com/s/1qWOSFXq" target="_blank" rel="external">svgdemo</a> 密码：qi7q</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/11/19/android_animation_svg2/" data-id="cj4zx2kfy000aqonhr73iu27t" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/animation/">animation</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/svg/">svg</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-android_animation_svg" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/11/19/android_animation_svg/" class="article-date">
  <time datetime="2015-11-19T08:48:29.000Z" itemprop="datePublished">2015-11-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/android/">android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/19/android_animation_svg/">Android之SVG图像详解(一)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>SVG图像是Android 5.0新特性，全称是Scalable Vector Graphics，叫可缩放矢量图形。它和位图（Bitmap）相对，SVG不会像位图一样因为缩放而让图片质量下降。下面这个图片展示了SVG和位图的区别，左边的位图在放大后出现了锯齿，而右边的SVG任然清晰。<br><img src="http://lvable.com/wp-content/uploads/2015/03/svg_cp-300x161.jpg" alt=""></p>
<p>SVG 的优势在于：</p>
<ul>
<li>1.SVG 可被非常多的工具读取和修改（比如记事本）,由于使用xml格式定义，所以可以直接被当作文本文件打开，看里面的数据；</li>
<li>2.SVG 与 JPEG 和 GIF 图像比起来，尺寸更小，且可压缩性更强，SVG 图就相当于保存了关键的数据点，比如要显示一个圆，需要知道圆心和半径，那么SVG 只保存圆心坐标和半径数据，而平常我们用的位图都是以像素点的形式根据图片大小保存对应个数的像素点，因而SVG尺寸更小；</li>
<li>3.SVG 是可伸缩的，平常使用的位图拉伸会发虚，压缩会变形，而SVG格式图片保存数据进行运算展示，不管多大多少，可以不失真显示；</li>
<li>4.SVG 图像可在任何的分辨率下被高质量地打印;</li>
<li>5.SVG 可在图像质量不下降的情况下被放大;</li>
<li>6.SVG 图像中的文本是可选的，同时也是可搜索的（很适合制作地图）;</li>
<li>7.SVG 可以与 Java 技术一起运行;</li>
<li>8.SVG 是开放的标准;</li>
<li>9.SVG 文件是纯粹的 XML;</li>
<li>节约空间，使用方便;<br><img src="http://lvable.com/wp-content/uploads/2015/03/QQ%E6%88%AA%E5%9B%BE20150329202954-300x157.jpg" alt=""></li>
</ul>
<h2 id="如何在Android中使用？"><a href="#如何在Android中使用？" class="headerlink" title="如何在Android中使用？"></a>如何在Android中使用？</h2><p><strong> 1.把普通SVG图片转成Android可用格式：</strong></p>
<p><img src="http://lvable.com/wp-content/uploads/2015/03/t-242x300.jpg" alt=""></p>
<p>有两种方法，手动改一下原始SVG的格式，或者用一个<a href="http://inloop.github.io/svg2android/" target="_blank" rel="external">自动转换的工具</a>（Android SVG to VectorDrawable）</p>
<p>下面展示一下,这个图像的SVG文件内容t<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">xmlns:svg</span>=<span class="string">"http://www.w3.org/2000/svg"</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span> <span class="attr">version</span>=<span class="string">"1.0"</span> <span class="attr">viewBox</span>=<span class="string">"0 0 180 400"</span> <span class="attr">width</span>=<span class="string">"180px"</span> <span class="attr">height</span>=<span class="string">"320"</span> <span class="attr">preserveAspectRatio</span>=<span class="string">"none"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">path</span> <span class="attr">d</span>=<span class="string">"M 180,230 L 0,320 0,0 180,0 z"</span> <span class="attr">fill</span>=<span class="string">"#000000"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>path是画出这个矢量图所需的笔画路径，这里就是移植到android所需要的关键部分。下面来看转换成android能用SVG图内容，这里我将重点讲解</p>
<p>sharp_rect.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">vector</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">        <span class="attr">android:width</span>=<span class="string">"180dp"</span></div><div class="line">        <span class="attr">android:height</span>=<span class="string">"320dp"</span></div><div class="line">        <span class="attr">android:viewportWidth</span>=<span class="string">"180"</span></div><div class="line">        <span class="attr">android:viewportHeight</span>=<span class="string">"400"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">path</span></span></div><div class="line">        <span class="attr">android:name</span>=<span class="string">"sharp_rect"</span></div><div class="line">        <span class="attr">android:fillColor</span>=<span class="string">"#000000"</span></div><div class="line">        <span class="attr">android:pathData</span>=<span class="string">"M 180,230 L 0,320 0,0 180,0 z"</span> /&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">vector</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>注意到和普通SVG图内容不同地方在与viewBox那变成了viewportWidth，viewportHeight，viewport就相当于画这个SVG的画布大小。width和height是规定这个SVG图像最终的显示大小的，一般用dp表示。第二个不同是有一个普通SVG里的fill到android里要变成fillColor，这里就是SVG图像填充的颜色。第三点不同是，普通SVG的path的数据是d开头的标签，在android里要写成pathData。综上所述，只要把viewBox的大小改成viewport的大小，把填充颜色的fill改成fillColor，把Path中的d，改成pathData就行了。</p>
<p>还有最后一个问题pathData中的那些奇怪的东西是啥？数字是在viewport中的坐标点，M代表move to（把画笔移动到），L是Line（划线），Z是封闭path.（<a href="http://www.w3schools.com/svg/svg_path.asp" target="_blank" rel="external">更多参考</a>）</p>
<p>我们可以通过上面的变动手动把普通SVG转成android用的VectorDrawable,或者我们可以用这个网站自动完成转换 <a href="http://inloop.github.io/svg2android/" target="_blank" rel="external">http://inloop.github.io/svg2android/</a></p>
<p><strong> 2.显示</strong></p>
<p>这个SVG就直接就是Drawable直接用就好:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">                <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></div><div class="line">                <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">                <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">                <span class="attr">android:padding</span>=<span class="string">"20dp"</span></div><div class="line">                <span class="attr">tools:context</span>=<span class="string">".MainActivity"</span>&gt;</div><div class="line">         <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line">            <span class="attr">android:src</span>=<span class="string">"@drawable/sharp_rect"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span> /&gt;        </div><div class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h2><p>效果图：<br><img src="http://lvable.com/wp-content/uploads/2015/03/test-193x300.gif" alt=""></p>
<p>要实现这个布局很简单，用FrameLayout加一个ImageView并设置一个图片，再在FrameLayout上放一个RelativeLayout，背景用<br><img src="http://lvable.com/wp-content/uploads/2015/03/t-242x300.jpg" alt=""><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">                <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></div><div class="line">                <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">                <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">                <span class="attr">android:padding</span>=<span class="string">"20dp"</span></div><div class="line">                <span class="attr">tools:context</span>=<span class="string">".MainActivity"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">FrameLayout</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/card_view"</span></div><div class="line">        <span class="attr">android:layout_centerInParent</span>=<span class="string">"true"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"260dp"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"430dp"</span></div><div class="line">        &gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/img"</span></div><div class="line">            <span class="attr">android:src</span>=<span class="string">"@drawable/p1"</span></div><div class="line">            <span class="attr">android:scaleType</span>=<span class="string">"centerCrop"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span> /&gt;</div><div class="line">        <span class="tag">&lt;<span class="name">RelativeLayout</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/card_content"</span></div><div class="line">            <span class="attr">android:background</span>=<span class="string">"@drawable/animate_rect"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"320dp"</span></div><div class="line">            <span class="attr">android:padding</span>=<span class="string">"15dp"</span>&gt;</div><div class="line">            <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">                <span class="attr">android:id</span>=<span class="string">"@+id/title"</span></div><div class="line">                <span class="attr">android:textColor</span>=<span class="string">"#03A9F4"</span></div><div class="line">                <span class="attr">android:textSize</span>=<span class="string">"25sp"</span></div><div class="line">                <span class="attr">android:layout_marginTop</span>=<span class="string">"6dp"</span></div><div class="line">                <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">                <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">                <span class="attr">android:text</span>=<span class="string">"Vector card"</span></div><div class="line">                <span class="attr">android:layout_alignParentTop</span>=<span class="string">"true"</span></div><div class="line">                <span class="attr">android:layout_centerHorizontal</span>=<span class="string">"true"</span>/&gt;</div><div class="line">            <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">                <span class="attr">android:id</span>=<span class="string">"@+id/tv_content"</span></div><div class="line">                <span class="attr">android:gravity</span>=<span class="string">"center"</span></div><div class="line">                <span class="attr">android:layout_marginTop</span>=<span class="string">"18dp"</span></div><div class="line">                <span class="attr">android:layout_below</span>=<span class="string">"@id/title"</span></div><div class="line">                <span class="attr">android:text</span>=<span class="string">"Lorem ipsum dolor sit amet, Duis aute irure dolor in reprehenderit sunt in culpa quilaborum. in voluptate velit esse cillum dolore eu fugiat nulla ."</span></div><div class="line">                <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">                <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">                /&gt;</div><div class="line"></div><div class="line"></div><div class="line">        <span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>怎么让它动起来呢?其实很简单,只要修改SVG图中的pathData就行,也就是从梯形变成一个长方形。原来的pathData的坐标和要变化的新坐标如图所示，<br><img src="http://lvable.com/wp-content/uploads/2015/03/t3-242x300.jpg" alt=""><br>SVG文件内容：sharp_rect.xml</p>
<p>注意,我们把path加了一个name=”sharp_rect”,这是做动画效果是要指定这部分,所以需要给个独一无二的name作为id<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">vector</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">        <span class="attr">android:width</span>=<span class="string">"180dp"</span></div><div class="line">        <span class="attr">android:height</span>=<span class="string">"320dp"</span></div><div class="line">        <span class="attr">android:viewportWidth</span>=<span class="string">"180"</span></div><div class="line">        <span class="attr">android:viewportHeight</span>=<span class="string">"400"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">path</span></span></div><div class="line">        <span class="attr">android:name</span>=<span class="string">"sharp_rect"</span></div><div class="line">        <span class="attr">android:fillColor</span>=<span class="string">"#000000"</span></div><div class="line">        <span class="attr">android:pathData</span>=<span class="string">"M 180,230 L 0,320 0,0 180,0 z"</span> /&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">vector</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>下面做animate-vector drawable:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">animated-vector</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">android:drawable</span>=<span class="string">"@drawable/sharp_rect"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">target</span></span></div><div class="line">        <span class="attr">android:animation</span>=<span class="string">"@animator/to_rect"</span></div><div class="line">        <span class="attr">android:name</span>=<span class="string">"sharp_rect"</span>/&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">animated-vector</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>在animated-vector里填入android:drawable=”@drawable/sharp_rect”,这是指定要产生动画的SVG。target里是需要动画的对象，这里我们的对象就是前面那个叫sharp_rect的梯形,所以name里填上它,然后animation填的是对应的动画文件。</p>
<p>动画用的是ObjectAnimator做的，内容如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">objectAnimator</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">                <span class="attr">android:duration</span>=<span class="string">"330"</span></div><div class="line">                <span class="attr">android:interpolator</span>=<span class="string">"@android:interpolator/decelerate_cubic"</span></div><div class="line">                <span class="attr">android:propertyName</span>=<span class="string">"pathData"</span></div><div class="line">                <span class="attr">android:valueType</span>=<span class="string">"pathType"</span></div><div class="line">                <span class="attr">android:valueFrom</span>=<span class="string">"M 180,230 L 0,320 0,0 180,0 z"</span></div><div class="line">                <span class="attr">android:valueTo</span>=<span class="string">"M 180,75 L 0,75 0,0 180,0 z"</span> /&gt;</div></pre></td></tr></table></figure>
<p>值得注意的是,我们要从梯形变成矩形,就是对pathData进行修改,也就是propertyName要填入pathData,valueType是pathType,valueFrom是原来的路径(也就是梯形的路径),最终变成的效果是valueTo(矩形的路径)。这里有个要注意的地方，如果要进行path的变换，里面的点数必须要一样！</p>
<p>Ok了大功告成，最后只要把ImageView的src改成animate_rect就行了,并设置触发函数就行了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> ImageView play = (ImageView)findViewById(R.id.icon_play);</div><div class="line">       play.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">               Drawable drawable = play.getDrawable();</div><div class="line">               <span class="keyword">if</span> ( drawable <span class="keyword">instanceof</span> Animatable)&#123;</div><div class="line">                   ((Animatable) drawable).start();</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;);</div></pre></td></tr></table></figure>
<p>注意,上面我这种方法不是Android SVG推荐的用法,SVG动画尺寸应该尽可能的小,和简单,因为每次动画都会先把这些path先计算绘成Bitmap,然后上传texture到GPU,如果SVG太大意味着生成更大的Bitmap,占更多内存,消耗更多时间.Google的推荐是把SVG用于图标(icon)和按钮(Button),只有需要的时候才修改Vector的属性(比如alpha,width,height),因为如果SVG不用于动画,android会把这个图生成一个Cache来节省时间,如果SVG动画这个Cache就没有用了。如果要用SVG动画，请确保它“短小精悍”（Short and sweet）。</p>
<p>下面还有一些SVG动画的例子：<br><img src="http://lvable.com/wp-content/uploads/2015/03/35ed6362d41a2a3e5a64d3bb8ed16033-181x300.gif" alt=""></p>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul>
<li><a href="http://lvable.com/?p=104" target="_blank" rel="external">SVG图像——Android 5.0新特性介绍</a></li>
<li><a href="https://github.com/qianlvable/VectorCard" target="_blank" rel="external">Demo源代码</a></li>
<li><a href="https://www.youtube.com/watch?v=wlFVIIstKmA" target="_blank" rel="external">DevBytes视频（Youtube）</a></li>
<li><a href="https://blog.stylingandroid.com/vectordrawables-part-1/" target="_blank" rel="external">VectorDrawables – Styling Android 系列</a></li>
<li><a href="http://blog.neteril.org/blog/2014/11/13/transitioning-to-infinity/" target="_blank" rel="external">Transitioning to Infinity</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/11/19/android_animation_svg/" data-id="cj4zx2kfi0005qonhn5mxy2ed" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/animation/">animation</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/svg/">svg</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-study_speech_dabing" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/11/19/study_speech_dabing/" class="article-date">
  <time datetime="2015-11-19T03:11:29.000Z" itemprop="datePublished">2015-11-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/study/">study</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/19/study_speech_dabing/">大兵在一席的演讲</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="大兵在一席的演讲"><a href="#大兵在一席的演讲" class="headerlink" title="大兵在一席的演讲"></a>大兵在一席的演讲</h2><p>小时候很喜欢看山东卫视的《阳光快车道》，记得主持人是大兵。后来就渐渐淡忘了。<br>直到后来，我在民谣里再一次遇到大兵，并意外的发现他也就小时候我喜欢的一个节目的主持人，莫名的亲切感，或许不是因为人，而是记忆。<br>看过他的演讲，很喜欢他。生活中有个性的人太少了，所以喜欢一切有个性的人。<br>什么是幸福？<br>什么是得到？<br>什么是有意义的生活？<br>或许每个人都有自己不同的答案。</p>
<object align="middle" height="250" width="280"><br><embed pluginspage="http://www.macromedia.com/go/getflashplayer" type="application/x-shockwave-flash" name="videoSwf" src="http://player.ku6cdn.com/default/out/pv201105281643.swf?ver=108&amp;vid=_hrtj1Nr6jh7epU82QfoTQ..&amp;type=v&amp;referer&amp;color=DCE1E6&amp;adss=0&amp;recommend=0&amp;fu=1" allowfullscreen="true" wmode="transparent" errormessage="please updata your flashplayer." align="middle" height="250" width="280"><br></object>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/11/19/study_speech_dabing/" data-id="cj4zx2kk1005xqonhy0la6og4" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/speech/">speech</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-android_sqlite" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/11/18/android_sqlite/" class="article-date">
  <time datetime="2015-11-18T11:47:29.000Z" itemprop="datePublished">2015-11-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/android/">android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/18/android_sqlite/">Android之SQLite详解</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><h2 id="1、SQLite介绍"><a href="#1、SQLite介绍" class="headerlink" title="1、SQLite介绍"></a>1、SQLite介绍</h2><p>自几十年前出现的商业应用程序以来，数据库就成为软件应用程序的主要组成部分。正与数据库管理系统非常关键一样，它们也变得非常庞大，并占用了相当多的系统资源，增加了管理的复杂性。随着软件应用程序逐渐模块模块化，一种新型数据库会比大型复杂的传统数据库管理系统更适应。嵌入式数据库直接在应用程序进程中运行，提供了零配置（zero-configuration）运行模式，并且资源占用非常少。<br>SQLite是一个开源的嵌入式关系数据库，它在2000年由D. Richard Hipp发布，它的减少应用程序管理数据的开销，SQLite可移植性好，很容易使用，很小，高效而且可靠。<br>SQLite嵌入到使用它的应用程序中，它们共用相同的进程空间，而不是单独的一个进程。从外部看，它并不像一个RDBMS，但在进程内部，它却是完整的，自包含的数据库引擎。</p>
<p>嵌入式数据库的一大好处就是在你的程序内部不需要网络配置，也不需要管理。因为客户端和服务器在同一进程空间运行。SQLite 的数据库权限只依赖于文件系统，没有用户帐户的概念。SQLite 有数据库级锁定，没有网络服务器。它需要的内存，其它开销很小，适合用于嵌入式设备。你需要做的仅仅是把它正确的编译到你的程序。</p>
<h2 id="2、架构-architecture"><a href="#2、架构-architecture" class="headerlink" title="2、架构(architecture)"></a>2、架构(architecture)</h2><p>SQLite采用了模块的设计，它由三个子系统，包括8个独立的模块构成。<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite01-1.JPG" alt=""></p>
<h3 id="2-1、接口-Interface"><a href="#2-1、接口-Interface" class="headerlink" title="2.1、接口(Interface)"></a>2.1、接口(Interface)</h3><p>接口由SQLite C API组成，也就是说不管是程序、脚本语言还是库文件，最终都是通过它与SQLite交互的(我们通常用得较多的ODBC/JDBC最后也会转化为相应C API的调用)。</p>
<h3 id="2-2、编译器-Compiler"><a href="#2-2、编译器-Compiler" class="headerlink" title="2.2、编译器(Compiler)"></a>2.2、编译器(Compiler)</h3><p>在编译器中，分词器（Tokenizer）和分析器(Parser)对SQL进行语法检查，然后把它转化为底层能更方便处理的分层的数据结构—语法树，然后把语法树传给代码生成器(code generator)进行处理。而代码生成器根据它生成一种针对SQLite的汇编代码，最后由虚拟机(Virtual Machine)执行。</p>
<h3 id="2-3、虚拟机-Virtual-Machine"><a href="#2-3、虚拟机-Virtual-Machine" class="headerlink" title="2.3、虚拟机(Virtual Machine)"></a>2.3、虚拟机(Virtual Machine)</h3><p>架构中最核心的部分是虚拟机，或者叫做虚拟数据库引擎(Virtual Database Engine,VDBE)。它和Java虚拟机相似，解释执行字节代码。VDBE的字节代码由<strong> 128个操作码(opcodes)</strong>构成，它们主要集中在数据库操作。它的每一条指令都用来完成特定的数据库操作(比如打开一个表的游标)或者为这些操作栈空间的准备(比如压入参数)。总之，所有的这些指令都是为了满足SQL命令的要求(关于VM，后面会做详细介绍)。</p>
<h3 id="2-4、后端-Back-End"><a href="#2-4、后端-Back-End" class="headerlink" title="2.4、后端(Back-End)"></a>2.4、后端(Back-End)</h3><p>后端由B-树(B-tree)，页缓存(page cache，pager)和操作系统接口(即系统调用)构成。B-tree和page cache共同对数据进行管理。B-tree的主要功能就是索引，它维护着各个页面之间的复杂的关系，便于快速找到所需数据。而pager的主要作用就是通过OS接口在B-tree和Disk之间传递页面。</p>
<h2 id="3、SQLite的特点-SQLite’s-Features-and-Philosophy"><a href="#3、SQLite的特点-SQLite’s-Features-and-Philosophy" class="headerlink" title="3、SQLite的特点(SQLite’s Features and Philosophy)"></a>3、SQLite的特点(SQLite’s Features and Philosophy)</h2><ul>
<li>零配置(Zero Configuration)</li>
<li>可移植(Portability)：它是运行在Windows,Linux,BSD,Mac OS X和一些商用Unix系统，比如Sun的Solaris,IBM的AIX，同样，它也可以工作在许多嵌入式操作系统下，比如QNX,VxWorks,Palm OS, Symbin和Windows CE。</li>
<li>紧致性(Compactness)：SQLite是被设计成轻量级，自包含的。one header file, one library, and you’re relational, no external database server required</li>
<li>简单(Simplicity)</li>
<li>灵活(Flexibility)</li>
<li>可靠(Reliability)：SQLite的核心大约有3万行标准C代码，这些代码都是模块化的，很容易阅读。</li>
</ul>
<h1 id="设计与概念"><a href="#设计与概念" class="headerlink" title="设计与概念"></a>设计与概念</h1><h2 id="1、-API"><a href="#1、-API" class="headerlink" title="1、 API"></a>1、 API</h2><p>由两部分组成: 核心API(core API) 和扩展API（extension API）<br>核心API的函数实现基本的数据库操作：连接数据库，处理SQL，遍历结果集。它也包括一些实用函数，比如字符串转换，操作控制，调试和错误处理。<br>扩展API通过创建你自定义的SQL函数去扩展SQLite。</p>
<h3 id="1-1、SQLite-Version-3的一些新特点："><a href="#1-1、SQLite-Version-3的一些新特点：" class="headerlink" title="1.1、SQLite Version 3的一些新特点："></a>1.1、SQLite Version 3的一些新特点：</h3><ul>
<li>(1)SQLite的API全部重新设计，由第二版的15个函数增加到88个函数。这些函数包括支持UTF-8和UTF-16编码的功能函数。</li>
<li>(2)改进并发性能。加锁子系统引进一种锁升级模型(lock escalation model)，解决了第二版的写进程饿死的问题(该问题是任何一个DBMS必须面对的问题)。这种模型保证写进程按照先来先服务的算法得到排斥锁(Exclusive Lock)。甚至，写进程通过把结果写入临时缓冲区(Temporary Buffer)，可以在得到排斥锁之前就能开始工作。这对于写要求较高的应用，性能可提高400%（引自参考文献）。</li>
<li>(3)改进的B-树。对于表采用B+树，大大提高查询效率。</li>
<li>(4)SQLite 3最重要的改变是它的存储模型。由第二版只支持文本模型，扩展到支持5种本地数据类型。<br>总之，SQLite Version 3与SQLite Vertion 2有很大的不同，在灵活性，特点和性能方面有很大的改进。</li>
</ul>
<h3 id="1-2、主要的数据结构-The-Principal-Data-Structures"><a href="#1-2、主要的数据结构-The-Principal-Data-Structures" class="headerlink" title="1.2、主要的数据结构(The Principal Data Structures)"></a>1.2、主要的数据结构(The Principal Data Structures)</h3><p>SQLite由很多部分组成－parser,tokenize,virtual machine等等。但是从程序员的角度，最需要知道的是:connection, statements, B-tree和pager。它们之间的关系如下：<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite02-1.JPG" alt=""></p>
<p>上图告诉我们在编程需要知道的三个主要方面：API,事务(Transaction)和锁(Locks)。从技术上来说，B-tree和pager不是API的一部分。但是它们却在事务和锁上起着关键作用（稍后将讨论）。</p>
<h3 id="1-3、Connections和Statements"><a href="#1-3、Connections和Statements" class="headerlink" title="1.3、Connections和Statements"></a>1.3、Connections和Statements</h3><p>Connection和statement是执行SQL命令涉及的两个主要数据结构，几乎所有通过API进行的操作都要用到它们。一个连接(Connection)代表在一个独立的事务环境下的一个连接A (connection represents a single connection to a database as well as a single transaction context)。每一个statement都和一个connection关联，它通常表示一个编译过的SQL语句，在内部，它以VDBE字节码表示。Statement包括执行一个命令所需要一切，包括保存VDBE程序执行状态所需的资源，指向硬盘记录的B-树游标，以及参数等等。</p>
<h3 id="1-4、B-tree和pager"><a href="#1-4、B-tree和pager" class="headerlink" title="1.4、B-tree和pager"></a>1.4、B-tree和pager</h3><p>一个connection可以有多个database对象—一个主要的数据库以及附加的数据库，每一个数据库对象有一个B-tree对象，一个B-tree有一个pager对象(这里的对象不是面向对象的“对象”，只是为了说清楚问题)。<br>Statement最终都是通过connection的B-tree和pager从数据库读或者写数据，通过B-tree的游标(cursor)遍历存储在页面(page)中的记录。游标在访问页面之前要把数所从disk加载到内存，而这就是pager的任务。任何时候，如果B-tree需要页面，它都会请求pager从disk读取数据，然后把页面(page)加载到页面缓冲区(page cache)，之后，B-tree和与之关联的游标就可以访问位于page中的记录了。<br>如果cursor改变了page，为了防止事务回滚，pager必须采取特殊的方式保存原来的page。总的来说，pager负责读写数据库，管理内存缓存和页面（page），以及管理事务，锁和崩溃恢复(这些在事务一节会详细介绍)。<br>总之，关于connection和transaction，你必须知道两件事：<br>(1) 对数据库的任何操作，一个连接存在于一个事务下。<br>(2) 一个连接决不会同时存在多个事务下。<br>whenever a connection does anything with a database, it always operates under exactly one<br>transaction, no more, no less.</p>
<h3 id="1-5、核心API"><a href="#1-5、核心API" class="headerlink" title="1.5、核心API"></a>1.5、核心API</h3><p>核心API 主要与执行SQL命令有关，本质上有两种方法执行SQL语句：prepared query 和wrapped query。Prepared query由三个阶段构成：preparation，execution和finalization。其实wrapped query只是对prepared query的三个过程包装而已，最终也会转化为prepared query的执行。</p>
<p><strong> 1.5.1、连接的生命周期(The Connection Lifecycle)</strong><br>和大多数据库连接相同，由三个过程构成：<br>（1） 连接数据库(Connect to the database)：<br>每一个SQLite数据库都存储在单独的操作系统文件中，连接，打开数据库的C API为：sqlite3_open()，它的实现位于main.c文件中，如下：<br>int sqlite3_open(const char <em>zFilename, sqlite3 *</em>ppDb)<br>{<br>  return openDatabase(zFilename, ppDb, SQLITE_OPEN_READWRITE | SQLITE_OPEN_CREATE, 0);<br>}<br>当连接一个在磁盘上的数据库，如果数据库文件存在，SQLite打开一个文件；如果不存在，SQLite会假定你想创建一个新的数据库。在这种情况下，SQLite不会立即在磁盘上创建一个文件，只有当你向数据库写入数据时才会创建文件，比如：创建表、视图或者其它数据库对象。如果你打开一个数据，不做任何事，然后关闭它，SQLite会创建一个文件，只是一个空文件而已。<br>另外一个不立即创建一个新文件的原因是，一些数据库的参数，比如：编码，页面大小等，只在在数据库创建前设置。默认情况下，页面大小为1024字节，但是你可以选择512-32768字节之间为 2幂数的数字。有些时候，较大的页面能更有效的处理大量的数据。<br>（2） 执行事务(Perform transactions)：<br>all commands are executed within transactions。默认情况下，事务自动提交，也就是每一个SQL语句都在一个独立的事务下运行。当然也可以通过使用BEGIN..COMMIT手动提交事务。<br>（3） 断开连接(Disconnect from the database)：<br>主要是关闭数据库的文件。</p>
<p><strong> 1.5.2、执行Prepared Query</strong><br>前面提到，预处理查询(Prepared Query)是SQLite执行所有SQL命令的方式，包括以下三个过程：<br>(1) Prepared Query：<br>分析器（parser），分词器(tokenizer)和代码生成器(code generator)把SQL Statement编译成VDBE字节码，编译器会创建一个statement句柄(sqlite3_stmt)，它包括字节码以及其它执行命令和遍历结果集的所有资源。<br> 相应的C API为sqlite3_prepare()，位于prepare.c文件中，如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">sqlite3_prepare</span><span class="params">(</span></span></div><div class="line">  sqlite3 *db,              <span class="comment">/* Database handle. */</span></div><div class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *zSql,         <span class="comment">/* UTF-8 encoded SQL statement. */</span></div><div class="line">  <span class="keyword">int</span> nBytes,               <span class="comment">/* Length of zSql in bytes. */</span></div><div class="line">  sqlite3_stmt **ppStmt,    <span class="comment">/* OUT: A pointer to the prepared statement */</span></div><div class="line">  <span class="keyword">const</span> <span class="keyword">char</span> **pzTail       <span class="comment">/* OUT: End of parsed string */</span></div><div class="line">)&#123;</div><div class="line">  <span class="keyword">int</span> rc;</div><div class="line">  rc = sqlite3LockAndPrepare(db,zSql,nBytes,<span class="number">0</span>,ppStmt,pzTail);</div><div class="line">  assert( rc==SQLITE_OK || ppStmt==<span class="number">0</span> || *ppStmt==<span class="number">0</span> );  <span class="comment">/* VERIFY: F13021 */</span></div><div class="line">  <span class="keyword">return</span> rc;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>(2) Execution：<br>虚拟机执行字节码，执行过程是一个步进(stepwise)的过程，每一步(step)由sqlite3_step()启动，并由VDBE执行一段字节码。由sqlite3_prepare编译字节代码，并由sqlite3_step()启动虚拟机执行。在遍历结果集的过程中，它返回SQLITE_ROW，当到达结果末尾时，返回SQLITE_DONE。<br>(3) Finalization：<br>VDBE关闭statement，释放资源。相应的C API为sqlite3_finalize()。</p>
<p>通过下图可以更容易理解该过程：<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite02-2.JPG" alt=""></p>
<p>最后以一个具体的例子结束本节，下节讨论事务。<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">#include &lt;stdio.h&gt;</div><div class="line">#include &lt;stdlib.h&gt;</div><div class="line">#include "sqlite3.h"</div><div class="line"></div><div class="line">#include &lt;string.h&gt;</div><div class="line"></div><div class="line">int main(int argc, char **argv)</div><div class="line">&#123;</div><div class="line">    int rc, i, ncols;</div><div class="line">    sqlite3 *db;</div><div class="line">    sqlite3_stmt *stmt;</div><div class="line">    char *sql;</div><div class="line">    const char *tail;</div><div class="line">    //打开数据</div><div class="line">    rc = sqlite3_open("foods.db", &amp;db);</div><div class="line"></div><div class="line">    if(rc) &#123;</div><div class="line">        fprintf(stderr, "Can't open database: %s\n", sqlite3_errmsg(db));</div><div class="line">        sqlite3_close(db);</div><div class="line">        exit(1);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    sql = "select * from episodes";</div><div class="line">    //预处理</div><div class="line">    rc = sqlite3_prepare(db, sql, (int)strlen(sql), &amp;stmt, &amp;tail);</div><div class="line"></div><div class="line">    if(rc != SQLITE_OK) &#123;</div><div class="line">        fprintf(stderr, "SQL error: %s\n", sqlite3_errmsg(db));</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    rc = sqlite3_step(stmt);</div><div class="line">    ncols = sqlite3_column_count(stmt); </div><div class="line"></div><div class="line">    while(rc == SQLITE_ROW) &#123;</div><div class="line">        </div><div class="line">        for(i=0; i &lt; ncols; i++) &#123;</div><div class="line">            fprintf(stderr, "'%s' ", sqlite3_column_text(stmt, i));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        fprintf(stderr, "\n");</div><div class="line"></div><div class="line">        rc = sqlite3_step(stmt);</div><div class="line">    &#125;</div><div class="line">    //释放statement</div><div class="line">    sqlite3_finalize(stmt);</div><div class="line">    //关闭数据库</div><div class="line">    sqlite3_close(db);</div><div class="line"></div><div class="line">    return 0;    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来讨论事务,事务是DBMS最核心的技术之一.在计算机科学史上,有三位科学家因在数据库领域的成就而获ACM图灵奖,而其中之一Jim Gray(曾任职微软)就是因为在事务处理方面的成就而获得这一殊荣,正是因为他,才使得OLTP系统在随后直到今天大行其道.关于事务处理技术,涉及到很多,随便就能写一本书.这里我只讨论SQLite事务实现的一些原理,SQLite的事务实现与大型通用的DBMS相比,其实现比较简单.这些内容可能比较偏于理论,但却不难,也是理解其它内容的基础.</p>
<h2 id="2、事务-Transaction"><a href="#2、事务-Transaction" class="headerlink" title="2、事务(Transaction)"></a>2、事务(Transaction)</h2><h3 id="2-1、事务的周期-Transaction-Lifecycles"><a href="#2-1、事务的周期-Transaction-Lifecycles" class="headerlink" title="2.1、事务的周期(Transaction Lifecycles)"></a>2.1、事务的周期(Transaction Lifecycles)</h3><p>程序与事务之间有两件事值得注意：<br>（1）哪些对象在事务下运行——这直接与API有关。<br>（2）事务的生命周期，即什么时候开始，什么时候结束以及它在什么时候开始影响别的连接（这点对于并发性很重要）——这涉及到SQLite的具体实现。<br>一个连接（connection）可以包含多个(statement)，而且每个连接有一个与数据库关联的B-tree和一个pager。Pager在连接中起着很重要的作用，因为它管理事务、锁、内存缓存以及负责崩溃恢复(crash recovery)。当你进行数据库写操作时，记住最重要的一件事：在任何时候，只在一个事务下执行一个连接。这些回答了第一个问题。<br>一般来说，一个事务的生命和statement差不多，你也可以手动结束它。默认情况下，事务自动提交，当然你也可以通过BEGIN..COMMIT手动提交。接下来就是锁的问题。</p>
<h3 id="2-2、锁的状态-Lock-States"><a href="#2-2、锁的状态-Lock-States" class="headerlink" title="2.2、锁的状态(Lock States)"></a>2.2、锁的状态(Lock States)</h3><p>锁对于实现并发访问很重要，而对于大型通用的DBMS，锁的实现也十分复杂，而SQLite相对较简单。通常情况下，它的持续时间和事务一致。一个事务开始，它会先加锁，事务结束，释放锁。但是系统在事务没有结束的情况下崩溃，那么下一个访问数据库的连接会处理这种情况。<br>在SQLite中有5种不同状态的锁，连接（connection）任何时候都处于其中的一个状态。下图显示了相应的状态以及锁的生命周期。</p>
<p> 关于这个图有以下几点值得注意：<br>（1）一个事务可以在UNLOCKED，RESERVED或EXCLUSIVE三种状态下开始。默认情况下在UNLOCKED时开始。<br>（2）白色框中的UNLOCKED, PENDING, SHARED和 RESERVED可以在一个数据库的同一时存在。<br>（3）从灰色的PENDING开始，事情就变得严格起来，意味着事务想得到排斥锁(EXCLUSIVE)（注意与白色框中的区别）。<br>虽然锁有这么多状态，但是从体质上来说，只有两种情况：读事务和写事务。</p>
<h3 id="2-3、读事务-Read-Transactions"><a href="#2-3、读事务-Read-Transactions" class="headerlink" title="2.3、读事务(Read Transactions)"></a>2.3、读事务(Read Transactions)</h3><p>我们先来看看SELECT语句执行时锁的状态变化过程，非常简单：一个连接执行select语句，触发一个事务，从UNLOCKED到SHARED，当事务COMMIT时，又回到UNLOCKED，就这么简单。<br>考虑下面的例子(为了简单，这里用了伪码)：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">db = open('foods.db')</div><div class="line">db.exec('BEGIN')</div><div class="line">db.exec('SELECT * FROM episodes')</div><div class="line">db.exec('SELECT * FROM episodes')</div><div class="line">db.exec('COMMIT')</div><div class="line">db.close()</div></pre></td></tr></table></figure></p>
<p>由于显式的使用了BEGIN和COMMIT，两个SELECT命令在一个事务下执行。第一个exec()执行时，connection处于SHARED，然后第二个exec()执行，当事务提交时，connection又从SHARED回到UNLOCKED状态，如下：<br>UNLOCKED→PENDING→SHARED→UNLOCKED<br>如果没有BEGIN和COMMIT两行时如下：<br>UNLOCKED→PENDING→SHARED→UNLOCKED→PENDING→ SHARED→UNLOCKED</p>
<h3 id="2-4、写事务（Write-Transactions）"><a href="#2-4、写事务（Write-Transactions）" class="headerlink" title="2.4、写事务（Write Transactions）"></a>2.4、写事务（Write Transactions）</h3><p>下面我们来考虑写数据库，比如UPDATE。和读事务一样，它也会经历UNLOCKED→PENDING→SHARED，但接下来却是灰色的PENDING，</p>
<p><strong> 2.4.1、The Reserved States</strong><br>当一个连接（connection）向数据库写数据时，从SHARED状态变为RESERVED状态，如果它得到RESERVED锁，也就意味着它已经准备好进行写操作了。即使它没有把修改写入数据库，也可以把修改保存到位于pager中缓存中（page cache）。<br>当一个连接进入RESERVED状态，pager就开始初始化恢复日志（rollback journal）。在RESERVED状态下，pager管理着三种页面：<br>(1)    Modified pages：包含被B-树修改的记录，位于page cache中。<br>(2)    Unmodified pages：包含没有被B-tree修改的记录。<br>(3)    Journal pages：这是修改页面以前的版本，这些并不存储在page cache中，而是在B-tree修改页面之前写入日志。<br>Page cache非常重要，正是因为它的存在，一个处于RESERVED状态的连接可以真正的开始工作，而不会干扰其它的（读）连接。所以，SQLite可以高效的处理在同一时刻的多个读连接和一个写连接。</p>
<p><strong> 2.4.2 、The Pending States</strong><br>当一个连接完成修改，就真正开始提交事务，执行该过程的pager进入EXCLUSIVE状态。从RESERVED状态，pager试着获取PENDING锁，一旦得到，就独占它，不允许任何其它连接获得PENDING锁（PENDING is a gateway lock）。既然写操作持有PENDING锁，其它任何连接都不能从UNLOCKED状态进入SHARED状态，即没有任何连接可以进入数据（no new readers, no new writers）。只有那些已经处于SHARED状态的连接可以继续工作。而处于PENDING状态的Writer会一直等到所有这些连接释放它们的锁，然后对数据库加EXCUSIVE锁，进入EXCLUSIVE状态，独占数据库(讨论到这里，对SQLite的加锁机制应该比较清晰了)。</p>
<p><strong> 2.4.3、The Exclusive State</strong><br>在EXCLUSIVE状态下，主要的工作是把修改的页面从page cache写入数据库文件，这是真正进行写操作的地方。<br>在pager写入modified pages之前，它还得先做一件事：写日志。它检查是否所有的日志都写入了磁盘，而这些通常位于操作的缓冲区中，所以pager得告诉OS把所有的文件写入磁盘，这是由程序synchronous(通过调用OS的相应的API实现)完成的。<br>日志是数据库进行恢复的惟一方法，所以日志对于DBMS非常重要。如果日志页面没有完全写入磁盘而发生崩溃，数据库就不能恢复到它原来的状态，此时数据库就处于不一致状态。日志写入完成后，pager就把所有的modified pages写入数据库文件。接下来就取决于事务提交的模式，如果是自动提交，那么pager清理日志，page cache，然后由EXCLUSIVE进入UNLOCKED。如果是手动提交，那么pager继续持有EXCLUSIVE锁和保存日志，直到COMMIT或者ROLLBACK。</p>
<p>总之，从性能方面来说，进程占有排斥锁的时间应该尽可能的短，所以DBMS通常都是在真正写文件时才会占有排斥锁，这样能大大提高并发性能。</p>
<h1 id="内核解析"><a href="#内核解析" class="headerlink" title="内核解析"></a>内核解析</h1><p>为了能更好的理解SQLite，我先从总的结构上讨论一下内核，从全局把握SQLite很重要。SQLite的内核实现不是很难，但是也不是很简单。总的来说分为三个部分，本章主要讨论虚拟机(Virtual Machine)，但是这里只是从原理上概述，不会太多的涉及实际代码。但是概述完内核之后会仔细讨论源代码的。好了，下面我们来讨论虚拟机(VM)。</p>
<h2 id="1、虚拟机（Virtual-Machine）"><a href="#1、虚拟机（Virtual-Machine）" class="headerlink" title="1、虚拟机（Virtual Machine）"></a>1、虚拟机（Virtual Machine）</h2><p>VDBE是SQLite的核心，它的上层模块和下层模块都是本质上都是为它服务的。它的实现位于vbde.c, vdbe.h, vdbeapi.c, vdbeInt.h, 和vdbemem.c几个文件中。它通过底层的基础设施B+Tree执行由编译器（Compiler）生成的字节代码，这种字节代码程序语言(bytecode programming lauguage)是为了进行查询，读取和修改数据库而专门设计的。<br>字节代码在内存中被封装成sqlite3_stmt对象(内部叫做Vdbe，见vdbeInt.h)，Vdbe（或者说statement）包含执行程序所需要的一切：</p>
<ul>
<li>a)a bytecode program</li>
<li>b)names and data types for all result columns</li>
<li>c)values bound to input parameters</li>
<li>d)a program counter</li>
<li>e)an execution stack of operands</li>
<li>f)an arbitrary amount of “numbered” memory cells</li>
<li>g)other run-time state information (such as open BTree objects, sorters, lists, sets)</li>
</ul>
<p>字节代码和汇编程序十分类似，每一条指令由操作码和三个操作数构成：<opcode, p1,="" p2,="" p3="">。Opcode为一定功能的操作码，为了理解，可以看成一个函数。P1是32位的有符号整数，p2是31位的无符号整数，它通常是导致跳转(jump)的指令的目标地址（destination），当然这了有其它用途；p3为一个以null结尾的字符串或者其它结构体的指针。和C API不同的是，VDBE操作码经常变化，所以不应该用字节码写程序。<br>下面的几个C API直接和VDBE交互：</opcode,></p>
<ul>
<li>sqlite3_bind_xxx() functions</li>
<li>sqlite3_step()</li>
<li>sqlite3_reset()</li>
<li>sqlite3_column_xxx() functions</li>
<li>sqlite3_finalize()</li>
</ul>
<p>为了有个感性，下面看一个具体的字节码程序：<br>sqlite&gt; .m col<br>sqlite&gt; .h on<br>sqlite&gt; .w 4 15 3 3 15<br>sqlite&gt; explain select * from episodes;<br>addr  opcode              p1   p2   p3</p>
<hr>
<p>0     Goto                0    12<br>1     Integer             0    0<br>2     OpenRead            0    2    # episodes<br>3     SetNumColumns       0    3<br>4     Rewind              0    10<br>5     Recno               0    0<br>6     Column              0    1<br>7     Column              0    2<br>8     Callback            3    0<br>9     Next                0    5<br>10    Close               0    0<br>11    Halt                0    0<br>12    Transaction         0    0<br>13    VerifyCookie        0    10<br>14    Goto                0    1<br>15    Noop                0    0</p>
<h3 id="1-1、栈-Stack"><a href="#1-1、栈-Stack" class="headerlink" title="1.1、栈(Stack)"></a>1.1、栈(Stack)</h3><p>一个VDBE程序通常由不同完成特定任务的段（section）构成，每一个段中，都有一些操作栈的指令。这是由于不同的指令有不同个数的参数，一些指令只有一个参数；一些指令没有参数；一些指令有好几个参数，这种情况下，三个操作数就不能满足。<br>考虑到这些情况，指令采用栈来传递参数。(注：从汇编的角度来看，传递参数的方式有好几种，比如：寄存器，全局变量，而堆栈是现代语言常用的方式，它具有很大的灵活性)。而这些指令不会自己做这些事情，所以在它们之前，需要其它一些指令的帮助。VDBE把计算的中间结果保存到内存单元(memory cells)中，其实，堆栈和内存单元都是基于Mem（见vdbeInt.h）数据结构(注：这里的栈，内存单元都是虚拟的，记得一位计算机科学家说过：计算机科学中90%以上的科学都是虚拟化问题。一点不假，OS本质上也是虚拟机，而在这里SQLite，我们也处处可见虚拟化的身影，到后面的OS Interface模块中再仔细讨论这个问题)。</p>
<h3 id="1-2、程序体-Program-Body"><a href="#1-2、程序体-Program-Body" class="headerlink" title="1.2、程序体(Program Body)"></a>1.2、程序体(Program Body)</h3><p>这是一个打开episodes表的过程。<br>第一条指令：Integer是为第二条指令作准备的，也就是把第二条指令执行需要的参数压入堆栈，OpenRead从堆栈中取出参数值然后执行。SQLite可以通过ATTACH命令在一个连接中打开多个数据库文件，每当SQLite打开一个数据，它就为之赋一个索引号(index)，main database的索引为0，第一个数据库为1，依次如此。Integer指令数据库索引的值压入栈，而OpenRead从中取出值，并决定打开哪个数据，来看看SQLite文档中的解释：</p>
<blockquote>
<p>Open a read-only cursor for the database table whose root page is P2 in a database file.<br>The database file is determined by an integer from the top of the stack. 0 means the main database and 1 means the database used for temporary tables. Give the new cursor an identifier of P1. The P1 values need not be contiguous but all P1 values should be small integers. It is an error for P1 to be negative.<br>If P2==0 then take the root page number from off of the stack.<br>There will be a read lock on the database whenever there is an open cursor. If the data-<br>base was unlocked prior to this instruction then a read lock is acquired as part of this instruction. A read lock allows other processes to read the database but prohibits any other process from modifying the database. The read lock is released when all cursors are closed. If this instruction attempts to get a read lock but fails, the script terminates with an SQLITE_BUSY error code.<br>The P3 value is a pointer to a KeyInfo structure that defines the content and collating</p>
</blockquote>
<p>sequence of indices. P3 is NULL for cursors that are not pointing to indices.</p>
<p>再来看看SetNumColumns指令设置游标将指向的列。P1为游标的索引（这里为0，刚刚打开），P2为列的数目，episodes表有三列。<br>继续Rewind指令，它将游标重新设置到表的开始，它会检查表是否为空（即没有记录），如果没有记录，它会导致指令指针跳到P2指定的指令处。在这里，P2为10，即Close指令。一旦Rewind设置游标，接下就执行5-9这几条指令，它们的主要功能是遍历结果集，Recno把由游标P1指定的记录的关键字压入堆栈。Column指令从由P1指定的游标，P2指定的列取值。5,6,7三条指令分别把id(primary key),season和name字段的值压入栈。接下来，Callback指令从栈中取出三个值（P1），然后形成一个记录数组，存储在内存单元中(memory cell)。Callback会停止VDBE的操作，把控制权交给sqlite3_stemp()，该函数返回SQLITE_ROW。<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite03-1.JPG" alt=""></p>
<p>一旦VDBE创建了记录结构，我们就可以通过sqlite3_column_xxx() functions从记录结构的域内取出值。当下次调用sqlite3_step()时，指令指针会指向Next指令，而Next指令会把游标向移向下一行，如果有其它的记录，它会跳到由P2指定的指令，在这里为指令5，创建一个新的记录结构，一直循环，直到结果集的最后。Close指令会关闭游标，然后执行Halt指令，结束VDBE程序。</p>
<h2 id="1-3、程序开始与停止"><a href="#1-3、程序开始与停止" class="headerlink" title="1.3、程序开始与停止"></a>1.3、程序开始与停止</h2><p>现在来看看其余的指令，Goto指令是一条跳转指令，跳到P2处，即第12条指令。指令12是Transaction，它开始一个新的事务；然后执行VerifyCookie，它的主要功能VDBE程序编译后，数据库模式是否改变（即是否进行过更新操作）。这在SQLite中是一个很重要的概念，在SQL被sqlite3_prepare()编译成VDBE代码至程序调用sqlite3_step()执行字节码的这段时间，另一个SQL命令可能会改变数据库模式（such as ALTER TABLE, DROP TABLE, or CREATE TABLE）。一旦发生这种情况，之前编译的statement就会变得无效，数据库模式信息记录在数据库文件的根页面中。类似，每一个statement都有一份用来比较的在编译时刻该模式的备份，VerifyCookie的功能就是检查它们是否匹配，如果不匹配，将采取相关操作。<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite03-2.JPG" alt=""></p>
<p>如果两者匹配，会执行下一条指令Goto；它会跳到程序的主要部分，即第一条指令，打开表读取记录。这里有两点值得注意：<br>(1)Transaction指令自己不会获取锁（ The Transaction instruction doesn’t acquire any locks in itself）。它的功能相当于BEGIN，而实际是由OpenRead指令获取share lock的。当事务关闭时释放锁，这取决于Halt指令，它会进行扫尾工作。<br>(2)statement对象（VDBE程序）所需的存储空间在程序执行前就已经确定。这有原于两个重要事实：首先，栈的深度不会比指令的数目还多（通常少得多）。其次，在执行VDBE程序之前，SQLite可以计算出为分配资源所需要的内存。</p>
<h2 id="1-4指令的类型-Instruction-Types"><a href="#1-4指令的类型-Instruction-Types" class="headerlink" title="1.4指令的类型(Instruction Types)"></a>1.4指令的类型(Instruction Types)</h2><p>每条指令都完成特定的任务，而且通常和别的指令有关。大体上来说，指令可分为三类：<br>（1)Value manipulation：这些指令通常完成算术运算，比如：add, subtract, divide；逻辑运算，比如：AND和OR；还有字符串操作。<br>（2)Data management：这些指令操作在内存和磁盘上的数据。内存指令进行栈操作或者在内存单元之间传递数据。磁盘操作指令控制B-tree和pager打开或操作游标，开始或结束事务，等等。<br>（3)Control flow：控制指令主要是移动指令指针。</p>
<h2 id="1-5、程序的执行-Program-execution"><a href="#1-5、程序的执行-Program-execution" class="headerlink" title="1.5、程序的执行(Program execution)"></a>1.5、程序的执行(Program execution)</h2><p>最后我们来看VM解释器是如何实现以及字节代码大致是如何执行的。在vdbe.c文件中有一个很关键的函数：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">//执行VDBE程序</div><div class="line">int sqlite3VdbeExec(</div><div class="line">  Vdbe *p                    /* The VDBE */</div><div class="line">)</div><div class="line">该函数是执行VDBE程序的入口。来看看它的内部实现：</div><div class="line"></div><div class="line">/*从这里开始执行指令</div><div class="line">**pc为程序计数器(int)</div><div class="line">*/</div><div class="line">for(pc=p-&gt;pc; rc==SQLITE_OK; pc++)&#123;</div><div class="line">  //取得操作码</div><div class="line">  pOp = &amp;p-&gt;aOp[pc];</div><div class="line">  switch( pOp-&gt;opcode )&#123;</div><div class="line">  case OP_Goto: &#123;             /* jump */</div><div class="line">      CHECK_FOR_INTERRUPT;</div><div class="line">      pc = pOp-&gt;p2 - 1;</div><div class="line">      break;</div><div class="line">     &#125;</div><div class="line">    … …</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从这段代码，我们大致可以推出VM执行的原理：VM解释器实际上是一个包含大量switch语句的for循环，每一个switch语句实现一个特定的操作指令。</p>
<p>SQLite采用了层次化，模块化的设计，而这些使得它的可扩展性和可移植性非常强。而且SQLite的架构与通用DBMS的结构差别不是很大，所以它对于理解通用DBMS具有重要意义。好了，下面我们开始讨论SQLite剩余的两部分：Back-end(后端)和compiler(编译器)。</p>
<h2 id="2、B-tree和Pager"><a href="#2、B-tree和Pager" class="headerlink" title="2、B-tree和Pager"></a>2、B-tree和Pager</h2><p>B-Tree使得VDBE可以在O(logN)下查询，插入和删除数据，以及O(1)下双向遍历结果集。B-Tree不会直接读写磁盘，它仅仅维护着页面(pages)之间的关系。当B-TREE需要页面或者修改页面时，它就会调用Pager。当修改页面时，pager保证原始页面首先写入日志文件，当它完成写操作时，pager根据事务状态决定如何做。B-tree不直接读写文件，而是通过page cache这个缓冲模块读写文件对于性能是有重要意义的（注：这和操作系统读写文件类似，在Linux中,操作系统的上层模块并不直接调用设备驱动读写设备，而是通过一个高速缓冲模块调用设备驱动读写文件,并将结果存到高速缓冲区）。</p>
<h3 id="2-1、数据库文件格式（Database-File-Format）"><a href="#2-1、数据库文件格式（Database-File-Format）" class="headerlink" title="2.1、数据库文件格式（Database File Format）"></a>2.1、数据库文件格式（Database File Format）</h3><p>数据库中所有的页面都按从1开始顺序标记。一个数据库由许多B-tree构成——每一个表和索引都有一个B-tree（注：索引采用B-tree，而表采用B+tree，这主要是表和索引的需求不同以及B-tree和B+tree的结构不同决定的：B+tree的所有叶子节点包含了全部关键字信息，而且可以有两种顺序查找——具体参见《数据结构》，严蔚敏。而B-tree更适合用来作索引）。所有表和索引的根页面都存储在sqlite_master表中。<br>数据库中第一个页面（page 1）有点特殊，page 1的前100个字节包含一个描述数据库文件的特殊的文件头。它包括库的版本，模式的版本，页面大小，编码等所有创建数据库时设置的参数。这个特殊的文件头的内容在btree.c中定义，page 1也是sqlite_master表的根页面。</p>
<h3 id="2-1、页面重用及回收-Page-Reuse-and-Vacuum"><a href="#2-1、页面重用及回收-Page-Reuse-and-Vacuum" class="headerlink" title="2.1、页面重用及回收(Page Reuse and Vacuum )"></a>2.1、页面重用及回收(Page Reuse and Vacuum )</h3><p>SQLite利用一个空闲列表(free list)进行页面回收。当一个页面的所有记录都被删除时，就被插入到该列表。当运行VACUUM命令时，会清除free list，所以数据库会缩小，本质上它是在新的文件重新建立数据库，而所有使用的页在都被拷贝过去，而free list却不会，结果就是一个新的，变小的数据库。当数据库的autovacuum开启时，SQLite不会使用free list，而且在每一次commit时自动压缩数据库。</p>
<h3 id="2-2、B-Tree记录"><a href="#2-2、B-Tree记录" class="headerlink" title="2.2、B-Tree记录"></a>2.2、B-Tree记录</h3><p>B-tree中页面由B-tree记录组成，也叫做payloads。每一个B-tree记录，或者payload有两个域：关键字域(key field)和数据域(data field)。Key field就是ROWID的值，或者数据库中表的关键字的值。从B-tree的角度，data field可以是任何无结构的数据。数据库的记录就保存在这些data fields中。B-tree的任务就是排序和遍历，它最需要就是关键字。Payloads的大小是不定的，这与内部的关键字和数据域有关，当一个payload太大不能存在一个页面内进便保存到多个页面。</p>
<p>B+Tree按关键字排序，所有的关键字必须唯一。表采用B+tree，内部页面不包含数据，如下：<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite03-3.JPG" alt=""><br>B+tree中根页面(root page)和内部页面(internal pages)都是用来导航的，这些页面的数据域都是指向下级页面的指针，仅仅包含关键字。所有的数据库记录都存储在叶子页面(leaf pages)内。在叶节点一级，记录和页面都是按照关键字的顺序的，所以B-tree可以水平方向遍历，时间复杂度为O(1)。</p>
<h3 id="2-3、记录和域（Records-and-Fields）"><a href="#2-3、记录和域（Records-and-Fields）" class="headerlink" title="2.3、记录和域（Records and Fields）"></a>2.3、记录和域（Records and Fields）</h3><p>位于叶节点页面的数据域的记录由VDBE管理，数据库记录以二进制的形式存储，但有一定的数据格式。记录格式包括一个逻辑头（logical header）和一个数据区(data segment)，header segment包括header的大小和一个数据类型数组，数据类型用来在data segment的数据的类型，如下：<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite03-4.JPG" alt=""></p>
<h3 id="2-4、层次数据组织-Hierarchical-Data-Organization"><a href="#2-4、层次数据组织-Hierarchical-Data-Organization" class="headerlink" title="2.4、层次数据组织(Hierarchical Data Organization)"></a>2.4、层次数据组织(Hierarchical Data Organization)</h3><p><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite03-5.JPG" alt=""><br>从上往下，数据越来越无序，从下向上，数据越来越结构化.</p>
<h3 id="2-5、B-Tree-API"><a href="#2-5、B-Tree-API" class="headerlink" title="2.5、B-Tree API"></a>2.5、B-Tree API</h3><p>B-Tree模块有它自己的API，它可以独立于C API使用。另一个特点就是它支持事务。由pager处理的事务，锁和日志都是为B-tree服务的。根据功能可以分为以下几类：</p>
<p>2.5.1、访问和事务函数</p>
<ul>
<li>sqlite3BtreeOpen: Opens a new database file. Returns a B-tree object.</li>
<li>sqlite3BtreeClose: Closes a database.</li>
<li>sqlite3BtreeBeginTrans: Starts a new transaction.</li>
<li>sqlite3BtreeCommit: Commits the current transaction.</li>
<li>sqlite3BtreeRollback: Rolls back the current transaction.</li>
<li>sqlite3BtreeBeginStmt: Starts a statement transaction.</li>
<li>sqlite3BtreeCommitStmt: Commits a statement transaction.</li>
<li>sqlite3BtreeRollbackStmt: Rolls back a statement transaction.</li>
</ul>
<p>2.5.2、表函数<br>sqlite3BtreeCreateTable: Creates a new, empty B-tree in a database file.<br>sqlite3BtreeDropTable: Destroys a B-tree in a database file.<br>sqlite3BtreeClearTable: Removes all data from a B-tree, but keeps the B-tree intact.</p>
<p>2.5.3、游标函数(Cursor Functions)</p>
<ul>
<li>sqlite3BtreeCursor: Creates a new cursor pointing to a particular B-tree.</li>
<li>sqlite3BtreeCloseCursor: Closes the B-tree cursor.</li>
<li>sqlite3BtreeFirst: Moves the cursor to the first element in a B-tree.</li>
<li>sqlite3BtreeLast: Moves the cursor to the last element in a B-tree.</li>
<li>sqlite3BtreeNext: Moves the cursor to the next element after the one it is currently pointing to.</li>
<li>sqlite3BtreePrevious: Moves the cursor to the previous element before the one it is currently pointing to.</li>
</ul>
<p>sqlite3BtreeMoveto: Moves the cursor to an element that matches the key value passed in as a parameter.</p>
<p>2.5.4、记录函数(Record Functions)</p>
<ul>
<li>sqlite3BtreeDelete: Deletes the record that the cursor is pointing to.</li>
<li>sqlite3BtreeInsert: Inserts a new element in the appropriate place of the B-tree.</li>
<li>sqlite3BtreeKeySize: Returns the number of bytes in the key of the record that the cursor is pointing to.</li>
<li>sqlite3BtreeKey: Returns the key of the record the cursor is currently pointing to.</li>
<li>sqlite3BtreeDataSize: Returns the number of bytes in the data record that the cursor is currently pointing to.</li>
<li>sqlite3BtreeData: Returns the data in the record the cursor is currently pointing to.</li>
</ul>
<p>2.5.5、配置函数(Configuration Functions)<br>sqlite3BtreeSetCacheSize: Controls the page cache size as well as the synchronous writes (as defined in the synchronous pragma).sqlite3BtreeSetSafetyLevel: Changes the way data is synced to disk in order to increase or decrease how well the database resists damage due to OS crashes and power failures.Level 1 is the same as asynchronous (no syncs() occur and there is a high probability of<br>damage). This is the equivalent to pragma synchronous=OFF. Level 2 is the default. There is a very low but non-zero probability of damage. This is the equivalent to pragma           synchronous=NORMAL. Level 3 reduces the probability of damage to near zero but with a write performance reduction. This is the equivalent to pragma synchronous=FULL.</p>
<ul>
<li>sqlite3BtreeSetPageSize: Sets the database page size.</li>
<li>sqlite3BtreeGetPageSize: Returns the database page size.</li>
<li>sqlite3BtreeSetAutoVacuum: Sets the autovacuum property of the database.</li>
<li>sqlite3BtreeGetAutoVacuum: Returns whether the database uses autovacuum.</li>
<li>sqlite3BtreeSetBusyHandler: Sets the busy handler</li>
</ul>
<h3 id="2-6、实例分析"><a href="#2-6、实例分析" class="headerlink" title="2.6、实例分析"></a>2.6、实例分析</h3><p>最后以sqlite3_open的具体实现结束本节的讨论(参见Version 3.6.10的源码)：<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite03-6.JPG" alt=""><br>由上图可以知道，SQLite的所有IO操作，最终都转化为操作系统的系统调用(一名话：DBMS建立在痛苦的OS之上)。同时也可以看到SQLite的实现非常的层次化，模块化，使得SQLite更易扩展，可移植性非常强。</p>
<h2 id="3、编译器（Compiler）"><a href="#3、编译器（Compiler）" class="headerlink" title="3、编译器（Compiler）"></a>3、编译器（Compiler）</h2><h3 id="3-1、分词器-Tokenizer"><a href="#3-1、分词器-Tokenizer" class="headerlink" title="3.1、分词器(Tokenizer)"></a>3.1、分词器(Tokenizer)</h3><p>接口把要执行的SQL语句传递给Tokenizer,Tokenizer按照SQL的词法定义把它切分一个一个的词，并传递给分析器(Parser)进行语法分析。分词器是手工写的，主要在Tokenizer.c中实现。</p>
<h3 id="3-2、分析器-Parser"><a href="#3-2、分析器-Parser" class="headerlink" title="3.2、分析器(Parser)"></a>3.2、分析器(Parser)</h3><p>SQLite的语法分析器是用Lemon——一个开源的LALR(1)语法分析器的生成器，生成的文件为parser.c。<br>一个简单的语法树：<br> SELECT rowid, name, season FROM episodes WHERE rowid=1 LIMIT 1<br> <img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite03-7.JPG" alt=""></p>
<h3 id="3-3、代码生成器（Code-Generator）"><a href="#3-3、代码生成器（Code-Generator）" class="headerlink" title="3.3、代码生成器（Code Generator）"></a>3.3、代码生成器（Code Generator）</h3><p>代码生成器是SQLite中取庞大，最复杂的部分。它与Parser关系紧密，根据语法分析树生成VDBE程序执行SQL语句的功能。由诸多文件构成：select.c,update.c,insert.c,delete.c,trigger.c,where.c等文件。这些文件生成相应的VDBE程序指令，比如SELECT语句就由select.c生成。下面是一个读操作中打开表的代码的生成实现：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* Generate code that will open a table for reading.</span></div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">sqlite3OpenTableForReading</span><span class="params">(</span></span></div><div class="line">  Vdbe *v,        <span class="comment">/* Generate code into this VDBE */</span></div><div class="line">  <span class="keyword">int</span> iCur,       <span class="comment">/* The cursor number of the table */</span></div><div class="line">  Table *pTab     <span class="comment">/* The table to be opened */</span></div><div class="line">)&#123;</div><div class="line">  sqlite3VdbeAddOp(v, OP_Integer, pTab-&gt;iDb, <span class="number">0</span>);</div><div class="line">  sqlite3VdbeAddOp(v, OP_OpenRead, iCur, pTab-&gt;tnum);</div><div class="line">  VdbeComment((v, <span class="string">"# %s"</span>, pTab-&gt;zName));</div><div class="line">  sqlite3VdbeAddOp(v, OP_SetNumColumns, iCur, pTab-&gt;nCol);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Sqlite3vdbeAddOp函数有三个参数：</p>
<ul>
<li>（1）VDBE实例（它将添加指令）</li>
<li>（2）操作码（一条指令）</li>
<li>（3）两个操作数</li>
</ul>
<h3 id="3-4、查询优化"><a href="#3-4、查询优化" class="headerlink" title="3.4、查询优化"></a>3.4、查询优化</h3><p>代码生成器不仅负责生成代码，也负责进行查询优化。主要的实现位于where.c中，生成的WHERE语句块通常被其它模块共享，比如select.c，update.c以及delete.c。这些模块调用sqlite3WhereBegin()开始WHERE语句块的指令生成，然后加入它们自己的VDBE代码返回，最后调用sqlite3WhereEnd()结束指令生成，如下：<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite03-8.JPG" alt=""></p>
<h1 id="Page-Cache之事务处理"><a href="#Page-Cache之事务处理" class="headerlink" title="Page Cache之事务处理"></a>Page Cache之事务处理</h1><p>接下来将对SQLite的每个模块进行讨论。讨论的顺序按照我阅读SQLite的顺序来进行，由于项目的需要，以及时间关系，不能给出一个完整的计划，但是我会先讨论我认为比较重要的内容。本节讨论SQLite的事务处理技术，事务处理是DBMS中最关键的技术，对SQLite也一样，它涉及到并发控制，以及故障恢复，由于内容较多，分为两节。好了，下面进入正题。</p>
<p> 本节通过一个具体的例子来分析SQLite原子提交的实现（基于Version 3.3.6的代码）。<br>CREATE TABLE episodes( id integer primary key,name text, cid int) ；<br>插入一条记录：insert into episodes(name,cid) values(“cat”,1) ;<br>它经过编译器处理后生成的虚拟机代码如下：<br>sqlite&gt; explain insert into episodes(name,cid) values(“cat”,1);<br>0|Trace|0|0|0|explain insert into episodes(name,cid) values(“cat”,1);|00|<br>1|Goto|0|12|0||00|<br>2|SetNumColumns|0|3|0||00|<br>3|OpenWrite|0|2|0||00|<br>4|NewRowid|0|2|0||00|<br>5|Null|0|3|0||00|<br>6|String8|0|4|0|cat|00|<br>7|Integer|1|5|0||00|<br>8|MakeRecord|3|3|6|dad|00|<br>9|Insert|0|6|2|episodes|0b|<br>10|Close|0|0|0||00|<br>11|Halt|0|0|0||00|<br>12|Transaction|0|1|0||00|<br>13|VerifyCookie|0|1|0||00|<br>14|Transaction|1|1|0||00|<br>15|VerifyCookie|1|0|0||00|</p>
<p>16|TableLock|0|2|1|episodes|00|</p>
<p>17|Goto|0|2|0||00|</p>
<p>1、初始状态（Initial State）<br>当一个数据库连接第一次打开时，状态如图所示。图中最右边（“Disk”标注）表示保存在存储设备中的内容。每个方框代表一个扇区。蓝色的块表示这个扇区保存了原始数据。图中中间区域是操作系统的磁盘缓冲区。开始的时候，这些缓存是还没有被使用，因此这些方框是空白的。图中左边区域显示SQLite用户进程的内存。因为这个数据库连接刚刚打开，所以还没有任何数据记录被读入，所以这些内存也是空的。<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-0.gif" alt=""><br>2、获取读锁(Acquiring A Read Lock)<br>在SQLite写数据库之前，它必须先从数据库中读取相关信息。比如，在插入新的数据时，SQLite会先从sqlite_master表中读取数据库模式(相当于数据字典)，以便编译器对INSERT语句进行分析，确定数据插入的位置。<br>在进行读操作之前，必须先获取数据库的共享锁(shared lock)，共享锁允许两个或更多的连接在同一时刻读取数据库。但是共享锁不允许其它连接对数据库进行写操作。<br>shared lock存在于操作系统磁盘缓存，而不是磁盘本身。文件锁的本质只是操作系统的内核数据结构，当操作系统崩溃或掉电时，这些内核数据也会随之消失。<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-1.gif" alt=""><br>3、读取数据<br>一旦得到shared lock，就可以进行读操作。如图所示，数据先由OS从磁盘读取到OS缓存，然后再由OS移到用户进程空间。一般来说，数据库文件分为很多页，而一次读操作只读取一小部分页面。如图，从8个页面读取3个页面。<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-2.gif" alt=""><br>4、获取Reserved Lock<br>在对数据进行修改操作之前，先要获取数据库文件的Reserved Lock，Reserved Lock和shared lock的相似之处在于，它们都允许其它进程对数据库文件进行读操作。Reserved Lock和Shared Lock可以共存，但是只能是一个Reserved Lock和多个Shared Lock——多个Reserved Lock不能共存。所以，在同一时刻，只能进行一个写操作。<br>Reserved Lock意味着当前进程(连接)想修改数据库文件，但是还没开始修改操作，所以其它的进程可以读数据库，但不能写数据库。<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-3.gif" alt=""><br>5、创建恢复日志(Creating A Rollback Journal File)<br>在对数据库进行写操作之前，SQLite先要创建一个单独的日志文件，然后把要修改的页面的原始数据写入日志。回滚日志包含一个日志头(图中的绿色)——记录数据库文件的原始大小。所以即使数据库文件大小改变了，我们仍知道数据库的原始大小。<br>从OS的角度来看，当一个文件创建时，大多数OS(Windows,Linux,Mac OS X)不会向磁盘写入数据，新创建的文件此时位于磁盘缓存中，之后才会真正写入磁盘。如图，日志文件位于OS磁盘缓存中，而不是位于磁盘。<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-4.gif" alt=""><br>上面 5步的代码的实现：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//事务指令的实现</span></div><div class="line"><span class="comment">//p1为数据库文件的索引号---0为main database;1为temporary tables使用的文件</span></div><div class="line"><span class="comment">//p2 不为0，一个写事务开始</span></div><div class="line"><span class="keyword">case</span> OP_Transaction: &#123;</div><div class="line">    <span class="comment">//数据库的索引号</span></div><div class="line">    <span class="keyword">int</span> i = pOp-&gt;p1;</div><div class="line">    <span class="comment">//指向数据库对应的btree</span></div><div class="line">  Btree *pBt;</div><div class="line"></div><div class="line">  <span class="keyword">assert</span>( i&gt;=<span class="number">0</span> &amp;&amp; i&lt;db-&gt;nDb );</div><div class="line">  <span class="keyword">assert</span>( (p-&gt;btreeMask &amp; (<span class="number">1</span>&lt;&lt;i))!=<span class="number">0</span> );</div><div class="line">  <span class="comment">//设置btree指针</span></div><div class="line">  pBt = db-&gt;aDb[i].pBt;</div><div class="line"></div><div class="line">  <span class="keyword">if</span>( pBt )&#123;</div><div class="line">      <span class="comment">//从这里btree开始事务,主要给文件加锁,并设置btree事务状态</span></div><div class="line">    rc = sqlite3BtreeBeginTrans(pBt, pOp-&gt;p2);</div><div class="line">    </div><div class="line">    <span class="keyword">if</span>( rc==SQLITE_BUSY )&#123;</div><div class="line">      p-&gt;pc = pc;</div><div class="line">      p-&gt;rc = rc = SQLITE_BUSY;</div><div class="line">      goto vdbe_return;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>( rc!=SQLITE_OK &amp;&amp; rc!=SQLITE_READONLY <span class="comment">/* &amp;&amp; rc!=SQLITE_BUSY */</span> )&#123;</div><div class="line">      goto abort_due_to_error;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">break</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//开始一个事务,如果第二个参数不为0,则一个写事务开始,否则是一个读事务</span></div><div class="line"><span class="comment">//如果wrflag&gt;=2,一个exclusive事务开始,此时别的连接不能访问数据库</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">sqlite3BtreeBeginTrans</span><span class="params">(Btree *p, <span class="keyword">int</span> wrflag)</span></span>&#123;</div><div class="line">  BtShared *pBt = p-&gt;pBt;</div><div class="line">  <span class="keyword">int</span> rc = SQLITE_OK;</div><div class="line"></div><div class="line">  btreeIntegrity(p);</div><div class="line"></div><div class="line">  <span class="comment">/* If the btree is already in a write-transaction, or it</span></div><div class="line">  ** is already in a read-transaction and a read-transaction</div><div class="line">  ** is requested, this is a no-op.</div><div class="line">  */</div><div class="line">  <span class="comment">//如果b-tree处于一个写事务;或者处于一个读事务,一个读事务又请求,则返回SQLITE_OK</span></div><div class="line">  <span class="keyword">if</span>( p-&gt;inTrans==TRANS_WRITE || (p-&gt;inTrans==TRANS_READ &amp;&amp; !wrflag) )&#123;</div><div class="line">    <span class="keyword">return</span> SQLITE_OK;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/* Write transactions are not possible on a read-only database */</span></div><div class="line">  <span class="comment">//写事务不能访问只读数据库</span></div><div class="line">  <span class="keyword">if</span>( pBt-&gt;readOnly &amp;&amp; wrflag )&#123;</div><div class="line">    <span class="keyword">return</span> SQLITE_READONLY;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/* If another database handle has already opened a write transaction </span></div><div class="line">  ** on this shared-btree structure and a second write transaction is</div><div class="line">  ** requested, return SQLITE_BUSY.</div><div class="line">  */</div><div class="line">  <span class="comment">//如果数据库已存在一个写事务,则该写事务请求时返回SQLITE_BUSY</span></div><div class="line">  <span class="keyword">if</span>( pBt-&gt;inTransaction==TRANS_WRITE &amp;&amp; wrflag )&#123;</div><div class="line">    <span class="keyword">return</span> SQLITE_BUSY;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">do</span> &#123;</div><div class="line">    <span class="comment">//如果数据库对应btree的第一个页面还没读进内存</span></div><div class="line">      <span class="comment">//则把该页面读进内存，数据库也相应的加read lock</span></div><div class="line">    <span class="keyword">if</span>( pBt-&gt;pPage1==<span class="number">0</span> )&#123;</div><div class="line">      <span class="comment">//加read lock，并读页面到内存</span></div><div class="line">      rc = lockBtree(pBt);</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">    <span class="keyword">if</span>( rc==SQLITE_OK &amp;&amp; wrflag )&#123;</div><div class="line">        <span class="comment">//对数据库文件加RESERVED_LOCK锁</span></div><div class="line">      rc = sqlite3pager_begin(pBt-&gt;pPage1-&gt;aData, wrflag&gt;<span class="number">1</span>);</div><div class="line">      <span class="keyword">if</span>( rc==SQLITE_OK )&#123;</div><div class="line">        rc = newDatabase(pBt);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">    <span class="keyword">if</span>( rc==SQLITE_OK )&#123;</div><div class="line">      <span class="keyword">if</span>( wrflag ) pBt-&gt;inStmt = <span class="number">0</span>;</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">      unlockBtreeIfUnused(pBt);</div><div class="line">    &#125;</div><div class="line">  &#125;<span class="keyword">while</span>( rc==SQLITE_BUSY &amp;&amp; pBt-&gt;inTransaction==TRANS_NONE &amp;&amp;</div><div class="line">          sqlite3InvokeBusyHandler(pBt-&gt;pBusyHandler) );</div><div class="line"></div><div class="line">  <span class="keyword">if</span>( rc==SQLITE_OK )&#123;</div><div class="line">    <span class="keyword">if</span>( p-&gt;inTrans==TRANS_NONE )&#123;</div><div class="line">        <span class="comment">//btree的事务数加1</span></div><div class="line">      pBt-&gt;nTransaction++;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//设置btree事务状态</span></div><div class="line">    p-&gt;inTrans = (wrflag?TRANS_WRITE:TRANS_READ);</div><div class="line">    <span class="keyword">if</span>( p-&gt;inTrans&gt;pBt-&gt;inTransaction )&#123;</div><div class="line">      pBt-&gt;inTransaction = p-&gt;inTrans;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  btreeIntegrity(p);</div><div class="line">  <span class="keyword">return</span> rc;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line">**获取数据库的写锁,发生以下情况时去除写锁:</div><div class="line">**   *  sqlite3pager_commit() is called.</div><div class="line">**   *  sqlite3pager_rollback() is called.</div><div class="line">**   *  sqlite3pager_close() is called.</div><div class="line">**   *  sqlite3pager_unref() is called to on every outstanding page.</div><div class="line">**   pData指向数据库的打开的页面,此时并不修改,仅仅只是获取</div><div class="line">**   相应的pager,检查它是否处于read-lock状态。</div><div class="line">**如果打开的不是临时文件,则打开日志文件.</div><div class="line">**如果数据库已经处于写状态，则do nothing</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">sqlite3pager_begin</span><span class="params">(<span class="keyword">void</span> *pData, <span class="keyword">int</span> exFlag)</span></span>&#123;</div><div class="line">  PgHdr *pPg = DATA_TO_PGHDR(pData);</div><div class="line">  Pager *pPager = pPg-&gt;pPager;</div><div class="line">  <span class="keyword">int</span> rc = SQLITE_OK;</div><div class="line">  <span class="keyword">assert</span>( pPg-&gt;nRef&gt;<span class="number">0</span> );</div><div class="line">  <span class="keyword">assert</span>( pPager-&gt;state!=PAGER_UNLOCK );</div><div class="line">  <span class="comment">//pager已经处于share状态</span></div><div class="line">  <span class="keyword">if</span>( pPager-&gt;state==PAGER_SHARED )&#123;</div><div class="line">    <span class="keyword">assert</span>( pPager-&gt;aInJournal==<span class="number">0</span> );</div><div class="line">    <span class="keyword">if</span>( MEMDB )&#123;</div><div class="line">      pPager-&gt;state = PAGER_EXCLUSIVE;</div><div class="line">      pPager-&gt;origDbSize = pPager-&gt;dbSize;</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        <span class="comment">//对文件加 RESERVED_LOCK</span></div><div class="line">      rc = sqlite3OsLock(pPager-&gt;fd, RESERVED_LOCK);</div><div class="line">      <span class="keyword">if</span>( rc==SQLITE_OK )&#123;</div><div class="line">          <span class="comment">//设置pager的状态</span></div><div class="line">        pPager-&gt;state = PAGER_RESERVED;</div><div class="line">        <span class="keyword">if</span>( exFlag )&#123;</div><div class="line">          rc = pager_wait_on_lock(pPager, EXCLUSIVE_LOCK);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span>( rc!=SQLITE_OK )&#123;</div><div class="line">        <span class="keyword">return</span> rc;</div><div class="line">      &#125;</div><div class="line">      pPager-&gt;dirtyCache = <span class="number">0</span>;</div><div class="line">      TRACE2(<span class="string">"TRANSACTION %d\n"</span>, PAGERID(pPager));</div><div class="line">      <span class="comment">//使用日志,不是临时文件,则打开日志文件</span></div><div class="line">      <span class="keyword">if</span>( pPager-&gt;useJournal &amp;&amp; !pPager-&gt;tempFile )&#123;</div><div class="line">          <span class="comment">//为pager打开日志文件,pager应该处于RESERVED或EXCLUSIVE状态</span></div><div class="line">          <span class="comment">//会向日志文件写入header</span></div><div class="line">        rc = pager_open_journal(pPager);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> rc;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//创建日志文件,pager应该处于RESERVED或EXCLUSIVE状态</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">pager_open_journal</span><span class="params">(Pager *pPager)</span></span>&#123;</div><div class="line">  <span class="keyword">int</span> rc;</div><div class="line">  <span class="keyword">assert</span>( !MEMDB );</div><div class="line">  <span class="keyword">assert</span>( pPager-&gt;state&gt;=PAGER_RESERVED );</div><div class="line">  <span class="keyword">assert</span>( pPager-&gt;journalOpen==<span class="number">0</span> );</div><div class="line">  <span class="keyword">assert</span>( pPager-&gt;useJournal );</div><div class="line">  <span class="keyword">assert</span>( pPager-&gt;aInJournal==<span class="number">0</span> );</div><div class="line">  sqlite3pager_pagecount(pPager);</div><div class="line">  <span class="comment">//日志文件页面位图</span></div><div class="line">  pPager-&gt;aInJournal = sqliteMalloc( pPager-&gt;dbSize/<span class="number">8</span> + <span class="number">1</span> );</div><div class="line">  <span class="keyword">if</span>( pPager-&gt;aInJournal==<span class="number">0</span> )&#123;</div><div class="line">    rc = SQLITE_NOMEM;</div><div class="line">    goto failed_to_open_journal;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//打开日志文件</span></div><div class="line">  rc = sqlite3OsOpenExclusive(pPager-&gt;zJournal, &amp;pPager-&gt;jfd,</div><div class="line">                                 pPager-&gt;tempFile);</div><div class="line">  <span class="comment">//日志文件的位置指针</span></div><div class="line">  pPager-&gt;journalOff = <span class="number">0</span>;</div><div class="line">  pPager-&gt;setMaster = <span class="number">0</span>;</div><div class="line">  pPager-&gt;journalHdr = <span class="number">0</span>;</div><div class="line">  <span class="keyword">if</span>( rc!=SQLITE_OK )&#123;</div><div class="line">    goto failed_to_open_journal;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">/*一般来说，os此时创建的文件位于磁盘缓存，并没有实际</span></div><div class="line">  **存在于磁盘,下面三个操作就是为了把结果写入磁盘,而对于</div><div class="line">  **windows系统来说,并没有提供相应API，所以实际上没有意义.</div><div class="line">  */</div><div class="line">  <span class="comment">//fullSync操作对windows没有意义</span></div><div class="line">  sqlite3OsSetFullSync(pPager-&gt;jfd, pPager-&gt;full_fsync);</div><div class="line">  sqlite3OsSetFullSync(pPager-&gt;fd, pPager-&gt;full_fsync);</div><div class="line">  <span class="comment">/* Attempt to open a file descriptor for the directory that contains a file. </span></div><div class="line">  **This file descriptor can be used to fsync() the directory</div><div class="line">  **in order to make sure the creation of a new file is actually written  to disk.</div><div class="line">  */</div><div class="line">  sqlite3OsOpenDirectory(pPager-&gt;jfd, pPager-&gt;zDirectory);</div><div class="line">  pPager-&gt;journalOpen = <span class="number">1</span>;</div><div class="line">  pPager-&gt;journalStarted = <span class="number">0</span>;</div><div class="line">  pPager-&gt;needSync = <span class="number">0</span>;</div><div class="line">  pPager-&gt;alwaysRollback = <span class="number">0</span>;</div><div class="line">  pPager-&gt;nRec = <span class="number">0</span>;</div><div class="line">  <span class="keyword">if</span>( pPager-&gt;errCode )&#123;</div><div class="line">    rc = pPager-&gt;errCode;</div><div class="line">    goto failed_to_open_journal;</div><div class="line">  &#125;</div><div class="line">  pPager-&gt;origDbSize = pPager-&gt;dbSize;</div><div class="line">  <span class="comment">//写入日志文件的header---24个字节</span></div><div class="line">  rc = writeJournalHdr(pPager);</div><div class="line"></div><div class="line">  <span class="keyword">if</span>( pPager-&gt;stmtAutoopen &amp;&amp; rc==SQLITE_OK )&#123;</div><div class="line">    rc = sqlite3pager_stmt_begin(pPager);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span>( rc!=SQLITE_OK &amp;&amp; rc!=SQLITE_NOMEM )&#123;</div><div class="line">    rc = pager_unwritelock(pPager);</div><div class="line">    <span class="keyword">if</span>( rc==SQLITE_OK )&#123;</div><div class="line">      rc = SQLITE_FULL;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> rc;</div><div class="line"></div><div class="line">failed_to_open_journal:</div><div class="line">  sqliteFree(pPager-&gt;aInJournal);</div><div class="line">  pPager-&gt;aInJournal = <span class="number">0</span>;</div><div class="line">  <span class="keyword">if</span>( rc==SQLITE_NOMEM )&#123;</div><div class="line">    <span class="comment">/* If this was a malloc() failure, then we will not be closing the pager</span></div><div class="line">    ** file. So delete any journal file we may have just created. Otherwise,</div><div class="line">    ** the system will get confused, we have a read-lock on the file and a</div><div class="line">    ** mysterious journal has appeared in the filesystem.</div><div class="line">    */</div><div class="line">    sqlite3OsDelete(pPager-&gt;zJournal);</div><div class="line">  &#125;<span class="keyword">else</span>&#123;</div><div class="line">    sqlite3OsUnlock(pPager-&gt;fd, NO_LOCK);</div><div class="line">    pPager-&gt;state = PAGER_UNLOCK;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> rc;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/*写入日志文件头</span></div><div class="line">**journal header的格式如下:</div><div class="line">** - 8 bytes: 标志日志文件的魔数</div><div class="line">** - 4 bytes: 日志文件中记录数</div><div class="line">** - 4 bytes: Random number used for page hash.</div><div class="line">** - 4 bytes: 原来数据库的大小(kb)</div><div class="line">** - 4 bytes: 扇区大小512byte</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">writeJournalHdr</span><span class="params">(Pager *pPager)</span></span>&#123;</div><div class="line">  <span class="comment">//日志文件头</span></div><div class="line">  <span class="keyword">char</span> zHeader[sizeof(aJournalMagic)+<span class="number">16</span>];</div><div class="line"></div><div class="line">  <span class="keyword">int</span> rc = seekJournalHdr(pPager);</div><div class="line">  <span class="keyword">if</span>( rc ) <span class="keyword">return</span> rc;</div><div class="line"></div><div class="line">  pPager-&gt;journalHdr = pPager-&gt;journalOff;</div><div class="line">  <span class="keyword">if</span>( pPager-&gt;stmtHdrOff==<span class="number">0</span> )&#123;</div><div class="line">    pPager-&gt;stmtHdrOff = pPager-&gt;journalHdr;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//设置文件指针指向header之后</span></div><div class="line">  pPager-&gt;journalOff += JOURNAL_HDR_SZ(pPager);</div><div class="line"></div><div class="line">  <span class="comment">/* FIX ME: </span></div><div class="line">  **</div><div class="line">  ** Possibly for a pager not in no-sync mode, the journal magic should not</div><div class="line">  ** be written until nRec is filled in as part of next syncJournal(). </div><div class="line">  **</div><div class="line">  ** Actually maybe the whole journal header should be delayed until that</div><div class="line">  ** point. Think about this.</div><div class="line">  */</div><div class="line">  memcpy(zHeader, aJournalMagic, sizeof(aJournalMagic));</div><div class="line">  <span class="comment">/* The nRec Field. 0xFFFFFFFF for no-sync journals. */</span></div><div class="line">  put32bits(&amp;zHeader[sizeof(aJournalMagic)], pPager-&gt;noSync ? <span class="number">0xffffffff</span> : <span class="number">0</span>);</div><div class="line">  <span class="comment">/* The random check-hash initialiser */</span> </div><div class="line">  sqlite3Randomness(sizeof(pPager-&gt;cksumInit), &amp;pPager-&gt;cksumInit);</div><div class="line">  put32bits(&amp;zHeader[sizeof(aJournalMagic)+<span class="number">4</span>], pPager-&gt;cksumInit);</div><div class="line">  <span class="comment">/* The initial database size */</span></div><div class="line">  put32bits(&amp;zHeader[sizeof(aJournalMagic)+<span class="number">8</span>], pPager-&gt;dbSize);</div><div class="line">  <span class="comment">/* The assumed sector size for this process */</span></div><div class="line">  put32bits(&amp;zHeader[sizeof(aJournalMagic)+<span class="number">12</span>], pPager-&gt;sectorSize);</div><div class="line">  <span class="comment">//写入文件头</span></div><div class="line">  rc = sqlite3OsWrite(pPager-&gt;jfd, zHeader, sizeof(zHeader));</div><div class="line"></div><div class="line">  <span class="comment">/* The journal header has been written successfully. Seek the journal</span></div><div class="line">  ** file descriptor to the end of the journal header sector.</div><div class="line">  */</div><div class="line">  <span class="keyword">if</span>( rc==SQLITE_OK )&#123;</div><div class="line">    rc = sqlite3OsSeek(pPager-&gt;jfd, pPager-&gt;journalOff-<span class="number">1</span>);</div><div class="line">    <span class="keyword">if</span>( rc==SQLITE_OK )&#123;</div><div class="line">      rc = sqlite3OsWrite(pPager-&gt;jfd, <span class="string">"\000"</span>, <span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> rc;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p> 其实现过程如下图所示：<br> <img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite04-01.GIF" alt=""></p>
<p> pager层是SQLite实现最为核心的模块，它具有四大功能：I/O，页面缓存，并发控制和日志恢复。而这些功能不仅是上层Btree的基础，而且对系统的性能和健壮性有关至关重要的影响。其中并发控制和日志恢复是事务处理实现的基础。SQLite并发控制的机制非常简单——封锁机制；别外，它的查询优化机制也非常简单——基于索引。这一切使得整个SQLite的实现变得简单，SQLite变得很小，运行速度也非常快，所以，特别适合嵌入式设备。好了，接下来讨论事务的剩余部分。<br>6、修改位于用户进程空间的页面(Changing Database Pages In User Space)<br>页面的原始数据写入日志之后，就可以修改页面了——位于用户进程空间。每个数据库连接都有自己私有的空间，所以页面的变化只对该连接可见，而对其它连接的数据仍然是磁盘缓存中的数据。从这里可以明白一件事：一个进程在修改页面数据的同时，其它进程可以继续进行读操作。图中的红色表示修改的页面。<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-5.gif" alt=""><br>7、日志文件刷入磁盘(Flushing The Rollback Journal File To Mass Storage)<br>接下来把日志文件的内容刷入磁盘，这对于数据库从意外中恢复来说是至关重要的一步。而且这通常也是一个耗时的操作，因为磁盘I/O速度很慢。<br>这个步骤不只把日志文件刷入磁盘那么简单，它的实现实际上分成两步：首先把日志文件的内容刷入磁盘（即页面数据）；然后把日志文件中页面的数目写入日志文件头，再把header刷入磁盘（这一过程在代码中清晰可见）。<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-6.gif" alt=""><br>代码如下：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line">**Sync日志文件,保证所有的脏页面写入磁盘日志文件</div><div class="line">*/</div><div class="line">static int syncJournal(Pager *pPager)&#123;</div><div class="line">  PgHdr *pPg;</div><div class="line">  int rc = SQLITE_OK;</div><div class="line"></div><div class="line">  /* Sync the journal before modifying the main database</div><div class="line">  ** (assuming there is a journal and it needs to be synced.)</div><div class="line">  */</div><div class="line">  if( pPager-&gt;needSync )&#123;</div><div class="line">    if( !pPager-&gt;tempFile )&#123;</div><div class="line">      assert( pPager-&gt;journalOpen );</div><div class="line">      /* assert( !pPager-&gt;noSync ); // noSync might be set if synchronous</div><div class="line">      ** was turned off after the transaction was started.  Ticket #615 */</div><div class="line">#ifndef NDEBUG</div><div class="line">      &#123;</div><div class="line">        /* Make sure the pPager-&gt;nRec counter we are keeping agrees</div><div class="line">        ** with the nRec computed from the size of the journal file.</div><div class="line">        */</div><div class="line">        i64 jSz;</div><div class="line">        rc = sqlite3OsFileSize(pPager-&gt;jfd, &amp;jSz);</div><div class="line">        if( rc!=0 ) return rc;</div><div class="line">        assert( pPager-&gt;journalOff==jSz );</div><div class="line">      &#125;</div><div class="line">#endif</div><div class="line">      &#123;</div><div class="line">        /* Write the nRec value into the journal file header. If in</div><div class="line">        ** full-synchronous mode, sync the journal first. This ensures that</div><div class="line">        ** all data has really hit the disk before nRec is updated to mark</div><div class="line">        ** it as a candidate for rollback. </div><div class="line">        */</div><div class="line">        if( pPager-&gt;fullSync )&#123;</div><div class="line">          TRACE2("SYNC journal of %d\n", PAGERID(pPager));</div><div class="line">    //首先保证脏页面中所有的数据都已经写入日志文件</div><div class="line">          rc = sqlite3OsSync(pPager-&gt;jfd, 0);</div><div class="line">          if( rc!=0 ) return rc;</div><div class="line">        &#125;</div><div class="line">        rc = sqlite3OsSeek(pPager-&gt;jfd,</div><div class="line">                           pPager-&gt;journalHdr + sizeof(aJournalMagic));</div><div class="line">        if( rc ) return rc;</div><div class="line">    //页面的数目写入日志文件</div><div class="line">        rc = write32bits(pPager-&gt;jfd, pPager-&gt;nRec);</div><div class="line">        if( rc ) return rc;</div><div class="line"></div><div class="line">        rc = sqlite3OsSeek(pPager-&gt;jfd, pPager-&gt;journalOff);</div><div class="line">        if( rc ) return rc;</div><div class="line">      &#125;</div><div class="line">      TRACE2("SYNC journal of %d\n", PAGERID(pPager));</div><div class="line">      rc = sqlite3OsSync(pPager-&gt;jfd, pPager-&gt;full_fsync);</div><div class="line">      if( rc!=0 ) return rc;</div><div class="line">      pPager-&gt;journalStarted = 1;</div><div class="line">    &#125;</div><div class="line">    pPager-&gt;needSync = 0;</div><div class="line"></div><div class="line">    /* Erase the needSync flag from every page.</div><div class="line">    */</div><div class="line">    //清除needSync标志位</div><div class="line">    for(pPg=pPager-&gt;pAll; pPg; pPg=pPg-&gt;pNextAll)&#123;</div><div class="line">      pPg-&gt;needSync = 0;</div><div class="line">    &#125;</div><div class="line">    pPager-&gt;pFirstSynced = pPager-&gt;pFirst;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">#ifndef NDEBUG</div><div class="line">  /* If the Pager.needSync flag is clear then the PgHdr.needSync</div><div class="line">  ** flag must also be clear for all pages.  Verify that this</div><div class="line">  ** invariant is true.</div><div class="line">  */</div><div class="line">  else&#123;</div><div class="line">    for(pPg=pPager-&gt;pAll; pPg; pPg=pPg-&gt;pNextAll)&#123;</div><div class="line">      assert( pPg-&gt;needSync==0 );</div><div class="line">    &#125;</div><div class="line">    assert( pPager-&gt;pFirstSynced==pPager-&gt;pFirst );</div><div class="line">  &#125;</div><div class="line">#endif</div><div class="line"></div><div class="line">  return rc;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>8、获取排斥锁（Obtaining An Exclusive Lock）<br>在对数据库文件进行修改之前(注：这里不是内存中的页面),我们必须得到数据库文件的排斥锁(Exclusive Lock)。得到排斥锁的过程可分为两步：首先得到Pending lock；然后Pending lock升级到exclusive lock。<br>Pending lock允许其它已经存在的Shared lock继续读数据库文件，但是不允许产生新的shared lock，这样做目的是为了防止写操作发生饿死情况。一旦所有的shared lock完成操作，则pending lock升级到exclusive lock。<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-7.gif" alt=""></p>
<p>9、修改的页面写入文件(Writing Changes To The Database File)<br>一旦得到exclusive lock，其它的进程就不能进行读操作，此时就可以把修改的页面写回数据库文件，但是通常OS都把结果暂时保存到磁盘缓存中，直到某个时刻才会真正把结果写入磁盘。<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-8.gif" alt=""><br>以上两步的实现代码：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line">//把所有的脏页面写入数据库</div><div class="line">//到这里开始获取EXCLUSIVEQ锁，并将页面写回操作系统文件</div><div class="line">static int pager_write_pagelist(PgHdr *pList)&#123;</div><div class="line">  Pager *pPager;</div><div class="line">  int rc;</div><div class="line"></div><div class="line">  if( pList==0 ) return SQLITE_OK;</div><div class="line">  pPager = pList-&gt;pPager;</div><div class="line"></div><div class="line">  /* At this point there may be either a RESERVED or EXCLUSIVE lock on the</div><div class="line">  ** database file. If there is already an EXCLUSIVE lock, the following</div><div class="line">  ** calls to sqlite3OsLock() are no-ops.</div><div class="line">  **</div><div class="line">  ** Moving the lock from RESERVED to EXCLUSIVE actually involves going</div><div class="line">  ** through an intermediate state PENDING.   A PENDING lock prevents new</div><div class="line">  ** readers from attaching to the database but is unsufficient for us to</div><div class="line">  ** write.  The idea of a PENDING lock is to prevent new readers from</div><div class="line">  ** coming in while we wait for existing readers to clear.</div><div class="line">  **</div><div class="line">  ** While the pager is in the RESERVED state, the original database file</div><div class="line">  ** is unchanged and we can rollback without having to playback the</div><div class="line">  ** journal into the original database file.  Once we transition to</div><div class="line">  ** EXCLUSIVE, it means the database file has been changed and any rollback</div><div class="line">  ** will require a journal playback.</div><div class="line">  */</div><div class="line">  //加EXCLUSIVE_LOCK锁</div><div class="line">  rc = pager_wait_on_lock(pPager, EXCLUSIVE_LOCK);</div><div class="line">  if( rc!=SQLITE_OK )&#123;</div><div class="line">    return rc;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  while( pList )&#123;</div><div class="line">    assert( pList-&gt;dirty );</div><div class="line">    rc = sqlite3OsSeek(pPager-&gt;fd, (pList-&gt;pgno-1)*(i64)pPager-&gt;pageSize);</div><div class="line">    if( rc ) return rc;</div><div class="line">    /* If there are dirty pages in the page cache with page numbers greater</div><div class="line">    ** than Pager.dbSize, this means sqlite3pager_truncate() was called to</div><div class="line">    ** make the file smaller (presumably by auto-vacuum code). Do not write</div><div class="line">    ** any such pages to the file.</div><div class="line">    */</div><div class="line">    if( pList-&gt;pgno&lt;=pPager-&gt;dbSize )&#123;</div><div class="line">      char *pData = CODEC2(pPager, PGHDR_TO_DATA(pList), pList-&gt;pgno, 6);</div><div class="line">      TRACE3("STORE %d page %d\n", PAGERID(pPager), pList-&gt;pgno);</div><div class="line">      //写入文件</div><div class="line">      rc = sqlite3OsWrite(pPager-&gt;fd, pData, pPager-&gt;pageSize);</div><div class="line">      TEST_INCR(pPager-&gt;nWrite);</div><div class="line">    &#125;</div><div class="line">#ifndef NDEBUG</div><div class="line">    else&#123;</div><div class="line">      TRACE3("NOSTORE %d page %d\n", PAGERID(pPager), pList-&gt;pgno);</div><div class="line">    &#125;</div><div class="line">#endif</div><div class="line">    if( rc ) return rc;</div><div class="line">    //设置dirty</div><div class="line">    pList-&gt;dirty = 0;</div><div class="line">#ifdef SQLITE_CHECK_PAGES</div><div class="line">    pList-&gt;pageHash = pager_pagehash(pList);</div><div class="line">#endif</div><div class="line">//指向下一个脏页面</div><div class="line">    pList = pList-&gt;pDirty;</div><div class="line">  &#125;</div><div class="line">  return SQLITE_OK;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>10、修改结果刷入存储设备(Flushing Changes To Mass Storage)<br>为了保证修改结果真正写入磁盘，这一步必不要少。对于数据库存的完整性，这一步也是关键的一步。由于要进行实际的I/O操作，所以和第7步一样，将花费较多的时间。<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-9.gif" alt=""><br>最后来看看这几步是如何实现的：</p>
<p>其实以上以上几步是在函数sqlite3BtreeSync()—btree.c中调用的(而关于该函数的调用后面再讲)。</p>
<p>代码如下：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div></pre></td><td class="code"><pre><div class="line">//同步btree对应的数据库文件</div><div class="line">//该函数返回之后，只需要提交写事务,删除日志文件</div><div class="line">int sqlite3BtreeSync(Btree *p, const char *zMaster)&#123;</div><div class="line">  int rc = SQLITE_OK;</div><div class="line">  if( p-&gt;inTrans==TRANS_WRITE )&#123;</div><div class="line">    BtShared *pBt = p-&gt;pBt;</div><div class="line">    Pgno nTrunc = 0;</div><div class="line">#ifndef SQLITE_OMIT_AUTOVACUUM</div><div class="line">    if( pBt-&gt;autoVacuum )&#123;</div><div class="line">      rc = autoVacuumCommit(pBt, &amp;nTrunc); </div><div class="line">      if( rc!=SQLITE_OK )&#123;</div><div class="line">        return rc;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">#endif</div><div class="line"></div><div class="line"> //调用pager进行sync</div><div class="line">    rc = sqlite3pager_sync(pBt-&gt;pPager, zMaster, nTrunc);</div><div class="line">  &#125;</div><div class="line">  return rc;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//把pager所有脏页面写回文件</div><div class="line">int sqlite3pager_sync(Pager *pPager, const char *zMaster, Pgno nTrunc)&#123;</div><div class="line">  int rc = SQLITE_OK;</div><div class="line"></div><div class="line">  TRACE4("DATABASE SYNC: File=%s zMaster=%s nTrunc=%d\n", </div><div class="line">      pPager-&gt;zFilename, zMaster, nTrunc);</div><div class="line"></div><div class="line">  /* If this is an in-memory db, or no pages have been written to, or this</div><div class="line">  ** function has already been called, it is a no-op.</div><div class="line">  */</div><div class="line">  //pager不处于PAGER_SYNCED状态,dirtyCache为1,</div><div class="line">  //则进行sync操作</div><div class="line">  if( pPager-&gt;state!=PAGER_SYNCED &amp;&amp; !MEMDB &amp;&amp; pPager-&gt;dirtyCache )&#123;</div><div class="line">    PgHdr *pPg;</div><div class="line">    assert( pPager-&gt;journalOpen );</div><div class="line"></div><div class="line">    /* If a master journal file name has already been written to the</div><div class="line">    ** journal file, then no sync is required. This happens when it is</div><div class="line">    ** written, then the process fails to upgrade from a RESERVED to an</div><div class="line">    ** EXCLUSIVE lock. The next time the process tries to commit the</div><div class="line">    ** transaction the m-j name will have already been written.</div><div class="line">    */</div><div class="line">    if( !pPager-&gt;setMaster )&#123;</div><div class="line">        //pager修改计数</div><div class="line">      rc = pager_incr_changecounter(pPager);</div><div class="line">      if( rc!=SQLITE_OK ) goto sync_exit;</div><div class="line">#ifndef SQLITE_OMIT_AUTOVACUUM</div><div class="line">      if( nTrunc!=0 )&#123;</div><div class="line">        /* If this transaction has made the database smaller, then all pages</div><div class="line">        ** being discarded by the truncation must be written to the journal</div><div class="line">        ** file.</div><div class="line">        */</div><div class="line">        Pgno i;</div><div class="line">        void *pPage;</div><div class="line">        int iSkip = PAGER_MJ_PGNO(pPager);</div><div class="line">        for( i=nTrunc+1; i&lt;=pPager-&gt;origDbSize; i++ )&#123;</div><div class="line">          if( !(pPager-&gt;aInJournal[i/8] &amp; (1&lt;&lt;(i&amp;7))) &amp;&amp; i!=iSkip )&#123;</div><div class="line">            rc = sqlite3pager_get(pPager, i, &amp;pPage);</div><div class="line">            if( rc!=SQLITE_OK ) goto sync_exit;</div><div class="line">            rc = sqlite3pager_write(pPage);</div><div class="line">            sqlite3pager_unref(pPage);</div><div class="line">            if( rc!=SQLITE_OK ) goto sync_exit;</div><div class="line">          &#125;</div><div class="line">        &#125; </div><div class="line">      &#125;</div><div class="line">#endif</div><div class="line">      rc = writeMasterJournal(pPager, zMaster);</div><div class="line">      if( rc!=SQLITE_OK ) goto sync_exit;</div><div class="line">      </div><div class="line">        //sync日志文件</div><div class="line">      rc = syncJournal(pPager);</div><div class="line">      if( rc!=SQLITE_OK ) goto sync_exit;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">#ifndef SQLITE_OMIT_AUTOVACUUM</div><div class="line">    if( nTrunc!=0 )&#123;</div><div class="line">      rc = sqlite3pager_truncate(pPager, nTrunc);</div><div class="line">      if( rc!=SQLITE_OK ) goto sync_exit;</div><div class="line">    &#125;</div><div class="line">#endif</div><div class="line"></div><div class="line">    /* Write all dirty pages to the database file */</div><div class="line">    pPg = pager_get_all_dirty_pages(pPager);</div><div class="line"></div><div class="line"></div><div class="line">   //把所有脏页面写回操作系统文件</div><div class="line">    rc = pager_write_pagelist(pPg);</div><div class="line">    if( rc!=SQLITE_OK ) goto sync_exit;</div><div class="line"></div><div class="line">    /* Sync the database file. */</div><div class="line">       //sync数据库文件</div><div class="line">    if( !pPager-&gt;noSync )&#123;</div><div class="line">      rc = sqlite3OsSync(pPager-&gt;fd, 0);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    pPager-&gt;state = PAGER_SYNCED;</div><div class="line">  &#125;else if( MEMDB &amp;&amp; nTrunc!=0 )&#123;</div><div class="line">    rc = sqlite3pager_truncate(pPager, nTrunc);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">sync_exit:</div><div class="line">  return rc;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>下图可以进一步解释该过程：<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite04-02.GIF" alt=""></p>
<p>11、删除日志文件(Deleting The Rollback Journal)<br>一旦更改写入设备，日志文件将会被删除，这是事务真正提交的时刻。如果在这之前系统发生崩溃，就会进行恢复处理，使得数据库和没发生改变一样；如果在这之后系统发生崩溃，表明所有的更改都已经写入磁盘。SQLite就是根据日志存在情况决定是否对数据库进行恢复处理。</p>
<p>删除文件本质上不是一个原子操作，但是从用户进程的角度来看是一个原子操作，所以一个事务看起来是一个原子操作。<br>在许多系统中，删除文件也是一个高代价的操作。作为优化，SQLite可以配置成把日志文件的长度截为0或者把日志文件头清零。<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-A.gif" alt=""><br>12、释放锁(Releasing The Lock)<br>作为原子提交的最后一步，释放排斥锁使得其它进程可以开始访问数据库了。<br>下图中，我们指明了当锁被释放的时候用户空间所拥有的信息已经被清空了.对于老版本的SQLite你可这么认为。但最新的SQLite会保存些用户空间的缓存不会被清空—万一下一个事务开始的时候，这些数据刚好可以用上呢。重新利用这些内存要比再次从操作系统磁盘缓存或者硬盘中读取要来得轻松与快捷得多，何乐而不为呢？在再次使用这些数据之前，我们必须先取得一个共享锁，同时我们还不得不去检查一下，保证还没有其他进程在我们拥有共享锁之前对数据库文件进行了修改。数据库文件的第一页中有一个计数器，数据库文件每做一次修改，这个计数器就会增长一下。我们可以通过检查这个计数器就可得知是否有其他进程修改过数据库文件。如果数据库文件已经被修改过了，那么用户内存空间的缓存就不得不清空，并重新读入。大多数情况下，这种情况不大会发生，因此用户空间的内存缓存将是有效的，这对于性能提高来说作用是显著的。<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-B.gif" alt=""><br>以上两步是在sqlite3BtreeCommit()—btree.c函数中实现的。</p>
<p>代码如下：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div></pre></td><td class="code"><pre><div class="line">//提交事务,至此一个事务完成.主要做两件事:</div><div class="line">//删除日志文件,释放数据库文件的写锁</div><div class="line">int sqlite3BtreeCommit(Btree *p)&#123;</div><div class="line">  BtShared *pBt = p-&gt;pBt;</div><div class="line"></div><div class="line">  btreeIntegrity(p);</div><div class="line"></div><div class="line">  /* If the handle has a write-transaction open, commit the shared-btrees </div><div class="line">  ** transaction and set the shared state to TRANS_READ.</div><div class="line">  */</div><div class="line">  if( p-&gt;inTrans==TRANS_WRITE )&#123;</div><div class="line">    int rc;</div><div class="line">    assert( pBt-&gt;inTransaction==TRANS_WRITE );</div><div class="line">    assert( pBt-&gt;nTransaction&gt;0 );</div><div class="line"></div><div class="line">   //调用pager，提交事务</div><div class="line">    rc = sqlite3pager_commit(pBt-&gt;pPager);</div><div class="line">    if( rc!=SQLITE_OK )&#123;</div><div class="line">      return rc;</div><div class="line">    &#125;</div><div class="line">    pBt-&gt;inTransaction = TRANS_READ;</div><div class="line">    pBt-&gt;inStmt = 0;</div><div class="line">  &#125;</div><div class="line">  unlockAllTables(p);</div><div class="line"></div><div class="line">  /* If the handle has any kind of transaction open, decrement the transaction</div><div class="line">  ** count of the shared btree. If the transaction count reaches 0, set</div><div class="line">  ** the shared state to TRANS_NONE. The unlockBtreeIfUnused() call below</div><div class="line">  ** will unlock the pager.</div><div class="line">  */</div><div class="line">  if( p-&gt;inTrans!=TRANS_NONE )&#123;</div><div class="line">    pBt-&gt;nTransaction--;</div><div class="line">    if( 0==pBt-&gt;nTransaction )&#123;</div><div class="line">      pBt-&gt;inTransaction = TRANS_NONE;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//提交事务，主要调用pager_unwritelock()函数</div><div class="line">int sqlite3pager_commit(Pager *pPager)&#123;</div><div class="line">  int rc;</div><div class="line">  PgHdr *pPg;</div><div class="line"></div><div class="line">  if( pPager-&gt;errCode )&#123;</div><div class="line">    return pPager-&gt;errCode;</div><div class="line">  &#125;</div><div class="line">  if( pPager-&gt;state&lt;PAGER_RESERVED )&#123;</div><div class="line">    return SQLITE_ERROR;</div><div class="line">  &#125;</div><div class="line">  TRACE2("COMMIT %d\n", PAGERID(pPager));</div><div class="line">  if( MEMDB )&#123;</div><div class="line">    pPg = pager_get_all_dirty_pages(pPager);</div><div class="line">    while( pPg )&#123;</div><div class="line">      clearHistory(PGHDR_TO_HIST(pPg, pPager));</div><div class="line">      pPg-&gt;dirty = 0;</div><div class="line">      pPg-&gt;inJournal = 0;</div><div class="line">      pPg-&gt;inStmt = 0;</div><div class="line">      pPg-&gt;needSync = 0;</div><div class="line">      pPg-&gt;pPrevStmt = pPg-&gt;pNextStmt = 0;</div><div class="line">      pPg = pPg-&gt;pDirty;</div><div class="line">    &#125;</div><div class="line">    pPager-&gt;pDirty = 0;</div><div class="line">#ifndef NDEBUG</div><div class="line">    for(pPg=pPager-&gt;pAll; pPg; pPg=pPg-&gt;pNextAll)&#123;</div><div class="line">      PgHistory *pHist = PGHDR_TO_HIST(pPg, pPager);</div><div class="line">      assert( !pPg-&gt;alwaysRollback );</div><div class="line">      assert( !pHist-&gt;pOrig );</div><div class="line">      assert( !pHist-&gt;pStmt );</div><div class="line">    &#125;</div><div class="line">#endif</div><div class="line">    pPager-&gt;pStmt = 0;</div><div class="line">    pPager-&gt;state = PAGER_SHARED;</div><div class="line">    return SQLITE_OK;</div><div class="line">  &#125;</div><div class="line">  if( pPager-&gt;dirtyCache==0 )&#123;</div><div class="line">    /* Exit early (without doing the time-consuming sqlite3OsSync() calls)</div><div class="line">    ** if there have been no changes to the database file. */</div><div class="line">    assert( pPager-&gt;needSync==0 );</div><div class="line">    rc = pager_unwritelock(pPager);</div><div class="line">    pPager-&gt;dbSize = -1;</div><div class="line">    return rc;</div><div class="line">  &#125;</div><div class="line">  assert( pPager-&gt;journalOpen );</div><div class="line">  rc = sqlite3pager_sync(pPager, 0, 0);</div><div class="line">  </div><div class="line">  //删除文件,释放写锁</div><div class="line">  if( rc==SQLITE_OK )&#123;</div><div class="line">    rc = pager_unwritelock(pPager);</div><div class="line">    pPager-&gt;dbSize = -1;</div><div class="line">  &#125;</div><div class="line">  return rc;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//对数据库加read lock，删除日志文件</div><div class="line">static int pager_unwritelock(Pager *pPager)&#123;</div><div class="line">  PgHdr *pPg;</div><div class="line">  int rc;</div><div class="line">  assert( !MEMDB );</div><div class="line">  if( pPager-&gt;state&lt;PAGER_RESERVED )&#123;</div><div class="line">    return SQLITE_OK;</div><div class="line">  &#125;</div><div class="line">  sqlite3pager_stmt_commit(pPager);</div><div class="line">  if( pPager-&gt;stmtOpen )&#123;</div><div class="line">    sqlite3OsClose(&amp;pPager-&gt;stfd);</div><div class="line">    pPager-&gt;stmtOpen = 0;</div><div class="line">  &#125;</div><div class="line">  if( pPager-&gt;journalOpen )&#123;</div><div class="line"></div><div class="line">   //关闭日志文件</div><div class="line">    sqlite3OsClose(&amp;pPager-&gt;jfd);</div><div class="line">    pPager-&gt;journalOpen = 0;</div><div class="line">    //删除日志文件</div><div class="line">    sqlite3OsDelete(pPager-&gt;zJournal);</div><div class="line">    sqliteFree( pPager-&gt;aInJournal );</div><div class="line">    pPager-&gt;aInJournal = 0;</div><div class="line">    for(pPg=pPager-&gt;pAll; pPg; pPg=pPg-&gt;pNextAll)&#123;</div><div class="line">      pPg-&gt;inJournal = 0;</div><div class="line">      pPg-&gt;dirty = 0;</div><div class="line">      pPg-&gt;needSync = 0;</div><div class="line">#ifdef SQLITE_CHECK_PAGES</div><div class="line">      pPg-&gt;pageHash = pager_pagehash(pPg);</div><div class="line">#endif</div><div class="line">    &#125;</div><div class="line">    pPager-&gt;pDirty = 0;</div><div class="line">    pPager-&gt;dirtyCache = 0;</div><div class="line">    pPager-&gt;nRec = 0;</div><div class="line">  &#125;else&#123;</div><div class="line">    assert( pPager-&gt;aInJournal==0 );</div><div class="line">    assert( pPager-&gt;dirtyCache==0 || pPager-&gt;useJournal==0 );</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  //释放写锁，加读锁</div><div class="line">  rc = sqlite3OsUnlock(pPager-&gt;fd, SHARED_LOCK);</div><div class="line">  pPager-&gt;state = PAGER_SHARED;</div><div class="line">  pPager-&gt;origDbSize = 0;</div><div class="line">  pPager-&gt;setMaster = 0;</div><div class="line">  pPager-&gt;needSync = 0;</div><div class="line">  pPager-&gt;pFirstSynced = pPager-&gt;pFirst;</div><div class="line">  return rc;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>下图可进一步描述该过程：<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite04-03.GIF" alt=""><br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div></pre></td><td class="code"><pre><div class="line">//虚拟机停机指令</div><div class="line">case OP_Halt: &#123;            /* no-push */</div><div class="line">  p-&gt;pTos = pTos;</div><div class="line">  p-&gt;rc = pOp-&gt;p1;</div><div class="line">  p-&gt;pc = pc;</div><div class="line">  p-&gt;errorAction = pOp-&gt;p2;</div><div class="line">  if( pOp-&gt;p3 )&#123;</div><div class="line">    sqlite3SetString(&amp;p-&gt;zErrMsg, pOp-&gt;p3, (char*)0);</div><div class="line">  &#125;</div><div class="line">  //设置虚拟机状态SQLITE_MAGIC_RUN 为 SQLITE_MAGIC_HALT,</div><div class="line">  //并提交事务</div><div class="line">  rc = sqlite3VdbeHalt(p);</div><div class="line">  assert( rc==SQLITE_BUSY || rc==SQLITE_OK );</div><div class="line">  if( rc==SQLITE_BUSY )&#123;</div><div class="line">    p-&gt;rc = SQLITE_BUSY;</div><div class="line">    return SQLITE_BUSY;</div><div class="line">  &#125;</div><div class="line">  return p-&gt;rc ? SQLITE_ERROR : SQLITE_DONE;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//当虚拟机要停机时,调用该函数,如果VDBE改变了数据库且为自动</div><div class="line">//提交模式，则提交这些改变</div><div class="line">int sqlite3VdbeHalt(Vdbe *p)&#123;</div><div class="line">  sqlite3 *db = p-&gt;db;</div><div class="line">  int i;</div><div class="line">  int (*xFunc)(Btree *pBt) = 0;  /* Function to call on each btree backend */</div><div class="line">  int isSpecialError;            /* Set to true if SQLITE_NOMEM or IOERR */</div><div class="line"></div><div class="line">  /* This function contains the logic that determines if a statement or</div><div class="line">  ** transaction will be committed or rolled back as a result of the</div><div class="line">  ** execution of this virtual machine. </div><div class="line">  **</div><div class="line">  ** Special errors:</div><div class="line">  **</div><div class="line">  **     If an SQLITE_NOMEM error has occured in a statement that writes to</div><div class="line">  **     the database, then either a statement or transaction must be rolled</div><div class="line">  **     back to ensure the tree-structures are in a consistent state. A</div><div class="line">  **     statement transaction is rolled back if one is open, otherwise the</div><div class="line">  **     entire transaction must be rolled back.</div><div class="line">  **</div><div class="line">  **     If an SQLITE_IOERR error has occured in a statement that writes to</div><div class="line">  **     the database, then the entire transaction must be rolled back. The</div><div class="line">  **     I/O error may have caused garbage to be written to the journal </div><div class="line">  **     file. Were the transaction to continue and eventually be rolled </div><div class="line">  **     back that garbage might end up in the database file.</div><div class="line">  **     </div><div class="line">  **     In both of the above cases, the Vdbe.errorAction variable is </div><div class="line">  **     ignored. If the sqlite3.autoCommit flag is false and a transaction</div><div class="line">  **     is rolled back, it will be set to true.</div><div class="line">  **</div><div class="line">  ** Other errors:</div><div class="line">  **</div><div class="line">  ** No error:</div><div class="line">  **</div><div class="line">  */</div><div class="line"></div><div class="line">  if( sqlite3MallocFailed() )&#123;</div><div class="line">    p-&gt;rc = SQLITE_NOMEM;</div><div class="line">  &#125;</div><div class="line">  if( p-&gt;magic!=VDBE_MAGIC_RUN )&#123;</div><div class="line">    /* Already halted.  Nothing to do. */</div><div class="line">    assert( p-&gt;magic==VDBE_MAGIC_HALT );</div><div class="line">    return SQLITE_OK;</div><div class="line">  &#125;</div><div class="line">  //释放虚拟机中所有的游标</div><div class="line">  closeAllCursors(p);</div><div class="line">  checkActiveVdbeCnt(db);</div><div class="line"></div><div class="line">  /* No commit or rollback needed if the program never started */</div><div class="line">  if( p-&gt;pc&gt;=0 )&#123;</div><div class="line"></div><div class="line">    /* Check for one of the special errors - SQLITE_NOMEM or SQLITE_IOERR */</div><div class="line">    isSpecialError = ((p-&gt;rc==SQLITE_NOMEM || p-&gt;rc==SQLITE_IOERR)?1:0);</div><div class="line">    if( isSpecialError )&#123;</div><div class="line">      /* This loop does static analysis of the query to see which of the</div><div class="line">      ** following three categories it falls into:</div><div class="line">      **</div><div class="line">      **     Read-only</div><div class="line">      **     Query with statement journal</div><div class="line">      **     Query without statement journal</div><div class="line">      **</div><div class="line">      ** We could do something more elegant than this static analysis (i.e.</div><div class="line">      ** store the type of query as part of the compliation phase), but </div><div class="line">      ** handling malloc() or IO failure is a fairly obscure edge case so </div><div class="line">      ** this is probably easier. Todo: Might be an opportunity to reduce </div><div class="line">      ** code size a very small amount though</div><div class="line">      */</div><div class="line">      int isReadOnly = 1;</div><div class="line">      int isStatement = 0;</div><div class="line">      assert(p-&gt;aOp || p-&gt;nOp==0);</div><div class="line">      for(i=0; i&lt;p-&gt;nOp; i++)&#123; </div><div class="line">        switch( p-&gt;aOp[i].opcode )&#123;</div><div class="line">          case OP_Transaction:</div><div class="line">            isReadOnly = 0;</div><div class="line">            break;</div><div class="line">          case OP_Statement:</div><div class="line">            isStatement = 1;</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">  </div><div class="line">      /* If the query was read-only, we need do no rollback at all. Otherwise,</div><div class="line">      ** proceed with the special handling.</div><div class="line">      */</div><div class="line">      if( !isReadOnly )&#123;</div><div class="line">        if( p-&gt;rc==SQLITE_NOMEM &amp;&amp; isStatement )&#123;</div><div class="line">          xFunc = sqlite3BtreeRollbackStmt;</div><div class="line">        &#125;else&#123;</div><div class="line">          /* We are forced to roll back the active transaction. Before doing</div><div class="line">          ** so, abort any other statements this handle currently has active.</div><div class="line">          */</div><div class="line">          sqlite3AbortOtherActiveVdbes(db, p);</div><div class="line">          sqlite3RollbackAll(db);</div><div class="line">          db-&gt;autoCommit = 1;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">    /* If the auto-commit flag is set and this is the only active vdbe, then</div><div class="line">    ** we do either a commit or rollback of the current transaction. </div><div class="line">    **</div><div class="line">    ** Note: This block also runs if one of the special errors handled </div><div class="line">    ** above has occured. </div><div class="line">    */</div><div class="line">    //如果自动提交事务，则提交事务</div><div class="line">    if( db-&gt;autoCommit &amp;&amp; db-&gt;activeVdbeCnt==1 )&#123;</div><div class="line">      if( p-&gt;rc==SQLITE_OK || (p-&gt;errorAction==OE_Fail &amp;&amp; !isSpecialError) )&#123;</div><div class="line">    /* The auto-commit flag is true, and the vdbe program was </div><div class="line">        ** successful or hit an 'OR FAIL' constraint. This means a commit </div><div class="line">        ** is required.</div><div class="line">        */</div><div class="line">        //提交事务</div><div class="line">        int rc = vdbeCommit(db);</div><div class="line">        if( rc==SQLITE_BUSY )&#123;</div><div class="line">          return SQLITE_BUSY;</div><div class="line">        &#125;else if( rc!=SQLITE_OK )&#123;</div><div class="line">          p-&gt;rc = rc;</div><div class="line">          sqlite3RollbackAll(db);</div><div class="line">        &#125;else&#123;</div><div class="line">          sqlite3CommitInternalChanges(db);</div><div class="line">        &#125;</div><div class="line">      &#125;else&#123;</div><div class="line">        sqlite3RollbackAll(db);</div><div class="line">      &#125;</div><div class="line">    &#125;else if( !xFunc )&#123;</div><div class="line">      if( p-&gt;rc==SQLITE_OK || p-&gt;errorAction==OE_Fail )&#123;</div><div class="line">        xFunc = sqlite3BtreeCommitStmt;</div><div class="line">      &#125;else if( p-&gt;errorAction==OE_Abort )&#123;</div><div class="line">        xFunc = sqlite3BtreeRollbackStmt;</div><div class="line">      &#125;else&#123;</div><div class="line">        sqlite3AbortOtherActiveVdbes(db, p);</div><div class="line">        sqlite3RollbackAll(db);</div><div class="line">        db-&gt;autoCommit = 1;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">    /* If xFunc is not NULL, then it is one of sqlite3BtreeRollbackStmt or</div><div class="line">    ** sqlite3BtreeCommitStmt. Call it once on each backend. If an error occurs</div><div class="line">    ** and the return code is still SQLITE_OK, set the return code to the new</div><div class="line">    ** error value.</div><div class="line">    */</div><div class="line">    assert(!xFunc ||</div><div class="line">      xFunc==sqlite3BtreeCommitStmt ||</div><div class="line">      xFunc==sqlite3BtreeRollbackStmt</div><div class="line">    );</div><div class="line">    for(i=0; xFunc &amp;&amp; i&lt;db-&gt;nDb; i++)&#123; </div><div class="line">      int rc;</div><div class="line">      Btree *pBt = db-&gt;aDb[i].pBt;</div><div class="line">      if( pBt )&#123;</div><div class="line">        rc = xFunc(pBt);</div><div class="line">        if( rc &amp;&amp; (p-&gt;rc==SQLITE_OK || p-&gt;rc==SQLITE_CONSTRAINT) )&#123;</div><div class="line">          p-&gt;rc = rc;</div><div class="line">          sqlite3SetString(&amp;p-&gt;zErrMsg, 0);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">    /* If this was an INSERT, UPDATE or DELETE and the statement was committed, </div><div class="line">    ** set the change counter. </div><div class="line">    */</div><div class="line">    if( p-&gt;changeCntOn &amp;&amp; p-&gt;pc&gt;=0 )&#123;</div><div class="line">      if( !xFunc || xFunc==sqlite3BtreeCommitStmt )&#123;</div><div class="line">        sqlite3VdbeSetChanges(db, p-&gt;nChange);</div><div class="line">      &#125;else&#123;</div><div class="line">        sqlite3VdbeSetChanges(db, 0);</div><div class="line">      &#125;</div><div class="line">      p-&gt;nChange = 0;</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">    /* Rollback or commit any schema changes that occurred. */</div><div class="line">    if( p-&gt;rc!=SQLITE_OK &amp;&amp; db-&gt;flags&amp;SQLITE_InternChanges )&#123;</div><div class="line">      sqlite3ResetInternalSchema(db, 0);</div><div class="line">      db-&gt;flags = (db-&gt;flags | SQLITE_InternChanges);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  /* We have successfully halted and closed the VM.  Record this fact. */</div><div class="line">  if( p-&gt;pc&gt;=0 )&#123;</div><div class="line">    db-&gt;activeVdbeCnt--;</div><div class="line">  &#125;</div><div class="line">  p-&gt;magic = VDBE_MAGIC_HALT;</div><div class="line">  checkActiveVdbeCnt(db);</div><div class="line"></div><div class="line">  return SQLITE_OK;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//提交事务,主要调用:</div><div class="line">//sqlite3BtreeSync()---同步btree, sqlite3BtreeCommit()---提交事务</div><div class="line">static int vdbeCommit(sqlite3 *db)&#123;</div><div class="line">  int i;</div><div class="line">  int nTrans = 0;  /* Number of databases with an active write-transaction */</div><div class="line">  int rc = SQLITE_OK;</div><div class="line">  int needXcommit = 0;</div><div class="line"></div><div class="line">  for(i=0; i&lt;db-&gt;nDb; i++)&#123; </div><div class="line">    Btree *pBt = db-&gt;aDb[i].pBt;</div><div class="line">    if( pBt &amp;&amp; sqlite3BtreeIsInTrans(pBt) )&#123;</div><div class="line">      needXcommit = 1;</div><div class="line">      if( i!=1 ) nTrans++;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  /* If there are any write-transactions at all, invoke the commit hook */</div><div class="line">  if( needXcommit &amp;&amp; db-&gt;xCommitCallback )&#123;</div><div class="line">    sqlite3SafetyOff(db);</div><div class="line">    rc = db-&gt;xCommitCallback(db-&gt;pCommitArg);</div><div class="line">    sqlite3SafetyOn(db);</div><div class="line">    if( rc )&#123;</div><div class="line">      return SQLITE_CONSTRAINT;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  /* The simple case - no more than one database file (not counting the</div><div class="line">  ** TEMP database) has a transaction active.   There is no need for the</div><div class="line">  ** master-journal.</div><div class="line">  **</div><div class="line">  ** If the return value of sqlite3BtreeGetFilename() is a zero length</div><div class="line">  ** string, it means the main database is :memory:.  In that case we do</div><div class="line">  ** not support atomic multi-file commits, so use the simple case then</div><div class="line">  ** too.</div><div class="line">  */</div><div class="line">  //简单的情况,只有一个数据库文件,不需要master-journal</div><div class="line">  if( 0==strlen(sqlite3BtreeGetFilename(db-&gt;aDb[0].pBt)) || nTrans&lt;=1 )&#123;</div><div class="line">    for(i=0; rc==SQLITE_OK &amp;&amp; i&lt;db-&gt;nDb; i++)&#123; </div><div class="line">      Btree *pBt = db-&gt;aDb[i].pBt;</div><div class="line">      if( pBt )&#123;</div><div class="line">          //同步btree</div><div class="line">        rc = sqlite3BtreeSync(pBt, 0);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /* Do the commit only if all databases successfully synced */</div><div class="line">    //commite事务</div><div class="line">    if( rc==SQLITE_OK )&#123;</div><div class="line">      for(i=0; i&lt;db-&gt;nDb; i++)&#123;</div><div class="line">        Btree *pBt = db-&gt;aDb[i].pBt;</div><div class="line">        if( pBt )&#123;</div><div class="line">          sqlite3BtreeCommit(pBt);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  /* The complex case - There is a multi-file write-transaction active.</div><div class="line">  ** This requires a master journal file to ensure the transaction is</div><div class="line">  ** committed atomicly.</div><div class="line">  */</div><div class="line">#ifndef SQLITE_OMIT_DISKIO</div><div class="line">  else&#123;</div><div class="line">    int needSync = 0;</div><div class="line">    char *zMaster = 0;   /* File-name for the master journal */</div><div class="line">    char const *zMainFile = sqlite3BtreeGetFilename(db-&gt;aDb[0].pBt);</div><div class="line">    OsFile *master = 0;</div><div class="line"></div><div class="line">    /* Select a master journal file name */</div><div class="line">    do &#123;</div><div class="line">      u32 random;</div><div class="line">      sqliteFree(zMaster);</div><div class="line">      sqlite3Randomness(sizeof(random), &amp;random);</div><div class="line">      zMaster = sqlite3MPrintf("%s-mj%08X", zMainFile, random&amp;0x7fffffff);</div><div class="line">      if( !zMaster )&#123;</div><div class="line">        return SQLITE_NOMEM;</div><div class="line">      &#125;</div><div class="line">    &#125;while( sqlite3OsFileExists(zMaster) );</div><div class="line"></div><div class="line">    /* Open the master journal. */</div><div class="line">    rc = sqlite3OsOpenExclusive(zMaster, &amp;master, 0);</div><div class="line">    if( rc!=SQLITE_OK )&#123;</div><div class="line">      sqliteFree(zMaster);</div><div class="line">      return rc;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    /* Write the name of each database file in the transaction into the new</div><div class="line">    ** master journal file. If an error occurs at this point close</div><div class="line">    ** and delete the master journal file. All the individual journal files</div><div class="line">    ** still have 'null' as the master journal pointer, so they will roll</div><div class="line">    ** back independently if a failure occurs.</div><div class="line">    */</div><div class="line">    for(i=0; i&lt;db-&gt;nDb; i++)&#123; </div><div class="line">      Btree *pBt = db-&gt;aDb[i].pBt;</div><div class="line">      if( i==1 ) continue;   /* Ignore the TEMP database */</div><div class="line">      if( pBt &amp;&amp; sqlite3BtreeIsInTrans(pBt) )&#123;</div><div class="line">        char const *zFile = sqlite3BtreeGetJournalname(pBt);</div><div class="line">        if( zFile[0]==0 ) continue;  /* Ignore :memory: databases */</div><div class="line">        if( !needSync &amp;&amp; !sqlite3BtreeSyncDisabled(pBt) )&#123;</div><div class="line">          needSync = 1;</div><div class="line">        &#125;</div><div class="line">        rc = sqlite3OsWrite(master, zFile, strlen(zFile)+1);</div><div class="line">        if( rc!=SQLITE_OK )&#123;</div><div class="line">          sqlite3OsClose(&amp;master);</div><div class="line">          sqlite3OsDelete(zMaster);</div><div class="line">          sqliteFree(zMaster);</div><div class="line">          return rc;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    /* Sync the master journal file. Before doing this, open the directory</div><div class="line">    ** the master journal file is store in so that it gets synced too.</div><div class="line">    */</div><div class="line">    zMainFile = sqlite3BtreeGetDirname(db-&gt;aDb[0].pBt);</div><div class="line">    rc = sqlite3OsOpenDirectory(master, zMainFile);</div><div class="line">    if( rc!=SQLITE_OK ||</div><div class="line">          (needSync &amp;&amp; (rc=sqlite3OsSync(master,0))!=SQLITE_OK) )&#123;</div><div class="line">      sqlite3OsClose(&amp;master);</div><div class="line">      sqlite3OsDelete(zMaster);</div><div class="line">      sqliteFree(zMaster);</div><div class="line">      return rc;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /* Sync all the db files involved in the transaction. The same call</div><div class="line">    ** sets the master journal pointer in each individual journal. If</div><div class="line">    ** an error occurs here, do not delete the master journal file.</div><div class="line">    **</div><div class="line">    ** If the error occurs during the first call to sqlite3BtreeSync(),</div><div class="line">    ** then there is a chance that the master journal file will be</div><div class="line">    ** orphaned. But we cannot delete it, in case the master journal</div><div class="line">    ** file name was written into the journal file before the failure</div><div class="line">    ** occured.</div><div class="line">    */</div><div class="line">    for(i=0; i&lt;db-&gt;nDb; i++)&#123; </div><div class="line">      Btree *pBt = db-&gt;aDb[i].pBt;</div><div class="line">      if( pBt &amp;&amp; sqlite3BtreeIsInTrans(pBt) )&#123;</div><div class="line">        rc = sqlite3BtreeSync(pBt, zMaster);</div><div class="line">        if( rc!=SQLITE_OK )&#123;</div><div class="line">          sqlite3OsClose(&amp;master);</div><div class="line">          sqliteFree(zMaster);</div><div class="line">          return rc;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    sqlite3OsClose(&amp;master);</div><div class="line"></div><div class="line">    /* Delete the master journal file. This commits the transaction. After</div><div class="line">    ** doing this the directory is synced again before any individual</div><div class="line">    ** transaction files are deleted.</div><div class="line">    */</div><div class="line">    rc = sqlite3OsDelete(zMaster);</div><div class="line">    assert( rc==SQLITE_OK );</div><div class="line">    sqliteFree(zMaster);</div><div class="line">    zMaster = 0;</div><div class="line">    rc = sqlite3OsSyncDirectory(zMainFile);</div><div class="line">    if( rc!=SQLITE_OK )&#123;</div><div class="line">      /* This is not good. The master journal file has been deleted, but</div><div class="line">      ** the directory sync failed. There is no completely safe course of</div><div class="line">      ** action from here. The individual journals contain the name of the</div><div class="line">      ** master journal file, but there is no way of knowing if that</div><div class="line">      ** master journal exists now or if it will exist after the operating</div><div class="line">      ** system crash that may follow the fsync() failure.</div><div class="line">      */</div><div class="line">      return rc;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /* All files and directories have already been synced, so the following</div><div class="line">    ** calls to sqlite3BtreeCommit() are only closing files and deleting</div><div class="line">    ** journals. If something goes wrong while this is happening we don't</div><div class="line">    ** really care. The integrity of the transaction is already guaranteed,</div><div class="line">    ** but some stray 'cold' journals may be lying around. Returning an</div><div class="line">    ** error code won't help matters.</div><div class="line">    */</div><div class="line">    for(i=0; i&lt;db-&gt;nDb; i++)&#123; </div><div class="line">      Btree *pBt = db-&gt;aDb[i].pBt;</div><div class="line">      if( pBt )&#123;</div><div class="line">        sqlite3BtreeCommit(pBt);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">#endif</div><div class="line"></div><div class="line">  return rc;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="SQLite-Version3-3-6源代码文件结构"><a href="#SQLite-Version3-3-6源代码文件结构" class="headerlink" title="SQLite Version3.3.6源代码文件结构"></a>SQLite Version3.3.6源代码文件结构</h1><h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><ul>
<li><a href="http://pan.baidu.com/s/1gd4Sk51" target="_blank" rel="external">The Definitive Guide to SQLite</a> 密码：stno</li>
<li><a href="http://www.cnblogs.com/hustcat/archive/2009/02/13/1390340.html" target="_blank" rel="external"> SQLite入门与分析</a></li>
<li><a href="http://www.sqlite.org/atomiccommit.html" target="_blank" rel="external">sqlite官网</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/11/18/android_sqlite/" data-id="cj4zx2knf00ccqonh71alfi89" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sqlite/">sqlite</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-vc_svn_guidance" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/11/18/vc_svn_guidance/" class="article-date">
  <time datetime="2015-11-18T03:11:29.000Z" itemprop="datePublished">2015-11-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/versioncontroll/">versioncontroll</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/18/vc_svn_guidance/">svn常用命令行及常见问题</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>SVN是Subversion的简称，是一个开放源代码的版本控制系统，相较于RCS、CVS，它采用了分支管理系统，它的设计目标就是取代CVS。svn服务器有2种运行方式：独立服务器和借助apache运行。svn存储版本数据也有2种方式：BDB(一种事务安全型表类型)和FSFS(一种不需要数据库的存储系统)。因为BDB方式在服务器中断时，有可能锁住数据，所以还是FSFS方式更安全一点。</p>
<ul>
<li>包含绝大部分CVS的功能</li>
<li>目录的版本化</li>
<li>基于版本的复制，删除和重命名</li>
<li>自由的版本化元数据操作</li>
<li>混合追踪</li>
<li>文件锁</li>
<li>apache网络服务的支持，基于WebDAV/DeltaV协议</li>
<li>可执行的标签</li>
<li>独立进程模式</li>
<li>一个只读的存储镜像</li>
</ul>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><p>备注：Mac svn命令linux同样适用，TortoiseSVN命令行也可以使用。</p>
<h3 id="1、将文件checkout到本地目录"><a href="#1、将文件checkout到本地目录" class="headerlink" title="1、将文件checkout到本地目录"></a>1、将文件checkout到本地目录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">svn checkout path（path是服务器上的目录）</div></pre></td></tr></table></figure>
<p>例如：svn checkout svn://192.168.1.1/pro/domain<br>简写：svn co</p>
<h3 id="2、往版本库中添加新的文件或文件夹"><a href="#2、往版本库中添加新的文件或文件夹" class="headerlink" title="2、往版本库中添加新的文件或文件夹"></a>2、往版本库中添加新的文件或文件夹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">svn add file</div></pre></td></tr></table></figure>
<p>例如：svn add test.php(添加test.php)<br>svn add *.php(添加当前目录下所有的php文件)</p>
<h3 id="3、将改动的文件提交到版本库"><a href="#3、将改动的文件提交到版本库" class="headerlink" title="3、将改动的文件提交到版本库"></a>3、将改动的文件提交到版本库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">svn commit -m “LogMessage“ [-N] [--no-unlock] PATH(如果选择了保持锁，就使用–no-unlock开关)</div></pre></td></tr></table></figure>
<p>例如：svn commit -m “add test file for my test“ test.php<br>简写：svn ci</p>
<h3 id="4、加锁-解锁"><a href="#4、加锁-解锁" class="headerlink" title="4、加锁/解锁"></a>4、加锁/解锁</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">svn lock -m “LockMessage“ [--force] PATH</div></pre></td></tr></table></figure>
<p>例如：svn lock -m “lock test file“ test.php<br>svn unlock PATH</p>
<h3 id="5、更新到某个版本"><a href="#5、更新到某个版本" class="headerlink" title="5、更新到某个版本"></a>5、更新到某个版本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">svn update -r m path</div></pre></td></tr></table></figure>
<p>例如：<br>svn update如果后面没有目录，默认将当前目录以及子目录下的所有文件都更新到最新版本。<br>svn update -r 200 test.php(将版本库中的文件test.php还原到版本200)<br>svn update test.php(更新，于版本库同步。如果在提交的时候提示过期的话，是因为冲突，需要先update，修改文件，然后清除svn resolved，最后再提交commit)<br>简写：svn up</p>
<h3 id="6、查看文件或者目录状态"><a href="#6、查看文件或者目录状态" class="headerlink" title="6、查看文件或者目录状态"></a>6、查看文件或者目录状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">svn status path（目录下的文件和子目录的状态，正常状态不显示）</div><div class="line">【?：不在svn的控制中；M：内容被修改；C：发生冲突；A：预定加入到版本库；K：被锁定】</div><div class="line">``` bash</div><div class="line">svn status -v path(显示文件和子目录状态)</div></pre></td></tr></table></figure>
<p>第一列保持相同，第二列显示工作版本号，第三和第四列显示最后一次修改的版本号和修改人。<br>注：svn status、svn diff和 svn revert这三条命令在没有网络的情况下也可以执行的，原因是svn在本地的.svn中保留了本地版本的原始拷贝。<br>简写：svn st</p>
<h3 id="7、删除文件"><a href="#7、删除文件" class="headerlink" title="7、删除文件"></a>7、删除文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">svn delete path -m “delete <span class="built_in">test</span> fle“</div></pre></td></tr></table></figure>
<p>例如：svn delete svn://192.168.1.1/pro/domain/test.php -m “delete test file”<br>或者直接svn delete test.php 然后再svn ci -m ‘delete test file‘，推荐使用这种<br>简写：svn (del, remove, rm)</p>
<h3 id="8、查看日志"><a href="#8、查看日志" class="headerlink" title="8、查看日志"></a>8、查看日志</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">svn <span class="built_in">log</span> path</div></pre></td></tr></table></figure>
<p>例如：svn log test.php 显示这个文件的所有修改记录，及其版本号的变化</p>
<h3 id="9、查看文件详细信息"><a href="#9、查看文件详细信息" class="headerlink" title="9、查看文件详细信息"></a>9、查看文件详细信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">svn info path</div></pre></td></tr></table></figure>
<p>例如：svn info test.php</p>
<h3 id="10、比较差异"><a href="#10、比较差异" class="headerlink" title="10、比较差异"></a>10、比较差异</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">svn diff path(将修改的文件与基础版本比较)</div></pre></td></tr></table></figure>
<p>例如：svn diff test.php<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">svn diff -r m:n path(对版本m和版本n比较差异)</div></pre></td></tr></table></figure></p>
<p>例如：svn diff -r 200:201 test.php<br>简写：svn di</p>
<h3 id="11、将两个版本之间的差异合并到当前文件"><a href="#11、将两个版本之间的差异合并到当前文件" class="headerlink" title="11、将两个版本之间的差异合并到当前文件"></a>11、将两个版本之间的差异合并到当前文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">svn merge -r m:n path</div></pre></td></tr></table></figure>
<p>例如：svn merge -r 200:205 test.php（将版本200与205之间的差异合并到当前文件，但是一般都会产生冲突，需要处理一下）</p>
<h3 id="12、SVN-帮助"><a href="#12、SVN-帮助" class="headerlink" title="12、SVN 帮助"></a>12、SVN 帮助</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">svn <span class="built_in">help</span></div></pre></td></tr></table></figure>
<p>例如：svn help ci</p>
<h3 id="13、版本库下的文件和目录列表"><a href="#13、版本库下的文件和目录列表" class="headerlink" title="13、版本库下的文件和目录列表"></a>13、版本库下的文件和目录列表</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">svn list path</div></pre></td></tr></table></figure>
<p>显示path目录下的所有属于版本库的文件和目录<br>简写：svn ls</p>
<h3 id="14、创建纳入版本控制下的新目录"><a href="#14、创建纳入版本控制下的新目录" class="headerlink" title="14、创建纳入版本控制下的新目录"></a>14、创建纳入版本控制下的新目录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">svn mkdir: 创建纳入版本控制下的新目录。</div></pre></td></tr></table></figure>
<p>用法: </p>
<ul>
<li>1、mkdir PATH…</li>
<li>2、mkdir URL…<br>创建版本控制的目录。</li>
<li>1、每一个以工作副本 PATH 指定的目录，都会创建在本地端，并且加入新增调度，以待下一次的提交。</li>
<li>2、每个以URL指定的目录，都会透过立即提交于仓库中创建。<br>在这两个情况下，所有的中间目录都必须事先存在。</li>
</ul>
<h3 id="15、恢复本地修改"><a href="#15、恢复本地修改" class="headerlink" title="15、恢复本地修改"></a>15、恢复本地修改</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">svn revert: 恢复原始未改变的工作副本文件 (恢复大部份的本地修改)。revert:</div></pre></td></tr></table></figure>
<p>用法: revert PATH…<br>注意: 本子命令不会存取网络，并且会解除冲突的状况。但是它不会恢复被删除的目录。</p>
<h3 id="16、代码库URL变更"><a href="#16、代码库URL变更" class="headerlink" title="16、代码库URL变更"></a>16、代码库URL变更</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">svn switch (sw): 更新工作副本至不同的URL。</div></pre></td></tr></table></figure>
<p>用法: </p>
<ul>
<li>1、switch URL [PATH]</li>
<li>2、switch –relocate FROM TO [PATH…]<br>1、更新你的工作副本，映射到一个新的URL，其行为跟“svn update”很像，也会将服务器上文件与本地文件合并。这是将工作副本对应到同一仓库中某个分支或者标记的方法。<br>2、改写工作副本的URL元数据，以反映单纯的URL上的改变。当仓库的根URL变动(比如方案名或是主机名称变动)，但是工作副本仍旧对映到同一仓库的同一目录时使用这个命令更新工作副本与仓库的对应关系。</li>
</ul>
<h3 id="17、解决冲突"><a href="#17、解决冲突" class="headerlink" title="17、解决冲突"></a>17、解决冲突</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">svn resolved: 移除工作副本的目录或文件的“冲突”状态。</div></pre></td></tr></table></figure>
<p>用法: resolved PATH…<br>注意: 本子命令不会依语法来解决冲突或是移除冲突标记；它只是移除冲突的<br>相关文件，然后让 PATH 可以再次提交。</p>
<h3 id="18、输出指定文件或URL的内容。"><a href="#18、输出指定文件或URL的内容。" class="headerlink" title="18、输出指定文件或URL的内容。"></a>18、输出指定文件或URL的内容。</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">svn cat 目标[@版本]…如果指定了版本，将从指定的版本开始查找。</div></pre></td></tr></table></figure>
<p>svn cat -r PREV filename &gt; filename (PREV 是上一版本,也可以写具体版本号,这样输出结果是可以提交的)</p>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><p><strong> Aborting commit: ‘XXXXXXXX’remains in conflict错误  </strong></p>
<p>今天在提交项目文件到本地SVN时提示错误如下：过期：”global.php“在事务”21-1“,You have to update your working copy first.运行update更新后再次提交又出现如下错误：<br>svn: Commit failed (details follow):svn: Aborting commit: ‘global.php’ remains in conflict，查了一下SVN的手册才知道原来是多个版本之间遇到冲突。此时你需要解决冲突（合并别人的修改）。</p>
<p>举一个例子，Sally修改了sandwich.txt，Harry刚刚改变了他的本地拷贝中的这个文件并且提交到服务器，Sally在提交之前更新它的工作拷贝得到了冲突：</p>
<blockquote>
<p>$ svn update C sandwich.txt Updated to revision 2.<br>$ ls -1 sandwich.txt sandwich.txt.mine sandwich.txt.r1 sandwich.txt.r2</p>
</blockquote>
<p>在这种情况下，Subversion不会允许你提交sandwich.txt，直到你的三个临时文件被删掉。</p>
<p>如果你遇到冲突，三件事你可以选择：</p>
<ul>
<li>“手动”合并冲突文本（检查和修改文件中的冲突标志）。</li>
<li>用某一个临时文件覆盖你的工作文件。</li>
<li>运行svn revert <filename>来放弃所有的修改。</filename></li>
</ul>
<p>一旦你解决了冲突，你需要通过命令svn resolved让Subversion知道，这样就会删除三个临时文件，Subversion就不会认为这个文件是在冲突状态了。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ svn resolved sandwich.txt Resolved conflicted state of <span class="string">'sandwich.txt'</span></div></pre></td></tr></table></figure></p>
<p>例如：<br>$ svn resolved sandwich.txt<br>$ svn commit -m “Go ahead and use my sandwich, discarding Sally’s edits.</p>
<blockquote>
<p>注意：如果你修改冲突时感到混乱，你可以参考subversion生成的三个文件—包括你未作更新的文件。你也可以使用第三方的合并工具检验这三个文件。</p>
</blockquote>
<p>拷贝覆盖你的工作文件<br>如果你只是希望取消你的修改，你可以仅仅拷贝Subversion为你生成的文件替换你的工作拷贝：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ svn update C    ---&gt; sandwich.txt Updated to revision 2.</div><div class="line">$ ls sandwich.*   ---&gt; sandwich.txt  sandwich.txt.mine  sandwich.txt.r2 sandwich.txt.r1</div><div class="line">$ cp sandwich.txt.r2 sandwich.txt</div><div class="line">$ svn resolved sandwich.txt</div></pre></td></tr></table></figure></p>
<p>使用svn revert：如果你得到冲突，经过检查你决定取消自己的修改并且重新编辑，你可以恢复你的修改：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ svn revert sandwich.txt ---&gt; Reverted <span class="string">'sandwich.txt'</span></div><div class="line">$ ls sandwich.*           ---&gt; sandwich.txt</div></pre></td></tr></table></figure></p>
<p>注意:当你恢复一个冲突的文件时，不需要再运行svn resolved。</p>
<p>现在我们准备好提交修改了，注意svn resolved不像我们本章学过的其他命令一样需要参数，在任何你认为解决了冲突的时候，只需要小心运行svn resolved，一旦删除了临时文件，Subversion会让你提交这文件，即使文件中还存在冲突标记。</p>
<p>提交修改:<br>svn commit命令发送所有的修改到版本库，当你提交修改时，你需要提供一些描述修改的日志信息，你的信息会附到这个修订版本上，如果信息很简短，你可以在命令行中使用–message（-m）选项.<br>版本库不知道也不关心你的修改作为一个整体是否有意义，它只检查是否有其他人修改了同一个文件，如果别人已经这样做了，你的整个提交会失败，并且提示你一个或多个文件已经过时了.</p>
<h2 id="其他问题"><a href="#其他问题" class="headerlink" title="其他问题"></a>其他问题</h2><p><strong> 问题1：’.’ is not a working copy. Can’t open file ‘.svn/entries’: 系统找不到指定的路径。</strong><br>解答：原因是输入的访问路径不正确，如svn://192.168.6.200/如果最后少写了“/”，就会出现这种错误提示。</p>
<p><strong> 问题2：将文件checkout之后，没有出现SVN的图标，是怎么回事？</strong><br>解答：有些时候在客户端Checkout文件后，SVN的系统图标也会不显示，可以执行一下“Clean up”，就会出现SVN的系统图标。</p>
<p><strong> 问题3：为什么添加的文件，别人看不到，版本库里也没有？</strong><br>解答：最可能的原因是，你只是执行了“Add”而没有“Commit”，这样只是在本地注明某个文件是预定要增加的，而没有实际添加到版本库中，要添加到版本库必须执行“Commit”。删除文件也是一样。</p>
<p><strong> 问题4：“Commit failed。……You have to update your working copy first”  提交失败，需要首先执行更新操作。</strong><br>解答：多人同时修改同一文件，在提交前其他人已经抢先提交到SVN服务器中，导致该错误；解决方法：对工作复本中的文件进行更新即可。</p>
<p><strong> 问题5：更新时提示文件发生冲突：“One or more files are not a conflicted state。”</strong><br>解答：多人同时修改同一文件的同一部分，SVN无法自动进行合并，会导致该错误；解决方法：对工作复本中的文件和服务器的文件进行比较，手工合并即可。</p>
<p><strong> 问题6：“Commit failed；File already exists”提交失败，文件</strong>已存在。**<br>解答：版本管理系统在改变你的计算机上的工作副本时，是非常的小心的。在做任何事情之前，它都尽可能把您的意图写到你的计算机上的日志文件中去。但如果偶然地操作中断了(例如：突然停电了，您的计算机死机了)，那么日志文件记录就可能同您最后的工作状态不一致。一种建议解决途径：先把要提交的东西拷出来放到其它目录，再更新本地文件，然后把拷出来的文件重新放回去提交。</p>
<p><strong> 问题7：Working copy’</strong>’locked. Please execute the ’Clean up’command.**<br>解答：Subversion客户端在提交内容之前会在本地的工作拷贝写日志，防止其他客户端再次作操作，如果这个提交过程中发生错误，就会存在未清理的日志，解决这个问题之需要执行“清理”操作，整理你的计算机上的工作副本，清理错误的日志记录，使您可以继续操作。</p>
<p><strong> 问题8：执行clean up时，出现错误“Subversion reported an error while doing a cleanup!” ‘</strong>‘ is not a working copy directory ”**<br>解答：遇到这种情况，先删除隐藏文件夹.svn中的tmp下面的临时文件，再执行clean up。</p>
<p><strong> 问题9：因为仓库与目录很多，使用TSVN每次选择目录URL of repository有很多地址，如何才清除呢？像清除浏览器中的历史那样，用什么方法呢？</strong><br>解答：右键-&gt;TortoiseSVN-&gt;Settings-&gt;Saved Data，就可以清除你想要的东西了，包括URL、log、窗口大小、密码缓存等。</p>
<p><strong> 问题10：在SVN中选中一个目录show log时，出现了某些版本只显示版本号和（no date），没有其他信息，什么原因引起的？</strong><br>解答：出现了（no date）的revision，为其他人修改了你所没有权限访问的某个目录下的文件。</p>
<p><strong> 问题11：Attempted to lock an already-locked dir is not under version control</strong><br>解答：I deleted the log file in the .svn directory (I also deleted the offending file in .svn/props-base)<br>      Then did a cleanup..           Then resumed my update.</p>
<p><strong> 问题12：svn: warning: ‘xxxxx’ is already under version control 解决办法?</strong><br>解答：只添加相应目录到SVN，但不添加目录下的文件:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#svn st uploads|grep ^?|awk "&#123;print /$2&#125;"|xargs svn add -N</span></div></pre></td></tr></table></figure></p>
<p>原因:  很可能是 .svn 隐藏目录版本信息被修改了<br>解决办法:<br>删除uploads目录下的.svn目录及下面的文件（保留uploads目录的.svn）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#find uploads |grep 'uploads/[^/.]*/.svn'|xargs rm -rf  //或者：find . -name ".svn" | xargs rm -Rf</span></div></pre></td></tr></table></figure></p>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul>
<li><a href="http://baike.baidu.com/view/429581.htm" target="_blank" rel="external">百度百科</a></li>
<li><a href="http://blog.sina.com.cn/s/blog_5fb39f910101dtki.html" target="_blank" rel="external">svn常见问题，报错，命令及我的总结</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/11/18/vc_svn_guidance/" data-id="cj4zx2kkn006wqonhrnlyn2xs" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/svn/">svn</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-android_fresco2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/11/17/android_fresco2/" class="article-date">
  <time datetime="2015-11-17T09:42:29.000Z" itemprop="datePublished">2015-11-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/android/">android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/17/android_fresco2/">图片缓存框架Fresco使用详解(二)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这篇文章主要讲述Fresco在AS中的详细使用流程。</p>
<h2 id="引入Fresco"><a href="#引入Fresco" class="headerlink" title="引入Fresco"></a>引入Fresco</h2><p>类库发布到了Maven中央库，Android Studio 或者 Gradle：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    compile <span class="string">'com.facebook.fresco:fresco:0.8.1'</span>  //最近的版本</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="关于在Android-Studio中编译"><a href="#关于在Android-Studio中编译" class="headerlink" title="关于在Android Studio中编译"></a>关于在Android Studio中编译</h2><p>Fresco 是一个典型的Android Studio 项目。如果想编译源码, 看demo项目，可以通过gradle或者Android Studio。一直以来，在国内更新Android SDK以及使用Android Studio导入项目时，都是一件麻烦的事情。使用gradle 或者 Android Studio会遇到一些网络障碍。这些障碍，需要FQ才能顺利完成编译。<br>另外对于NDK，因为Android Studio还支持不够。所以需要在命令行下预编译。<br>具体可以参考：</p>
<ul>
<li><a href="http://www.liaohuqiu.net/cn/posts/about-red-apricot-and-compiling-fresco/" target="_blank" rel="external">关于红杏的公益代理, Android Studio以及freso的编译</a></li>
<li><a href="https://github.com/liaohuqiu/fresco-demo-for-gradle" target="_blank" rel="external">DEMO</a></li>
</ul>
<p><strong> 编译Fresco</strong></p>
<ul>
<li>设置好代理，从github顺利clone项目</li>
<li>给SDK Manager 设置好代理，顺利更新sdk到最新</li>
<li>给Android Studio设置好代理，顺利打开freso项目<br>Open an exsiting Android Studio Project，选择build.gradle</li>
<li>但是，Android Studio目前还不支持NDK，所以需要在命令行下预编译。//最新版本支持NDK（1.4）<br>./gradlew :sample:assembleDebug</li>
</ul>
<p>好了，编译完成之后，Android Studio就可以正常运行了。</p>
<h2 id="开始使用-Fresco"><a href="#开始使用-Fresco" class="headerlink" title="开始使用 Fresco"></a>开始使用 Fresco</h2><p>如果你仅仅是想简单下载一张网络图片，在下载完成之前，显示一张占位图，那么简单使用 SimpleDraweeView 即可。<br>为了下载网络图片，请确保在 AndroidManifest.xml 中有以下权限：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.INTERNET"</span>/&gt;</span></div></pre></td></tr></table></figure></p>
<p>在 Application 初始化时，在应用调用 setContentView() 之前，进行初始化：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Fresco.initialize(context);</div></pre></td></tr></table></figure></p>
<p>在xml布局文件中, 加入命名空间：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 其他元素 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> </span></div><div class="line">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></div><div class="line">    <span class="attr">xmlns:fresco</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span>&gt;</div></pre></td></tr></table></figure></p>
<p>加入SimpleDraweeView:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">com.facebook.drawee.view.SimpleDraweeView</span></span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/my_image_view"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"20dp"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"20dp"</span></div><div class="line">    <span class="attr">fresco:placeholderImage</span>=<span class="string">"@drawable/my_drawable"</span></div><div class="line">  /&gt;</div></pre></td></tr></table></figure></p>
<p><strong> 开始加载图片</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Uri uri = Uri.parse(<span class="string">"https://raw.githubusercontent.com/facebook/fresco/gh-pages/static/fresco-logo.png"</span>);</div><div class="line">SimpleDraweeView draweeView = (SimpleDraweeView) findViewById(R.id.my_image_view);</div><div class="line">draweeView.setImageURI(uri);</div></pre></td></tr></table></figure></p>
<p>剩下的，Fresco会替你完成:</p>
<ul>
<li>显示占位图直到加载完成；</li>
<li>下载图片；</li>
<li>缓存图片；</li>
<li>图片不再显示时，从内存中移除；<br>等等等等。</li>
</ul>
<h2 id="关键概念"><a href="#关键概念" class="headerlink" title="关键概念"></a>关键概念</h2><p><strong> Drawees</strong><br>Drawees 负责图片的呈现，包含几个组件，有点像MVC模式。</p>
<p><strong> DraweeView</strong><br>继承于 <a href="http://developer.android.com/reference/android/view/View.html" target="_blank" rel="external">View</a>, 负责图片的显示。<br>一般情况下，使用SimpleDraweeView 即可. 简单的用法，在这个页面：<a href="http://fresco-cn.org/docs/index.html" target="_blank" rel="external">开始使用</a> 。<br>它支持很多自定义效果，参见这里: <a href="http://fresco-cn.org/docs/using-drawees-xml.html" target="_blank" rel="external">自定义显示效果</a>.</p>
<p><strong> DraweeHierarchy</strong><br>DraweeHierarchy 用于组织和维护最终绘制和呈现的<a href="http://developer.android.com/reference/android/graphics/drawable/Drawable.html" target="_blank" rel="external">Drawable对象</a>，相当于MVC中的M(Model)。<br>如果你想在Java代码中自定义图片的展示，可以通过这类实现，具体的请参考这里: <a href="http://fresco-cn.org/docs/using-drawees-code.html" target="_blank" rel="external">在Java代码中自定义显示效果</a></p>
<p><strong> DraweeController</strong><br>DraweeController 负责和 image loader 交互（默认是Fresco中 image pipeline），可以创建一个这个类的实例，来实现对所要显示的图片做更多的控制。</p>
<p><strong> DraweeControllerBuilder</strong><br>DraweeControllers 由 DraweeControllerBuilder 采用 Builder 模式创建，创建之后，不可修改。具体参见: <a href="http://fresco-cn.org/docs/using-controllerbuilder.html" target="_blank" rel="external">使用ControllerBuilder</a>。</p>
<p><strong> Listeners</strong><br>使用 ControllerListener 的一个场景就是设置一个 <a href="http://fresco-cn.org/docs/listening-download-events.html" target="_blank" rel="external">Listener</a>监听图片的下载。</p>
<p><strong> Image Pipeline</strong><br>Fresco 的 Image Pipeline 负责图片的获取和管理。图片可以来自远程服务器，本地文件，或者Content Provider，本地资源。压缩后的文件缓存在本地存储中，Bitmap数据缓存在内存中。</p>
<p>在5.0系统以下，Image Pipeline 使用`pinned purgeables*将Bitmap数据避开Java堆内存，存在ashmem中。这要求图片不使用时，要显式地释放内存。</p>
<p>SimpleDraweeView 自动处理了这个释放过程，所以没有特殊情况，尽量使用SimpleDraweeView，在特殊的场合，如果有需要，也可以直接控制Image Pipeline。</p>
<p><strong> ImageRequest</strong><br>ImageRequest存储着Image Pipeline处理被请求图片所需要的有用信息(Uri、是否渐进式图片、是否返回缩略图、缩放、是否自动旋转等。)。</p>
<p>它仅仅用来装信息，而且一经初始化后就无法改变内容（即Immutable，不过可以获取内容）。 并且它的初始化只能通过ImageRequest.fromUri(Uri uri)或ImageRequestBuilder.build()来实现。</p>
<p>SimpleDraweeView调用setUri(Uri)会产生一个默认的ImageRequest含有指定Uri信息，如果需要修改ImageRequest其他信息，必须手动创建ImageRequest，并在PipelineDraweeControllerBuilder调用.build()之前使用.setImageRequest设置它。</p>
<h2 id="支持的URIs"><a href="#支持的URIs" class="headerlink" title="支持的URIs"></a>支持的URIs</h2><p><strong> Fresco 支持许多URI格式。</strong></p>
<p>特别注意：Fresco 不支持 相对路径的URI. 所有的URI都必须是绝对路径，并且带上该URI的scheme。</p>
<p>如下：</p>
<table><tr><th>类型</th><th>Scheme</th><th>示例</th></tr><tr><td>远程图片</td><td>http://, https://</td><td>HttpURLConnection 或者参考<a href="http://fresco-cn.org/docs/using-other-network-layers.html" target="_blank" rel="external">使用其他网络加载方案</a></td></tr><tr><td>本地文件</td><td>file://</td><td>FileInputStream</td></tr><tr><td>Content provider</td><td>content://</td><td>ContentResolver</td></tr><tr><td>asset目录下的资源</td><td>asset://</td><td>AssetManager</td></tr><tr><td>res目录下的资源</td><td>res://</td><td>Resources.openRawResource</td></tr></table>

<p><strong> res 示例:</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Uri uri = Uri.parse(<span class="string">"res://包名(实际可以是任何字符串甚至留空)/"</span> + R.drawable.ic_launcher);</div></pre></td></tr></table></figure></p>
<p><strong> 注意：</strong><br>只有图片资源才能使用在Image pipeline中，比如(PNG)。其他资源类型，比如字符串，或者XML Drawable在Image pipeline中没有意义。所以加载的资源不支持这些类型。<br>像ShapeDrawable这样声明在XML中的drawable可能引起困惑。注意到这毕竟不是图片，如果想把这样的drawable作为图像显示。<br>那么把这个drawable设置为占位图，然后把URI设置为null。</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li><a href="https://github.com/facebook/fresco" target="_blank" rel="external">GitHub Fresco</a></li>
<li><a href="http://fresco-cn.org/docs/index.html#_" target="_blank" rel="external">Fresco中文文档</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/11/17/android_fresco2/" data-id="cj4zx2khs001yqonhjhdfurat" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/imageloader/">imageloader</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-android_studio_study" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/11/13/android_studio_study/" class="article-date">
  <time datetime="2015-11-13T08:11:29.000Z" itemprop="datePublished">2015-11-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/android/">android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/13/android_studio_study/">Android Studio学习笔记1</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>开发者      Google<br>稳定版本    1.4（2015年9月30日）<br>开发状态    Stable<br>编程语言    Java<br>操作系统    跨平台<br>类型        Android集成开发环境<br>许可协议    Apache 2.0<br>网站  developer.android.com/sdk/index.html</p>
<p>Android Studio是一个为Android平台开发程序的集成开发环境。2013年5月16日由Google产品经理Ellie Powers在Google I/O上发布，可供开发者免费使用。2013年5月发布早期预览版本，版本号为0.1。2014年6月发布0.8版本，至此进入beta阶段。[2]第一个稳定版本1.0于2014年12月8日发布。Android Studio基于JetBrains IntelliJ IDEA，为Android开发特殊定制，并在Windows、OS X和Linux平台上均可运行。</p>
<h2 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h2><p>当前版本以下功能可用：</p>
<ul>
<li>可视化布局： WYSIWYG编辑器 - 实时编码 - 实时程序界面预览；[9]</li>
<li>开发者控制台： 优化提示，协助翻译，来源跟踪，宣传和营销曲线图 - 使用率度量；</li>
<li>Beta版本测试，并阶段性展示；</li>
<li>基于Gradle的构建支持；</li>
<li>Android特定代码重构和快速修复；</li>
<li>Lint提示工具更好地对程序性能、可用性、版本兼容和其他问题进行控制捕捉；</li>
<li>支持ProGuard和应用签名功能；</li>
<li>基于模板的向导来生成常用的Android应用设计和组件；</li>
<li>自带布局编辑器，可让开发者拖放UI组件，并预览在不同尺寸设备上的UI显示效果，等等。</li>
<li>支持构建Android Wear应用</li>
<li>内置Google Cloud Platform支持，支持Google Cloud Messaging和App Engine的集成。</li>
</ul>
<h2 id="系统要求"><a href="#系统要求" class="headerlink" title="系统要求"></a>系统要求</h2><table border="1" bordercolor="#000000" style="border-collapse:collapse;"><tr><td width="149"></td><td width="364">Windows</td><td width="325">OS X</td><td width="468">Linux</td></tr><tr><td>操作系统版本</td><td>Microsoft Windows 10/8.1/8/7/Vista/2003/XP (32或64位)</td><td>OS X 10.8.5或更高版本，最高10.10.5 (Yosemite)</td><td>GNOME、KDE、Unity desktop on Ubuntu、Fedora、GNU/Linux Debian</td></tr><tr><td>内存</td><td colspan="3">最低2 GB，推荐4 GB内存</td></tr><tr><td>磁盘空间</td><td colspan="3">500 MB磁盘空间</td></tr><tr><td>Space for Android SDK</td><td colspan="3">至少1 GB用于Android SDK，模拟器系统映像和缓存</td></tr><tr><td>JDK版本</td><td colspan="3">Java Development Kit (JDK) 7或更高版本</td></tr><tr><td>屏幕分辨率</td><td colspan="3">最低1280×800屏幕分辨率</td></tr></table>

<h2 id="Android-Studio和Eclipse-ADT比较"><a href="#Android-Studio和Eclipse-ADT比较" class="headerlink" title="Android Studio和Eclipse ADT比较"></a>Android Studio和Eclipse ADT比较</h2><table><tr><td>特性</td><td>Android Studio</td><td>Eclipse ADT</td></tr><tr><td>编译系统</td><td>Gradle</td><td>Ant</td></tr><tr><td>基于Maven的构建依赖</td><td>是</td><td>否</td></tr><tr><td>构建变体和多APK生成</td><td>是</td><td>否</td></tr><tr><td>高级的Android代码完成和重构</td><td>是</td><td>否</td></tr><tr><td>图形布局编辑器</td><td>是</td><td>是</td></tr><tr><td>APK签名和密钥库管理</td><td>是</td><td>是</td></tr><tr><td>NDK支持</td><td>Beta</td><td>是</td></tr></table>

<h2 id="AS常用技巧汇总"><a href="#AS常用技巧汇总" class="headerlink" title="AS常用技巧汇总"></a>AS常用技巧汇总</h2><p>下面的使用技巧是实际开发中可能使用到的，后续会不断更新。</p>
<h3 id="Android-Studio中如何打JAR包"><a href="#Android-Studio中如何打JAR包" class="headerlink" title="Android Studio中如何打JAR包"></a>Android Studio中如何打JAR包</h3><p>Android Studio中对于library类型的Moudle，默认打出来的是AAR包，但有时候我们的SDK还需要共享给一些其他eclipse的项目使用，这样我们就需要输出JAR包，<br>可以通过在Moudle中的build.gradle加入task来实现<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">task makeJar(<span class="built_in">type</span>: Copy) &#123;</div><div class="line">    delete <span class="string">'build/libs/mysdk.jar'</span></div><div class="line">    from(<span class="string">'build/intermediates/bundles/release/'</span>)</div><div class="line">    into(<span class="string">'build/libs/'</span>)</div><div class="line">    include(<span class="string">'classes.jar'</span>)</div><div class="line">    rename (<span class="string">'classes.jar'</span>, <span class="string">'mysdk.jar'</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line">makeJar.dependsOn(build)</div></pre></td></tr></table></figure></p>
<p>在终端执行生成JAR包<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./gradview makeJar</div></pre></td></tr></table></figure></p>
<p>在以下目录就可以找到我们生成的JAR包<br><img src="http://7xjq5l.com1.z0.glb.clouddn.com/18501-83bd39417153d8f1.png" alt=""></p>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul>
<li><a href="https://developer.android.com/tools/studio/index.html" target="_blank" rel="external">官方网站</a></li>
<li><a href="https://www.youtube.com/watch?v=lmv1dTnhLH4#t=0h0m0s" target="_blank" rel="external">Youtube介绍</a></li>
<li><a href="http://www.aswifter.com" target="_blank" rel="external">aswifter APP开发者</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/11/13/android_studio_study/" data-id="cj4zx2kj60040qonh2x5pp7fw" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/androidstudio/">androidstudio</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-android_studio_gradle_guide" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/11/12/android_studio_gradle_guide/" class="article-date">
  <time datetime="2015-11-12T03:11:29.000Z" itemprop="datePublished">2015-11-12</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/android/">android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/12/android_studio_gradle_guide/">AndroidStudio之Gradle Guide官方文档翻译</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>google推出了全新的Android Studio集成开发环境，其中Android项目的结构与Eclipse的Android项目结构有很大的区别，原因就在于两开发环境使用的构建工具不同。<br>Android Studio使用Gradle构建工具，Eclipse的ADT插件使用的是Ant构建工具。因为两个构建工具的区别，导致习惯了Eclipse开发环境的开发者刚开始比较难适应Android Studio。如果要迁移到Android Studio，建议最好了解下Gradle构建工具。Gradle构建工具是任务驱动型的构建工具，并且可以通过各种Plugin插件扩展功能以适应各种构建任务。对应Android项目的Gradle插件就是Android Gradle Plugin。本文是Google官方的Android Gradle Plugin使用指南翻译，如英语水平还不错的同学，建议直接查看官方原文。</p>
<h2 id="1-Introduction（简介"><a href="#1-Introduction（简介" class="headerlink" title="1.Introduction（简介)"></a>1.Introduction（简介)</h2><h3 id="1-1-gradle构建系统的目标"><a href="#1-1-gradle构建系统的目标" class="headerlink" title="1.1 gradle构建系统的目标"></a>1.1 gradle构建系统的目标</h3><p>采用Gradle作为新构建系统的目标：</p>
<ul>
<li>让重用代码和资源变得更加容易。</li>
<li>让创建同一应用程序的不同版本变得更加容易，无论是多个apk发布版本还是同一个应用的不同定制版本。</li>
<li>让构建过程变得更加容易配置，扩展和定制。</li>
<li>整合优秀的IDE</li>
</ul>
<h3 id="1-2-为什么使用gradle"><a href="#1-2-为什么使用gradle" class="headerlink" title="1.2 为什么使用gradle"></a>1.2 为什么使用gradle</h3><p>Gradle是一个优秀的构建系统和构建工具，它允许通过插件创建自定义的构建逻辑。 我们基于Gradle以下的一些特点而选择了它：</p>
<ul>
<li>采用了Domain Specific Language(DSL语言)来描述和控制构建逻辑。</li>
<li>构建文件基于Groovy，并且允许通过混合声明DSL元素和使用代码来控制DSL元素以控制自定义的构建逻辑。</li>
<li>支持Maven或者Ivy的依赖管理。</li>
<li>非常灵活。允许使用最好的实现，但是不会强制实现的方式。</li>
<li>插件可以提供自己的DSL和API以供构建文件使用。</li>
<li>良好的API工具供IDE集成。</li>
</ul>
<h2 id="2-Requirements（要求）"><a href="#2-Requirements（要求）" class="headerlink" title="2.Requirements（要求）"></a>2.Requirements（要求）</h2><ul>
<li>Gradle 2.2版本。</li>
<li>SDK build tools 要求版本19.0.0。一些新的特征可能需要更高版本。</li>
</ul>
<h2 id="3-Basic-Project（基本项目）"><a href="#3-Basic-Project（基本项目）" class="headerlink" title="3.Basic Project（基本项目）"></a>3.Basic Project（基本项目）</h2><p>一个Gradle项目的构建过程定义在build.gradle文件中，位于项目的根目录下。(可以参考<a href="https://docs.gradle.org/current/userguide/userguide_single.html" target="_blank" rel="external">Gradle User Guide</a>)</p>
<h3 id="3-1-简单的构建文件"><a href="#3-1-简单的构建文件" class="headerlink" title="3.1 简单的构建文件"></a>3.1 简单的构建文件</h3><p>最简单的Android项目的build.gradle文件包含以下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">buildscript &#123;</div><div class="line">    repositories &#123;</div><div class="line">        mavenCentral()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    dependencies &#123;</div><div class="line">        classpath <span class="string">'com.android.tools.build:gradle:0.11.1'</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">apply plugin: <span class="string">'android'</span></div><div class="line"></div><div class="line">android &#123;</div><div class="line">    compileSdkVersion 19</div><div class="line">    buildToolsVersion <span class="string">"19.0.0"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里包括了Android build file的3个主要部分：</p>
<p>buildscrip{…}这里配置了驱动构建过程的代码。</p>
<p>在这个部分，它声明了使用Maven仓库，并且声明了一个maven文件的依赖路径。这个文件就是包含了1.3.1版本android gradle插件的库。</p>
<blockquote>
<p>注意：这里的配置只影响控制构建过程的代码，不影响项目源代码。项目本身需要声明自己的仓库和依赖关系，稍后将会提到这部分。</p>
</blockquote>
<p>接下来，跟前面提到的Java Plugin一样添加了android plugin。</p>
<p>最后，andorid{…}配置了所有android构建过程需要的参数。这里也是Android DSL的入口点。</p>
<p>默认情况下，只需要配置目标编译SDK版本和编译工具版本，即compileSdkVersion和buildToolsVersion属性。 这个complieSdkVersion属性相当于旧构建系统中project.properites文件中的target属性。这个新的属性可以跟旧的target属性一样指定一个int或者String类型的值。</p>
<blockquote>
<p>重要：你只能添加android plugin。同时添加java plugin会导致构建错误。<br>注意：你同样需要在相同路径下添加一个local.properties文件，并使用sdk.dir属性来设置SDK路径。 另外，你也可以通过设置ANDROID_HOME环境变量，这两种方式没有什么不同，根据你自己的喜好选择其中一种设置。</p>
</blockquote>
<h3 id="3-2-项目结构"><a href="#3-2-项目结构" class="headerlink" title="3.2 项目结构"></a>3.2 项目结构</h3><p>上面提到的基本的构建文件需要一个默认的文件夹结构。Gradle遵循约定优先于配置的概念，在可能的情况尽可能提供合理的默认配置参数。<br>基本的项目开始于两个名为“source sets”的组件，即main source code和test code。它们分别位于：</p>
<ul>
<li>src/main/</li>
<li>src/androidTest/</li>
</ul>
<p>里面每一个存在的文件夹对应相应的源组件。 对于Java plugin和Android plugin来说，它们的Java源代码和资源文件路径如下：</p>
<ul>
<li>java/</li>
<li>resources/</li>
</ul>
<p>但对于Android plugin来说，它还拥有以下特有的文件和文件夹结构：</p>
<ul>
<li>AndroidManifest.xml</li>
<li>res/</li>
<li>assets/</li>
<li>aidl/</li>
<li>rs/</li>
<li>jni/</li>
</ul>
<blockquote>
<p>注意：src/androidTest/AndroidManifest.xml是不需要的，它会自动被创建。</p>
</blockquote>
<p><strong> 3.1.1 项目结构配置</strong><br>当默认的项目结构不适用的时候，你可能需要去配置它。根据Gradle文档，重新为Java项目配置sourceSets可以使用以下方法：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">sourceSets &#123;</div><div class="line">    main &#123;</div><div class="line">        java &#123;</div><div class="line">            srcDir <span class="string">'src/java'</span></div><div class="line">        &#125;</div><div class="line">        resources &#123;</div><div class="line">            srcDir <span class="string">'src/resources'</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>注意：srcDir将会被添加到指定的已存在的源文件夹中（这在Gradle文档中没有提到，但是实际上确实会这样执行）。</p>
</blockquote>
<p>替换默认的源代码文件夹，你可能想要使用能够传入一个路径数组的srcDirs来替换单一的srcDir。以下是使用调用对象的另一种不同方法：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sourceSets &#123;</div><div class="line">    main.java.srcDirs = [<span class="string">'src/java'</span>]</div><div class="line">    main.resources.srcDirs = [<span class="string">'src/resources'</span>]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>想要获取更多信息，可以参考Gradle文档中关于Java Pluign的部分。</p>
<p>Android Plugin使用的是类似的语法。但是由于它使用的是自己的sourceSets，这些配置将会被添加在android对象中。</p>
<p>以下是一个示例，它使用了旧项目结构中的main源码，并且将androidTest sourceSet组件重新映射到tests文件夹。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    sourceSets &#123;</div><div class="line">        main &#123;</div><div class="line">            manifest.srcFile <span class="string">'AndroidManifest.xml'</span></div><div class="line">            java.srcDirs = [<span class="string">'src'</span>]</div><div class="line">            resources.srcDirs = [<span class="string">'src'</span>]</div><div class="line">            aidl.srcDirs = [<span class="string">'src'</span>]</div><div class="line">            renderscript.srcDirs = [<span class="string">'src'</span>]</div><div class="line">            res.srcDirs = [<span class="string">'res'</span>]</div><div class="line">            assets.srcDirs = [<span class="string">'assets'</span>]</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        androidTest.setRoot(<span class="string">'tests'</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>注意：由于旧的项目结构将所有的源文件（java,aidl,renderscripthe和java资源文件）都放在同一个目录里面，所以我们需要将这些sourceSet组件重新映射到src目录下。</p>
<p>注意：setRoot()方法将移动整个组件（包括它的子文件夹）到一个新的文件夹。示例中将会移动src/androidTest/<em>到tests/</em>下。 以上这些是Android特有的，如果配置在Java的sourceSets里面将不会有作用。</p>
</blockquote>
<p>以上也是将旧构建系统项目迁移到新构建系统需要做的迁移工作。</p>
<h3 id="3-3-构建任务"><a href="#3-3-构建任务" class="headerlink" title="3.3 构建任务"></a>3.3 构建任务</h3><p><strong> 3.3.1 通用任务</strong><br>添加一个插件到构建文件中将会自动创建一系列构建任务(build tasks)去执行（注：gradle属于任务驱动型构建工具，它的构建过程是基于Task的）。Java plugin和Android plugin都会创建以下task：</p>
<ul>
<li>assemble 这个task将会组合项目的所有输出。</li>
<li>check 这个task将会执行所有检查。</li>
<li>build 这个task将会执行assemble和check两个task的所有工作</li>
<li>clean 这个task将会清空项目的输出。</li>
</ul>
<p>实际上assemble，check，build这三个task不做任何事情。它们只是一个Task标志，用来告诉android plugin添加实际需要执行的task去完成这些工作。</p>
<p>这就允许你去调用相同的task，而不需要考虑当前是什么类型的项目，或者当前项目添加了什么plugin。 例如，添加了findbugs plugin将会创建一个新的task并且让check task依赖于这个新的task。当check task被调用的时候，这个新的task将会先被调用。</p>
<p>在命令行环境中，你可以执行以下命令来获取更多高级别的task：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gradle tasks</div></pre></td></tr></table></figure></p>
<p>查看所有task列表和它们之间的依赖关系可以执行以下命令：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gradle tasks --all</div></pre></td></tr></table></figure></p>
<blockquote>
<p>注意：Gradle会自动监视一个task声明的所有输入和输出。 两次执行build task并且期间项目没有任何改动，gradle将会使用UP-TO-DATE通知所有task。这意味着第二次build执行的时候不会请求任何task执行。这允许task之间互相依赖，而不会导致不需要的构建请求被执行。</p>
</blockquote>
<p><strong> 3.3.2 Java项目的Task</strong><br>Java plugin主要创建了两个task，依赖于main task（一个标识性的task）：</p>
<ul>
<li>assemble<ul>
<li>jar 这个task创建所有输出</li>
</ul>
</li>
<li>check<ul>
<li>test 这个task执行所有的测试。</li>
</ul>
</li>
</ul>
<p>jar task自身直接或者间接依赖于其他task：classes task将会被调用于编译java源码。 testClasses task用于编译测试，但是它很少被调用，因为test task依赖于它（类似于classes task）。</p>
<p>通常情况下，你只需要调用到assemble和check，不需要其他task。</p>
<p>你可以在Gradle文档中查看java plugin的全部task。</p>
<p><strong> 3.3.3 Android项目的tasks</strong><br>Android plugin使用相同的约定以兼容其他插件，并且附加了自己的标识性task，包括：</p>
<ul>
<li>assemble 这个task用于组合项目中的所有输出。</li>
<li>check 这个task用于执行所有检查。</li>
<li>connectedCheck 这个task将会在一个指定的设备或者模拟器上执行检查，它们可以同时在所有连接的设备上执行。</li>
<li>deviceCheck 通过APIs连接远程设备来执行检查，这是在CL服务器上使用的。</li>
<li>build 这个task执行assemble和check的所有工作。</li>
<li>clean 这个task清空项目的所有输出。</li>
</ul>
<p>这些新的标识性task是必须的，以保证能够在没有设备连接的情况下执行定期检查。 注意build task不依赖于deviceCheck或者connectedCheck。<br>一个Android项目至少拥有两个输出：debug APK（调试版APK)和release APK（发布版APK）。每一个输出都拥有自己的标识性task以便能够单独构建它们。<br>assemble</p>
<ul>
<li>assembleDebug </li>
<li>assembleRelease</li>
</ul>
<p>它们都依赖于其它一些tasks以完成构建一个APK需要多个步骤。其中assemble task依赖于这两个task，所以执行assemble将会同时构建出两个APK。</p>
<blockquote>
<p>小提示：gradle在命令行终端上支持骆驼命名法的task简称，例如，执行<br>      gradle aR<br>  命令等同于执行<br>      gradle assembleRelease。</p>
</blockquote>
<p>check task也拥有自己的依赖：</p>
<ul>
<li>check<ul>
<li>lint</li>
</ul>
</li>
<li>connectedCheck<ul>
<li>connectedAndroidTest</li>
<li>connectedUiAutomatorTest(目前还没有应用到）</li>
</ul>
</li>
<li>deviceCheck<ul>
<li>这个test依赖于test创建时，其它实现测试扩展点的插件。</li>
</ul>
</li>
</ul>
<p>最后，只要task能够被安装（那些要求签名的task），android plugin就会为所有构建类型（debug，release，test）安装或者卸载。</p>
<h3 id="3-4-基本的构建定制"><a href="#3-4-基本的构建定制" class="headerlink" title="3.4 基本的构建定制"></a>3.4 基本的构建定制</h3><p>Android plugin提供了大量DSL用于直接从构建系统定制大部分事情。</p>
<p><strong> 3.4.1 Manifest属性</strong><br>通过SDL可以配置一下manifest选项：</p>
<ul>
<li>minSdkVersion</li>
<li>targetSdkVersion</li>
<li>versionName</li>
<li>applicationId (有效的包名 – 更多详情请查阅ApplicationId 对比 PackageName)</li>
<li>package Name for the test application</li>
<li>Instrumentation test runner</li>
</ul>
<p>例如：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    compileSdkVersion 19</div><div class="line">    buildToolsVersion <span class="string">"19.0.0"</span></div><div class="line"></div><div class="line">    defaultConfig &#123;</div><div class="line">        versionCode 12</div><div class="line">        versionName <span class="string">"2.0"</span></div><div class="line">        minSdkVersion 16</div><div class="line">        targetSdkVersion 16</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在android元素中的defaultConfig元素中定义所有配置。</p>
<p>之前的Android Plugin版本使用packageName来配置manifest文件中的packageName属性。从0.11.0版本开始，你需要在build.gradle文件中使用applicationId来配置manifest文件中的packageName属性。 这是为了消除应用程序的packageName（也是程序的ID）和java包名所引起的混乱。</p>
<p>在构建文件中定义的强大之处在于它是动态的。 例如，可以从一个文件中或者其它自定义的逻辑代码中读取版本信息：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">def <span class="function"><span class="title">computeVersionName</span></span>() &#123;</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"></div><div class="line">android &#123;</div><div class="line">    compileSdkVersion 19</div><div class="line">    buildToolsVersion <span class="string">"19.0.0"</span></div><div class="line"></div><div class="line">    defaultConfig &#123;</div><div class="line">        versionCode 12</div><div class="line">        versionName computeVersionName()</div><div class="line">        minSdkVersion 16</div><div class="line">        targetSdkVersion 16</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>注意：不要使用与在给定范围内的getter方法可能引起冲突的方法名。例如，在defaultConfig{…}中调用getVersionName()将会自动调用defaultConfig.getVersionName()方法，你自定义的getVersionName()方法就被取代掉了。</p>
<p>如果一个属性没有使用DSL进行设置，一些默认的属性值将会被使用。以下表格是可能使用到的值:</p>
<table><tr><th>Property Name</th><th>Default value in DSL object</th><th>Default value</th></tr><tr><td>versionCode</td><td>-1</td><td>value from manifest if present</td></tr><tr><td>versionName</td><td>null</td><td>value from manifest if present</td></tr><tr><td>minSdkVersion</td><td>-1</td><td>value from manifest if present</td></tr><tr><td>targetSdkVersion</td><td>-1</td><td>value from manifest if present</td></tr><tr><td>applicationId</td><td>null</td><td>value from manifest if present</td></tr><tr><td>testApplicationId</td><td>null</td><td>applicationId + “.test”</td></tr><tr><td>testInstrumentationRunner</td><td>null</td><td>android.test.InstrumentationTestRunner</td></tr><tr><td>signingConfig</td><td>null</td><td>null</td></tr><tr><td>proguardFile</td><td>N/A (set only)</td><td>N/A (set only)</td></tr><tr><td>proguardFiles</td><td>N/A (set only)</td><td>N/A (set only)</td></tr></table>

<p>如果你在构建脚本中使用自定义代码逻辑请求这些属性，那么第二列的值将非常重要。例如，你可能会写：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (android.defaultConfig.testInstrumentationRunner == null) &#123;</div><div class="line">    // assign a better default...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果这个值一直保持null，那么在构建执行期间将会实际替换成第三列的默认值。但是在DSL元素中并没有包含这个默认值，所以，你无法查询到这个值。 除非是真的需要，这是为了预防解析应用的manifest文件。</p>
<p><strong> 3.4.2 构建类型</strong></p>
<p>默认情况下，Android Plugin会自动给项目设置同时构建应用程序的debug和release版本。 两个版本之间的不同主要围绕着能否在一个安全设备上调试，以及APK如何签名。</p>
<p>Debug版本采用使用通用的name/password键值对自动创建的数字证书进行签名，以防止构建过程中出现请求信息。Release版本在构建过程中没有签名，需要稍后再签名。</p>
<p>这些配置通过一个BuildType对象来配置。默认情况下，这两个实例都会被创建，分别是一个debug版本和一个release版本。</p>
<p>Android plugin允许像创建其他构建类型一样定制debug和release实例。这需要在buildTypes的DSL容器中配置：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    buildTypes &#123;</div><div class="line">        debug &#123;</div><div class="line">            applicationIdSuffix <span class="string">".debug"</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        jnidebug.initWith(buildTypes.debug)</div><div class="line">        jnidebug &#123;</div><div class="line">            packageNameSuffix <span class="string">".jnidebug"</span></div><div class="line">            jnidebugBuild <span class="literal">true</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">`</div></pre></td></tr></table></figure></p>
<p>以上代码片段实现了以下功能：</p>
<ul>
<li>配置默认的debug构建类型<ul>
<li>将debug版本的包名设置为.debug以便能够同时在一台设备上安装debug和release版本的apk。</li>
</ul>
</li>
<li>创建了一个名为jnidebug的新构建类型，并且这个构建类型是debug构建类型的一个副本。</li>
<li>继续配置jnidebug构建类型，允许使用JNI组件，并且也添加了不一样的包名后缀。</li>
</ul>
<p>创建一个新的构建类型就是简单的在buildType标签下添加一个新的元素，并且可以使用initWith()或者直接使用闭包来配置它。</p>
<p>以下是一些可能使用到的属性和默认值：</p>
<table><tr><th>Property name</th><th>Default values for debug</th><th>Default values for release / other</th></tr><tr><td>debuggable</td><td>TRUE</td><td>FALSE</td></tr><tr><td>jniDebugBuild</td><td>FALSE</td><td>FALSE</td></tr><tr><td>renderscriptDebugBuild</td><td>FALSE</td><td>FALSE</td></tr><tr><td>renderscriptOptimLevel</td><td>3</td><td>3</td></tr><tr><td>applicationIdSuffix</td><td>null</td><td>null</td></tr><tr><td>versionNameSuffix</td><td>null</td><td>null</td></tr><tr><td>signingConfig</td><td>android.signingConfigs.debug</td><td>null</td></tr><tr><td>zipAlign</td><td>FALSE</td><td>TRUE</td></tr><tr><td>runProguard</td><td>FALSE</td><td>FALSE</td></tr><tr><td>proguardFile</td><td>N/A (set only)</td><td>N/A (set only)</td></tr><tr><td>proguardFiles</td><td>N/A (set only)</td><td>N/A (set only)</td></tr></table>

<p>除了以上属性之外，Build Type还会受项目源码和资源影响： 对于每一个Build Type都会自动创建一个匹配的sourceSet。默认的路径为：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">src/&lt;buildtypename&gt;/</div></pre></td></tr></table></figure></p>
<p>这意味着BuildType名称不能是main或者androidTest（因为这两个是由plugin强制实现的），并且他们互相之间都必须是唯一的。</p>
<p>跟其他sourceSet设置一样，Build Type的source set路径可以重新被定向：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    sourceSets.jnidebug.setRoot(<span class="string">'foo/jnidebug'</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>另外，每一个Build Type都会创建一个新的assemble任务。</p>
<p>assembleDebug和assembleRelease两个Task在上面已经提到过，这里要讲这两个Task从哪里被创建。当debug和release构建类型被预创建的时候，它们的tasks就会自动创建对应的这个两个Task。<br>上面提到的build.gradle代码片段中也会实现assembleJnidebug task，并且assemble会像依赖于assembleDebug和assembleRelease一样依赖于assembleJnidebug。</p>
<blockquote>
<p>提示：你可以在终端下输入gradle aJ去运行assembleJnidebug task。</p>
</blockquote>
<p>可能会使用到的情况：</p>
<ul>
<li>release模式不需要，只有debug模式下才使用到的权限</li>
<li>自定义的debug实现</li>
<li>为debug模式使用不同的资源（例如当资源的值由绑定的证书决定）</li>
</ul>
<p>BuildType的代码和资源通过以下方式被使用：</p>
<ul>
<li>manifest将被混合进app的manifest</li>
<li>代码行为只是另一个资源文件夹</li>
<li>资源将叠加到main的资源中，并替换已存在的资源。</li>
</ul>
<p><strong> 3.4.3 签名配置</strong><br>对一个应用程序签名需要以下：</p>
<ul>
<li>一个Keystory</li>
<li>一个keystory密码</li>
<li>一个key的别名</li>
<li>一个key的密码</li>
<li>存储类型</li>
</ul>
<p>位置，键名，两个密码，还有存储类型一起形成了签名配置。<br>默认情况下，debug被配置成使用一个debug keystory。 debug keystory使用了默认的密码和默认key及默认的key密码。 debug keystory的位置在$HOME/.android/debug.keystroe，如果对应位置不存在这个文件将会自动创建一个。</p>
<p><u>debug Build Type(构建类型) </u> 会自动使用debug SigningConfig (签名配置)。</p>
<p>可以创建其他配置或者自定义内建的默认配置。通过signingConfigs这个DSL容器来配置：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    signingConfigs &#123;</div><div class="line">        debug &#123;</div><div class="line">            storeFile file(<span class="string">"debug.keystore"</span>)</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        myConfig &#123;</div><div class="line">            storeFile file(<span class="string">"other.keystore"</span>)</div><div class="line">            storePassword <span class="string">"android"</span></div><div class="line">            keyAlias <span class="string">"androiddebugkey"</span></div><div class="line">            keyPassword <span class="string">"android"</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    buildTypes &#123;</div><div class="line">        foo &#123;</div><div class="line">            debuggable <span class="literal">true</span></div><div class="line">            jniDebugBuild <span class="literal">true</span></div><div class="line">            signingConfig signingConfigs.myConfig</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>以上代码片段修改debug keystory的路径到项目的根目录下。在这个例子中，这将自动影响其他使用到debug构建类型的构建类型。<br>这里也创建了一个新的Single Config（签名配置）和一个使用这个新签名配置的新的Build Type（构建类型）。</p>
<blockquote>
<p>注意：只有默认路径下的debug keystory不存在时会被自动创建。更改debug keystory的路径并不会自动在新路径下创建debug keystory。如果创建一个新的不同名字的SignConfig，但是使用默认的debug keystore路径来创建一个非默认的名字的SigningConing，那么还是会在默认路径下创建debug keystory。换句话说，会不会自动创建是根据keystory的路径来判断，而不是配置的名称。</p>
<p>注意：虽然经常使用项目根目录的相对路径作为keystore的路径，但是也可以使用绝对路径，尽管这并不推荐（除了自动创建出来的debug keystore）。</p>
<p>注意：如果你将这些文件添加到版本控制工具中，你可能不希望将密码直接写到这些文件中。下面Stack Overflow链接提供从控制台或者环境变量中获取密码的方法：<a href="http://stackoverflow.com/questions/18328730/how-to-create-a-release-signed-apk-file-using-gradle" target="_blank" rel="external">方法</a>我们以后还会在这个指南中添加更多的详细信息。</p>
</blockquote>
<p><strong> 3.4.4 运行 Proguard</strong></p>
<p>从Gradle Plugin for ProGuard version 4.10之后就开始支持ProGuard。ProGuard插件是自动添加进来的。如果Build Type的runProguard属性被设置为true，对应的task将会自动创建。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    buildTypes &#123;</div><div class="line">        release &#123;</div><div class="line">            runProguard <span class="literal">true</span></div><div class="line">            proguardFile getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    productFlavors &#123;</div><div class="line">        flavor1 &#123;</div><div class="line">        &#125;</div><div class="line">        flavor2 &#123;</div><div class="line">            proguardFile <span class="string">'some-other-rules.txt'</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>发布版本将会使用它的Build Type中声明的规则文件，product flavor（定制的产品版本）将会使用对应flavor中声明的规则文件。</p>
<p>这里有两个默认的规则文件：</p>
<ul>
<li>proguard-android.txt</li>
<li>proguard-android-optimize.txt</li>
</ul>
<p>这两个文件都在SDK的路径下。使用getDefaultProguardFile()可以获取这些文件的完整路径。它们除了是否要进行优化之外，其它都是相同的。</p>
<h2 id="4-依赖关系，Android库和多项目设置"><a href="#4-依赖关系，Android库和多项目设置" class="headerlink" title="4.依赖关系，Android库和多项目设置"></a>4.依赖关系，Android库和多项目设置</h2><p>Gradle项目可以依赖于其它组件。这些组件可以是外部二进制包，或者是其它的Gradle项目。</p>
<h3 id="4-1-依赖二进制包"><a href="#4-1-依赖二进制包" class="headerlink" title="4.1 依赖二进制包"></a>4.1 依赖二进制包</h3><p><strong> 4.1.1 本地包</strong><br>配置一个外部库的jar包依赖，你需要在compile配置中添加一个依赖。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    compile files(<span class="string">'libs/foo.jar'</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line">android &#123;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>注意：这个dependencies DSL标签是标准Gradle API中的一部分，所以它不属于android标签。</p>
</blockquote>
<p>这个compile配置将被用于编译main application。它里面的所有东西都被会被添加到编译的classpath中，同时也会被打包进最终的APK。 以下是添加依赖时可能用到的其它一些配置选项：</p>
<ul>
<li>compile main application（主module）</li>
<li>androidTestCompile test application（测试module）</li>
<li>debugCompile debug Build Type（debug类型的编译）</li>
<li>releaseCompile release Build Type（发布类型的编译）</li>
</ul>
<p>因为没有可能去构建一个没有关联任何Build Type（构建类型）的APK，APK默认配置了两个或两个以上的编译配置：compile和&lt; buildtype &gt;Compile. 创建一个新的Build Type将会自动创建一个基于它名字的新配置。<br>这对于debug版本需要使用一个自定义库（为了反馈实例化的崩溃信息等）但发布版本不需要，或者它们依赖于同一个库的不同版本时会非常有用。</p>
<p><strong> 4.1.2 远程文件</strong></p>
<p>Gradle支持从Maven或者Ivy仓库中拉取文件。<br>首先必须将仓库添加到列表中，然后必须在依赖中声明Maven或者Ivy声明的文件。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">repositories &#123;</div><div class="line">    mavenCentral()</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">dependencies &#123;</div><div class="line">    compile <span class="string">'com.google.guava:guava:11.0.2'</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">android &#123;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>注意：mavenCentral()是指定仓库URL的简单方法。Gradle支持远程和本地仓库。</p>
<p>注意：Gradle会遵循依赖关系的传递性。这意味着如果一个依赖本身依赖于其它东西，这些东西也会一并被拉取回来。</p>
</blockquote>
<p>更多关于设置依赖关系的信息，请参考<a href="http://gradle.org/docs/current/userguide/artifact_dependencies_tutorial.html" target="_blank" rel="external">Gradle用户指南</a>和<a href="http://gradle.org/docs/current/dsl/org.gradle.api.artifacts.dsl.DependencyHandler.html" target="_blank" rel="external">DSL文档</a>。</p>
<h3 id="4-2-多项目设置"><a href="#4-2-多项目设置" class="headerlink" title="4.2 多项目设置"></a>4.2 多项目设置</h3><p>Gradle项目也可以通过使用多项目配置依赖于其它Gradle项目。<br>多项目配置的实现通常是在一个根项目路径下将所有项目作为子文件夹包含进去。<br>例如，给定以下项目结构：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">MyProject/</div><div class="line"> + app/</div><div class="line"> + libraries/</div><div class="line">    + lib1/</div><div class="line">    + lib2/</div></pre></td></tr></table></figure></p>
<p>我们可以定义3个项目。Grand将会按照以下名字映射它们：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">:app</div><div class="line">:libraries:lib1</div><div class="line">:libraries:lib2</div></pre></td></tr></table></figure></p>
<p>每一个项目都拥有自己的build.gradle文件来声明自己如何构建。 另外，在根目录下还有一个setting.gradle文件用于声明所有项目。 这些文件的结构如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">MyProject/</div><div class="line"> | settings.gradle</div><div class="line"> + app/</div><div class="line">    | build.gradle</div><div class="line"> + libraries/</div><div class="line">    + lib1/</div><div class="line">       | build.gradle</div><div class="line">    + lib2/</div><div class="line">       | build.gradle</div></pre></td></tr></table></figure></p>
<p>其中setting.gradle的内容非常简单：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">include <span class="string">':app'</span>, <span class="string">':libraries:lib1'</span>, <span class="string">':libraries:lib2'</span></div></pre></td></tr></table></figure></p>
<p>这里定义了哪一个文件夹才是真正的Gradle项目。<br>其中:app项目可能依赖于这些库，这是通过以下依赖配置声明的：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    compile project(<span class="string">':libraries:lib1'</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>更多关于多项目配置的信息请参考<a href="http://gradle.org/docs/current/userguide/multi_project_builds.html" target="_blank" rel="external">这里</a>。</p>
<h3 id="4-3-库项目"><a href="#4-3-库项目" class="headerlink" title="4.3 库项目"></a>4.3 库项目</h3><p>在上面的多项目配置中，:libraries:lib1和:libraries:lib2可能是一个Java项目，并且:app这个Android项目将会使用它们的jar包输出。<br>但是，如果你想要共享代码来访问Android API或者使用Android样式的资源，那么这些库就不能是通常的Java项目，而应该是Android库项目。</p>
<p><strong> 4.3.1 创建一个库项目</strong></p>
<p>一个库项目与通常的Android项目非常类似，只是有一点小区别。<br>尽管构建库项目不同于构建应用程序，它们使用了不同的plugin。但是在内部这些plugin共享了大部分相同的代码，并且它们都由相同的com.android.tools.build.gradle.jar提供。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">buildscript &#123;</div><div class="line"></div><div class="line">    repositories &#123;</div><div class="line">        mavenCentral()</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    dependencies &#123;</div><div class="line">        classpath <span class="string">'com.android.tools.build:gradle:0.5.6'</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">apply plugin: <span class="string">'android-library'</span></div><div class="line"></div><div class="line">android &#123;</div><div class="line">    compileSdkVersion 15</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里创建了一个使用API 15编译SourceSet的库项目，并且依赖关系的配置方法与应用程序项目的配置方法一样，同样也支持自定义配置。</p>
<p><strong> 4.3.2 普通项目和库项目之间的区别</strong></p>
<p>一个库项目的main输出是一个.aar包（它代表Android的归档文件）。它组合了编译代码（例如jar包或者是本地的.so文件）和资源（manifest，res，assets）。 一个库项目同样也可以独立于应用程序生成一个测试用的apk来测试。<br>标识Task同样适用于库项目（assembleDebug，assembleRelease），因此在命令行上与构建一个项目没有什么不同。</p>
<p>其余的部分，库项目与应用程序项目一样。它们都拥有build type和product flavor，也可以生成多个aar版本。 记住大部分Build Type的配置不适用于库项目。但是你可以根据库项目是否被其它项目使用或者是否用来测试来使用自定义的sourceSet改变库项目的内容。</p>
<p><strong> 4.3.3 引用一个库项目</strong></p>
<p>引用一个库项目的方法与引用其它项目的方法一样：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    compile project(<span class="string">':libraries:lib1'</span>)</div><div class="line">    compile project(<span class="string">':libraries:lib2'</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>注意：如果你要引用多个库，那么排序将非常重要。这类似于旧构建系统里面的project.properties文件中的依赖排序。</p>
</blockquote>
<p><strong> 4.3.4 库项目发布</strong></p>
<p>一般情况下一个库只会发布它的release Variant（变种）版本。这个版本将会被所有引用它的项目使用，而不管它们本身自己构建了什么版本。这是由于Gradle的限制，我们正在努力消除这个问题，所以这只是临时的限制。<br>你可以控制哪一个Variant版本作为发行版：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    defaultPublishConfig <span class="string">"debug"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意这里的发布配置名称引用的是完整的Variant版本名称。Relesae，debug只适用于项目中没有其它特性版本的时候使用。如果你想要使用其它Variant版本取代默认的发布版本，你可以：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    defaultPublishConfig <span class="string">"flavor1Debug"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>将库项目的所有Variant版本都发布也是可能的。我们计划在一般的项目依赖项目（类似于上述所说的）情况下允许这种做法，但是由于Gradle的限制（我们也在努力修复这个问题）现在还不太可能。 默认情况下没有启用发布所有Variant版本。可以通过以下启用：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    publishNonDefault <span class="literal">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>理解发布多个Variant版本意味着发布多个arr文件而不是一个arr文件包含所有Variant版本是非常重要的。每一个arr包都包含一个单一的Variant版本。 发布一个变种版本意味着构建一个可用的arr文件作为Gradle项目的输出文件。无论是发布到一个maven仓库，还是其它项目需要创建一个这个库项目的依赖都可以使用到这个文件。</p>
<p>Gradle有一个默认文件的概念。当添加以下配置后就会被使用到：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">compile project(<span class="string">':libraries:lib2'</span>)</div></pre></td></tr></table></figure></p>
<p>创建一个其它发布文件的依赖，你需要指定具体使用哪一个：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    flavor1Compile project(path: <span class="string">':lib1'</span>, configuration: <span class="string">'flavor1Release'</span>)</div><div class="line">    flavor2Compile project(path: <span class="string">':lib1'</span>, configuration: <span class="string">'flavor2Release'</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>重要：注意已发布的配置是一个完整的Variant版本，其中包括了build type，并且需要像以上一样被引用。<br>当启用非默认发布，maven发布插件将会发布其它Variant版本作为扩展包（按分类器分类）。这意味着不能真正的兼容发布到maven仓库。你应该另外发布一个单一的Variant版本到仓库中，或者允许发布所有配置以支持跨项目依赖。</p>
</blockquote>
<h2 id="5-测试"><a href="#5-测试" class="headerlink" title="5.测试"></a>5.测试</h2><p>构建一个测试程序已经被集成到应用项目中，没有必要再专门建立一个测试项目。</p>
<h3 id="5-1-基本知识和配置"><a href="#5-1-基本知识和配置" class="headerlink" title="5.1 基本知识和配置"></a>5.1 基本知识和配置</h3><p>正如前面所提到的，紧邻main sourceSet的就是androidTest sourceSet，默认路径在src/androidTest/下。 在这个测试sourceSet中会构建一个使用Android测试框架，并且可以部署到设备上的测试apk来测试应用程序。这里面包含单元测试，集成测试，和后续UI自动化测试。 这个测试sourceSet不应该包含AndroidManifest.xml文件，因为这个文件会自动生成。</p>
<p>下面这些值可能会在测试应用配置中使用到：</p>
<ul>
<li>testPackageName</li>
<li>testInstrumentationRunner</li>
<li>testHandleProfiling</li>
<li>testfunctionalTest</li>
</ul>
<p>正如前面所看到的，这些配置在defaultConfig对象中配置：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    defaultConfig &#123;</div><div class="line">        testPackageName <span class="string">"com.test.foo"</span></div><div class="line">        testInstrumentationRunner <span class="string">"android.test.InstrumentationTestRunner"</span></div><div class="line">        testHandleProfiling <span class="literal">true</span></div><div class="line">        testFunctionalTest <span class="literal">true</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在测试应用程序的manifest文件中，instrumentation节点的targetPackage属性值会自动使用测试应用的package名称设置，即使这个名称是通过defaultConfig或者Build Type对象自定义的。这也是manifest文件需要自动生成的一个原因。</p>
<p>另外，这个测试sourceSet也可以拥有自己的依赖。 默认情况下，应用程序和他的依赖会自动添加的测试应用的classpath中，但是也可以通过以下来扩展：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    androidTestCompile <span class="string">'com.google.guava:guava:11.0.2'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>测试应用通过assembleTest task来构建。assembleTest不依赖于main中的assemble task，需要手动设置运行，不能自动运行。</p>
<p>目前只有一个Build Type被测试。默认情况下是debug Build Type，但是这也可以通过以下自定义配置：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    ...</div><div class="line">    testBuildType <span class="string">"staging"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="5-2-运行测试"><a href="#5-2-运行测试" class="headerlink" title="5.2 运行测试"></a>5.2 运行测试</h3><p>正如前面提到的，标志性task connectedCheck要求一个连接的设备来启动。 这个过程依赖于androidTest task，因此将会运行androidTest。这个task将会执行下面内容：</p>
<ul>
<li>确认应用和测试应用都被构建（依赖于assembleDebug和assembleTest）。</li>
<li>安装这两个应用。</li>
<li>运行这些测试。</li>
<li>卸载这两个应用。</li>
</ul>
<p>如果有多于一个连接设备，那么所有测试都会同时运行在所有连接设备上。如果其中一个测试失败，不管是哪一个设备算失败。<br>所有测试结果都被保存为XML文档，路径为：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">_build/androidTest-results_</div></pre></td></tr></table></figure></p>
<p>这类似于JUnit的运行结果保存在build/test-results.</p>
<p>同样，这也可以自定义配置：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    ...</div><div class="line"></div><div class="line">    testOptions &#123;</div><div class="line">        resultsDir = <span class="string">"<span class="variable">$project</span>.buildDir/foo/results"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里的android.testOptions.resultsDir将由Project.file(String)获得。</p>
<h3 id="5-3-测试Android库"><a href="#5-3-测试Android库" class="headerlink" title="5.3 测试Android库"></a>5.3 测试Android库</h3><p>测试Android库项目的方法与应用项目的方法类似。<br>唯一的不同在于整个库（包括它的依赖）都是自动作为依赖库被添加到测试应用中。结果就是测试APK不单只包含它的代码，还包含了库项目自己和库的所有依赖。 库的manifest被组合到测试应用的manifest中（作为一些项目引用这个库的壳）。</p>
<p>androidTest task的变改只是安装（或者卸载）测试APK（因为没有其它APK被安装）。<br>其它的部分都是类似的。</p>
<h3 id="5-4-测试报告"><a href="#5-4-测试报告" class="headerlink" title="5.4 测试报告"></a>5.4 测试报告</h3><p>当运行单元测试的时候，Gradle会输出一份HTML格式的报告以方便查看结果。 Android plugin也是基于此，并且扩展了HTML报告文件，它将所有连接设备的报告都合并到一个文件里面。</p>
<p><strong> 5.4.1 独立项目</strong></p>
<p>一个项目将会自动生成测试运行。默认位置为：build/reports/androidTests<br>这非常类似于JUnit的报告所在位置build/reports/tests，其它的报告通常位于build/reports/&lt; plugin &gt;/。</p>
<p>这个路径也可以通过以下方式自定义：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    ...</div><div class="line"></div><div class="line">    testOptions &#123;</div><div class="line">        reportDir = <span class="string">"<span class="variable">$project</span>.buildDir/foo/report"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>报告将会合并运行在不同设备上的测试结果。</p>
<p><strong> 5.4.2 多项目报告</strong></p>
<p>在一个配置了多个应用或者多个库项目的多项目里，当同时运行所有测试的时候，生成一个报告文件记录所有的测试可能是非常有用的。<br>为了实现这个目的，需要使用同一个依赖文件（译注：指的是使用android gradle插件的依赖文件）中的另一个插件。可以通过以下方式添加：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">buildscript &#123;</div><div class="line">    repositories &#123;</div><div class="line">        mavenCentral()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    dependencies &#123;</div><div class="line">        classpath <span class="string">'com.android.tools.build:gradle:0.5.6'</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">apply plugin: <span class="string">'android-reporting'</span></div></pre></td></tr></table></figure></p>
<p>这必须添加到项目的根目录下，例如与settings.gradle文件同个目录的build.gradle文件中。</p>
<p>之后，在命令行中导航到项目根目录下，输入以下命令就可以运行所有测试并合并所有报告：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gradle deviceCheck mergeAndroidReports --<span class="built_in">continue</span></div></pre></td></tr></table></figure></p>
<blockquote>
<p>注意：这里的–continue选项将允许所有测试，即使子项目中的任何一个运行失败都不会停止。如果没有这个选项，第一个失败测试将会终止全部测试的运行，这可能导致一些项目没有执行过它们的测试。</p>
</blockquote>
<h3 id="5-5-Lint支持"><a href="#5-5-Lint支持" class="headerlink" title="5.5 Lint支持"></a>5.5 Lint支持</h3><blockquote>
<p>Lint支持，译者注：Lint是一个可以检查Android项目中存在的问题的工具</p>
</blockquote>
<p>从0.7.0版本开始，你可以为项目中一个特定的Variant（变种）版本运行lint，也可以为所有Variant版本都运行lint。它将会生成一个报告描述哪一个Variant版本中存在着问题。<br>你可以通过以下lint选项配置lint。通常情况下你只需要配置其中一部分，以下列出了所有可使用的选项：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    lintOptions &#123;</div><div class="line">        // <span class="built_in">set</span> to <span class="literal">true</span> to turn off analysis progress reporting by lint</div><div class="line">        quiet <span class="literal">true</span></div><div class="line">        // <span class="keyword">if</span> <span class="literal">true</span>, stop the gradle build <span class="keyword">if</span> errors are found</div><div class="line">        abortOnError <span class="literal">false</span></div><div class="line">        // <span class="keyword">if</span> <span class="literal">true</span>, only report errors</div><div class="line">        ignoreWarnings <span class="literal">true</span></div><div class="line">        // <span class="keyword">if</span> <span class="literal">true</span>, emit full/absolute paths to files with errors (<span class="literal">true</span> by default)</div><div class="line">        //absolutePaths <span class="literal">true</span></div><div class="line">        // <span class="keyword">if</span> <span class="literal">true</span>, check all issues, including those that are off by default</div><div class="line">        checkAllWarnings <span class="literal">true</span></div><div class="line">        // <span class="keyword">if</span> <span class="literal">true</span>, treat all warnings as errors</div><div class="line">        warningsAsErrors <span class="literal">true</span></div><div class="line">        // turn off checking the given issue id<span class="string">'s</span></div><div class="line">        disable 'TypographyFractions<span class="string">','</span>TypographyQuotes<span class="string">'</span></div><div class="line">        // turn on the given issue id's</div><div class="line">        <span class="built_in">enable</span> <span class="string">'RtlHardcoded'</span>,<span class="string">'RtlCompat'</span>, <span class="string">'RtlEnabled'</span></div><div class="line">        // check *only* the given issue id<span class="string">'s</span></div><div class="line">        check 'NewApi<span class="string">', '</span>InlinedApi<span class="string">'</span></div><div class="line">        // if true, don't include <span class="built_in">source</span> code lines <span class="keyword">in</span> the error output</div><div class="line">        noLines <span class="literal">true</span></div><div class="line">        // <span class="keyword">if</span> <span class="literal">true</span>, show all locations <span class="keyword">for</span> an error, <span class="keyword">do</span> not truncate lists, etc.</div><div class="line">        showAll <span class="literal">true</span></div><div class="line">        // Fallback lint configuration (default severities, etc.)</div><div class="line">        lintConfig file(<span class="string">"default-lint.xml"</span>)</div><div class="line">        // <span class="keyword">if</span> <span class="literal">true</span>, generate a text report of issues (<span class="literal">false</span> by default)</div><div class="line">        textReport <span class="literal">true</span></div><div class="line">        // location to write the output; can be a file or <span class="string">'stdout'</span></div><div class="line">        textOutput <span class="string">'stdout'</span></div><div class="line">        // <span class="keyword">if</span> <span class="literal">true</span>, generate an XML report <span class="keyword">for</span> use by <span class="keyword">for</span> example Jenkins</div><div class="line">        xmlReport <span class="literal">false</span></div><div class="line">        // file to write report to (<span class="keyword">if</span> not specified, defaults to lint-results.xml)</div><div class="line">        xmlOutput file(<span class="string">"lint-report.xml"</span>)</div><div class="line">        // <span class="keyword">if</span> <span class="literal">true</span>, generate an HTML report (with issue explanations, sourcecode, etc)</div><div class="line">        htmlReport <span class="literal">true</span></div><div class="line">        // optional path to report (default will be lint-results.html <span class="keyword">in</span> the builddir)</div><div class="line">        htmlOutput file(<span class="string">"lint-report.html"</span>)</div><div class="line"></div><div class="line">   // <span class="built_in">set</span> to <span class="literal">true</span> to have all release builds run lint on issues with severity=fatal</div><div class="line">   // and abort the build (controlled by abortOnError above) <span class="keyword">if</span> fatal issues are found</div><div class="line">   checkReleaseBuilds <span class="literal">true</span></div><div class="line">        // Set the severity of the given issues to fatal (<span class="built_in">which</span> means they will be</div><div class="line">        // checked during release builds (even <span class="keyword">if</span> the lint target is not included)</div><div class="line">        fatal <span class="string">'NewApi'</span>, <span class="string">'InlineApi'</span></div><div class="line">        // Set the severity of the given issues to error</div><div class="line">        error <span class="string">'Wakelock'</span>, <span class="string">'TextViewEdits'</span></div><div class="line">        // Set the severity of the given issues to warning</div><div class="line">        warning <span class="string">'ResourceAsColor'</span></div><div class="line">        // Set the severity of the given issues to ignore (same as disabling the check)</div><div class="line">        ignore <span class="string">'TypographyQuotes'</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="6-构建变种版本"><a href="#6-构建变种版本" class="headerlink" title="6.构建变种版本"></a>6.构建变种版本</h2><p>新构建系统的一个目标就是允许为同一个应用创建不同的版本。<br>这里有两个主要的使用情景：</p>
<ul>
<li>1.同一个应用的不同版本。 例如一个免费的版本和一个收费的专业版本。</li>
<li>2.同一个应用需要打包成不同的apk以发布Google Play Store。 点击此处查看更多详细信息。</li>
<li>3.综合1和2两种情景。</li>
</ul>
<p>这个目标就是要让在同一个项目里生成不同的APK成为可能，以取代以前需要使用一个库项目和两个及两个以上的应用项目分别生成不同APK的做法。</p>
<h3 id="6-1-不同定制的产品"><a href="#6-1-不同定制的产品" class="headerlink" title="6.1 不同定制的产品"></a>6.1 不同定制的产品</h3><p>一个product flavor定义了从项目中构建了一个应用的自定义版本。一个单一的项目可以同时定义多个不同的flavor来改变应用的输出。<br>这个新的设计概念是为了解决不同的版本之间的差异非常小的情况。虽然最项目终生成了多个定制的版本，但是它们本质上都是同一个应用，那么这种做法可能是比使用库项目更好的实现方式。</p>
<p>Product flavor需要在productFlavors这个DSL容器中声明：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    ....</div><div class="line"></div><div class="line">    productFlavors &#123;</div><div class="line">        flavor1 &#123;</div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        flavor2 &#123;</div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里创建了两个flavor，名为flavor1和flavor2。</p>
<blockquote>
<p>注意：flavor的命名不能与已存在的Build Type或者androidTest这个sourceSet有冲突。</p>
</blockquote>
<h3 id="6-2-构建类型-定制产品-构建变种版本"><a href="#6-2-构建类型-定制产品-构建变种版本" class="headerlink" title="6.2 构建类型+定制产品=构建变种版本"></a>6.2 构建类型+定制产品=构建变种版本</h3><p>正如前面章节所提到的，每一个Build Type都会生成一个新的APK。<br>Product Flavor同样也会做这些事情：项目的输出将会拼接所有可能的Build Type和Product Flavor（如果有Flavor定义存在的话）的组合。</p>
<p>每一种组合（包含Build Type和Product Flavor）就是一个Build Variant（构建变种版本）。</p>
<p>例如，在上面的Flavor声明例子中与默认的debug和release两个Build Type将会生成4个Build Variant：</p>
<ul>
<li>Flavor1 - debug</li>
<li>Flavor1 - release</li>
<li>Flavor2 - debug</li>
<li>Flavor2 - release</li>
</ul>
<p>项目中如果没有定义flavor同样也会有Build Variant，只是使用的是默认的flavor和配置。default(默认)的flavor/config是没有名字的，所以生成的Build Variant列表看起来就跟Build Type列表一样。</p>
<h3 id="6-3-Product-Flavor的配置"><a href="#6-3-Product-Flavor的配置" class="headerlink" title="6.3 Product Flavor的配置"></a>6.3 Product Flavor的配置</h3><p>每一个flavor都是通过闭包来配置的：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    ...</div><div class="line"></div><div class="line">    defaultConfig &#123;</div><div class="line">        minSdkVersion 8</div><div class="line">        versionCode 10</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    productFlavors &#123;</div><div class="line">        flavor1 &#123;</div><div class="line">            packageName <span class="string">"com.example.flavor1"</span></div><div class="line">            versionCode 20</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        flavor2 &#123;</div><div class="line">            packageName <span class="string">"com.example.flavor2"</span></div><div class="line">            minSdkVersion 14</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>注意ProductFlavor类型的android.productFlavors.*对象与android.defaultConfig对象的类型是相同的。这意味着它们共享相同的属性。</p>
</blockquote>
<p>defaultConfig为所有的flavor提供基本的配置，每一个flavor都可以重设这些配置的值。在上面的例子中，最终的配置结果将会是：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">* `flavor1`</div><div class="line">    * `packageName`: com.example.flavor1</div><div class="line">    * `minSdkVersion`: 8</div><div class="line">    * `versionCode`: 20</div><div class="line">* `flavor2`</div><div class="line">    * `packageName`: com.example.flavor2</div><div class="line">    * `minSdkVersion`: 14</div><div class="line">    * `versionCode`: 10</div></pre></td></tr></table></figure></p>
<p>通常情况下，Build Type的配置会覆盖其它的配置。例如，Build Type的packageNameSuffix会被追加到Product Flavor的packageName上面。<br>也有一些情况是一些设置可以同时在Build Type和Product Flavor中设置。在这种情况下，按照个别为主的原则决定。</p>
<p>例如，signingConfig就这种属性的一个例子。 signingConfig允许通过设置android.buildTypes.release.signingConfig来为所有的release包共享相同的SigningConfig。也可以通过设置android.productFlavors.*.signingConfig来为每一个release包指定它们自己的SigningConfig。</p>
<h3 id="6-4-源组件和依赖关系"><a href="#6-4-源组件和依赖关系" class="headerlink" title="6.4 源组件和依赖关系"></a>6.4 源组件和依赖关系</h3><p>与Build Type类似，Product Flavor也会通过它们自己的sourceSet提供代码和资源。</p>
<p>上面的例子将会创建4个sourceSet：</p>
<ul>
<li>android.sourceSets.flavor1 位于src/flavor1/</li>
<li>android.sourceSets.flavor2 位于src/flavor2/</li>
<li>android.sourceSets.androidTestFlavor1 位于src/androidTestFlavor1/</li>
<li>android.sourceSets.androidTestFlavor2 位于src/androidTestFlavor2/</li>
</ul>
<p>这些sourceSet用于与android.sourceSets.main和Build Type的sourceSet来构建APK。</p>
<p>下面的规则用于处理所有使用的sourceSet来构建一个APK：</p>
<ul>
<li>多个文件夹中的所有的源代码（src/*/java）都会合并起来生成一个输出。</li>
<li>所有的Manifest文件都会合并成一个Manifest文件。类似于Build Type，允许Product Flavor可以拥有不同的的组件和权限声明。</li>
<li>所有使用的资源（Android res和assets）遵循的优先级为Build Type会覆盖Product Flavor，最终覆盖main sourceSet的资源。</li>
<li>每一个Build Variant都会根据资源生成自己的R类（或者其它一些源代码）。Variant互相之间没有什么是共享的。</li>
</ul>
<p>最终，类似Build Type，Product Flavor也可以有它们自己的依赖关系。例如，如果使用flavor来生成一个基于广告的应用版本和一个付费的应用版本，其中广告版本可能需要依赖于一个广告SDK，但是另一个不需要。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    flavor1Compile <span class="string">"..."</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在这个例子中，src/flavor1/AndroidManifest.xml文件中可能需要声明访问网络的权限。</p>
<p>每一个Variant也会创建额外的sourceSet：</p>
<ul>
<li>android.sourceSets.flavor1Debug 位于src/flavor1Debug/</li>
<li>android.sourceSets.flavor1Release 位于src/flavor1Release/</li>
<li>android.sourceSets.flavor2Debug 位于src/flavor2Debug/</li>
<li>android.sourceSets.flavor2Release 位于src/flavor2Release/</li>
</ul>
<p>这些sourceSet拥有比Build Type的sourceSet更高的优先级，并允许在Variant的层次上做一些定制。</p>
<h3 id="6-5-构建和任务"><a href="#6-5-构建和任务" class="headerlink" title="6.5 构建和任务"></a>6.5 构建和任务</h3><p>我们前面提到每一个Build Type会创建自己的assemble&lt; name &gt;task，但是Build Variant是Build Type和Product Flavor的组合。<br>当使用Product Flavor的时候，将会创建更多的assemble-type task。分别是：</p>
<ul>
<li>1.assemble&lt; Variant Name &gt; 允许直接构建一个Variant版本，例如assembleFlavor1Debug。</li>
<li>2.assemble&lt; Build Type Name &gt; 允许构建指定Build Type的所有APK，例如assembleDebug将会构建Flavor1Debug和Flavor2Debug两个Variant版本。</li>
<li>3.assemble&lt; Product Flavor Name &gt; 允许构建指定flavor的所有APK，例如assembleFlavor1将会构建Flavor1Debug和Flavor1Release两个Variant版本。</li>
</ul>
<p>另外assemble task会构建所有可能组合的Variant版本。</p>
<h3 id="6-6-测试"><a href="#6-6-测试" class="headerlink" title="6.6 测试"></a>6.6 测试</h3><p>测试multi-flavors项目非常类似于测试简单的项目。<br>androidTest sourceSet用于定义所有flavor共用的测试，但是每一个flavor也可以有它自己特有的测试。</p>
<p>正如前面提到的，每一个flavor都会创建自己的测试sourceSet：</p>
<ul>
<li>android.sourceSets.androidTestFlavor1 位于src/androidTestFlavor1/</li>
<li>android.sourceSets.androidTestFlavor2 位于src/androidTestFlavor2/</li>
</ul>
<p>同样的，它们也可以拥有自己的依赖关系：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    androidTestFlavor1Compile <span class="string">"..."</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这些测试可以通过main的标志性deviceCheck task或者main的androidTest task（当flavor被使用的时候这个task相当于一个标志性task）来执行。</p>
<p>每一个flavor也拥有它们自己的task来这行这些测试：androidTest&lt; VariantName &gt;。例如：</p>
<ul>
<li>androidTestFlavor1Debug</li>
<li>androidTestFlavor2Debug</li>
</ul>
<p>同样的，每一个Variant版本也会创建对应的测试APK构建task和安装或卸载task：</p>
<ul>
<li>assembleFlavor1Test</li>
<li>installFlavor1Debug</li>
<li>installFlavor1Test</li>
<li>uninstallFlavor1Debug<br>  …</li>
</ul>
<p>最终的HTML报告支持根据flavor合并生成。 下面是测试结果和报告文件的路径，第一个是每一个flavor版本的结果，后面的是合并起来的结果：</p>
<ul>
<li>build/androidTest-results/flavors/&lt; FlavorName &gt;</li>
<li>build/androidTest-results/all/</li>
<li>build/reports/androidTests/flavors&lt; FlavorName &gt;</li>
<li>build/reports/androidTests/all/</li>
</ul>
<h3 id="6-7-多版本-Multi-flavor-variants"><a href="#6-7-多版本-Multi-flavor-variants" class="headerlink" title="6.7 多版本(Multi-flavor variants)"></a>6.7 多版本(Multi-flavor variants)</h3><p>在一些情况下，一个应用可能需要基于多个标准来创建多个版本。例如，Google Play中的multi-apk支持4个不同的过滤器。区分创建的不同APK的每一个过滤器要求能够使用多维的Product Flavor。</p>
<p>假如有个游戏需要一个免费版本和一个付费的版本，并且需要在multi-apk支持中使用ABI过滤器（译注：ABI，应用二进制接口，优点是不需要改动应用的任何代码就能够将应用迁移到任何支持相同ABI的平台上）。这个游戏应用需要3个ABI和两个特定应用版本，因此就需要生成6个APK（没有因计算不同Build Types生成的Variant版本）。 然而，注意到在这个例子中，为三个ABI构建的付费版本源代码都是相同，因此创建6个flavor来实现不是一个好办法。 相反的，使用两个flavor维度，并且自动构建所有可能的Variant组合。</p>
<p>这个功能的实现就是使用Flavor Groups。每一个Group代表一个维度，并且flavor都被分配到一个指定的Group中。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    ...</div><div class="line"></div><div class="line">    flavorGroups <span class="string">"abi"</span>, <span class="string">"version"</span></div><div class="line"></div><div class="line">    productFlavors &#123;</div><div class="line">        freeapp &#123;</div><div class="line">            flavorGroup <span class="string">"version"</span></div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        x86 &#123;</div><div class="line">            flavorGroup <span class="string">"abi"</span></div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>andorid.flavorGroups数组按照先后排序定义了可能使用的group。每一个Product Flavor都被分配到一个group中。</p>
<p>上面的例子中将Product Flavor分为两组（即两个维度），为别为abi维度[x86,arm,mips]和version维度[freeapp,paidapp]，再加上默认的Build Type有[debug,release]，这将会组合生成以下的Build Variant：</p>
<ul>
<li>x86-freeapp-debug</li>
<li>x86-freeapp-release</li>
<li>arm-freeapp-debug</li>
<li>arm-freeapp-release</li>
<li>mips-freeapp-debug</li>
<li>mips-freeapp-release</li>
<li>x86-paidapp-debug</li>
<li>x86-paidapp-release</li>
<li>arm-paidapp-debug</li>
<li>arm-paidapp-release</li>
<li>mips-paidapp-debug</li>
<li>mips-paidapp-release</li>
</ul>
<p>android.flavorGroups中定义的group排序非常重要（Variant命名和优先级等）。</p>
<p>每一个Variant版本的配置由几个Product Flavor对象决定：</p>
<ul>
<li>android.defaultConfig</li>
<li>一个来自abi组中的对象</li>
<li>一个来自version组中的对象</li>
</ul>
<p>flavorGroups中的排序决定了哪一个flavor覆盖哪一个，这对于资源来说非常重要，因为一个flavor中的值会替换定义在低优先级的flavor中的值。<br>flavor groups使用最高的优先级定义，因此在上面例子中的优先级为：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">abi &gt; version &gt; defaultConfig</div></pre></td></tr></table></figure></p>
<p>Multi-flavors项目同样拥有额外的sourceSet，类似于Variant的sourceSet，只是少了Build Type：</p>
<ul>
<li>android.sourceSets.x86Freeapp 位于src/x86Freeapp/</li>
<li>android.sourceSets.armPaidapp 位于src/armPaidapp/</li>
<li>等等…</li>
</ul>
<p>这允许在flavor-combination的层次上进行定制。它们拥有过比基础的flavor sourceSet更高的优先级，但是优先级低于Build Type的sourceSet。</p>
<h2 id="7-高级构建定制"><a href="#7-高级构建定制" class="headerlink" title="7.高级构建定制"></a>7.高级构建定制</h2><h3 id="7-1-构建选项"><a href="#7-1-构建选项" class="headerlink" title="7.1 构建选项"></a>7.1 构建选项</h3><p><strong> 7.1.1 Java编译选项</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    compileOptions &#123;</div><div class="line">        sourceCompatibility = <span class="string">"1.6"</span></div><div class="line">        targetCompatibility = <span class="string">"1.6"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>默认值是“1.6”。这个设置将影响所有task编译Java源代码。</p>
<p><strong> 7.1.2 aapt选项</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    aaptOptions &#123;</div><div class="line">        noCompress <span class="string">'foo'</span>, <span class="string">'bar'</span></div><div class="line">        ignoreAssetsPattern <span class="string">"!.svn:!.git:!.ds_store:!*.scc:.*:&lt;dir&gt;_*:!CVS:!thumbs.db:!picasa.ini:!*~"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这将影响所有使用aapt的task。</p>
<p><strong> 7.1.3 dex选项</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    dexOptions &#123;</div><div class="line">        incremental <span class="literal">false</span></div><div class="line"></div><div class="line">        preDexLibraries = <span class="literal">false</span></div><div class="line"></div><div class="line">        jumboMode = <span class="literal">false</span></div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这将应用所有使用dex的task。</p>
<h3 id="7-2-操作task"><a href="#7-2-操作task" class="headerlink" title="7.2 操作task"></a>7.2 操作task</h3><p>基础Java项目有一组有限的task用于互相处理生成一个输出。 classes是一个编译Java源代码的task。可以在build.gradle文件中通过脚本很容易使用classes。这是project.tasks.classes的缩写。<br>在Android项目中，相比之下这就有点复杂。因为Android项目中会有大量相同的task，并且它们的名字基于Build Types和Product Flavor生成。</p>
<p>为了解决这个问题，android对象有两个属性：</p>
<ul>
<li>applicationVariants（只适用于app plugin）</li>
<li>libraryVariants（只适用于library plugin）</li>
<li>testVariants（两个plugin都适用）</li>
</ul>
<p>这三个都会分别返回一个ApplicationVariant、LibraryVariant和TestVariant对象的<a href="http://www.gradle.org/docs/current/javadoc/org/gradle/api/DomainObjectCollection.html" target="_blank" rel="external">DomainObjectCollection</a>。<br>注意使用这三个collection中的其中一个都会触发生成所有对应的task。这意味着使用collection之后不需要更改配置。</p>
<p>DomainObjectCollection可以直接访问所有对象，或者通过过滤器进行筛选。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">android.applicationVariants.each &#123; variant -&gt;</div><div class="line">    ....</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这三个variant类都共享下面的属性:</p>
<table><tr><th>属性名</th><th>属性类型</th><th>说明</th></tr><tr><td>name</td><td>String</td><td>Variant的名字，必须是唯一的。</td></tr><tr><td>description</td><td>String</td><td>Variant的描述说明。</td></tr><tr><td>dirName</td><td>String</td><td>Variant的子文件夹名，必须也是唯一的。可能也会有不止一个子文件夹，例如“debug/flavor1”</td></tr><tr><td>baseName</td><td>String</td><td>Variant输出的基础名字，必须唯一。</td></tr><tr><td>outputFile</td><td>File</td><td>Variant的输出，这是一个可读可写的属性。</td></tr><tr><td>processManifest</td><td>ProcessManifest</td><td>处理Manifest的task。</td></tr><tr><td>aidlCompile</td><td>AidlCompile</td><td>编译AIDL文件的task。</td></tr><tr><td>renderscriptCompile</td><td>RenderscriptCompile</td><td>编译Renderscript文件的task。</td></tr><tr><td>mergeResources</td><td>MergeResources</td><td>混合资源文件的task。</td></tr><tr><td>mergeAssets</td><td>MergeAssets</td><td>混合asset的task。</td></tr><tr><td>processResources</td><td>ProcessAndroidResources</td><td>处理并编译资源文件的task。</td></tr><tr><td>generateBuildConfig</td><td>GenerateBuildConfig</td><td>生成BuildConfig类的task。</td></tr><tr><td>javaCompile</td><td>JavaCompile</td><td>编译Java源代码的task。</td></tr><tr><td>processJavaResources</td><td>Copy</td><td>处理Java资源的task。</td></tr><tr><td>assemble</td><td>DefaultTask</td><td>Variant的标志性assemble task。</td></tr></table>

<p>ApplicationVariant类还有以下附加属性:</p>
<table><tr><th>属性名</th><th>属性类型</th><th>说明</th></tr><tr><td>buildType</td><td>BuildType</td><td>Variant的BuildType。</td></tr><tr><td>productFlavors</td><td>List</td><td>Variant的ProductFlavor。一般不为空但也允许空值。</td></tr><tr><td>mergedFlavor</td><td>ProductFlavor</td><td>android.defaultConfig和variant.productFlavors的合并。</td></tr><tr><td>signingConfig</td><td>SigningConfig</td><td>Variant使用的SigningConfig对象。</td></tr><tr><td>isSigningReady</td><td>boolean</td><td>如果是true则表明这个Variant已经具备了所有需要签名的信息。</td></tr><tr><td>testVariant</td><td>BuildVariant</td><td>将会测试这个Variant的TestVariant。</td></tr><tr><td>dex</td><td>Dex</td><td>将代码打包成dex的task。如果这个Variant是个库，这个值可以为空。</td></tr><tr><td>packageApplication</td><td>PackageApplication</td><td>打包最终APK的task。如果这个Variant是个库，这个值可以为空。</td></tr><tr><td>zipAlign</td><td>ZipAlign</td><td>zip压缩APK的task。如果这个Variant是个库或者APK不能被签名，这个值可以为空。</td></tr><tr><td>install</td><td>DefaultTask</td><td>负责安装的task，不能为空。</td></tr><tr><td>uninstall</td><td>DefaultTask</td><td>负责卸载的task。</td></tr></table>

<p>LibraryVariant类还有以下附加属性：</p>
<table><tr><th>属性名</th><th>属性类型</th><th>说明</th></tr><tr><td>buildType</td><td>BuildType</td><td>Variant的BuildType.</td></tr><tr><td>mergedFlavor</td><td>ProductFlavor</td><td>The defaultConfig values</td></tr><tr><td>testVariant</td><td>BuildVariant</td><td>用于测试这个Variant。</td></tr><tr><td>packageLibrary</td><td>Zip</td><td>用于打包库项目的AAR文件。如果是个库项目，这个值不能为空。</td></tr></table>

<p>TestVariant类还有以下属性:</p>
<table><tr><th>属性名</th><th>属性类型</th><th>说明</th></tr><tr><td>buildType</td><td>BuildType</td><td>Variant的Build Type。</td></tr><tr><td>productFlavors</td><td>List</td><td>Variant的ProductFlavor。一般不为空但也允许空值。</td></tr><tr><td>mergedFlavor</td><td>ProductFlavor</td><td>android.defaultConfig和variant.productFlavors的合并。</td></tr><tr><td>signingConfig</td><td>SigningConfig</td><td>Variant使用的SigningConfig对象。</td></tr><tr><td>isSigningReady</td><td>boolean</td><td>如果是true则表明这个Variant已经具备了所有需要签名的信息。</td></tr><tr><td>testedVariant</td><td>BaseVariant</td><td>TestVariant测试的BaseVariant</td></tr><tr><td>dex</td><td>Dex</td><td>将代码打包成dex的task。如果这个Variant是个库，这个值可以为空。</td></tr><tr><td>packageApplication</td><td>PackageApplication</td><td>打包最终APK的task。如果这个Variant是个库，这个值可以为空。</td></tr><tr><td>zipAlign</td><td>ZipAlign</td><td>zip压缩APK的task。如果这个Variant是个库或者APK不能被签名，这个值可以为空。</td></tr><tr><td>install</td><td>DefaultTask</td><td>负责安装的task，不能为空。</td></tr><tr><td>uninstall</td><td>DefaultTask</td><td>负责卸载的task。</td></tr><tr><td>connectedAndroidTest</td><td>DefaultTask</td><td>在连接设备上行执行Android测试的task。</td></tr><tr><td>providerAndroidTest</td><td>DefaultTask</td><td>使用扩展API执行Android测试的task。</td></tr></table>

<p>Android task特有类型的API：</p>
<ul>
<li>ProcessManifest<ul>
<li>File manifestOutputFile</li>
</ul>
</li>
<li>AidlCompile<ul>
<li>File sourceOutputDir</li>
</ul>
</li>
<li>RenderscriptCompile<ul>
<li>File sourceOutputDir</li>
<li>File resOutputDir</li>
</ul>
</li>
<li>MergeResources<ul>
<li>File outputDir</li>
</ul>
</li>
<li>MergeAssets<ul>
<li>File outputDir</li>
</ul>
</li>
<li>ProcessAndroidResources<ul>
<li>File manifestFile</li>
<li>File resDir</li>
<li>File assetsDir</li>
<li>File sourceOutputDir</li>
<li>File textSymbolOutputDir</li>
<li>File packageOutputFile</li>
<li>File proguardOutputFile</li>
</ul>
</li>
<li>GenerateBuildConfig<ul>
<li>File sourceOutputDir</li>
</ul>
</li>
<li>Dex<ul>
<li>File outputFolder</li>
</ul>
</li>
<li>PackageApplication<ul>
<li>File resourceFile</li>
<li>File dexFile</li>
<li>File javaResourceDir</li>
<li>File jniDir</li>
<li>File outputFile<br>直接在Variant对象中使用“outputFile”可以改变最终的输出文件夹。</li>
</ul>
</li>
<li>ZipAlign<ul>
<li>File inputFile</li>
<li>File outputFile<br>直接在Variant对象中使用“outputFile”可以改变最终的输出文件夹。</li>
</ul>
</li>
</ul>
<p>每个task类型的API由于Gradle的工作方式和Android plugin的配置方式而受到限制。 首先，Gradle意味着拥有的task只能配置输入输出的路径和一些可能使用的选项标识。因此，task只能定义一些输入或者输出。</p>
<p>其次，这里面大多数task的输入都不是单一的，一般都混合了sourceSet、Build Type和Product Flavor中的值。为了保持构建文件的简单和可读性，目标是要让开发者通过DSL语言修改这些对象来配饰构建的过程，而不是深入修改输入和task的选项。</p>
<p>另外需要注意，除了ZipAlign这个task类型，其它所有类型都要求设置私有数据来让它们运行。这意味着不可能自动创建这些类型的新task实例。<br>这些API也可能会被更改。一般来说，目前的API是围绕着给定task的输入和输出入口来添加额外的处理（如果需要的时候）。欢迎反馈意见，特别是那些没有预见过的需求。<br>对于Gradle的task（DefaultTask，JavaCompile，Copy，Zip），请参考Gradle文档。</p>
<h3 id="7-3-BuildType和Product-Flavor属性参考"><a href="#7-3-BuildType和Product-Flavor属性参考" class="headerlink" title="7.3 BuildType和Product Flavor属性参考"></a>7.3 BuildType和Product Flavor属性参考</h3><p>coming soon。。。。= = 对于Gradle的task（DefaultTask，JavaCompile，Copy，Zip），请参考Gradle文档。</p>
<h3 id="7-4-使用（JDK）1-7版本的sourceCompatibility"><a href="#7-4-使用（JDK）1-7版本的sourceCompatibility" class="headerlink" title="7.4 使用（JDK）1.7版本的sourceCompatibility"></a>7.4 使用（JDK）1.7版本的sourceCompatibility</h3><p>使用Android KitKat（19版本的buildTools）就可以使用diamond operator，multi-catch，switch中使用字符串，try with resource等等（译注：都是JDK7的一些新特性，详情请参考JDK7文档）。设置使用1.7版本，需要修改你的构建文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    compileSdkVersion 19</div><div class="line">    buildToolsVersion <span class="string">"19.0.0"</span></div><div class="line"></div><div class="line">    defaultConfig &#123;</div><div class="line">        minSdkVersion 7</div><div class="line">        targetSdkVersion 19</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    compileOptions &#123;</div><div class="line">        sourceCompatibility JavaVersion.VERSION_1_7</div><div class="line">        targetCompatibility JavaVersion.VERSION_1_7</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>使用Android KitKat（19版本的buildTools）就可以使用diamond operator，multi-catch，switch中使用字符串，try with resource等等（译注：都是JDK7的一些新特性，详情请参考JDK7文档）。设置使用1.7版本，需要修改你的构建文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    compileSdkVersion 19</div><div class="line">    buildToolsVersion <span class="string">"19.0.0"</span></div><div class="line"></div><div class="line">    defaultConfig &#123;</div><div class="line">        minSdkVersion 7</div><div class="line">        targetSdkVersion 19</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    compileOptions &#123;</div><div class="line">        sourceCompatibility JavaVersion.VERSION_1_7</div><div class="line">        targetCompatibility JavaVersion.VERSION_1_7</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>注意：你可以将minSdkVersion的值设置为19之前的版本，只是你只能使用除了try with resources之外的其它新语言特性。如果你想要使用try with resources特性，你就需要把minSdkVersion也设置为19。</p>
</blockquote>
<p>你同样也需要确认Gradle使用1.7或者更高版本的JDK（Android Gradle plugin也需要0.6.1或者更高的版本）。注意：你可以将minSdkVersion的值设置为19之前的版本，只是你只能使用除了try with resources之外的其它新语言特性。如果你想要使用try with resources特性，你就需要把minSdkVersion也设置为19。</p>
<p>你同样也需要确认Gradle使用1.7或者更高版本的JDK（Android Gradle plugin也需要0.6.1或者更高的版本）。</p>
<h2 id="补充说明"><a href="#补充说明" class="headerlink" title="补充说明"></a>补充说明</h2><p>该官方文档的翻译大部分参考了<a href="http://blog.csdn.net/qinxiandiqi/article/category/2394347" target="_blank" rel="external">琴弦第七</a>的翻译,鉴于他翻译的版本比较老了，所以根据官方文档做了局部更新，水平有限，翻译错误请留言。</p>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul>
<li><a href="http://blog.csdn.net/qinxiandiqi/article/category/2394347" target="_blank" rel="external">中文版原文翻译</a></li>
<li><a href="http://avatarqing.github.io/Gradle-Plugin-User-Guide-Chinese-Verision" target="_blank" rel="external">中文版avatarqing整理版本</a></li>
<li><a href="https://github.com/AvatarQing/Gradle-Plugin-User-Guide-Chinese-Verision" target="_blank" rel="external">avatarqing版本GitHub地址</a></li>
<li><a href="http://tools.android.com/tech-docs/new-build-system/user-guide" target="_blank" rel="external">Gradle Plugin User Guide 官方原文地址</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/11/12/android_studio_gradle_guide/" data-id="cj4zx2kj6003xqonhbx1xlv1s" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/androidstudio/">androidstudio</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gradle/">gradle</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-android_studio_problems_solution" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/11/11/android_studio_problems_solution/" class="article-date">
  <time datetime="2015-11-11T10:00:29.000Z" itemprop="datePublished">2015-11-11</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/android/">android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/11/android_studio_problems_solution/">AndroidStudio常见问题解决方案</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="问题1-Error-1-0-Plugin-with-id-‘com-android-application’-not-found"><a href="#问题1-Error-1-0-Plugin-with-id-‘com-android-application’-not-found" class="headerlink" title="问题1: Error:(1, 0) Plugin with id ‘com.android.application’ not found"></a>问题1: Error:(1, 0) Plugin with id ‘com.android.application’ not found</h2><p>Latest Gradle: 2.8</p>
<p>Check with: gradle -v</p>
<p>Download here: <a href="http://services.gradle.org/distributions/gradle-2.8-bin.zip" target="_blank" rel="external">http://services.gradle.org/distributions/gradle-2.8-bin.zip</a></p>
<p>Latest Android Build Tools: 1.3.1</p>
<p>If you add the following code snippet to the top of your build.gradle file, gradle will update the build tools.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">buildscript &#123;</div><div class="line">    repositories &#123;</div><div class="line">        jcenter() <span class="comment">// or mavenCentral()</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    dependencies &#123;</div><div class="line">        classpath <span class="string">'com.android.tools.build:gradle:1.3.1'</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Read more here: <a href="http://tools.android.com/tech-docs/new-build-system" target="_blank" rel="external">http://tools.android.com/tech-docs/new-build-system</a></p>
<h2 id="问题2-Error-Cause-failed-to-find-target-with-hash-string-‘android-xx’-in-C-xxx"><a href="#问题2-Error-Cause-failed-to-find-target-with-hash-string-‘android-xx’-in-C-xxx" class="headerlink" title="问题2: Error:Cause: failed to find target with hash string ‘android-xx’ in: C:\xxx"></a>问题2: Error:Cause: failed to find target with hash string ‘android-xx’ in: C:\xxx</h2><p>Android Studio 在加载OpenCV库时, 会出现报错: “failed to find target android-xx”,修改app文件夹中的build.gradle文件即可. 把SdkVersion改为使用的SDK, 如19.<br>修改步骤：</p>
<ul>
<li>Flie — Project structure — Modules — Compile Sdk Version(选中本地可用的SDK版本)</li>
<li>对应修改build.gradle<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    compileSdkVersion 20</div><div class="line">    buildToolsVersion <span class="string">'20.0.0'</span> //与本地版本相对应</div><div class="line"></div><div class="line">    ... ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="问题3-android-studio在编译的时候提示非法字符。"><a href="#问题3-android-studio在编译的时候提示非法字符。" class="headerlink" title="问题3:android studio在编译的时候提示非法字符。"></a>问题3:android studio在编译的时候提示非法字符。</h2><p>这种问题一边都是文件编码的问题，需要注意的是即使是UTF-8的编码也是分有BOM和无BOM编码的，一般提示非法字符是因为有BOM编码引起的。解决方式是点击选中有问题的文件，ctr+shif+c复制该文件的路径，然后在notepad中ctr+o打开这个文件，在格式中，选择无BOM的UTF-8编码保存，工程刷新即可。</p>
<h2 id="问题4：Android-studio常量表达式的错误。"><a href="#问题4：Android-studio常量表达式的错误。" class="headerlink" title="问题4：Android studio常量表达式的错误。"></a>问题4：Android studio常量表达式的错误。</h2><p>在switch语句的case中，如果使用 R.id.xxx 则会提示有问题，不允许非常量在case语句中。<br>这个错误在eclipse下并没有，但是AS中会报这个错，是switch case的问题，解决方法是将switch换成if else<br>在AS中我们使用Alt＋Enter（opt+Enter for Mac）快捷键直接将switch转换为if else,如下图所示：<br><img src="http://img.blog.csdn.net/20150619184558008" alt=""></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/11/11/android_studio_problems_solution/" data-id="cj4zx2kj60043qonhcsan076b" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/androidstudio/">androidstudio</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gradle/">gradle</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-android_studio_gradle" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/11/11/android_studio_gradle/" class="article-date">
  <time datetime="2015-11-11T09:11:29.000Z" itemprop="datePublished">2015-11-11</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/android/">android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/11/android_studio_gradle/">AndroidStudio之Gradle详解(一)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>首先我们学习几个gradle 的脚本语法，掌握了这几个语法，你就能非常简单的用gradle构建打包android项目了。 首先，我们来看下一个最简单android build.gradle。</p>
<h2 id="build-gradle"><a href="#build-gradle" class="headerlink" title="build.gradle"></a>build.gradle</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line">  //设置脚本的运行环境</div><div class="line">  buildscript &#123;</div><div class="line">       //支持java 依赖库管理（maven/ivy）,用于项目的依赖。</div><div class="line">repositories &#123;</div><div class="line">          mavenCentral()</div><div class="line">      &#125;</div><div class="line">      //依赖包的定义。支持maven/ivy，远程，本地库，也支持单文件</div><div class="line">      dependencies &#123;</div><div class="line">          classpath <span class="string">'com.android.tools.build:gradle:0.4'</span></div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">  //声明构建的项目类型，这里当然是android了</div><div class="line">  apply plugin: <span class="string">'android'</span></div><div class="line">  //设置编译android项目的参数</div><div class="line">  android &#123;</div><div class="line">      compileSdkVersion 17</div><div class="line">      buildToolsVersion <span class="string">"17"</span></div><div class="line">  </div><div class="line">      defaultConfig &#123;</div><div class="line">          minSdkVersion 8</div><div class="line">          targetSdkVersion 17</div><div class="line">      &#125;</div><div class="line">      //Android默认配置</div><div class="line">      sourceSets &#123;</div><div class="line">          main &#123;</div><div class="line">              manifest.srcFile <span class="string">'AndroidManifest.xml'</span></div><div class="line">              java.srcDirs = [<span class="string">'src'</span>]</div><div class="line">              resources.srcDirs = [<span class="string">'src'</span>]</div><div class="line">              aidl.srcDirs = [<span class="string">'src'</span>]</div><div class="line">              renderscript.srcDirs = [<span class="string">'src'</span>]</div><div class="line">              res.srcDirs = [<span class="string">'res'</span>]</div><div class="line">              assets.srcDirs = [<span class="string">'assets'</span>]</div><div class="line">          &#125;</div><div class="line">          //测试所在的路径，这里假设是tests文件夹，没有可以不写这一行</div><div class="line">          instrumentTest.setRoot(<span class="string">'tests'</span>)</div><div class="line">      &#125;</div><div class="line">      </div><div class="line">      //这个是解决lint报错的代码</div><div class="line">      lintOptions &#123;</div><div class="line">          abortOnError <span class="literal">false</span></div><div class="line">      &#125;</div><div class="line">      /**</div><div class="line">       * 签名设置</div><div class="line">       */</div><div class="line">      signingConfigs &#123;</div><div class="line">          myConfigs &#123;</div><div class="line">              storeFile file(<span class="string">"签名文件地址"</span>)</div><div class="line">              keyAlias <span class="string">"..."</span></div><div class="line">              keyPassword <span class="string">"..."</span></div><div class="line">              storePassword <span class="string">"..."</span></div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">      /**</div><div class="line">       * 混淆设置</div><div class="line">       */</div><div class="line">      buildTypes &#123;</div><div class="line">          release &#123;</div><div class="line">              signingConfig signingConfigs.myConfigs</div><div class="line">              runProguard <span class="literal">true</span></div><div class="line">              proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>), <span class="string">'proguard-rules.pro'</span></div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">      /**</div><div class="line">       * 渠道打包（不同包名）</div><div class="line">       */</div><div class="line">      productFlavors &#123;</div><div class="line">          qqqq &#123;</div><div class="line">              applicationId = <span class="string">'包名'</span></div><div class="line">          &#125;</div><div class="line">          hhhhh &#123;</div><div class="line">              applicationId=<span class="string">'包名'</span></div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">  /**</div><div class="line">   * .so文件的导入</div><div class="line">   */</div><div class="line">  task copyNativeLibs(<span class="built_in">type</span>: Copy) &#123;</div><div class="line">      from fileTree(dir: <span class="string">'libs'</span>, include: <span class="string">'armeabi/*.so'</span>) into <span class="string">'build/lib'</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  tasks.withType(Compile) &#123;</div><div class="line">      options.encoding = <span class="string">"UTF-8"</span></div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  tasks.withType(Compile) &#123;</div><div class="line">      compileTask -&gt; compileTask.dependsOn copyNativeLibs</div><div class="line">  &#125;</div><div class="line">  clean.dependsOn <span class="string">'cleanCopyNativeLibs'</span></div><div class="line">  tasks.withType(com.android.build.gradle.tasks.PackageApplication) &#123; pkgTask -&gt;</div><div class="line">      pkgTask.jniFolders = [new File(buildDir, <span class="string">'lib'</span>)]</div><div class="line">  &#125;</div><div class="line">  //依赖库</div><div class="line">  dependencies &#123;</div><div class="line">  compile fileTree(dir: <span class="string">'libs'</span>, include: [<span class="string">'*.jar'</span>])</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h2 id="本地依赖"><a href="#本地依赖" class="headerlink" title="本地依赖"></a>本地依赖</h2><p>gradle 作为构建工具，能够很方便的使用本地jar包，以下为使用的代码块。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;	</div><div class="line">        //单文件依赖</div><div class="line">	compile files(<span class="string">'libs/android-support-v4.jar'</span>)	</div><div class="line">	//某个文件夹下面全部依赖</div><div class="line">	compile fileTree(dir: <span class="string">'libs'</span>, include: <span class="string">'*.jar'</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line">android &#123;</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="远程依赖"><a href="#远程依赖" class="headerlink" title="远程依赖"></a>远程依赖</h2><p>gradle 同时支持maven，ivy，由于ivy我没用过，所以用maven 作为例子，以下为代码块：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">repositories &#123;	</div><div class="line">        //从中央库里面获取依赖</div><div class="line">	mavenCentral()	</div><div class="line">	//或者使用指定的本地maven 库</div><div class="line">	maven&#123;</div><div class="line">		url <span class="string">"file://F:/githubrepo/releases"</span></div><div class="line">	&#125;	</div><div class="line">	//或者使用指定的远程maven库</div><div class="line">	maven&#123;</div><div class="line">		url <span class="string">"远程库地址"</span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">dependencies &#123;	</div><div class="line">        //应用格式: packageName:artifactId:version</div><div class="line">	compile <span class="string">'com.google.android:support-v4:r13'</span>&#125;</div><div class="line"></div><div class="line">android &#123;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="android-library-依赖"><a href="#android-library-依赖" class="headerlink" title="android library 依赖"></a>android library 依赖</h2><p>对于项目依赖 android library的话，就不是依赖一个jar，那么简单了，在这里需要使用gradle mulit project 机制。在过去，android library并没有一个很好的包管理方式，简单来说，在gradle出现以前，官方并没有一种用于管理android library 依赖包的方式，一般我们都是直接下载别人的android library project 源码进行集成，而对于第三方的android-maven-plugin 用的是apklib 格式。</p>
<p>而现在，官方终于推出一种android library的打包格式，扩展名为<em>.aar。前面提到，目前android gradle插件并不支持本地直接使用</em>.aar文件，不过，支持包管理库的引用方式，下面，我为大家说一下，怎么对android library 发布使用。</p>
<h2 id="打包android-library"><a href="#打包android-library" class="headerlink" title="打包android library"></a>打包android library</h2><p>对android library 进行打包直接在library项目下面使用gradle build 即可，然后，你就会在 build/libs 目录下看到两个*.aar文件，一个debug包用的，一个是release 下用的，看个人需求使用，这里我们用的是release 版本的 .aar 文件。</p>
<p>引用脚本跟前面讲的依赖库相似<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    compile(name: <span class="string">'pulltorefresh'</span>, ext: <span class="string">'aar'</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最后，分享个maven库地址：<a href="http://mvnrepository.com/" target="_blank" rel="external">http://mvnrepository.com/</a></p>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul>
<li><a href="http://tools.android.com/tech-docs/new-build-system/user-guide" target="_blank" rel="external">Gradle官方文档</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/11/11/android_studio_gradle/" data-id="cj4zx2kiq003tqonh6it6nwl0" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/androidstudio/">androidstudio</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gradle/">gradle</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/page/5/">&laquo; __('prev')</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><a class="page-number" href="/page/8/">8</a><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/7/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/algorithm/">algorithm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/android/">android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/article/">article</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/coding/">coding</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/">database</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/framework/">framework</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/humanism/">humanism</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/message-push/">message_push</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/music/">music</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ndk/">ndk</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/note/">note</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/protocol/">protocol</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/reading/">reading</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/springmvc/">springmvc</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/string/">string</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/study/">study</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tools/">tools</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/versioncontroll/">versioncontroll</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/好文/">好文</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/电影/">电影</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AliPay/">AliPay</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Einstein/">Einstein</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GreenDao/">GreenDao</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ORMLite/">ORMLite</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WXPay/">WXPay</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/activity/">activity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android-studio/">android_studio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android-ui/">android_ui</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/androidstudio/">androidstudio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/animation/">animation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/application/">application</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/book/">book</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/broadcast/">broadcast</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bugfix/">bugfix</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/chinese-weman/">chinese_weman</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/code-collection/">code_collection</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/context/">context</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/database/">database</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/decomplication/">decomplication</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/design-model/">design model</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/eclipse/">eclipse</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/eventbus/">eventbus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/feminism/">feminism</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fullstack/">fullstack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github/">github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/google/">google</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gradle/">gradle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/handle/">handle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/handler/">handler</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/http/">http</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/https/">https</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/humanism/">humanism</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iframe/">iframe</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/image/">image</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/imageloader/">imageloader</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/intent/">intent</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/intentflag/">intentflag</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iphone/">iphone</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jni/">jni</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/listview/">listview</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/markdown/">markdown</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/material-design/">material_design</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maven/">maven</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/music/">music</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mvp/">mvp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nd/">nd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/notification/">notification</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/obfuscation/">obfuscation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/observer/">observer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/opensource/">opensource</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/otto/">otto</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pageradapter/">pageradapter</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pay/">pay</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/placeholder/">placeholder</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/project-build/">project_build</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pulltorefresh/">pulltorefresh</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pulltorefreshlistview/">pulltorefreshlistview</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/saxophone/">saxophone</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/screen-record/">screen-record</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shortkey/">shortkey</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/snack/">snack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/socket/">socket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sort/">sort</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spannable/">spannable</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/speech/">speech</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/springmvc/">springmvc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sqlite/">sqlite</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ssl/">ssl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sublime/">sublime</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/svg/">svg</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/svn/">svn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/templates/">templates</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/textview/">textview</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tomcat/">tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/translate/">translate</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/viewpager/">viewpager</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/volley/">volley</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/website/">website</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webview/">webview</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xpnet/">xpnet</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/书单/">书单</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/史玉柱/">史玉柱</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/感悟/">感悟</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/电影/">电影</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/贾樟柯/">贾樟柯</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/AliPay/" style="font-size: 10px;">AliPay</a> <a href="/tags/Einstein/" style="font-size: 10px;">Einstein</a> <a href="/tags/GreenDao/" style="font-size: 10px;">GreenDao</a> <a href="/tags/ORMLite/" style="font-size: 10px;">ORMLite</a> <a href="/tags/WXPay/" style="font-size: 10px;">WXPay</a> <a href="/tags/activity/" style="font-size: 10px;">activity</a> <a href="/tags/android-studio/" style="font-size: 10px;">android_studio</a> <a href="/tags/android-ui/" style="font-size: 10px;">android_ui</a> <a href="/tags/androidstudio/" style="font-size: 20px;">androidstudio</a> <a href="/tags/animation/" style="font-size: 20px;">animation</a> <a href="/tags/application/" style="font-size: 10px;">application</a> <a href="/tags/book/" style="font-size: 10px;">book</a> <a href="/tags/broadcast/" style="font-size: 10px;">broadcast</a> <a href="/tags/bugfix/" style="font-size: 13.33px;">bugfix</a> <a href="/tags/chinese-weman/" style="font-size: 10px;">chinese_weman</a> <a href="/tags/code-collection/" style="font-size: 10px;">code_collection</a> <a href="/tags/context/" style="font-size: 10px;">context</a> <a href="/tags/database/" style="font-size: 10px;">database</a> <a href="/tags/decomplication/" style="font-size: 10px;">decomplication</a> <a href="/tags/design-model/" style="font-size: 13.33px;">design model</a> <a href="/tags/eclipse/" style="font-size: 10px;">eclipse</a> <a href="/tags/eventbus/" style="font-size: 10px;">eventbus</a> <a href="/tags/feminism/" style="font-size: 10px;">feminism</a> <a href="/tags/fullstack/" style="font-size: 10px;">fullstack</a> <a href="/tags/github/" style="font-size: 13.33px;">github</a> <a href="/tags/google/" style="font-size: 10px;">google</a> <a href="/tags/gradle/" style="font-size: 16.67px;">gradle</a> <a href="/tags/handle/" style="font-size: 10px;">handle</a> <a href="/tags/handler/" style="font-size: 10px;">handler</a> <a href="/tags/hexo/" style="font-size: 16.67px;">hexo</a> <a href="/tags/http/" style="font-size: 10px;">http</a> <a href="/tags/https/" style="font-size: 10px;">https</a> <a href="/tags/humanism/" style="font-size: 10px;">humanism</a> <a href="/tags/iframe/" style="font-size: 10px;">iframe</a> <a href="/tags/image/" style="font-size: 10px;">image</a> <a href="/tags/imageloader/" style="font-size: 20px;">imageloader</a> <a href="/tags/intent/" style="font-size: 10px;">intent</a> <a href="/tags/intentflag/" style="font-size: 13.33px;">intentflag</a> <a href="/tags/iphone/" style="font-size: 10px;">iphone</a> <a href="/tags/jni/" style="font-size: 10px;">jni</a> <a href="/tags/listview/" style="font-size: 10px;">listview</a> <a href="/tags/markdown/" style="font-size: 10px;">markdown</a> <a href="/tags/material-design/" style="font-size: 10px;">material_design</a> <a href="/tags/maven/" style="font-size: 10px;">maven</a> <a href="/tags/music/" style="font-size: 13.33px;">music</a> <a href="/tags/mvp/" style="font-size: 10px;">mvp</a> <a href="/tags/mysql/" style="font-size: 16.67px;">mysql</a> <a href="/tags/nd/" style="font-size: 10px;">nd</a> <a href="/tags/notification/" style="font-size: 10px;">notification</a> <a href="/tags/obfuscation/" style="font-size: 10px;">obfuscation</a> <a href="/tags/observer/" style="font-size: 10px;">observer</a> <a href="/tags/opensource/" style="font-size: 13.33px;">opensource</a> <a href="/tags/otto/" style="font-size: 10px;">otto</a> <a href="/tags/pageradapter/" style="font-size: 10px;">pageradapter</a> <a href="/tags/pay/" style="font-size: 13.33px;">pay</a> <a href="/tags/placeholder/" style="font-size: 10px;">placeholder</a> <a href="/tags/project-build/" style="font-size: 10px;">project_build</a> <a href="/tags/pulltorefresh/" style="font-size: 10px;">pulltorefresh</a> <a href="/tags/pulltorefreshlistview/" style="font-size: 13.33px;">pulltorefreshlistview</a> <a href="/tags/saxophone/" style="font-size: 10px;">saxophone</a> <a href="/tags/screen-record/" style="font-size: 10px;">screen-record</a> <a href="/tags/shortkey/" style="font-size: 10px;">shortkey</a> <a href="/tags/snack/" style="font-size: 10px;">snack</a> <a href="/tags/socket/" style="font-size: 10px;">socket</a> <a href="/tags/sort/" style="font-size: 13.33px;">sort</a> <a href="/tags/spannable/" style="font-size: 10px;">spannable</a> <a href="/tags/speech/" style="font-size: 10px;">speech</a> <a href="/tags/springmvc/" style="font-size: 10px;">springmvc</a> <a href="/tags/sqlite/" style="font-size: 10px;">sqlite</a> <a href="/tags/ssl/" style="font-size: 13.33px;">ssl</a> <a href="/tags/sublime/" style="font-size: 10px;">sublime</a> <a href="/tags/svg/" style="font-size: 13.33px;">svg</a> <a href="/tags/svn/" style="font-size: 13.33px;">svn</a> <a href="/tags/templates/" style="font-size: 10px;">templates</a> <a href="/tags/textview/" style="font-size: 10px;">textview</a> <a href="/tags/tomcat/" style="font-size: 16.67px;">tomcat</a> <a href="/tags/translate/" style="font-size: 10px;">translate</a> <a href="/tags/viewpager/" style="font-size: 13.33px;">viewpager</a> <a href="/tags/volley/" style="font-size: 10px;">volley</a> <a href="/tags/website/" style="font-size: 13.33px;">website</a> <a href="/tags/webview/" style="font-size: 10px;">webview</a> <a href="/tags/xpnet/" style="font-size: 13.33px;">xpnet</a> <a href="/tags/书单/" style="font-size: 10px;">书单</a> <a href="/tags/史玉柱/" style="font-size: 10px;">史玉柱</a> <a href="/tags/感悟/" style="font-size: 10px;">感悟</a> <a href="/tags/电影/" style="font-size: 10px;">电影</a> <a href="/tags/贾樟柯/" style="font-size: 10px;">贾樟柯</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/11/11/study_my_website_collection/">常用网站收集</a>
          </li>
        
          <li>
            <a href="/2016/05/04/web_develop_config/">WEB开发之环境配置</a>
          </li>
        
          <li>
            <a href="/2016/05/04/web_springmvc1/">Spring MVC入门(一)</a>
          </li>
        
          <li>
            <a href="/2016/04/07/android_network_ssl/">为你的Android App实现自签名的SSL证书</a>
          </li>
        
          <li>
            <a href="/2016/03/28/android_notification_push/">Android实现推送方式解决方案</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 ARESXIONG<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>