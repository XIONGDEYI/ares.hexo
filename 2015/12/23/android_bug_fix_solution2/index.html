<!DOCTYPE html>
<html >
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="ARESXIONG" />



<meta name="description" content="IntroductionThe Dalvik VM provides facilities for developers to perform custom class loading. Instead of loading Dalvik executable (“dex”) files from the default location, an application can load them">
<meta name="keywords" content="bugfix">
<meta property="og:type" content="article">
<meta property="og:title" content="Custom Class Loading in Dalvik">
<meta property="og:url" content="http://yoursite.com/2015/12/23/android_bug_fix_solution2/index.html">
<meta property="og:site_name" content="ARESXIONG">
<meta property="og:description" content="IntroductionThe Dalvik VM provides facilities for developers to perform custom class loading. Instead of loading Dalvik executable (“dex”) files from the default location, an application can load them">
<meta property="og:updated_time" content="2017-07-11T17:45:09.214Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Custom Class Loading in Dalvik">
<meta name="twitter:description" content="IntroductionThe Dalvik VM provides facilities for developers to perform custom class loading. Instead of loading Dalvik executable (“dex”) files from the default location, an application can load them">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="ARESXIONG" type="application/atom+xml">



    <link rel="shortcut icon" href="/favicon.png">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">



<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>Custom Class Loading in Dalvik | ARESXIONG</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: undefined
    }
</script>


    <script> yiliaConfig.jquery_ui = [false]; </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/avatar.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">ARESXIONG</a></h1>
        </hgroup>

        

        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>Menu</li>
                        <li>Tags</li>
                        
                        <li>Friends</li>
                        
                        
                        <li>About Me</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:123@123.com" title="Email"></a>
                            
                                <a class="fa GitHub" href="#" title="GitHub"></a>
                            
                                <a class="fa RSS" href="/atom.xml" title="RSS"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AliPay/">AliPay</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Einstein/">Einstein</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GreenDao/">GreenDao</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ORMLite/">ORMLite</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WXPay/">WXPay</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/activity/">activity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android-studio/">android_studio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android-ui/">android_ui</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/androidstudio/">androidstudio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/animation/">animation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/application/">application</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/book/">book</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/broadcast/">broadcast</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bugfix/">bugfix</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/chinese-weman/">chinese_weman</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/code-collection/">code_collection</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/context/">context</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/database/">database</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/decomplication/">decomplication</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/design-model/">design model</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/eclipse/">eclipse</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/eventbus/">eventbus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/feminism/">feminism</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fullstack/">fullstack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github/">github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/google/">google</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gradle/">gradle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/handle/">handle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/handler/">handler</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/http/">http</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/https/">https</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/humanism/">humanism</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iframe/">iframe</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/image/">image</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/imageloader/">imageloader</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/intent/">intent</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/intentflag/">intentflag</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iphone/">iphone</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jni/">jni</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/listview/">listview</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/markdown/">markdown</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/material-design/">material_design</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maven/">maven</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/music/">music</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mvp/">mvp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nd/">nd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/notification/">notification</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/obfuscation/">obfuscation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/observer/">observer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/opensource/">opensource</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/otto/">otto</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pageradapter/">pageradapter</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pay/">pay</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/placeholder/">placeholder</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/project-build/">project_build</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pulltorefresh/">pulltorefresh</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pulltorefreshlistview/">pulltorefreshlistview</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/saxophone/">saxophone</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/screen-record/">screen-record</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shortkey/">shortkey</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/snack/">snack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/socket/">socket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sort/">sort</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spannable/">spannable</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/speech/">speech</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/springmvc/">springmvc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sqlite/">sqlite</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ssl/">ssl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sublime/">sublime</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/svg/">svg</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/svn/">svn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/templates/">templates</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/textview/">textview</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tomcat/">tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/translate/">translate</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/viewpager/">viewpager</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/volley/">volley</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/website/">website</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webview/">webview</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xpnet/">xpnet</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/书单/">书单</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/史玉柱/">史玉柱</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/感悟/">感悟</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/电影/">电影</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/贾樟柯/">贾樟柯</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="https://hexo.io">Hexo</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://pages.github.com/">GitHub</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://moxfive.xyz/">MOxFIVE</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">专注于前端</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">ARESXIONG</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/avatar.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">ARESXIONG</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:123@123.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="#" title="GitHub"></a>
                            
                                <a class="fa RSS" target="_blank" href="/atom.xml" title="RSS"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="Tags" friends="Friends" about="About Me"/>
</nav>
      <div class="body-wrap"><article id="post-android_bug_fix_solution2" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/23/android_bug_fix_solution2/" class="article-date">
      <time datetime="2015-12-23T02:15:29.000Z" itemprop="datePublished">2015-12-23</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Custom Class Loading in Dalvik
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/android/">android</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/bugfix/">bugfix</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>The Dalvik VM provides facilities for developers to perform custom class loading. Instead of loading Dalvik executable (“dex”) files from the default location, an application can load them from alternative locations such as internal storage or over the network.</p>
<p>This technique is not for every application; In fact, most do just fine without it. However, there are situations where custom class loading can come in handy. Here are a couple of scenarios:</p>
<ul>
<li>Big apps can contain more than 64K method references, which is the maximum number of supported in a dex file. To get around this limitation, developers can partition part of the program into multiple secondary dex files, and load them at runtime.</li>
<li>Frameworks can be designed to make their execution logic extensible by dynamic code loading at runtime.</li>
</ul>
<p>We have created a sample app to demonstrate the partitioning of dex files and runtime class loading. (Note that for reasons discussed below, the app cannot be built with the ADT Eclipse plug-in. Instead, use the included Ant build script. See Readme.txt for detail.)</p>
<p>The app has a simple Activity that invokes a library component to display a Toast. The Activity and its resources are kept in the default dex, whereas the library code is stored in a secondary dex bundled in the APK. This requires a modified build process, which is shown below in detail.</p>
<p>Before the library method can be invoked, the app has to first explicitly load the secondary dex file. Let’s take a look at the relevant moving parts.</p>
<h2 id="Code-Organization"><a href="#Code-Organization" class="headerlink" title="Code Organization"></a>Code Organization</h2><p>The application consists of 3 classes.</p>
<ul>
<li>com.example.dex.MainActivity: UI component from which the library is invoked</li>
<li>com.example.dex.LibraryInterface: Interface definition for the library</li>
<li>com.example.dex.lib.LibraryProvider: Implementation of the library</li>
</ul>
<p>The library is packaged in a secondary dex, while the rest of the classes are included in the default (primary) dex file. The “Build process” section below illustrates how to accomplish this. Of course, the packaging decision is dependent on the particular scenario a developer is dealing with.<br>Class loading and method invocation</p>
<p>The secondary dex file, containing LibraryProvider, is stored as an application asset. First, it has to be copied to a storage location whose path can be supplied to the class loader. The sample app uses the app’s private internal storage area for this purpose. (Technically, external storage would also work, but one has to consider the security implications of keeping application binaries there.)</p>
<p>Below is a snippet from MainActivity where standard file I/O is used to accomplish the copying.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">// Before the secondary dex file can be processed by the DexClassLoader,</div><div class="line">// it has to be first copied from asset resource to a storage location.</div><div class="line">File dexInternalStoragePath = new File(getDir(&quot;dex&quot;, Context.MODE_PRIVATE),</div><div class="line">        SECONDARY_DEX_NAME);</div><div class="line">...</div><div class="line">BufferedInputStream bis = null;</div><div class="line">OutputStream dexWriter = null;</div><div class="line"></div><div class="line">static final int BUF_SIZE = 8 * 1024;</div><div class="line">try &#123;</div><div class="line">    bis = new BufferedInputStream(getAssets().open(SECONDARY_DEX_NAME));</div><div class="line">    dexWriter = new BufferedOutputStream(</div><div class="line">        new FileOutputStream(dexInternalStoragePath));</div><div class="line">    byte[] buf = new byte[BUF_SIZE];</div><div class="line">    int len;</div><div class="line">    while((len = bis.read(buf, 0, BUF_SIZE)) &gt; 0) &#123;</div><div class="line">        dexWriter.write(buf, 0, len);</div><div class="line">    &#125;</div><div class="line">    dexWriter.close();</div><div class="line">    bis.close();</div><div class="line">    </div><div class="line">&#125; catch (. . .) &#123;...&#125;</div></pre></td></tr></table></figure></p>
<p>Next, a <a href="http://developer.android.com/reference/dalvik/system/DexClassLoader.html" target="_blank" rel="external">DexClassLoader</a> is instantiated to load the library from the extracted secondary dex file. There are a couple of ways to invoke methods on classes loaded in this manner. In this sample, the class instance is cast to an interface through which the method is called directly.</p>
<p>Another approach is to invoke methods using the reflection API. The advantage of using reflection is that it doesn’t require the secondary dex file to implement any particular interfaces. However, one should be aware that reflection is verbose and slow.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">// Internal storage where the DexClassLoader writes the optimized dex file to</div><div class="line">final File optimizedDexOutputPath = getDir(&quot;outdex&quot;, Context.MODE_PRIVATE);</div><div class="line"></div><div class="line">DexClassLoader cl = new DexClassLoader(dexInternalStoragePath.getAbsolutePath(),</div><div class="line">                                       optimizedDexOutputPath.getAbsolutePath(),</div><div class="line">                                       null,</div><div class="line">                                       getClassLoader());</div><div class="line">Class libProviderClazz = null;</div><div class="line">try &#123;</div><div class="line">    // Load the library.</div><div class="line">    libProviderClazz =</div><div class="line">        cl.loadClass(&quot;com.example.dex.lib.LibraryProvider&quot;);</div><div class="line">    // Cast the return object to the library interface so that the</div><div class="line">    // caller can directly invoke methods in the interface.</div><div class="line">    // Alternatively, the caller can invoke methods through reflection,</div><div class="line">    // which is more verbose. </div><div class="line">    LibraryInterface lib = (LibraryInterface) libProviderClazz.newInstance();</div><div class="line">    lib.showAwesomeToast(this, &quot;hello&quot;);</div><div class="line">&#125; catch (Exception e) &#123; ... &#125;</div></pre></td></tr></table></figure></p>
<h2 id="Build-Process"><a href="#Build-Process" class="headerlink" title="Build Process"></a>Build Process</h2><p>In order to churn out two separate dex files, we need to tweak the standard build process. To do the trick, we simply modify the “-dex” target in the project’s Ant <a href="http://code.google.com/p/android-custom-class-loading-sample/source/browse/trunk/android-custom-class-loading-sample/build.xml" target="_blank" rel="external">build.xml</a>.</p>
<p>The modified “-dex” target performs the following operations:</p>
<p>1.Create two staging directories to store .class files to be converted to the default dex and the secondary dex.</p>
<p>2.Selectively copy .class files from PROJECT_ROOT/bin/classes to the two staging directories.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;!-- Primary dex to include everything but the concrete library</div><div class="line">           implementation. --&gt;</div><div class="line">      &lt;copy todir=&quot;$&#123;out.classes.absolute.dir&#125;.1&quot; &gt;</div><div class="line">          &lt;fileset dir=&quot;$&#123;out.classes.absolute.dir&#125;&quot; &gt;</div><div class="line">                  &lt;exclude name=&quot;com/example/dex/lib/**&quot; /&gt;</div><div class="line">          &lt;/fileset&gt;</div><div class="line">      &lt;/copy&gt;</div><div class="line">      &lt;!-- Secondary dex to include the concrete library implementation. --&gt;</div><div class="line">      &lt;copy todir=&quot;$&#123;out.classes.absolute.dir&#125;.2&quot; &gt;</div><div class="line">          &lt;fileset dir=&quot;$&#123;out.classes.absolute.dir&#125;&quot; &gt;</div><div class="line">                  &lt;include name=&quot;com/example/dex/lib/**&quot; /&gt;</div><div class="line">          &lt;/fileset&gt;</div><div class="line">      &lt;/copy&gt;</div></pre></td></tr></table></figure></p>
<p>3.Convert .class files from the two staging directories into two separate dex files.</p>
<p>4.Add the secondary dex file to a jar file, which is the expected input format for the DexClassLoader. Lastly, store the jar file in the “assets” directory of the project.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;!-- Package the output in the assets directory of the apk. --&gt;</div><div class="line">        &lt;jar destfile=&quot;$&#123;asset.absolute.dir&#125;/secondary_dex.jar&quot;</div><div class="line">               basedir=&quot;$&#123;out.absolute.dir&#125;/secondary_dex_dir&quot;</div><div class="line">               includes=&quot;classes.dex&quot; /&gt;</div></pre></td></tr></table></figure>
<p>To kick-off the build, you execute ant debug (or release) from the project root directory.</p>
<p>That’s it! In the right situations, dynamic class loading can be quite useful.</p>
<h2 id="Link"><a href="#Link" class="headerlink" title="Link"></a>Link</h2><ul>
<li><a href="http://android-developers.blogspot.jp/2011/07/custom-class-loading-in-dalvik.html" target="_blank" rel="external">Custom Class Loading in Dalvik</a></li>
<li><a href="https://www.facebook.com/notes/facebook-engineering/under-the-hood-dalvik-patch-for-facebook-for-android/10151345597798920" target="_blank" rel="external">Under the Hood: Dalvik patch for Facebook for Android</a></li>
<li><a href="http://developer.android.com/intl/zh-cn/tools/building/multidex.html" target="_blank" rel="external">Building Apps with Over 65K Methods</a></li>
<li><a href="https://github.com/XIONGDEYI/android-custom-class-loading-sample" target="_blank" rel="external">DEMO in GitHub</a></li>
<li><a href="http://aresxiong.com/2015/12/07/android_bug_fix_solution/" target="_blank" rel="external">安卓应用的热补丁动态修复技术</a></li>
</ul>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>Title:</span><a href="/2015/12/23/android_bug_fix_solution2/">Custom Class Loading in Dalvik</a></p>
        <p><span>Author:</span><a href="/" title="Back to Homepage">ARESXIONG</a></p>
        <p><span>Created:</span>2015-12-23, 10:15:29</p>
        <p><span>Updated:</span>2017-07-12, 01:45:09</p>
        <p>
            <span>Full URL:</span><a class="post-url" href="/2015/12/23/android_bug_fix_solution2/" title="Custom Class Loading in Dalvik">http://yoursite.com/2015/12/23/android_bug_fix_solution2/</a>
            <span class="copy-path" data-clipboard-text="From http://yoursite.com/2015/12/23/android_bug_fix_solution2/　　By ARESXIONG" title="Copy Article&#39;s Link &amp; Author"><i class="fa fa-clipboard"></i></span>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>License:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target = "_blank">"CC BY-NC-SA 4.0"</a> Keep Link &amp; Author if Distribute.
        </p>
    </div>



    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/2016/01/13/android_webview/">
                    android之WebView使用详解
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2015/12/22/android_intent/">
                    关于Intent的七大属性
                </a>
            </div>
        
    </nav>

  
</article>

    <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Code-Organization"><span class="toc-number">2.</span> <span class="toc-text">Code Organization</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Build-Process"><span class="toc-number">3.</span> <span class="toc-text">Build Process</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Link"><span class="toc-number">4.</span> <span class="toc-text">Link</span></a></li></ol>
        
    </div>
    <style>
        .left-col .switch-btn,
        .left-col .switch-area {
            display: none;
        }
        .toc-level-3 i,
        .toc-level-3 ol {
            display: none !important;
        }
    </style>

    <input type="button" id="tocButton" value="Hide"  title="Show or Hide Table of Contents">

    <script>
        yiliaConfig.toc = ["Hide", "Show", !!"false"];
    </script>



    
<div class="share">
    
        <div class="bdsharebuttonbox">
            <a href="#" class="fa fa-twitter bds_twi" data-cmd="twi" title="分享到推特"></a>
            <a href="#" class="fa fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
            <a href="#" class="fa fa-qq bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
            <a href="#" class="fa fa-files-o bds_copy" data-cmd="copy" title="复制网址"></a>
            <a href="#" class="fa fa fa-envelope-o bds_mail" data-cmd="mail" title="通过邮件分享"></a>
            <a href="#" class="fa fa-weixin bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
            <a href="#" class="fa fa-share-alt bds_more" data-cmd="more"></i></a>
        </div>
        <script>
            window._bd_share_config={
                "common":{"bdSnsKey":{},"bdText":"Custom Class Loading in Dalvik　| ARESXIONG　","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
        </script>
    

    
</div>







    




    <div class="scroll" id="post-nav-button">
        
            <a href="/2016/01/13/android_webview/" title="Pre: android之WebView使用详解">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="Mini Archives"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2015/12/22/android_intent/" title="Next: 关于Intent的七大属性">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/11/11/study_my_website_collection/">常用网站收集</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/04/web_develop_config/">WEB开发之环境配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/04/web_springmvc1/">Spring MVC入门(一)</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/07/android_network_ssl/">为你的Android App实现自签名的SSL证书</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/28/android_notification_push/">Android实现推送方式解决方案</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/17/android_frame_animation/">Android逐帧动画FrameAnimation</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/08/android_volley/">Volley详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/04/android_ndk_development1/">Android之NDK开发</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/02/article_my_faith/">爱因斯坦：我的信仰</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/25/android_string_replace/">Android占位符</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/23/note_work_xp02/">工作笔记整理02</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/23/note_work_xp01/">工作笔记整理01</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/19/algorithm_sort_heapsort/">排序算法之堆排序</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/19/algorithm_sort_heap/">排序算法之堆排序</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/27/reading_book_list1/">201601书单整理</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/13/android_project_build/">从零开始搭建架构实施Android项目</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/13/android_webview/">android之WebView使用详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/23/android_bug_fix_solution2/">Custom Class Loading in Dalvik</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/22/android_intent/">关于Intent的七大属性</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/21/android_material_design_snack/">Snackbar使用详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/16/android_event_bus_otto/">Android事件总线之Otto</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/15/reading_note_myMarketingTips_shiyuzhu/">读书笔记：我的营销心得</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/15/android_application_security/">开发安全的android应用</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/14/android_activity_start_way/">Activity中的四种启动模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/14/android_book_SmashingAndroidUI/">Smashing Android UI</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/14/android_context/">Android Context解析</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/14/android_code_collection/">ANDROID开发必备的常用代码片段整理</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/11/android_opensource_in_github2/">P2:Open Source Projects In GitHub</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/10/android_opensource_in_github/">P1:Open Source Projects In GitHub</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/10/android_screen_record/">Android手机如何录制屏幕及转GIF</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/10/android_app_obfuscation/">android应用代码混淆</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/10/android_app_decomplilcation/">android应用反编译</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/10/tools_iphone_download_app/">iPhone切换AppStore</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/09/android_textview_attributes/">TextView属性详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/08/android_design_model_observer/">Android设计模式之Observer</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/07/study_full_stack_developer/">假如你想成为全栈工程师…</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/07/android_bug_fix_solution/">安卓应用的热补丁动态修复技术</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/05/tools_hexo_article_contents/">为Hexo博客文章添加目录</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/05/tools_ubuntu_svn_server/">Ubuntu Server端部署SVN</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/03/android_activity_stack/">Intent Flag之FLAG_ACTIVITY_CLEAR_TOP</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/03/article_we_have_no_choice_but_to_work_hard/">除了努力，我们别无选择</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/02/android_design_model_mvp/">Android设计模式之MVP</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/01/android_application/">Application使用详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/30/android_viewpager_pageradapter/">PagerAdapter的使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/30/protocol_ssl_socket/">用SSL构建安全的Socket</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/30/protocol_http_and_https/">HTTP协议和HTTPS协议详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/24/android_animation_translate/">Android动画之translate(位移动画)</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/23/tools_tomcat_conect_to_mysql/">Tomcat8配置MySQL数据库连接</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/23/tools_tomcat_install/">Tomcat安装详细教程[windows+linux]</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/23/database_mysql_cmd/">MySQL常用命令汇总</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/19/android_animation_svg2/">Android之SVG图像详解(二)</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/19/android_animation_svg/">Android之SVG图像详解(一)</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/19/study_speech_dabing/">大兵在一席的演讲</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/18/android_sqlite/">Android之SQLite详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/18/vc_svn_guidance/">svn常用命令行及常见问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/17/android_fresco2/">图片缓存框架Fresco使用详解(二)</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/13/android_studio_study/">Android Studio学习笔记1</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/12/android_studio_gradle_guide/">AndroidStudio之Gradle Guide官方文档翻译</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/11/android_studio_problems_solution/">AndroidStudio常见问题解决方案</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/11/android_studio_gradle/">AndroidStudio之Gradle详解(一)</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/11/tools_google_website_collect/">Google 镜像站搜集</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/10/tools_hexo_architecture/">Hexo博客的云端备份与迁移</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/10/android_spannable/">Android中的spannable的使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/10/android_eventbus/">Android事件总线之EventBus</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/09/android_fresco1/">图片缓存框架Fresco使用详解(一)</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/09/android_imgloader2/">Universal-Image-Loader使用详解(二)</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/09/android_imgloader1/">Universal-Image-Loader使用详解(一)</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/09/android_pulltorefresh_listview3/">PullToRefresh使用详解（三）—— 自定义下拉刷新动画</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/09/android_pay_alipay/">Android移动支付之支付宝支付</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/09/android_pay_weixinpay/">Android移动支付之微信支付</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/09/android_image_process/">Android通过相册和拍照获取图片</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/09/android_pulltorefresh_listview2/">PullToRefresh使用详解（二）—— ListView的下拉刷新与上拉加载</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/06/music_saxophone_playlist/">我喜欢的萨克斯歌曲</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/06/android_broadcast/">android Broadcast学习 (一)</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/06/android_viewpager1/">ViewPager的基本使用一</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/06/tools_hexo_build_guidance/">Hexo博客搭建图文教程[Windows]</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/06/android_as_shortkey/">倍数提高工作效率的Android Studio奇技</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/06/article_humanism_chinese_wemen/">曾金燕：中国女性终其一生承受的暴力</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/05/tools_sublime_text3_shortkey/">sublime实用功能和常用快捷键[Windows]</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/05/music_folk_playlist/">我喜欢的民谣歌曲</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/05/android_handler2/">Android Handler机制 (二)</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/05/android_handler/">android中handler用法总结 (一)</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/05/movie_shanheguren/">贾樟柯说，我的电影无暇顾及中国牛不牛逼</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/04/database_ORMLite_and_GreenDao/">SQLite数据库框架ORMLite与GreenDao的简单比较</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/04/tools_java_code_templates/">java编程代码样式的xml模板</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/04/android_pulltorefresh_listview/">PullToRefresh使用详解（一）--构建下拉刷新的listView</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2016-2017 ARESXIONG
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="A fast, simple &amp; powerful blog framework">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="Another simple and elegant theme for Hexo  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="Site Visitors"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit"  title="Page Hits"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#" title="Back to Top"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="Comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="Go to Bottom"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>