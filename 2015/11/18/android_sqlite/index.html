<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="http://yoursite.com">
  <title>Android之SQLite详解 | ARESXIONG</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="简介1、SQLite介绍自几十年前出现的商业应用程序以来，数据库就成为软件应用程序的主要组成部分。正与数据库管理系统非常关键一样，它们也变得非常庞大，并占用了相当多的系统资源，增加了管理的复杂性。随着软件应用程序逐渐模块模块化，一种新型数据库会比大型复杂的传统数据库管理系统更适应。嵌入式数据库直接在应用程序进程中运行，提供了零配置（zero-configuration）运行模式，并且资源占用非常少">
<meta name="keywords" content="sqlite">
<meta property="og:type" content="article">
<meta property="og:title" content="Android之SQLite详解">
<meta property="og:url" content="http://yoursite.com/2015/11/18/android_sqlite/index.html">
<meta property="og:site_name" content="ARESXIONG">
<meta property="og:description" content="简介1、SQLite介绍自几十年前出现的商业应用程序以来，数据库就成为软件应用程序的主要组成部分。正与数据库管理系统非常关键一样，它们也变得非常庞大，并占用了相当多的系统资源，增加了管理的复杂性。随着软件应用程序逐渐模块模块化，一种新型数据库会比大型复杂的传统数据库管理系统更适应。嵌入式数据库直接在应用程序进程中运行，提供了零配置（zero-configuration）运行模式，并且资源占用非常少">
<meta property="og:image" content="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite01-1.JPG">
<meta property="og:image" content="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite02-1.JPG">
<meta property="og:image" content="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite02-2.JPG">
<meta property="og:image" content="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite03-1.JPG">
<meta property="og:image" content="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite03-2.JPG">
<meta property="og:image" content="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite03-3.JPG">
<meta property="og:image" content="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite03-4.JPG">
<meta property="og:image" content="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite03-5.JPG">
<meta property="og:image" content="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite03-6.JPG">
<meta property="og:image" content="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite03-7.JPG">
<meta property="og:image" content="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite03-8.JPG">
<meta property="og:image" content="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-0.gif">
<meta property="og:image" content="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-1.gif">
<meta property="og:image" content="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-2.gif">
<meta property="og:image" content="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-3.gif">
<meta property="og:image" content="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-4.gif">
<meta property="og:image" content="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite04-01.GIF">
<meta property="og:image" content="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-5.gif">
<meta property="og:image" content="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-6.gif">
<meta property="og:image" content="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-7.gif">
<meta property="og:image" content="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-8.gif">
<meta property="og:image" content="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-9.gif">
<meta property="og:image" content="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite04-02.GIF">
<meta property="og:image" content="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-A.gif">
<meta property="og:image" content="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-B.gif">
<meta property="og:image" content="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite04-03.GIF">
<meta property="og:updated_time" content="2017-07-11T17:45:09.452Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android之SQLite详解">
<meta name="twitter:description" content="简介1、SQLite介绍自几十年前出现的商业应用程序以来，数据库就成为软件应用程序的主要组成部分。正与数据库管理系统非常关键一样，它们也变得非常庞大，并占用了相当多的系统资源，增加了管理的复杂性。随着软件应用程序逐渐模块模块化，一种新型数据库会比大型复杂的传统数据库管理系统更适应。嵌入式数据库直接在应用程序进程中运行，提供了零配置（zero-configuration）运行模式，并且资源占用非常少">
<meta name="twitter:image" content="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite01-1.JPG">
  
    <link rel="alternative" href="/atom.xml" title="ARESXIONG" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" type="text/css" href="/./main.266c1c.css">
  <style type="text/css">
  
    #container.show {
      background: linear-gradient(200deg,#a0cfe4,#e8c37e);
    }
  </style>
  

  

</head>

<body>
  <div id="container" q-class="show:isCtnShow">
    <canvas id="anm-canvas" class="anm-canvas"></canvas>
    <div class="left-col" q-class="show:isShow">
      
<div class="overlay" style="background: #4d4d4d"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img src="null" class="js-avatar">
		</a>
		<hgroup>
		  <h1 class="header-author"><a href="/">ARESXIONG</a></h1>
		</hgroup>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
				<li><a href="/tags/随笔/">随笔</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
    		
    			
    			<a q-on="click: openSlider(e, 'innerArchive')" href="javascript:void(0)">所有文章</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'friends')" href="javascript:void(0)">友链</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'aboutme')" href="javascript:void(0)">关于我</a>
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="#" title="github"><i class="icon-github"></i></a>
		        
					<a class="weibo" target="_blank" href="#" title="weibo"><i class="icon-weibo"></i></a>
		        
					<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
		        
					<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col" q-class="show:isShow,hide:isShow|isFalse">
      
<nav id="mobile-nav">
  	<div class="overlay js-overlay" style="background: #4d4d4d"></div>
	<div class="btnctn js-mobile-btnctn">
  		<div class="slider-trigger list" q-on="click: openSlider(e)"><i class="icon icon-sort"></i></div>
	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="null" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author js-header-author">ARESXIONG</h1>
			</hgroup>
			
			
			
				
			
				
			
			
			
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="#" title="github"><i class="icon-github"></i></a>
			        
						<a class="weibo" target="_blank" href="#" title="weibo"><i class="icon-weibo"></i></a>
			        
						<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
			        
						<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
			        
				</div>
			</nav>

			<nav class="header-menu js-header-menu">
				<ul style="width: 50%">
				
				
					<li style="width: 50%"><a href="/">主页</a></li>
		        
					<li style="width: 50%"><a href="/tags/随笔/">随笔</a></li>
		        
				</ul>
			</nav>
		</header>				
	</div>
	<div class="mobile-mask" style="display:none" q-show="isShow"></div>
</nav>

      <div id="wrapper" class="body-wrap">
        <div class="menu-l">
          <div class="canvas-wrap">
            <canvas data-colors="#eaeaea" data-sectionHeight="100" data-contentId="js-content" id="myCanvas1" class="anm-canvas"></canvas>
          </div>
          <div id="js-content" class="content-ll">
            <article id="post-android_sqlite" class="article article-type-post " itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Android之SQLite详解
    </h1>
  

        
        <a href="/2015/11/18/android_sqlite/" class="archive-article-date">
  	<time datetime="2015-11-18T11:47:29.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2015-11-18</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><h2 id="1、SQLite介绍"><a href="#1、SQLite介绍" class="headerlink" title="1、SQLite介绍"></a>1、SQLite介绍</h2><p>自几十年前出现的商业应用程序以来，数据库就成为软件应用程序的主要组成部分。正与数据库管理系统非常关键一样，它们也变得非常庞大，并占用了相当多的系统资源，增加了管理的复杂性。随着软件应用程序逐渐模块模块化，一种新型数据库会比大型复杂的传统数据库管理系统更适应。嵌入式数据库直接在应用程序进程中运行，提供了零配置（zero-configuration）运行模式，并且资源占用非常少。<br>SQLite是一个开源的嵌入式关系数据库，它在2000年由D. Richard Hipp发布，它的减少应用程序管理数据的开销，SQLite可移植性好，很容易使用，很小，高效而且可靠。<br>SQLite嵌入到使用它的应用程序中，它们共用相同的进程空间，而不是单独的一个进程。从外部看，它并不像一个RDBMS，但在进程内部，它却是完整的，自包含的数据库引擎。</p>
<p>嵌入式数据库的一大好处就是在你的程序内部不需要网络配置，也不需要管理。因为客户端和服务器在同一进程空间运行。SQLite 的数据库权限只依赖于文件系统，没有用户帐户的概念。SQLite 有数据库级锁定，没有网络服务器。它需要的内存，其它开销很小，适合用于嵌入式设备。你需要做的仅仅是把它正确的编译到你的程序。</p>
<h2 id="2、架构-architecture"><a href="#2、架构-architecture" class="headerlink" title="2、架构(architecture)"></a>2、架构(architecture)</h2><p>SQLite采用了模块的设计，它由三个子系统，包括8个独立的模块构成。<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite01-1.JPG" alt=""></p>
<h3 id="2-1、接口-Interface"><a href="#2-1、接口-Interface" class="headerlink" title="2.1、接口(Interface)"></a>2.1、接口(Interface)</h3><p>接口由SQLite C API组成，也就是说不管是程序、脚本语言还是库文件，最终都是通过它与SQLite交互的(我们通常用得较多的ODBC/JDBC最后也会转化为相应C API的调用)。</p>
<h3 id="2-2、编译器-Compiler"><a href="#2-2、编译器-Compiler" class="headerlink" title="2.2、编译器(Compiler)"></a>2.2、编译器(Compiler)</h3><p>在编译器中，分词器（Tokenizer）和分析器(Parser)对SQL进行语法检查，然后把它转化为底层能更方便处理的分层的数据结构—语法树，然后把语法树传给代码生成器(code generator)进行处理。而代码生成器根据它生成一种针对SQLite的汇编代码，最后由虚拟机(Virtual Machine)执行。</p>
<h3 id="2-3、虚拟机-Virtual-Machine"><a href="#2-3、虚拟机-Virtual-Machine" class="headerlink" title="2.3、虚拟机(Virtual Machine)"></a>2.3、虚拟机(Virtual Machine)</h3><p>架构中最核心的部分是虚拟机，或者叫做虚拟数据库引擎(Virtual Database Engine,VDBE)。它和Java虚拟机相似，解释执行字节代码。VDBE的字节代码由<strong> 128个操作码(opcodes)</strong>构成，它们主要集中在数据库操作。它的每一条指令都用来完成特定的数据库操作(比如打开一个表的游标)或者为这些操作栈空间的准备(比如压入参数)。总之，所有的这些指令都是为了满足SQL命令的要求(关于VM，后面会做详细介绍)。</p>
<h3 id="2-4、后端-Back-End"><a href="#2-4、后端-Back-End" class="headerlink" title="2.4、后端(Back-End)"></a>2.4、后端(Back-End)</h3><p>后端由B-树(B-tree)，页缓存(page cache，pager)和操作系统接口(即系统调用)构成。B-tree和page cache共同对数据进行管理。B-tree的主要功能就是索引，它维护着各个页面之间的复杂的关系，便于快速找到所需数据。而pager的主要作用就是通过OS接口在B-tree和Disk之间传递页面。</p>
<h2 id="3、SQLite的特点-SQLite’s-Features-and-Philosophy"><a href="#3、SQLite的特点-SQLite’s-Features-and-Philosophy" class="headerlink" title="3、SQLite的特点(SQLite’s Features and Philosophy)"></a>3、SQLite的特点(SQLite’s Features and Philosophy)</h2><ul>
<li>零配置(Zero Configuration)</li>
<li>可移植(Portability)：它是运行在Windows,Linux,BSD,Mac OS X和一些商用Unix系统，比如Sun的Solaris,IBM的AIX，同样，它也可以工作在许多嵌入式操作系统下，比如QNX,VxWorks,Palm OS, Symbin和Windows CE。</li>
<li>紧致性(Compactness)：SQLite是被设计成轻量级，自包含的。one header file, one library, and you’re relational, no external database server required</li>
<li>简单(Simplicity)</li>
<li>灵活(Flexibility)</li>
<li>可靠(Reliability)：SQLite的核心大约有3万行标准C代码，这些代码都是模块化的，很容易阅读。</li>
</ul>
<h1 id="设计与概念"><a href="#设计与概念" class="headerlink" title="设计与概念"></a>设计与概念</h1><h2 id="1、-API"><a href="#1、-API" class="headerlink" title="1、 API"></a>1、 API</h2><p>由两部分组成: 核心API(core API) 和扩展API（extension API）<br>核心API的函数实现基本的数据库操作：连接数据库，处理SQL，遍历结果集。它也包括一些实用函数，比如字符串转换，操作控制，调试和错误处理。<br>扩展API通过创建你自定义的SQL函数去扩展SQLite。</p>
<h3 id="1-1、SQLite-Version-3的一些新特点："><a href="#1-1、SQLite-Version-3的一些新特点：" class="headerlink" title="1.1、SQLite Version 3的一些新特点："></a>1.1、SQLite Version 3的一些新特点：</h3><ul>
<li>(1)SQLite的API全部重新设计，由第二版的15个函数增加到88个函数。这些函数包括支持UTF-8和UTF-16编码的功能函数。</li>
<li>(2)改进并发性能。加锁子系统引进一种锁升级模型(lock escalation model)，解决了第二版的写进程饿死的问题(该问题是任何一个DBMS必须面对的问题)。这种模型保证写进程按照先来先服务的算法得到排斥锁(Exclusive Lock)。甚至，写进程通过把结果写入临时缓冲区(Temporary Buffer)，可以在得到排斥锁之前就能开始工作。这对于写要求较高的应用，性能可提高400%（引自参考文献）。</li>
<li>(3)改进的B-树。对于表采用B+树，大大提高查询效率。</li>
<li>(4)SQLite 3最重要的改变是它的存储模型。由第二版只支持文本模型，扩展到支持5种本地数据类型。<br>总之，SQLite Version 3与SQLite Vertion 2有很大的不同，在灵活性，特点和性能方面有很大的改进。</li>
</ul>
<h3 id="1-2、主要的数据结构-The-Principal-Data-Structures"><a href="#1-2、主要的数据结构-The-Principal-Data-Structures" class="headerlink" title="1.2、主要的数据结构(The Principal Data Structures)"></a>1.2、主要的数据结构(The Principal Data Structures)</h3><p>SQLite由很多部分组成－parser,tokenize,virtual machine等等。但是从程序员的角度，最需要知道的是:connection, statements, B-tree和pager。它们之间的关系如下：<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite02-1.JPG" alt=""></p>
<p>上图告诉我们在编程需要知道的三个主要方面：API,事务(Transaction)和锁(Locks)。从技术上来说，B-tree和pager不是API的一部分。但是它们却在事务和锁上起着关键作用（稍后将讨论）。</p>
<h3 id="1-3、Connections和Statements"><a href="#1-3、Connections和Statements" class="headerlink" title="1.3、Connections和Statements"></a>1.3、Connections和Statements</h3><p>Connection和statement是执行SQL命令涉及的两个主要数据结构，几乎所有通过API进行的操作都要用到它们。一个连接(Connection)代表在一个独立的事务环境下的一个连接A (connection represents a single connection to a database as well as a single transaction context)。每一个statement都和一个connection关联，它通常表示一个编译过的SQL语句，在内部，它以VDBE字节码表示。Statement包括执行一个命令所需要一切，包括保存VDBE程序执行状态所需的资源，指向硬盘记录的B-树游标，以及参数等等。</p>
<h3 id="1-4、B-tree和pager"><a href="#1-4、B-tree和pager" class="headerlink" title="1.4、B-tree和pager"></a>1.4、B-tree和pager</h3><p>一个connection可以有多个database对象—一个主要的数据库以及附加的数据库，每一个数据库对象有一个B-tree对象，一个B-tree有一个pager对象(这里的对象不是面向对象的“对象”，只是为了说清楚问题)。<br>Statement最终都是通过connection的B-tree和pager从数据库读或者写数据，通过B-tree的游标(cursor)遍历存储在页面(page)中的记录。游标在访问页面之前要把数所从disk加载到内存，而这就是pager的任务。任何时候，如果B-tree需要页面，它都会请求pager从disk读取数据，然后把页面(page)加载到页面缓冲区(page cache)，之后，B-tree和与之关联的游标就可以访问位于page中的记录了。<br>如果cursor改变了page，为了防止事务回滚，pager必须采取特殊的方式保存原来的page。总的来说，pager负责读写数据库，管理内存缓存和页面（page），以及管理事务，锁和崩溃恢复(这些在事务一节会详细介绍)。<br>总之，关于connection和transaction，你必须知道两件事：<br>(1) 对数据库的任何操作，一个连接存在于一个事务下。<br>(2) 一个连接决不会同时存在多个事务下。<br>whenever a connection does anything with a database, it always operates under exactly one<br>transaction, no more, no less.</p>
<h3 id="1-5、核心API"><a href="#1-5、核心API" class="headerlink" title="1.5、核心API"></a>1.5、核心API</h3><p>核心API 主要与执行SQL命令有关，本质上有两种方法执行SQL语句：prepared query 和wrapped query。Prepared query由三个阶段构成：preparation，execution和finalization。其实wrapped query只是对prepared query的三个过程包装而已，最终也会转化为prepared query的执行。</p>
<p><strong> 1.5.1、连接的生命周期(The Connection Lifecycle)</strong><br>和大多数据库连接相同，由三个过程构成：<br>（1） 连接数据库(Connect to the database)：<br>每一个SQLite数据库都存储在单独的操作系统文件中，连接，打开数据库的C API为：sqlite3_open()，它的实现位于main.c文件中，如下：<br>int sqlite3_open(const char <em>zFilename, sqlite3 *</em>ppDb)<br>{<br>  return openDatabase(zFilename, ppDb, SQLITE_OPEN_READWRITE | SQLITE_OPEN_CREATE, 0);<br>}<br>当连接一个在磁盘上的数据库，如果数据库文件存在，SQLite打开一个文件；如果不存在，SQLite会假定你想创建一个新的数据库。在这种情况下，SQLite不会立即在磁盘上创建一个文件，只有当你向数据库写入数据时才会创建文件，比如：创建表、视图或者其它数据库对象。如果你打开一个数据，不做任何事，然后关闭它，SQLite会创建一个文件，只是一个空文件而已。<br>另外一个不立即创建一个新文件的原因是，一些数据库的参数，比如：编码，页面大小等，只在在数据库创建前设置。默认情况下，页面大小为1024字节，但是你可以选择512-32768字节之间为 2幂数的数字。有些时候，较大的页面能更有效的处理大量的数据。<br>（2） 执行事务(Perform transactions)：<br>all commands are executed within transactions。默认情况下，事务自动提交，也就是每一个SQL语句都在一个独立的事务下运行。当然也可以通过使用BEGIN..COMMIT手动提交事务。<br>（3） 断开连接(Disconnect from the database)：<br>主要是关闭数据库的文件。</p>
<p><strong> 1.5.2、执行Prepared Query</strong><br>前面提到，预处理查询(Prepared Query)是SQLite执行所有SQL命令的方式，包括以下三个过程：<br>(1) Prepared Query：<br>分析器（parser），分词器(tokenizer)和代码生成器(code generator)把SQL Statement编译成VDBE字节码，编译器会创建一个statement句柄(sqlite3_stmt)，它包括字节码以及其它执行命令和遍历结果集的所有资源。<br> 相应的C API为sqlite3_prepare()，位于prepare.c文件中，如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">sqlite3_prepare</span><span class="params">(</span></span></div><div class="line">  sqlite3 *db,              <span class="comment">/* Database handle. */</span></div><div class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *zSql,         <span class="comment">/* UTF-8 encoded SQL statement. */</span></div><div class="line">  <span class="keyword">int</span> nBytes,               <span class="comment">/* Length of zSql in bytes. */</span></div><div class="line">  sqlite3_stmt **ppStmt,    <span class="comment">/* OUT: A pointer to the prepared statement */</span></div><div class="line">  <span class="keyword">const</span> <span class="keyword">char</span> **pzTail       <span class="comment">/* OUT: End of parsed string */</span></div><div class="line">)&#123;</div><div class="line">  <span class="keyword">int</span> rc;</div><div class="line">  rc = sqlite3LockAndPrepare(db,zSql,nBytes,<span class="number">0</span>,ppStmt,pzTail);</div><div class="line">  assert( rc==SQLITE_OK || ppStmt==<span class="number">0</span> || *ppStmt==<span class="number">0</span> );  <span class="comment">/* VERIFY: F13021 */</span></div><div class="line">  <span class="keyword">return</span> rc;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>(2) Execution：<br>虚拟机执行字节码，执行过程是一个步进(stepwise)的过程，每一步(step)由sqlite3_step()启动，并由VDBE执行一段字节码。由sqlite3_prepare编译字节代码，并由sqlite3_step()启动虚拟机执行。在遍历结果集的过程中，它返回SQLITE_ROW，当到达结果末尾时，返回SQLITE_DONE。<br>(3) Finalization：<br>VDBE关闭statement，释放资源。相应的C API为sqlite3_finalize()。</p>
<p>通过下图可以更容易理解该过程：<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite02-2.JPG" alt=""></p>
<p>最后以一个具体的例子结束本节，下节讨论事务。<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">#include &lt;stdio.h&gt;</div><div class="line">#include &lt;stdlib.h&gt;</div><div class="line">#include "sqlite3.h"</div><div class="line"></div><div class="line">#include &lt;string.h&gt;</div><div class="line"></div><div class="line">int main(int argc, char **argv)</div><div class="line">&#123;</div><div class="line">    int rc, i, ncols;</div><div class="line">    sqlite3 *db;</div><div class="line">    sqlite3_stmt *stmt;</div><div class="line">    char *sql;</div><div class="line">    const char *tail;</div><div class="line">    //打开数据</div><div class="line">    rc = sqlite3_open("foods.db", &amp;db);</div><div class="line"></div><div class="line">    if(rc) &#123;</div><div class="line">        fprintf(stderr, "Can't open database: %s\n", sqlite3_errmsg(db));</div><div class="line">        sqlite3_close(db);</div><div class="line">        exit(1);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    sql = "select * from episodes";</div><div class="line">    //预处理</div><div class="line">    rc = sqlite3_prepare(db, sql, (int)strlen(sql), &amp;stmt, &amp;tail);</div><div class="line"></div><div class="line">    if(rc != SQLITE_OK) &#123;</div><div class="line">        fprintf(stderr, "SQL error: %s\n", sqlite3_errmsg(db));</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    rc = sqlite3_step(stmt);</div><div class="line">    ncols = sqlite3_column_count(stmt); </div><div class="line"></div><div class="line">    while(rc == SQLITE_ROW) &#123;</div><div class="line">        </div><div class="line">        for(i=0; i &lt; ncols; i++) &#123;</div><div class="line">            fprintf(stderr, "'%s' ", sqlite3_column_text(stmt, i));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        fprintf(stderr, "\n");</div><div class="line"></div><div class="line">        rc = sqlite3_step(stmt);</div><div class="line">    &#125;</div><div class="line">    //释放statement</div><div class="line">    sqlite3_finalize(stmt);</div><div class="line">    //关闭数据库</div><div class="line">    sqlite3_close(db);</div><div class="line"></div><div class="line">    return 0;    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来讨论事务,事务是DBMS最核心的技术之一.在计算机科学史上,有三位科学家因在数据库领域的成就而获ACM图灵奖,而其中之一Jim Gray(曾任职微软)就是因为在事务处理方面的成就而获得这一殊荣,正是因为他,才使得OLTP系统在随后直到今天大行其道.关于事务处理技术,涉及到很多,随便就能写一本书.这里我只讨论SQLite事务实现的一些原理,SQLite的事务实现与大型通用的DBMS相比,其实现比较简单.这些内容可能比较偏于理论,但却不难,也是理解其它内容的基础.</p>
<h2 id="2、事务-Transaction"><a href="#2、事务-Transaction" class="headerlink" title="2、事务(Transaction)"></a>2、事务(Transaction)</h2><h3 id="2-1、事务的周期-Transaction-Lifecycles"><a href="#2-1、事务的周期-Transaction-Lifecycles" class="headerlink" title="2.1、事务的周期(Transaction Lifecycles)"></a>2.1、事务的周期(Transaction Lifecycles)</h3><p>程序与事务之间有两件事值得注意：<br>（1）哪些对象在事务下运行——这直接与API有关。<br>（2）事务的生命周期，即什么时候开始，什么时候结束以及它在什么时候开始影响别的连接（这点对于并发性很重要）——这涉及到SQLite的具体实现。<br>一个连接（connection）可以包含多个(statement)，而且每个连接有一个与数据库关联的B-tree和一个pager。Pager在连接中起着很重要的作用，因为它管理事务、锁、内存缓存以及负责崩溃恢复(crash recovery)。当你进行数据库写操作时，记住最重要的一件事：在任何时候，只在一个事务下执行一个连接。这些回答了第一个问题。<br>一般来说，一个事务的生命和statement差不多，你也可以手动结束它。默认情况下，事务自动提交，当然你也可以通过BEGIN..COMMIT手动提交。接下来就是锁的问题。</p>
<h3 id="2-2、锁的状态-Lock-States"><a href="#2-2、锁的状态-Lock-States" class="headerlink" title="2.2、锁的状态(Lock States)"></a>2.2、锁的状态(Lock States)</h3><p>锁对于实现并发访问很重要，而对于大型通用的DBMS，锁的实现也十分复杂，而SQLite相对较简单。通常情况下，它的持续时间和事务一致。一个事务开始，它会先加锁，事务结束，释放锁。但是系统在事务没有结束的情况下崩溃，那么下一个访问数据库的连接会处理这种情况。<br>在SQLite中有5种不同状态的锁，连接（connection）任何时候都处于其中的一个状态。下图显示了相应的状态以及锁的生命周期。</p>
<p> 关于这个图有以下几点值得注意：<br>（1）一个事务可以在UNLOCKED，RESERVED或EXCLUSIVE三种状态下开始。默认情况下在UNLOCKED时开始。<br>（2）白色框中的UNLOCKED, PENDING, SHARED和 RESERVED可以在一个数据库的同一时存在。<br>（3）从灰色的PENDING开始，事情就变得严格起来，意味着事务想得到排斥锁(EXCLUSIVE)（注意与白色框中的区别）。<br>虽然锁有这么多状态，但是从体质上来说，只有两种情况：读事务和写事务。</p>
<h3 id="2-3、读事务-Read-Transactions"><a href="#2-3、读事务-Read-Transactions" class="headerlink" title="2.3、读事务(Read Transactions)"></a>2.3、读事务(Read Transactions)</h3><p>我们先来看看SELECT语句执行时锁的状态变化过程，非常简单：一个连接执行select语句，触发一个事务，从UNLOCKED到SHARED，当事务COMMIT时，又回到UNLOCKED，就这么简单。<br>考虑下面的例子(为了简单，这里用了伪码)：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">db = open('foods.db')</div><div class="line">db.exec('BEGIN')</div><div class="line">db.exec('SELECT * FROM episodes')</div><div class="line">db.exec('SELECT * FROM episodes')</div><div class="line">db.exec('COMMIT')</div><div class="line">db.close()</div></pre></td></tr></table></figure></p>
<p>由于显式的使用了BEGIN和COMMIT，两个SELECT命令在一个事务下执行。第一个exec()执行时，connection处于SHARED，然后第二个exec()执行，当事务提交时，connection又从SHARED回到UNLOCKED状态，如下：<br>UNLOCKED→PENDING→SHARED→UNLOCKED<br>如果没有BEGIN和COMMIT两行时如下：<br>UNLOCKED→PENDING→SHARED→UNLOCKED→PENDING→ SHARED→UNLOCKED</p>
<h3 id="2-4、写事务（Write-Transactions）"><a href="#2-4、写事务（Write-Transactions）" class="headerlink" title="2.4、写事务（Write Transactions）"></a>2.4、写事务（Write Transactions）</h3><p>下面我们来考虑写数据库，比如UPDATE。和读事务一样，它也会经历UNLOCKED→PENDING→SHARED，但接下来却是灰色的PENDING，</p>
<p><strong> 2.4.1、The Reserved States</strong><br>当一个连接（connection）向数据库写数据时，从SHARED状态变为RESERVED状态，如果它得到RESERVED锁，也就意味着它已经准备好进行写操作了。即使它没有把修改写入数据库，也可以把修改保存到位于pager中缓存中（page cache）。<br>当一个连接进入RESERVED状态，pager就开始初始化恢复日志（rollback journal）。在RESERVED状态下，pager管理着三种页面：<br>(1)    Modified pages：包含被B-树修改的记录，位于page cache中。<br>(2)    Unmodified pages：包含没有被B-tree修改的记录。<br>(3)    Journal pages：这是修改页面以前的版本，这些并不存储在page cache中，而是在B-tree修改页面之前写入日志。<br>Page cache非常重要，正是因为它的存在，一个处于RESERVED状态的连接可以真正的开始工作，而不会干扰其它的（读）连接。所以，SQLite可以高效的处理在同一时刻的多个读连接和一个写连接。</p>
<p><strong> 2.4.2 、The Pending States</strong><br>当一个连接完成修改，就真正开始提交事务，执行该过程的pager进入EXCLUSIVE状态。从RESERVED状态，pager试着获取PENDING锁，一旦得到，就独占它，不允许任何其它连接获得PENDING锁（PENDING is a gateway lock）。既然写操作持有PENDING锁，其它任何连接都不能从UNLOCKED状态进入SHARED状态，即没有任何连接可以进入数据（no new readers, no new writers）。只有那些已经处于SHARED状态的连接可以继续工作。而处于PENDING状态的Writer会一直等到所有这些连接释放它们的锁，然后对数据库加EXCUSIVE锁，进入EXCLUSIVE状态，独占数据库(讨论到这里，对SQLite的加锁机制应该比较清晰了)。</p>
<p><strong> 2.4.3、The Exclusive State</strong><br>在EXCLUSIVE状态下，主要的工作是把修改的页面从page cache写入数据库文件，这是真正进行写操作的地方。<br>在pager写入modified pages之前，它还得先做一件事：写日志。它检查是否所有的日志都写入了磁盘，而这些通常位于操作的缓冲区中，所以pager得告诉OS把所有的文件写入磁盘，这是由程序synchronous(通过调用OS的相应的API实现)完成的。<br>日志是数据库进行恢复的惟一方法，所以日志对于DBMS非常重要。如果日志页面没有完全写入磁盘而发生崩溃，数据库就不能恢复到它原来的状态，此时数据库就处于不一致状态。日志写入完成后，pager就把所有的modified pages写入数据库文件。接下来就取决于事务提交的模式，如果是自动提交，那么pager清理日志，page cache，然后由EXCLUSIVE进入UNLOCKED。如果是手动提交，那么pager继续持有EXCLUSIVE锁和保存日志，直到COMMIT或者ROLLBACK。</p>
<p>总之，从性能方面来说，进程占有排斥锁的时间应该尽可能的短，所以DBMS通常都是在真正写文件时才会占有排斥锁，这样能大大提高并发性能。</p>
<h1 id="内核解析"><a href="#内核解析" class="headerlink" title="内核解析"></a>内核解析</h1><p>为了能更好的理解SQLite，我先从总的结构上讨论一下内核，从全局把握SQLite很重要。SQLite的内核实现不是很难，但是也不是很简单。总的来说分为三个部分，本章主要讨论虚拟机(Virtual Machine)，但是这里只是从原理上概述，不会太多的涉及实际代码。但是概述完内核之后会仔细讨论源代码的。好了，下面我们来讨论虚拟机(VM)。</p>
<h2 id="1、虚拟机（Virtual-Machine）"><a href="#1、虚拟机（Virtual-Machine）" class="headerlink" title="1、虚拟机（Virtual Machine）"></a>1、虚拟机（Virtual Machine）</h2><p>VDBE是SQLite的核心，它的上层模块和下层模块都是本质上都是为它服务的。它的实现位于vbde.c, vdbe.h, vdbeapi.c, vdbeInt.h, 和vdbemem.c几个文件中。它通过底层的基础设施B+Tree执行由编译器（Compiler）生成的字节代码，这种字节代码程序语言(bytecode programming lauguage)是为了进行查询，读取和修改数据库而专门设计的。<br>字节代码在内存中被封装成sqlite3_stmt对象(内部叫做Vdbe，见vdbeInt.h)，Vdbe（或者说statement）包含执行程序所需要的一切：</p>
<ul>
<li>a)a bytecode program</li>
<li>b)names and data types for all result columns</li>
<li>c)values bound to input parameters</li>
<li>d)a program counter</li>
<li>e)an execution stack of operands</li>
<li>f)an arbitrary amount of “numbered” memory cells</li>
<li>g)other run-time state information (such as open BTree objects, sorters, lists, sets)</li>
</ul>
<p>字节代码和汇编程序十分类似，每一条指令由操作码和三个操作数构成：<opcode, p1,="" p2,="" p3="">。Opcode为一定功能的操作码，为了理解，可以看成一个函数。P1是32位的有符号整数，p2是31位的无符号整数，它通常是导致跳转(jump)的指令的目标地址（destination），当然这了有其它用途；p3为一个以null结尾的字符串或者其它结构体的指针。和C API不同的是，VDBE操作码经常变化，所以不应该用字节码写程序。<br>下面的几个C API直接和VDBE交互：</opcode,></p>
<ul>
<li>sqlite3_bind_xxx() functions</li>
<li>sqlite3_step()</li>
<li>sqlite3_reset()</li>
<li>sqlite3_column_xxx() functions</li>
<li>sqlite3_finalize()</li>
</ul>
<p>为了有个感性，下面看一个具体的字节码程序：<br>sqlite&gt; .m col<br>sqlite&gt; .h on<br>sqlite&gt; .w 4 15 3 3 15<br>sqlite&gt; explain select * from episodes;<br>addr  opcode              p1   p2   p3</p>
<hr>
<p>0     Goto                0    12<br>1     Integer             0    0<br>2     OpenRead            0    2    # episodes<br>3     SetNumColumns       0    3<br>4     Rewind              0    10<br>5     Recno               0    0<br>6     Column              0    1<br>7     Column              0    2<br>8     Callback            3    0<br>9     Next                0    5<br>10    Close               0    0<br>11    Halt                0    0<br>12    Transaction         0    0<br>13    VerifyCookie        0    10<br>14    Goto                0    1<br>15    Noop                0    0</p>
<h3 id="1-1、栈-Stack"><a href="#1-1、栈-Stack" class="headerlink" title="1.1、栈(Stack)"></a>1.1、栈(Stack)</h3><p>一个VDBE程序通常由不同完成特定任务的段（section）构成，每一个段中，都有一些操作栈的指令。这是由于不同的指令有不同个数的参数，一些指令只有一个参数；一些指令没有参数；一些指令有好几个参数，这种情况下，三个操作数就不能满足。<br>考虑到这些情况，指令采用栈来传递参数。(注：从汇编的角度来看，传递参数的方式有好几种，比如：寄存器，全局变量，而堆栈是现代语言常用的方式，它具有很大的灵活性)。而这些指令不会自己做这些事情，所以在它们之前，需要其它一些指令的帮助。VDBE把计算的中间结果保存到内存单元(memory cells)中，其实，堆栈和内存单元都是基于Mem（见vdbeInt.h）数据结构(注：这里的栈，内存单元都是虚拟的，记得一位计算机科学家说过：计算机科学中90%以上的科学都是虚拟化问题。一点不假，OS本质上也是虚拟机，而在这里SQLite，我们也处处可见虚拟化的身影，到后面的OS Interface模块中再仔细讨论这个问题)。</p>
<h3 id="1-2、程序体-Program-Body"><a href="#1-2、程序体-Program-Body" class="headerlink" title="1.2、程序体(Program Body)"></a>1.2、程序体(Program Body)</h3><p>这是一个打开episodes表的过程。<br>第一条指令：Integer是为第二条指令作准备的，也就是把第二条指令执行需要的参数压入堆栈，OpenRead从堆栈中取出参数值然后执行。SQLite可以通过ATTACH命令在一个连接中打开多个数据库文件，每当SQLite打开一个数据，它就为之赋一个索引号(index)，main database的索引为0，第一个数据库为1，依次如此。Integer指令数据库索引的值压入栈，而OpenRead从中取出值，并决定打开哪个数据，来看看SQLite文档中的解释：</p>
<blockquote>
<p>Open a read-only cursor for the database table whose root page is P2 in a database file.<br>The database file is determined by an integer from the top of the stack. 0 means the main database and 1 means the database used for temporary tables. Give the new cursor an identifier of P1. The P1 values need not be contiguous but all P1 values should be small integers. It is an error for P1 to be negative.<br>If P2==0 then take the root page number from off of the stack.<br>There will be a read lock on the database whenever there is an open cursor. If the data-<br>base was unlocked prior to this instruction then a read lock is acquired as part of this instruction. A read lock allows other processes to read the database but prohibits any other process from modifying the database. The read lock is released when all cursors are closed. If this instruction attempts to get a read lock but fails, the script terminates with an SQLITE_BUSY error code.<br>The P3 value is a pointer to a KeyInfo structure that defines the content and collating</p>
</blockquote>
<p>sequence of indices. P3 is NULL for cursors that are not pointing to indices.</p>
<p>再来看看SetNumColumns指令设置游标将指向的列。P1为游标的索引（这里为0，刚刚打开），P2为列的数目，episodes表有三列。<br>继续Rewind指令，它将游标重新设置到表的开始，它会检查表是否为空（即没有记录），如果没有记录，它会导致指令指针跳到P2指定的指令处。在这里，P2为10，即Close指令。一旦Rewind设置游标，接下就执行5-9这几条指令，它们的主要功能是遍历结果集，Recno把由游标P1指定的记录的关键字压入堆栈。Column指令从由P1指定的游标，P2指定的列取值。5,6,7三条指令分别把id(primary key),season和name字段的值压入栈。接下来，Callback指令从栈中取出三个值（P1），然后形成一个记录数组，存储在内存单元中(memory cell)。Callback会停止VDBE的操作，把控制权交给sqlite3_stemp()，该函数返回SQLITE_ROW。<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite03-1.JPG" alt=""></p>
<p>一旦VDBE创建了记录结构，我们就可以通过sqlite3_column_xxx() functions从记录结构的域内取出值。当下次调用sqlite3_step()时，指令指针会指向Next指令，而Next指令会把游标向移向下一行，如果有其它的记录，它会跳到由P2指定的指令，在这里为指令5，创建一个新的记录结构，一直循环，直到结果集的最后。Close指令会关闭游标，然后执行Halt指令，结束VDBE程序。</p>
<h2 id="1-3、程序开始与停止"><a href="#1-3、程序开始与停止" class="headerlink" title="1.3、程序开始与停止"></a>1.3、程序开始与停止</h2><p>现在来看看其余的指令，Goto指令是一条跳转指令，跳到P2处，即第12条指令。指令12是Transaction，它开始一个新的事务；然后执行VerifyCookie，它的主要功能VDBE程序编译后，数据库模式是否改变（即是否进行过更新操作）。这在SQLite中是一个很重要的概念，在SQL被sqlite3_prepare()编译成VDBE代码至程序调用sqlite3_step()执行字节码的这段时间，另一个SQL命令可能会改变数据库模式（such as ALTER TABLE, DROP TABLE, or CREATE TABLE）。一旦发生这种情况，之前编译的statement就会变得无效，数据库模式信息记录在数据库文件的根页面中。类似，每一个statement都有一份用来比较的在编译时刻该模式的备份，VerifyCookie的功能就是检查它们是否匹配，如果不匹配，将采取相关操作。<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite03-2.JPG" alt=""></p>
<p>如果两者匹配，会执行下一条指令Goto；它会跳到程序的主要部分，即第一条指令，打开表读取记录。这里有两点值得注意：<br>(1)Transaction指令自己不会获取锁（ The Transaction instruction doesn’t acquire any locks in itself）。它的功能相当于BEGIN，而实际是由OpenRead指令获取share lock的。当事务关闭时释放锁，这取决于Halt指令，它会进行扫尾工作。<br>(2)statement对象（VDBE程序）所需的存储空间在程序执行前就已经确定。这有原于两个重要事实：首先，栈的深度不会比指令的数目还多（通常少得多）。其次，在执行VDBE程序之前，SQLite可以计算出为分配资源所需要的内存。</p>
<h2 id="1-4指令的类型-Instruction-Types"><a href="#1-4指令的类型-Instruction-Types" class="headerlink" title="1.4指令的类型(Instruction Types)"></a>1.4指令的类型(Instruction Types)</h2><p>每条指令都完成特定的任务，而且通常和别的指令有关。大体上来说，指令可分为三类：<br>（1)Value manipulation：这些指令通常完成算术运算，比如：add, subtract, divide；逻辑运算，比如：AND和OR；还有字符串操作。<br>（2)Data management：这些指令操作在内存和磁盘上的数据。内存指令进行栈操作或者在内存单元之间传递数据。磁盘操作指令控制B-tree和pager打开或操作游标，开始或结束事务，等等。<br>（3)Control flow：控制指令主要是移动指令指针。</p>
<h2 id="1-5、程序的执行-Program-execution"><a href="#1-5、程序的执行-Program-execution" class="headerlink" title="1.5、程序的执行(Program execution)"></a>1.5、程序的执行(Program execution)</h2><p>最后我们来看VM解释器是如何实现以及字节代码大致是如何执行的。在vdbe.c文件中有一个很关键的函数：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">//执行VDBE程序</div><div class="line">int sqlite3VdbeExec(</div><div class="line">  Vdbe *p                    /* The VDBE */</div><div class="line">)</div><div class="line">该函数是执行VDBE程序的入口。来看看它的内部实现：</div><div class="line"></div><div class="line">/*从这里开始执行指令</div><div class="line">**pc为程序计数器(int)</div><div class="line">*/</div><div class="line">for(pc=p-&gt;pc; rc==SQLITE_OK; pc++)&#123;</div><div class="line">  //取得操作码</div><div class="line">  pOp = &amp;p-&gt;aOp[pc];</div><div class="line">  switch( pOp-&gt;opcode )&#123;</div><div class="line">  case OP_Goto: &#123;             /* jump */</div><div class="line">      CHECK_FOR_INTERRUPT;</div><div class="line">      pc = pOp-&gt;p2 - 1;</div><div class="line">      break;</div><div class="line">     &#125;</div><div class="line">    … …</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从这段代码，我们大致可以推出VM执行的原理：VM解释器实际上是一个包含大量switch语句的for循环，每一个switch语句实现一个特定的操作指令。</p>
<p>SQLite采用了层次化，模块化的设计，而这些使得它的可扩展性和可移植性非常强。而且SQLite的架构与通用DBMS的结构差别不是很大，所以它对于理解通用DBMS具有重要意义。好了，下面我们开始讨论SQLite剩余的两部分：Back-end(后端)和compiler(编译器)。</p>
<h2 id="2、B-tree和Pager"><a href="#2、B-tree和Pager" class="headerlink" title="2、B-tree和Pager"></a>2、B-tree和Pager</h2><p>B-Tree使得VDBE可以在O(logN)下查询，插入和删除数据，以及O(1)下双向遍历结果集。B-Tree不会直接读写磁盘，它仅仅维护着页面(pages)之间的关系。当B-TREE需要页面或者修改页面时，它就会调用Pager。当修改页面时，pager保证原始页面首先写入日志文件，当它完成写操作时，pager根据事务状态决定如何做。B-tree不直接读写文件，而是通过page cache这个缓冲模块读写文件对于性能是有重要意义的（注：这和操作系统读写文件类似，在Linux中,操作系统的上层模块并不直接调用设备驱动读写设备，而是通过一个高速缓冲模块调用设备驱动读写文件,并将结果存到高速缓冲区）。</p>
<h3 id="2-1、数据库文件格式（Database-File-Format）"><a href="#2-1、数据库文件格式（Database-File-Format）" class="headerlink" title="2.1、数据库文件格式（Database File Format）"></a>2.1、数据库文件格式（Database File Format）</h3><p>数据库中所有的页面都按从1开始顺序标记。一个数据库由许多B-tree构成——每一个表和索引都有一个B-tree（注：索引采用B-tree，而表采用B+tree，这主要是表和索引的需求不同以及B-tree和B+tree的结构不同决定的：B+tree的所有叶子节点包含了全部关键字信息，而且可以有两种顺序查找——具体参见《数据结构》，严蔚敏。而B-tree更适合用来作索引）。所有表和索引的根页面都存储在sqlite_master表中。<br>数据库中第一个页面（page 1）有点特殊，page 1的前100个字节包含一个描述数据库文件的特殊的文件头。它包括库的版本，模式的版本，页面大小，编码等所有创建数据库时设置的参数。这个特殊的文件头的内容在btree.c中定义，page 1也是sqlite_master表的根页面。</p>
<h3 id="2-1、页面重用及回收-Page-Reuse-and-Vacuum"><a href="#2-1、页面重用及回收-Page-Reuse-and-Vacuum" class="headerlink" title="2.1、页面重用及回收(Page Reuse and Vacuum )"></a>2.1、页面重用及回收(Page Reuse and Vacuum )</h3><p>SQLite利用一个空闲列表(free list)进行页面回收。当一个页面的所有记录都被删除时，就被插入到该列表。当运行VACUUM命令时，会清除free list，所以数据库会缩小，本质上它是在新的文件重新建立数据库，而所有使用的页在都被拷贝过去，而free list却不会，结果就是一个新的，变小的数据库。当数据库的autovacuum开启时，SQLite不会使用free list，而且在每一次commit时自动压缩数据库。</p>
<h3 id="2-2、B-Tree记录"><a href="#2-2、B-Tree记录" class="headerlink" title="2.2、B-Tree记录"></a>2.2、B-Tree记录</h3><p>B-tree中页面由B-tree记录组成，也叫做payloads。每一个B-tree记录，或者payload有两个域：关键字域(key field)和数据域(data field)。Key field就是ROWID的值，或者数据库中表的关键字的值。从B-tree的角度，data field可以是任何无结构的数据。数据库的记录就保存在这些data fields中。B-tree的任务就是排序和遍历，它最需要就是关键字。Payloads的大小是不定的，这与内部的关键字和数据域有关，当一个payload太大不能存在一个页面内进便保存到多个页面。</p>
<p>B+Tree按关键字排序，所有的关键字必须唯一。表采用B+tree，内部页面不包含数据，如下：<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite03-3.JPG" alt=""><br>B+tree中根页面(root page)和内部页面(internal pages)都是用来导航的，这些页面的数据域都是指向下级页面的指针，仅仅包含关键字。所有的数据库记录都存储在叶子页面(leaf pages)内。在叶节点一级，记录和页面都是按照关键字的顺序的，所以B-tree可以水平方向遍历，时间复杂度为O(1)。</p>
<h3 id="2-3、记录和域（Records-and-Fields）"><a href="#2-3、记录和域（Records-and-Fields）" class="headerlink" title="2.3、记录和域（Records and Fields）"></a>2.3、记录和域（Records and Fields）</h3><p>位于叶节点页面的数据域的记录由VDBE管理，数据库记录以二进制的形式存储，但有一定的数据格式。记录格式包括一个逻辑头（logical header）和一个数据区(data segment)，header segment包括header的大小和一个数据类型数组，数据类型用来在data segment的数据的类型，如下：<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite03-4.JPG" alt=""></p>
<h3 id="2-4、层次数据组织-Hierarchical-Data-Organization"><a href="#2-4、层次数据组织-Hierarchical-Data-Organization" class="headerlink" title="2.4、层次数据组织(Hierarchical Data Organization)"></a>2.4、层次数据组织(Hierarchical Data Organization)</h3><p><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite03-5.JPG" alt=""><br>从上往下，数据越来越无序，从下向上，数据越来越结构化.</p>
<h3 id="2-5、B-Tree-API"><a href="#2-5、B-Tree-API" class="headerlink" title="2.5、B-Tree API"></a>2.5、B-Tree API</h3><p>B-Tree模块有它自己的API，它可以独立于C API使用。另一个特点就是它支持事务。由pager处理的事务，锁和日志都是为B-tree服务的。根据功能可以分为以下几类：</p>
<p>2.5.1、访问和事务函数</p>
<ul>
<li>sqlite3BtreeOpen: Opens a new database file. Returns a B-tree object.</li>
<li>sqlite3BtreeClose: Closes a database.</li>
<li>sqlite3BtreeBeginTrans: Starts a new transaction.</li>
<li>sqlite3BtreeCommit: Commits the current transaction.</li>
<li>sqlite3BtreeRollback: Rolls back the current transaction.</li>
<li>sqlite3BtreeBeginStmt: Starts a statement transaction.</li>
<li>sqlite3BtreeCommitStmt: Commits a statement transaction.</li>
<li>sqlite3BtreeRollbackStmt: Rolls back a statement transaction.</li>
</ul>
<p>2.5.2、表函数<br>sqlite3BtreeCreateTable: Creates a new, empty B-tree in a database file.<br>sqlite3BtreeDropTable: Destroys a B-tree in a database file.<br>sqlite3BtreeClearTable: Removes all data from a B-tree, but keeps the B-tree intact.</p>
<p>2.5.3、游标函数(Cursor Functions)</p>
<ul>
<li>sqlite3BtreeCursor: Creates a new cursor pointing to a particular B-tree.</li>
<li>sqlite3BtreeCloseCursor: Closes the B-tree cursor.</li>
<li>sqlite3BtreeFirst: Moves the cursor to the first element in a B-tree.</li>
<li>sqlite3BtreeLast: Moves the cursor to the last element in a B-tree.</li>
<li>sqlite3BtreeNext: Moves the cursor to the next element after the one it is currently pointing to.</li>
<li>sqlite3BtreePrevious: Moves the cursor to the previous element before the one it is currently pointing to.</li>
</ul>
<p>sqlite3BtreeMoveto: Moves the cursor to an element that matches the key value passed in as a parameter.</p>
<p>2.5.4、记录函数(Record Functions)</p>
<ul>
<li>sqlite3BtreeDelete: Deletes the record that the cursor is pointing to.</li>
<li>sqlite3BtreeInsert: Inserts a new element in the appropriate place of the B-tree.</li>
<li>sqlite3BtreeKeySize: Returns the number of bytes in the key of the record that the cursor is pointing to.</li>
<li>sqlite3BtreeKey: Returns the key of the record the cursor is currently pointing to.</li>
<li>sqlite3BtreeDataSize: Returns the number of bytes in the data record that the cursor is currently pointing to.</li>
<li>sqlite3BtreeData: Returns the data in the record the cursor is currently pointing to.</li>
</ul>
<p>2.5.5、配置函数(Configuration Functions)<br>sqlite3BtreeSetCacheSize: Controls the page cache size as well as the synchronous writes (as defined in the synchronous pragma).sqlite3BtreeSetSafetyLevel: Changes the way data is synced to disk in order to increase or decrease how well the database resists damage due to OS crashes and power failures.Level 1 is the same as asynchronous (no syncs() occur and there is a high probability of<br>damage). This is the equivalent to pragma synchronous=OFF. Level 2 is the default. There is a very low but non-zero probability of damage. This is the equivalent to pragma           synchronous=NORMAL. Level 3 reduces the probability of damage to near zero but with a write performance reduction. This is the equivalent to pragma synchronous=FULL.</p>
<ul>
<li>sqlite3BtreeSetPageSize: Sets the database page size.</li>
<li>sqlite3BtreeGetPageSize: Returns the database page size.</li>
<li>sqlite3BtreeSetAutoVacuum: Sets the autovacuum property of the database.</li>
<li>sqlite3BtreeGetAutoVacuum: Returns whether the database uses autovacuum.</li>
<li>sqlite3BtreeSetBusyHandler: Sets the busy handler</li>
</ul>
<h3 id="2-6、实例分析"><a href="#2-6、实例分析" class="headerlink" title="2.6、实例分析"></a>2.6、实例分析</h3><p>最后以sqlite3_open的具体实现结束本节的讨论(参见Version 3.6.10的源码)：<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite03-6.JPG" alt=""><br>由上图可以知道，SQLite的所有IO操作，最终都转化为操作系统的系统调用(一名话：DBMS建立在痛苦的OS之上)。同时也可以看到SQLite的实现非常的层次化，模块化，使得SQLite更易扩展，可移植性非常强。</p>
<h2 id="3、编译器（Compiler）"><a href="#3、编译器（Compiler）" class="headerlink" title="3、编译器（Compiler）"></a>3、编译器（Compiler）</h2><h3 id="3-1、分词器-Tokenizer"><a href="#3-1、分词器-Tokenizer" class="headerlink" title="3.1、分词器(Tokenizer)"></a>3.1、分词器(Tokenizer)</h3><p>接口把要执行的SQL语句传递给Tokenizer,Tokenizer按照SQL的词法定义把它切分一个一个的词，并传递给分析器(Parser)进行语法分析。分词器是手工写的，主要在Tokenizer.c中实现。</p>
<h3 id="3-2、分析器-Parser"><a href="#3-2、分析器-Parser" class="headerlink" title="3.2、分析器(Parser)"></a>3.2、分析器(Parser)</h3><p>SQLite的语法分析器是用Lemon——一个开源的LALR(1)语法分析器的生成器，生成的文件为parser.c。<br>一个简单的语法树：<br> SELECT rowid, name, season FROM episodes WHERE rowid=1 LIMIT 1<br> <img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite03-7.JPG" alt=""></p>
<h3 id="3-3、代码生成器（Code-Generator）"><a href="#3-3、代码生成器（Code-Generator）" class="headerlink" title="3.3、代码生成器（Code Generator）"></a>3.3、代码生成器（Code Generator）</h3><p>代码生成器是SQLite中取庞大，最复杂的部分。它与Parser关系紧密，根据语法分析树生成VDBE程序执行SQL语句的功能。由诸多文件构成：select.c,update.c,insert.c,delete.c,trigger.c,where.c等文件。这些文件生成相应的VDBE程序指令，比如SELECT语句就由select.c生成。下面是一个读操作中打开表的代码的生成实现：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* Generate code that will open a table for reading.</span></div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">sqlite3OpenTableForReading</span><span class="params">(</span></span></div><div class="line">  Vdbe *v,        <span class="comment">/* Generate code into this VDBE */</span></div><div class="line">  <span class="keyword">int</span> iCur,       <span class="comment">/* The cursor number of the table */</span></div><div class="line">  Table *pTab     <span class="comment">/* The table to be opened */</span></div><div class="line">)&#123;</div><div class="line">  sqlite3VdbeAddOp(v, OP_Integer, pTab-&gt;iDb, <span class="number">0</span>);</div><div class="line">  sqlite3VdbeAddOp(v, OP_OpenRead, iCur, pTab-&gt;tnum);</div><div class="line">  VdbeComment((v, <span class="string">"# %s"</span>, pTab-&gt;zName));</div><div class="line">  sqlite3VdbeAddOp(v, OP_SetNumColumns, iCur, pTab-&gt;nCol);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Sqlite3vdbeAddOp函数有三个参数：</p>
<ul>
<li>（1）VDBE实例（它将添加指令）</li>
<li>（2）操作码（一条指令）</li>
<li>（3）两个操作数</li>
</ul>
<h3 id="3-4、查询优化"><a href="#3-4、查询优化" class="headerlink" title="3.4、查询优化"></a>3.4、查询优化</h3><p>代码生成器不仅负责生成代码，也负责进行查询优化。主要的实现位于where.c中，生成的WHERE语句块通常被其它模块共享，比如select.c，update.c以及delete.c。这些模块调用sqlite3WhereBegin()开始WHERE语句块的指令生成，然后加入它们自己的VDBE代码返回，最后调用sqlite3WhereEnd()结束指令生成，如下：<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite03-8.JPG" alt=""></p>
<h1 id="Page-Cache之事务处理"><a href="#Page-Cache之事务处理" class="headerlink" title="Page Cache之事务处理"></a>Page Cache之事务处理</h1><p>接下来将对SQLite的每个模块进行讨论。讨论的顺序按照我阅读SQLite的顺序来进行，由于项目的需要，以及时间关系，不能给出一个完整的计划，但是我会先讨论我认为比较重要的内容。本节讨论SQLite的事务处理技术，事务处理是DBMS中最关键的技术，对SQLite也一样，它涉及到并发控制，以及故障恢复，由于内容较多，分为两节。好了，下面进入正题。</p>
<p> 本节通过一个具体的例子来分析SQLite原子提交的实现（基于Version 3.3.6的代码）。<br>CREATE TABLE episodes( id integer primary key,name text, cid int) ；<br>插入一条记录：insert into episodes(name,cid) values(“cat”,1) ;<br>它经过编译器处理后生成的虚拟机代码如下：<br>sqlite&gt; explain insert into episodes(name,cid) values(“cat”,1);<br>0|Trace|0|0|0|explain insert into episodes(name,cid) values(“cat”,1);|00|<br>1|Goto|0|12|0||00|<br>2|SetNumColumns|0|3|0||00|<br>3|OpenWrite|0|2|0||00|<br>4|NewRowid|0|2|0||00|<br>5|Null|0|3|0||00|<br>6|String8|0|4|0|cat|00|<br>7|Integer|1|5|0||00|<br>8|MakeRecord|3|3|6|dad|00|<br>9|Insert|0|6|2|episodes|0b|<br>10|Close|0|0|0||00|<br>11|Halt|0|0|0||00|<br>12|Transaction|0|1|0||00|<br>13|VerifyCookie|0|1|0||00|<br>14|Transaction|1|1|0||00|<br>15|VerifyCookie|1|0|0||00|</p>
<p>16|TableLock|0|2|1|episodes|00|</p>
<p>17|Goto|0|2|0||00|</p>
<p>1、初始状态（Initial State）<br>当一个数据库连接第一次打开时，状态如图所示。图中最右边（“Disk”标注）表示保存在存储设备中的内容。每个方框代表一个扇区。蓝色的块表示这个扇区保存了原始数据。图中中间区域是操作系统的磁盘缓冲区。开始的时候，这些缓存是还没有被使用，因此这些方框是空白的。图中左边区域显示SQLite用户进程的内存。因为这个数据库连接刚刚打开，所以还没有任何数据记录被读入，所以这些内存也是空的。<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-0.gif" alt=""><br>2、获取读锁(Acquiring A Read Lock)<br>在SQLite写数据库之前，它必须先从数据库中读取相关信息。比如，在插入新的数据时，SQLite会先从sqlite_master表中读取数据库模式(相当于数据字典)，以便编译器对INSERT语句进行分析，确定数据插入的位置。<br>在进行读操作之前，必须先获取数据库的共享锁(shared lock)，共享锁允许两个或更多的连接在同一时刻读取数据库。但是共享锁不允许其它连接对数据库进行写操作。<br>shared lock存在于操作系统磁盘缓存，而不是磁盘本身。文件锁的本质只是操作系统的内核数据结构，当操作系统崩溃或掉电时，这些内核数据也会随之消失。<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-1.gif" alt=""><br>3、读取数据<br>一旦得到shared lock，就可以进行读操作。如图所示，数据先由OS从磁盘读取到OS缓存，然后再由OS移到用户进程空间。一般来说，数据库文件分为很多页，而一次读操作只读取一小部分页面。如图，从8个页面读取3个页面。<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-2.gif" alt=""><br>4、获取Reserved Lock<br>在对数据进行修改操作之前，先要获取数据库文件的Reserved Lock，Reserved Lock和shared lock的相似之处在于，它们都允许其它进程对数据库文件进行读操作。Reserved Lock和Shared Lock可以共存，但是只能是一个Reserved Lock和多个Shared Lock——多个Reserved Lock不能共存。所以，在同一时刻，只能进行一个写操作。<br>Reserved Lock意味着当前进程(连接)想修改数据库文件，但是还没开始修改操作，所以其它的进程可以读数据库，但不能写数据库。<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-3.gif" alt=""><br>5、创建恢复日志(Creating A Rollback Journal File)<br>在对数据库进行写操作之前，SQLite先要创建一个单独的日志文件，然后把要修改的页面的原始数据写入日志。回滚日志包含一个日志头(图中的绿色)——记录数据库文件的原始大小。所以即使数据库文件大小改变了，我们仍知道数据库的原始大小。<br>从OS的角度来看，当一个文件创建时，大多数OS(Windows,Linux,Mac OS X)不会向磁盘写入数据，新创建的文件此时位于磁盘缓存中，之后才会真正写入磁盘。如图，日志文件位于OS磁盘缓存中，而不是位于磁盘。<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-4.gif" alt=""><br>上面 5步的代码的实现：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//事务指令的实现</span></div><div class="line"><span class="comment">//p1为数据库文件的索引号---0为main database;1为temporary tables使用的文件</span></div><div class="line"><span class="comment">//p2 不为0，一个写事务开始</span></div><div class="line"><span class="keyword">case</span> OP_Transaction: &#123;</div><div class="line">    <span class="comment">//数据库的索引号</span></div><div class="line">    <span class="keyword">int</span> i = pOp-&gt;p1;</div><div class="line">    <span class="comment">//指向数据库对应的btree</span></div><div class="line">  Btree *pBt;</div><div class="line"></div><div class="line">  <span class="keyword">assert</span>( i&gt;=<span class="number">0</span> &amp;&amp; i&lt;db-&gt;nDb );</div><div class="line">  <span class="keyword">assert</span>( (p-&gt;btreeMask &amp; (<span class="number">1</span>&lt;&lt;i))!=<span class="number">0</span> );</div><div class="line">  <span class="comment">//设置btree指针</span></div><div class="line">  pBt = db-&gt;aDb[i].pBt;</div><div class="line"></div><div class="line">  <span class="keyword">if</span>( pBt )&#123;</div><div class="line">      <span class="comment">//从这里btree开始事务,主要给文件加锁,并设置btree事务状态</span></div><div class="line">    rc = sqlite3BtreeBeginTrans(pBt, pOp-&gt;p2);</div><div class="line">    </div><div class="line">    <span class="keyword">if</span>( rc==SQLITE_BUSY )&#123;</div><div class="line">      p-&gt;pc = pc;</div><div class="line">      p-&gt;rc = rc = SQLITE_BUSY;</div><div class="line">      goto vdbe_return;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>( rc!=SQLITE_OK &amp;&amp; rc!=SQLITE_READONLY <span class="comment">/* &amp;&amp; rc!=SQLITE_BUSY */</span> )&#123;</div><div class="line">      goto abort_due_to_error;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">break</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//开始一个事务,如果第二个参数不为0,则一个写事务开始,否则是一个读事务</span></div><div class="line"><span class="comment">//如果wrflag&gt;=2,一个exclusive事务开始,此时别的连接不能访问数据库</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">sqlite3BtreeBeginTrans</span><span class="params">(Btree *p, <span class="keyword">int</span> wrflag)</span></span>&#123;</div><div class="line">  BtShared *pBt = p-&gt;pBt;</div><div class="line">  <span class="keyword">int</span> rc = SQLITE_OK;</div><div class="line"></div><div class="line">  btreeIntegrity(p);</div><div class="line"></div><div class="line">  <span class="comment">/* If the btree is already in a write-transaction, or it</span></div><div class="line">  ** is already in a read-transaction and a read-transaction</div><div class="line">  ** is requested, this is a no-op.</div><div class="line">  */</div><div class="line">  <span class="comment">//如果b-tree处于一个写事务;或者处于一个读事务,一个读事务又请求,则返回SQLITE_OK</span></div><div class="line">  <span class="keyword">if</span>( p-&gt;inTrans==TRANS_WRITE || (p-&gt;inTrans==TRANS_READ &amp;&amp; !wrflag) )&#123;</div><div class="line">    <span class="keyword">return</span> SQLITE_OK;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/* Write transactions are not possible on a read-only database */</span></div><div class="line">  <span class="comment">//写事务不能访问只读数据库</span></div><div class="line">  <span class="keyword">if</span>( pBt-&gt;readOnly &amp;&amp; wrflag )&#123;</div><div class="line">    <span class="keyword">return</span> SQLITE_READONLY;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/* If another database handle has already opened a write transaction </span></div><div class="line">  ** on this shared-btree structure and a second write transaction is</div><div class="line">  ** requested, return SQLITE_BUSY.</div><div class="line">  */</div><div class="line">  <span class="comment">//如果数据库已存在一个写事务,则该写事务请求时返回SQLITE_BUSY</span></div><div class="line">  <span class="keyword">if</span>( pBt-&gt;inTransaction==TRANS_WRITE &amp;&amp; wrflag )&#123;</div><div class="line">    <span class="keyword">return</span> SQLITE_BUSY;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">do</span> &#123;</div><div class="line">    <span class="comment">//如果数据库对应btree的第一个页面还没读进内存</span></div><div class="line">      <span class="comment">//则把该页面读进内存，数据库也相应的加read lock</span></div><div class="line">    <span class="keyword">if</span>( pBt-&gt;pPage1==<span class="number">0</span> )&#123;</div><div class="line">      <span class="comment">//加read lock，并读页面到内存</span></div><div class="line">      rc = lockBtree(pBt);</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">    <span class="keyword">if</span>( rc==SQLITE_OK &amp;&amp; wrflag )&#123;</div><div class="line">        <span class="comment">//对数据库文件加RESERVED_LOCK锁</span></div><div class="line">      rc = sqlite3pager_begin(pBt-&gt;pPage1-&gt;aData, wrflag&gt;<span class="number">1</span>);</div><div class="line">      <span class="keyword">if</span>( rc==SQLITE_OK )&#123;</div><div class="line">        rc = newDatabase(pBt);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">    <span class="keyword">if</span>( rc==SQLITE_OK )&#123;</div><div class="line">      <span class="keyword">if</span>( wrflag ) pBt-&gt;inStmt = <span class="number">0</span>;</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">      unlockBtreeIfUnused(pBt);</div><div class="line">    &#125;</div><div class="line">  &#125;<span class="keyword">while</span>( rc==SQLITE_BUSY &amp;&amp; pBt-&gt;inTransaction==TRANS_NONE &amp;&amp;</div><div class="line">          sqlite3InvokeBusyHandler(pBt-&gt;pBusyHandler) );</div><div class="line"></div><div class="line">  <span class="keyword">if</span>( rc==SQLITE_OK )&#123;</div><div class="line">    <span class="keyword">if</span>( p-&gt;inTrans==TRANS_NONE )&#123;</div><div class="line">        <span class="comment">//btree的事务数加1</span></div><div class="line">      pBt-&gt;nTransaction++;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//设置btree事务状态</span></div><div class="line">    p-&gt;inTrans = (wrflag?TRANS_WRITE:TRANS_READ);</div><div class="line">    <span class="keyword">if</span>( p-&gt;inTrans&gt;pBt-&gt;inTransaction )&#123;</div><div class="line">      pBt-&gt;inTransaction = p-&gt;inTrans;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  btreeIntegrity(p);</div><div class="line">  <span class="keyword">return</span> rc;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line">**获取数据库的写锁,发生以下情况时去除写锁:</div><div class="line">**   *  sqlite3pager_commit() is called.</div><div class="line">**   *  sqlite3pager_rollback() is called.</div><div class="line">**   *  sqlite3pager_close() is called.</div><div class="line">**   *  sqlite3pager_unref() is called to on every outstanding page.</div><div class="line">**   pData指向数据库的打开的页面,此时并不修改,仅仅只是获取</div><div class="line">**   相应的pager,检查它是否处于read-lock状态。</div><div class="line">**如果打开的不是临时文件,则打开日志文件.</div><div class="line">**如果数据库已经处于写状态，则do nothing</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">sqlite3pager_begin</span><span class="params">(<span class="keyword">void</span> *pData, <span class="keyword">int</span> exFlag)</span></span>&#123;</div><div class="line">  PgHdr *pPg = DATA_TO_PGHDR(pData);</div><div class="line">  Pager *pPager = pPg-&gt;pPager;</div><div class="line">  <span class="keyword">int</span> rc = SQLITE_OK;</div><div class="line">  <span class="keyword">assert</span>( pPg-&gt;nRef&gt;<span class="number">0</span> );</div><div class="line">  <span class="keyword">assert</span>( pPager-&gt;state!=PAGER_UNLOCK );</div><div class="line">  <span class="comment">//pager已经处于share状态</span></div><div class="line">  <span class="keyword">if</span>( pPager-&gt;state==PAGER_SHARED )&#123;</div><div class="line">    <span class="keyword">assert</span>( pPager-&gt;aInJournal==<span class="number">0</span> );</div><div class="line">    <span class="keyword">if</span>( MEMDB )&#123;</div><div class="line">      pPager-&gt;state = PAGER_EXCLUSIVE;</div><div class="line">      pPager-&gt;origDbSize = pPager-&gt;dbSize;</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        <span class="comment">//对文件加 RESERVED_LOCK</span></div><div class="line">      rc = sqlite3OsLock(pPager-&gt;fd, RESERVED_LOCK);</div><div class="line">      <span class="keyword">if</span>( rc==SQLITE_OK )&#123;</div><div class="line">          <span class="comment">//设置pager的状态</span></div><div class="line">        pPager-&gt;state = PAGER_RESERVED;</div><div class="line">        <span class="keyword">if</span>( exFlag )&#123;</div><div class="line">          rc = pager_wait_on_lock(pPager, EXCLUSIVE_LOCK);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span>( rc!=SQLITE_OK )&#123;</div><div class="line">        <span class="keyword">return</span> rc;</div><div class="line">      &#125;</div><div class="line">      pPager-&gt;dirtyCache = <span class="number">0</span>;</div><div class="line">      TRACE2(<span class="string">"TRANSACTION %d\n"</span>, PAGERID(pPager));</div><div class="line">      <span class="comment">//使用日志,不是临时文件,则打开日志文件</span></div><div class="line">      <span class="keyword">if</span>( pPager-&gt;useJournal &amp;&amp; !pPager-&gt;tempFile )&#123;</div><div class="line">          <span class="comment">//为pager打开日志文件,pager应该处于RESERVED或EXCLUSIVE状态</span></div><div class="line">          <span class="comment">//会向日志文件写入header</span></div><div class="line">        rc = pager_open_journal(pPager);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> rc;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//创建日志文件,pager应该处于RESERVED或EXCLUSIVE状态</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">pager_open_journal</span><span class="params">(Pager *pPager)</span></span>&#123;</div><div class="line">  <span class="keyword">int</span> rc;</div><div class="line">  <span class="keyword">assert</span>( !MEMDB );</div><div class="line">  <span class="keyword">assert</span>( pPager-&gt;state&gt;=PAGER_RESERVED );</div><div class="line">  <span class="keyword">assert</span>( pPager-&gt;journalOpen==<span class="number">0</span> );</div><div class="line">  <span class="keyword">assert</span>( pPager-&gt;useJournal );</div><div class="line">  <span class="keyword">assert</span>( pPager-&gt;aInJournal==<span class="number">0</span> );</div><div class="line">  sqlite3pager_pagecount(pPager);</div><div class="line">  <span class="comment">//日志文件页面位图</span></div><div class="line">  pPager-&gt;aInJournal = sqliteMalloc( pPager-&gt;dbSize/<span class="number">8</span> + <span class="number">1</span> );</div><div class="line">  <span class="keyword">if</span>( pPager-&gt;aInJournal==<span class="number">0</span> )&#123;</div><div class="line">    rc = SQLITE_NOMEM;</div><div class="line">    goto failed_to_open_journal;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//打开日志文件</span></div><div class="line">  rc = sqlite3OsOpenExclusive(pPager-&gt;zJournal, &amp;pPager-&gt;jfd,</div><div class="line">                                 pPager-&gt;tempFile);</div><div class="line">  <span class="comment">//日志文件的位置指针</span></div><div class="line">  pPager-&gt;journalOff = <span class="number">0</span>;</div><div class="line">  pPager-&gt;setMaster = <span class="number">0</span>;</div><div class="line">  pPager-&gt;journalHdr = <span class="number">0</span>;</div><div class="line">  <span class="keyword">if</span>( rc!=SQLITE_OK )&#123;</div><div class="line">    goto failed_to_open_journal;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">/*一般来说，os此时创建的文件位于磁盘缓存，并没有实际</span></div><div class="line">  **存在于磁盘,下面三个操作就是为了把结果写入磁盘,而对于</div><div class="line">  **windows系统来说,并没有提供相应API，所以实际上没有意义.</div><div class="line">  */</div><div class="line">  <span class="comment">//fullSync操作对windows没有意义</span></div><div class="line">  sqlite3OsSetFullSync(pPager-&gt;jfd, pPager-&gt;full_fsync);</div><div class="line">  sqlite3OsSetFullSync(pPager-&gt;fd, pPager-&gt;full_fsync);</div><div class="line">  <span class="comment">/* Attempt to open a file descriptor for the directory that contains a file. </span></div><div class="line">  **This file descriptor can be used to fsync() the directory</div><div class="line">  **in order to make sure the creation of a new file is actually written  to disk.</div><div class="line">  */</div><div class="line">  sqlite3OsOpenDirectory(pPager-&gt;jfd, pPager-&gt;zDirectory);</div><div class="line">  pPager-&gt;journalOpen = <span class="number">1</span>;</div><div class="line">  pPager-&gt;journalStarted = <span class="number">0</span>;</div><div class="line">  pPager-&gt;needSync = <span class="number">0</span>;</div><div class="line">  pPager-&gt;alwaysRollback = <span class="number">0</span>;</div><div class="line">  pPager-&gt;nRec = <span class="number">0</span>;</div><div class="line">  <span class="keyword">if</span>( pPager-&gt;errCode )&#123;</div><div class="line">    rc = pPager-&gt;errCode;</div><div class="line">    goto failed_to_open_journal;</div><div class="line">  &#125;</div><div class="line">  pPager-&gt;origDbSize = pPager-&gt;dbSize;</div><div class="line">  <span class="comment">//写入日志文件的header---24个字节</span></div><div class="line">  rc = writeJournalHdr(pPager);</div><div class="line"></div><div class="line">  <span class="keyword">if</span>( pPager-&gt;stmtAutoopen &amp;&amp; rc==SQLITE_OK )&#123;</div><div class="line">    rc = sqlite3pager_stmt_begin(pPager);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span>( rc!=SQLITE_OK &amp;&amp; rc!=SQLITE_NOMEM )&#123;</div><div class="line">    rc = pager_unwritelock(pPager);</div><div class="line">    <span class="keyword">if</span>( rc==SQLITE_OK )&#123;</div><div class="line">      rc = SQLITE_FULL;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> rc;</div><div class="line"></div><div class="line">failed_to_open_journal:</div><div class="line">  sqliteFree(pPager-&gt;aInJournal);</div><div class="line">  pPager-&gt;aInJournal = <span class="number">0</span>;</div><div class="line">  <span class="keyword">if</span>( rc==SQLITE_NOMEM )&#123;</div><div class="line">    <span class="comment">/* If this was a malloc() failure, then we will not be closing the pager</span></div><div class="line">    ** file. So delete any journal file we may have just created. Otherwise,</div><div class="line">    ** the system will get confused, we have a read-lock on the file and a</div><div class="line">    ** mysterious journal has appeared in the filesystem.</div><div class="line">    */</div><div class="line">    sqlite3OsDelete(pPager-&gt;zJournal);</div><div class="line">  &#125;<span class="keyword">else</span>&#123;</div><div class="line">    sqlite3OsUnlock(pPager-&gt;fd, NO_LOCK);</div><div class="line">    pPager-&gt;state = PAGER_UNLOCK;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> rc;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/*写入日志文件头</span></div><div class="line">**journal header的格式如下:</div><div class="line">** - 8 bytes: 标志日志文件的魔数</div><div class="line">** - 4 bytes: 日志文件中记录数</div><div class="line">** - 4 bytes: Random number used for page hash.</div><div class="line">** - 4 bytes: 原来数据库的大小(kb)</div><div class="line">** - 4 bytes: 扇区大小512byte</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">writeJournalHdr</span><span class="params">(Pager *pPager)</span></span>&#123;</div><div class="line">  <span class="comment">//日志文件头</span></div><div class="line">  <span class="keyword">char</span> zHeader[sizeof(aJournalMagic)+<span class="number">16</span>];</div><div class="line"></div><div class="line">  <span class="keyword">int</span> rc = seekJournalHdr(pPager);</div><div class="line">  <span class="keyword">if</span>( rc ) <span class="keyword">return</span> rc;</div><div class="line"></div><div class="line">  pPager-&gt;journalHdr = pPager-&gt;journalOff;</div><div class="line">  <span class="keyword">if</span>( pPager-&gt;stmtHdrOff==<span class="number">0</span> )&#123;</div><div class="line">    pPager-&gt;stmtHdrOff = pPager-&gt;journalHdr;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//设置文件指针指向header之后</span></div><div class="line">  pPager-&gt;journalOff += JOURNAL_HDR_SZ(pPager);</div><div class="line"></div><div class="line">  <span class="comment">/* FIX ME: </span></div><div class="line">  **</div><div class="line">  ** Possibly for a pager not in no-sync mode, the journal magic should not</div><div class="line">  ** be written until nRec is filled in as part of next syncJournal(). </div><div class="line">  **</div><div class="line">  ** Actually maybe the whole journal header should be delayed until that</div><div class="line">  ** point. Think about this.</div><div class="line">  */</div><div class="line">  memcpy(zHeader, aJournalMagic, sizeof(aJournalMagic));</div><div class="line">  <span class="comment">/* The nRec Field. 0xFFFFFFFF for no-sync journals. */</span></div><div class="line">  put32bits(&amp;zHeader[sizeof(aJournalMagic)], pPager-&gt;noSync ? <span class="number">0xffffffff</span> : <span class="number">0</span>);</div><div class="line">  <span class="comment">/* The random check-hash initialiser */</span> </div><div class="line">  sqlite3Randomness(sizeof(pPager-&gt;cksumInit), &amp;pPager-&gt;cksumInit);</div><div class="line">  put32bits(&amp;zHeader[sizeof(aJournalMagic)+<span class="number">4</span>], pPager-&gt;cksumInit);</div><div class="line">  <span class="comment">/* The initial database size */</span></div><div class="line">  put32bits(&amp;zHeader[sizeof(aJournalMagic)+<span class="number">8</span>], pPager-&gt;dbSize);</div><div class="line">  <span class="comment">/* The assumed sector size for this process */</span></div><div class="line">  put32bits(&amp;zHeader[sizeof(aJournalMagic)+<span class="number">12</span>], pPager-&gt;sectorSize);</div><div class="line">  <span class="comment">//写入文件头</span></div><div class="line">  rc = sqlite3OsWrite(pPager-&gt;jfd, zHeader, sizeof(zHeader));</div><div class="line"></div><div class="line">  <span class="comment">/* The journal header has been written successfully. Seek the journal</span></div><div class="line">  ** file descriptor to the end of the journal header sector.</div><div class="line">  */</div><div class="line">  <span class="keyword">if</span>( rc==SQLITE_OK )&#123;</div><div class="line">    rc = sqlite3OsSeek(pPager-&gt;jfd, pPager-&gt;journalOff-<span class="number">1</span>);</div><div class="line">    <span class="keyword">if</span>( rc==SQLITE_OK )&#123;</div><div class="line">      rc = sqlite3OsWrite(pPager-&gt;jfd, <span class="string">"\000"</span>, <span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> rc;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p> 其实现过程如下图所示：<br> <img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite04-01.GIF" alt=""></p>
<p> pager层是SQLite实现最为核心的模块，它具有四大功能：I/O，页面缓存，并发控制和日志恢复。而这些功能不仅是上层Btree的基础，而且对系统的性能和健壮性有关至关重要的影响。其中并发控制和日志恢复是事务处理实现的基础。SQLite并发控制的机制非常简单——封锁机制；别外，它的查询优化机制也非常简单——基于索引。这一切使得整个SQLite的实现变得简单，SQLite变得很小，运行速度也非常快，所以，特别适合嵌入式设备。好了，接下来讨论事务的剩余部分。<br>6、修改位于用户进程空间的页面(Changing Database Pages In User Space)<br>页面的原始数据写入日志之后，就可以修改页面了——位于用户进程空间。每个数据库连接都有自己私有的空间，所以页面的变化只对该连接可见，而对其它连接的数据仍然是磁盘缓存中的数据。从这里可以明白一件事：一个进程在修改页面数据的同时，其它进程可以继续进行读操作。图中的红色表示修改的页面。<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-5.gif" alt=""><br>7、日志文件刷入磁盘(Flushing The Rollback Journal File To Mass Storage)<br>接下来把日志文件的内容刷入磁盘，这对于数据库从意外中恢复来说是至关重要的一步。而且这通常也是一个耗时的操作，因为磁盘I/O速度很慢。<br>这个步骤不只把日志文件刷入磁盘那么简单，它的实现实际上分成两步：首先把日志文件的内容刷入磁盘（即页面数据）；然后把日志文件中页面的数目写入日志文件头，再把header刷入磁盘（这一过程在代码中清晰可见）。<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-6.gif" alt=""><br>代码如下：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line">**Sync日志文件,保证所有的脏页面写入磁盘日志文件</div><div class="line">*/</div><div class="line">static int syncJournal(Pager *pPager)&#123;</div><div class="line">  PgHdr *pPg;</div><div class="line">  int rc = SQLITE_OK;</div><div class="line"></div><div class="line">  /* Sync the journal before modifying the main database</div><div class="line">  ** (assuming there is a journal and it needs to be synced.)</div><div class="line">  */</div><div class="line">  if( pPager-&gt;needSync )&#123;</div><div class="line">    if( !pPager-&gt;tempFile )&#123;</div><div class="line">      assert( pPager-&gt;journalOpen );</div><div class="line">      /* assert( !pPager-&gt;noSync ); // noSync might be set if synchronous</div><div class="line">      ** was turned off after the transaction was started.  Ticket #615 */</div><div class="line">#ifndef NDEBUG</div><div class="line">      &#123;</div><div class="line">        /* Make sure the pPager-&gt;nRec counter we are keeping agrees</div><div class="line">        ** with the nRec computed from the size of the journal file.</div><div class="line">        */</div><div class="line">        i64 jSz;</div><div class="line">        rc = sqlite3OsFileSize(pPager-&gt;jfd, &amp;jSz);</div><div class="line">        if( rc!=0 ) return rc;</div><div class="line">        assert( pPager-&gt;journalOff==jSz );</div><div class="line">      &#125;</div><div class="line">#endif</div><div class="line">      &#123;</div><div class="line">        /* Write the nRec value into the journal file header. If in</div><div class="line">        ** full-synchronous mode, sync the journal first. This ensures that</div><div class="line">        ** all data has really hit the disk before nRec is updated to mark</div><div class="line">        ** it as a candidate for rollback. </div><div class="line">        */</div><div class="line">        if( pPager-&gt;fullSync )&#123;</div><div class="line">          TRACE2("SYNC journal of %d\n", PAGERID(pPager));</div><div class="line">    //首先保证脏页面中所有的数据都已经写入日志文件</div><div class="line">          rc = sqlite3OsSync(pPager-&gt;jfd, 0);</div><div class="line">          if( rc!=0 ) return rc;</div><div class="line">        &#125;</div><div class="line">        rc = sqlite3OsSeek(pPager-&gt;jfd,</div><div class="line">                           pPager-&gt;journalHdr + sizeof(aJournalMagic));</div><div class="line">        if( rc ) return rc;</div><div class="line">    //页面的数目写入日志文件</div><div class="line">        rc = write32bits(pPager-&gt;jfd, pPager-&gt;nRec);</div><div class="line">        if( rc ) return rc;</div><div class="line"></div><div class="line">        rc = sqlite3OsSeek(pPager-&gt;jfd, pPager-&gt;journalOff);</div><div class="line">        if( rc ) return rc;</div><div class="line">      &#125;</div><div class="line">      TRACE2("SYNC journal of %d\n", PAGERID(pPager));</div><div class="line">      rc = sqlite3OsSync(pPager-&gt;jfd, pPager-&gt;full_fsync);</div><div class="line">      if( rc!=0 ) return rc;</div><div class="line">      pPager-&gt;journalStarted = 1;</div><div class="line">    &#125;</div><div class="line">    pPager-&gt;needSync = 0;</div><div class="line"></div><div class="line">    /* Erase the needSync flag from every page.</div><div class="line">    */</div><div class="line">    //清除needSync标志位</div><div class="line">    for(pPg=pPager-&gt;pAll; pPg; pPg=pPg-&gt;pNextAll)&#123;</div><div class="line">      pPg-&gt;needSync = 0;</div><div class="line">    &#125;</div><div class="line">    pPager-&gt;pFirstSynced = pPager-&gt;pFirst;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">#ifndef NDEBUG</div><div class="line">  /* If the Pager.needSync flag is clear then the PgHdr.needSync</div><div class="line">  ** flag must also be clear for all pages.  Verify that this</div><div class="line">  ** invariant is true.</div><div class="line">  */</div><div class="line">  else&#123;</div><div class="line">    for(pPg=pPager-&gt;pAll; pPg; pPg=pPg-&gt;pNextAll)&#123;</div><div class="line">      assert( pPg-&gt;needSync==0 );</div><div class="line">    &#125;</div><div class="line">    assert( pPager-&gt;pFirstSynced==pPager-&gt;pFirst );</div><div class="line">  &#125;</div><div class="line">#endif</div><div class="line"></div><div class="line">  return rc;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>8、获取排斥锁（Obtaining An Exclusive Lock）<br>在对数据库文件进行修改之前(注：这里不是内存中的页面),我们必须得到数据库文件的排斥锁(Exclusive Lock)。得到排斥锁的过程可分为两步：首先得到Pending lock；然后Pending lock升级到exclusive lock。<br>Pending lock允许其它已经存在的Shared lock继续读数据库文件，但是不允许产生新的shared lock，这样做目的是为了防止写操作发生饿死情况。一旦所有的shared lock完成操作，则pending lock升级到exclusive lock。<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-7.gif" alt=""></p>
<p>9、修改的页面写入文件(Writing Changes To The Database File)<br>一旦得到exclusive lock，其它的进程就不能进行读操作，此时就可以把修改的页面写回数据库文件，但是通常OS都把结果暂时保存到磁盘缓存中，直到某个时刻才会真正把结果写入磁盘。<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-8.gif" alt=""><br>以上两步的实现代码：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line">//把所有的脏页面写入数据库</div><div class="line">//到这里开始获取EXCLUSIVEQ锁，并将页面写回操作系统文件</div><div class="line">static int pager_write_pagelist(PgHdr *pList)&#123;</div><div class="line">  Pager *pPager;</div><div class="line">  int rc;</div><div class="line"></div><div class="line">  if( pList==0 ) return SQLITE_OK;</div><div class="line">  pPager = pList-&gt;pPager;</div><div class="line"></div><div class="line">  /* At this point there may be either a RESERVED or EXCLUSIVE lock on the</div><div class="line">  ** database file. If there is already an EXCLUSIVE lock, the following</div><div class="line">  ** calls to sqlite3OsLock() are no-ops.</div><div class="line">  **</div><div class="line">  ** Moving the lock from RESERVED to EXCLUSIVE actually involves going</div><div class="line">  ** through an intermediate state PENDING.   A PENDING lock prevents new</div><div class="line">  ** readers from attaching to the database but is unsufficient for us to</div><div class="line">  ** write.  The idea of a PENDING lock is to prevent new readers from</div><div class="line">  ** coming in while we wait for existing readers to clear.</div><div class="line">  **</div><div class="line">  ** While the pager is in the RESERVED state, the original database file</div><div class="line">  ** is unchanged and we can rollback without having to playback the</div><div class="line">  ** journal into the original database file.  Once we transition to</div><div class="line">  ** EXCLUSIVE, it means the database file has been changed and any rollback</div><div class="line">  ** will require a journal playback.</div><div class="line">  */</div><div class="line">  //加EXCLUSIVE_LOCK锁</div><div class="line">  rc = pager_wait_on_lock(pPager, EXCLUSIVE_LOCK);</div><div class="line">  if( rc!=SQLITE_OK )&#123;</div><div class="line">    return rc;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  while( pList )&#123;</div><div class="line">    assert( pList-&gt;dirty );</div><div class="line">    rc = sqlite3OsSeek(pPager-&gt;fd, (pList-&gt;pgno-1)*(i64)pPager-&gt;pageSize);</div><div class="line">    if( rc ) return rc;</div><div class="line">    /* If there are dirty pages in the page cache with page numbers greater</div><div class="line">    ** than Pager.dbSize, this means sqlite3pager_truncate() was called to</div><div class="line">    ** make the file smaller (presumably by auto-vacuum code). Do not write</div><div class="line">    ** any such pages to the file.</div><div class="line">    */</div><div class="line">    if( pList-&gt;pgno&lt;=pPager-&gt;dbSize )&#123;</div><div class="line">      char *pData = CODEC2(pPager, PGHDR_TO_DATA(pList), pList-&gt;pgno, 6);</div><div class="line">      TRACE3("STORE %d page %d\n", PAGERID(pPager), pList-&gt;pgno);</div><div class="line">      //写入文件</div><div class="line">      rc = sqlite3OsWrite(pPager-&gt;fd, pData, pPager-&gt;pageSize);</div><div class="line">      TEST_INCR(pPager-&gt;nWrite);</div><div class="line">    &#125;</div><div class="line">#ifndef NDEBUG</div><div class="line">    else&#123;</div><div class="line">      TRACE3("NOSTORE %d page %d\n", PAGERID(pPager), pList-&gt;pgno);</div><div class="line">    &#125;</div><div class="line">#endif</div><div class="line">    if( rc ) return rc;</div><div class="line">    //设置dirty</div><div class="line">    pList-&gt;dirty = 0;</div><div class="line">#ifdef SQLITE_CHECK_PAGES</div><div class="line">    pList-&gt;pageHash = pager_pagehash(pList);</div><div class="line">#endif</div><div class="line">//指向下一个脏页面</div><div class="line">    pList = pList-&gt;pDirty;</div><div class="line">  &#125;</div><div class="line">  return SQLITE_OK;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>10、修改结果刷入存储设备(Flushing Changes To Mass Storage)<br>为了保证修改结果真正写入磁盘，这一步必不要少。对于数据库存的完整性，这一步也是关键的一步。由于要进行实际的I/O操作，所以和第7步一样，将花费较多的时间。<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-9.gif" alt=""><br>最后来看看这几步是如何实现的：</p>
<p>其实以上以上几步是在函数sqlite3BtreeSync()—btree.c中调用的(而关于该函数的调用后面再讲)。</p>
<p>代码如下：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div></pre></td><td class="code"><pre><div class="line">//同步btree对应的数据库文件</div><div class="line">//该函数返回之后，只需要提交写事务,删除日志文件</div><div class="line">int sqlite3BtreeSync(Btree *p, const char *zMaster)&#123;</div><div class="line">  int rc = SQLITE_OK;</div><div class="line">  if( p-&gt;inTrans==TRANS_WRITE )&#123;</div><div class="line">    BtShared *pBt = p-&gt;pBt;</div><div class="line">    Pgno nTrunc = 0;</div><div class="line">#ifndef SQLITE_OMIT_AUTOVACUUM</div><div class="line">    if( pBt-&gt;autoVacuum )&#123;</div><div class="line">      rc = autoVacuumCommit(pBt, &amp;nTrunc); </div><div class="line">      if( rc!=SQLITE_OK )&#123;</div><div class="line">        return rc;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">#endif</div><div class="line"></div><div class="line"> //调用pager进行sync</div><div class="line">    rc = sqlite3pager_sync(pBt-&gt;pPager, zMaster, nTrunc);</div><div class="line">  &#125;</div><div class="line">  return rc;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//把pager所有脏页面写回文件</div><div class="line">int sqlite3pager_sync(Pager *pPager, const char *zMaster, Pgno nTrunc)&#123;</div><div class="line">  int rc = SQLITE_OK;</div><div class="line"></div><div class="line">  TRACE4("DATABASE SYNC: File=%s zMaster=%s nTrunc=%d\n", </div><div class="line">      pPager-&gt;zFilename, zMaster, nTrunc);</div><div class="line"></div><div class="line">  /* If this is an in-memory db, or no pages have been written to, or this</div><div class="line">  ** function has already been called, it is a no-op.</div><div class="line">  */</div><div class="line">  //pager不处于PAGER_SYNCED状态,dirtyCache为1,</div><div class="line">  //则进行sync操作</div><div class="line">  if( pPager-&gt;state!=PAGER_SYNCED &amp;&amp; !MEMDB &amp;&amp; pPager-&gt;dirtyCache )&#123;</div><div class="line">    PgHdr *pPg;</div><div class="line">    assert( pPager-&gt;journalOpen );</div><div class="line"></div><div class="line">    /* If a master journal file name has already been written to the</div><div class="line">    ** journal file, then no sync is required. This happens when it is</div><div class="line">    ** written, then the process fails to upgrade from a RESERVED to an</div><div class="line">    ** EXCLUSIVE lock. The next time the process tries to commit the</div><div class="line">    ** transaction the m-j name will have already been written.</div><div class="line">    */</div><div class="line">    if( !pPager-&gt;setMaster )&#123;</div><div class="line">        //pager修改计数</div><div class="line">      rc = pager_incr_changecounter(pPager);</div><div class="line">      if( rc!=SQLITE_OK ) goto sync_exit;</div><div class="line">#ifndef SQLITE_OMIT_AUTOVACUUM</div><div class="line">      if( nTrunc!=0 )&#123;</div><div class="line">        /* If this transaction has made the database smaller, then all pages</div><div class="line">        ** being discarded by the truncation must be written to the journal</div><div class="line">        ** file.</div><div class="line">        */</div><div class="line">        Pgno i;</div><div class="line">        void *pPage;</div><div class="line">        int iSkip = PAGER_MJ_PGNO(pPager);</div><div class="line">        for( i=nTrunc+1; i&lt;=pPager-&gt;origDbSize; i++ )&#123;</div><div class="line">          if( !(pPager-&gt;aInJournal[i/8] &amp; (1&lt;&lt;(i&amp;7))) &amp;&amp; i!=iSkip )&#123;</div><div class="line">            rc = sqlite3pager_get(pPager, i, &amp;pPage);</div><div class="line">            if( rc!=SQLITE_OK ) goto sync_exit;</div><div class="line">            rc = sqlite3pager_write(pPage);</div><div class="line">            sqlite3pager_unref(pPage);</div><div class="line">            if( rc!=SQLITE_OK ) goto sync_exit;</div><div class="line">          &#125;</div><div class="line">        &#125; </div><div class="line">      &#125;</div><div class="line">#endif</div><div class="line">      rc = writeMasterJournal(pPager, zMaster);</div><div class="line">      if( rc!=SQLITE_OK ) goto sync_exit;</div><div class="line">      </div><div class="line">        //sync日志文件</div><div class="line">      rc = syncJournal(pPager);</div><div class="line">      if( rc!=SQLITE_OK ) goto sync_exit;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">#ifndef SQLITE_OMIT_AUTOVACUUM</div><div class="line">    if( nTrunc!=0 )&#123;</div><div class="line">      rc = sqlite3pager_truncate(pPager, nTrunc);</div><div class="line">      if( rc!=SQLITE_OK ) goto sync_exit;</div><div class="line">    &#125;</div><div class="line">#endif</div><div class="line"></div><div class="line">    /* Write all dirty pages to the database file */</div><div class="line">    pPg = pager_get_all_dirty_pages(pPager);</div><div class="line"></div><div class="line"></div><div class="line">   //把所有脏页面写回操作系统文件</div><div class="line">    rc = pager_write_pagelist(pPg);</div><div class="line">    if( rc!=SQLITE_OK ) goto sync_exit;</div><div class="line"></div><div class="line">    /* Sync the database file. */</div><div class="line">       //sync数据库文件</div><div class="line">    if( !pPager-&gt;noSync )&#123;</div><div class="line">      rc = sqlite3OsSync(pPager-&gt;fd, 0);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    pPager-&gt;state = PAGER_SYNCED;</div><div class="line">  &#125;else if( MEMDB &amp;&amp; nTrunc!=0 )&#123;</div><div class="line">    rc = sqlite3pager_truncate(pPager, nTrunc);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">sync_exit:</div><div class="line">  return rc;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>下图可以进一步解释该过程：<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite04-02.GIF" alt=""></p>
<p>11、删除日志文件(Deleting The Rollback Journal)<br>一旦更改写入设备，日志文件将会被删除，这是事务真正提交的时刻。如果在这之前系统发生崩溃，就会进行恢复处理，使得数据库和没发生改变一样；如果在这之后系统发生崩溃，表明所有的更改都已经写入磁盘。SQLite就是根据日志存在情况决定是否对数据库进行恢复处理。</p>
<p>删除文件本质上不是一个原子操作，但是从用户进程的角度来看是一个原子操作，所以一个事务看起来是一个原子操作。<br>在许多系统中，删除文件也是一个高代价的操作。作为优化，SQLite可以配置成把日志文件的长度截为0或者把日志文件头清零。<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-A.gif" alt=""><br>12、释放锁(Releasing The Lock)<br>作为原子提交的最后一步，释放排斥锁使得其它进程可以开始访问数据库了。<br>下图中，我们指明了当锁被释放的时候用户空间所拥有的信息已经被清空了.对于老版本的SQLite你可这么认为。但最新的SQLite会保存些用户空间的缓存不会被清空—万一下一个事务开始的时候，这些数据刚好可以用上呢。重新利用这些内存要比再次从操作系统磁盘缓存或者硬盘中读取要来得轻松与快捷得多，何乐而不为呢？在再次使用这些数据之前，我们必须先取得一个共享锁，同时我们还不得不去检查一下，保证还没有其他进程在我们拥有共享锁之前对数据库文件进行了修改。数据库文件的第一页中有一个计数器，数据库文件每做一次修改，这个计数器就会增长一下。我们可以通过检查这个计数器就可得知是否有其他进程修改过数据库文件。如果数据库文件已经被修改过了，那么用户内存空间的缓存就不得不清空，并重新读入。大多数情况下，这种情况不大会发生，因此用户空间的内存缓存将是有效的，这对于性能提高来说作用是显著的。<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/commit-B.gif" alt=""><br>以上两步是在sqlite3BtreeCommit()—btree.c函数中实现的。</p>
<p>代码如下：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div></pre></td><td class="code"><pre><div class="line">//提交事务,至此一个事务完成.主要做两件事:</div><div class="line">//删除日志文件,释放数据库文件的写锁</div><div class="line">int sqlite3BtreeCommit(Btree *p)&#123;</div><div class="line">  BtShared *pBt = p-&gt;pBt;</div><div class="line"></div><div class="line">  btreeIntegrity(p);</div><div class="line"></div><div class="line">  /* If the handle has a write-transaction open, commit the shared-btrees </div><div class="line">  ** transaction and set the shared state to TRANS_READ.</div><div class="line">  */</div><div class="line">  if( p-&gt;inTrans==TRANS_WRITE )&#123;</div><div class="line">    int rc;</div><div class="line">    assert( pBt-&gt;inTransaction==TRANS_WRITE );</div><div class="line">    assert( pBt-&gt;nTransaction&gt;0 );</div><div class="line"></div><div class="line">   //调用pager，提交事务</div><div class="line">    rc = sqlite3pager_commit(pBt-&gt;pPager);</div><div class="line">    if( rc!=SQLITE_OK )&#123;</div><div class="line">      return rc;</div><div class="line">    &#125;</div><div class="line">    pBt-&gt;inTransaction = TRANS_READ;</div><div class="line">    pBt-&gt;inStmt = 0;</div><div class="line">  &#125;</div><div class="line">  unlockAllTables(p);</div><div class="line"></div><div class="line">  /* If the handle has any kind of transaction open, decrement the transaction</div><div class="line">  ** count of the shared btree. If the transaction count reaches 0, set</div><div class="line">  ** the shared state to TRANS_NONE. The unlockBtreeIfUnused() call below</div><div class="line">  ** will unlock the pager.</div><div class="line">  */</div><div class="line">  if( p-&gt;inTrans!=TRANS_NONE )&#123;</div><div class="line">    pBt-&gt;nTransaction--;</div><div class="line">    if( 0==pBt-&gt;nTransaction )&#123;</div><div class="line">      pBt-&gt;inTransaction = TRANS_NONE;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//提交事务，主要调用pager_unwritelock()函数</div><div class="line">int sqlite3pager_commit(Pager *pPager)&#123;</div><div class="line">  int rc;</div><div class="line">  PgHdr *pPg;</div><div class="line"></div><div class="line">  if( pPager-&gt;errCode )&#123;</div><div class="line">    return pPager-&gt;errCode;</div><div class="line">  &#125;</div><div class="line">  if( pPager-&gt;state&lt;PAGER_RESERVED )&#123;</div><div class="line">    return SQLITE_ERROR;</div><div class="line">  &#125;</div><div class="line">  TRACE2("COMMIT %d\n", PAGERID(pPager));</div><div class="line">  if( MEMDB )&#123;</div><div class="line">    pPg = pager_get_all_dirty_pages(pPager);</div><div class="line">    while( pPg )&#123;</div><div class="line">      clearHistory(PGHDR_TO_HIST(pPg, pPager));</div><div class="line">      pPg-&gt;dirty = 0;</div><div class="line">      pPg-&gt;inJournal = 0;</div><div class="line">      pPg-&gt;inStmt = 0;</div><div class="line">      pPg-&gt;needSync = 0;</div><div class="line">      pPg-&gt;pPrevStmt = pPg-&gt;pNextStmt = 0;</div><div class="line">      pPg = pPg-&gt;pDirty;</div><div class="line">    &#125;</div><div class="line">    pPager-&gt;pDirty = 0;</div><div class="line">#ifndef NDEBUG</div><div class="line">    for(pPg=pPager-&gt;pAll; pPg; pPg=pPg-&gt;pNextAll)&#123;</div><div class="line">      PgHistory *pHist = PGHDR_TO_HIST(pPg, pPager);</div><div class="line">      assert( !pPg-&gt;alwaysRollback );</div><div class="line">      assert( !pHist-&gt;pOrig );</div><div class="line">      assert( !pHist-&gt;pStmt );</div><div class="line">    &#125;</div><div class="line">#endif</div><div class="line">    pPager-&gt;pStmt = 0;</div><div class="line">    pPager-&gt;state = PAGER_SHARED;</div><div class="line">    return SQLITE_OK;</div><div class="line">  &#125;</div><div class="line">  if( pPager-&gt;dirtyCache==0 )&#123;</div><div class="line">    /* Exit early (without doing the time-consuming sqlite3OsSync() calls)</div><div class="line">    ** if there have been no changes to the database file. */</div><div class="line">    assert( pPager-&gt;needSync==0 );</div><div class="line">    rc = pager_unwritelock(pPager);</div><div class="line">    pPager-&gt;dbSize = -1;</div><div class="line">    return rc;</div><div class="line">  &#125;</div><div class="line">  assert( pPager-&gt;journalOpen );</div><div class="line">  rc = sqlite3pager_sync(pPager, 0, 0);</div><div class="line">  </div><div class="line">  //删除文件,释放写锁</div><div class="line">  if( rc==SQLITE_OK )&#123;</div><div class="line">    rc = pager_unwritelock(pPager);</div><div class="line">    pPager-&gt;dbSize = -1;</div><div class="line">  &#125;</div><div class="line">  return rc;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//对数据库加read lock，删除日志文件</div><div class="line">static int pager_unwritelock(Pager *pPager)&#123;</div><div class="line">  PgHdr *pPg;</div><div class="line">  int rc;</div><div class="line">  assert( !MEMDB );</div><div class="line">  if( pPager-&gt;state&lt;PAGER_RESERVED )&#123;</div><div class="line">    return SQLITE_OK;</div><div class="line">  &#125;</div><div class="line">  sqlite3pager_stmt_commit(pPager);</div><div class="line">  if( pPager-&gt;stmtOpen )&#123;</div><div class="line">    sqlite3OsClose(&amp;pPager-&gt;stfd);</div><div class="line">    pPager-&gt;stmtOpen = 0;</div><div class="line">  &#125;</div><div class="line">  if( pPager-&gt;journalOpen )&#123;</div><div class="line"></div><div class="line">   //关闭日志文件</div><div class="line">    sqlite3OsClose(&amp;pPager-&gt;jfd);</div><div class="line">    pPager-&gt;journalOpen = 0;</div><div class="line">    //删除日志文件</div><div class="line">    sqlite3OsDelete(pPager-&gt;zJournal);</div><div class="line">    sqliteFree( pPager-&gt;aInJournal );</div><div class="line">    pPager-&gt;aInJournal = 0;</div><div class="line">    for(pPg=pPager-&gt;pAll; pPg; pPg=pPg-&gt;pNextAll)&#123;</div><div class="line">      pPg-&gt;inJournal = 0;</div><div class="line">      pPg-&gt;dirty = 0;</div><div class="line">      pPg-&gt;needSync = 0;</div><div class="line">#ifdef SQLITE_CHECK_PAGES</div><div class="line">      pPg-&gt;pageHash = pager_pagehash(pPg);</div><div class="line">#endif</div><div class="line">    &#125;</div><div class="line">    pPager-&gt;pDirty = 0;</div><div class="line">    pPager-&gt;dirtyCache = 0;</div><div class="line">    pPager-&gt;nRec = 0;</div><div class="line">  &#125;else&#123;</div><div class="line">    assert( pPager-&gt;aInJournal==0 );</div><div class="line">    assert( pPager-&gt;dirtyCache==0 || pPager-&gt;useJournal==0 );</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  //释放写锁，加读锁</div><div class="line">  rc = sqlite3OsUnlock(pPager-&gt;fd, SHARED_LOCK);</div><div class="line">  pPager-&gt;state = PAGER_SHARED;</div><div class="line">  pPager-&gt;origDbSize = 0;</div><div class="line">  pPager-&gt;setMaster = 0;</div><div class="line">  pPager-&gt;needSync = 0;</div><div class="line">  pPager-&gt;pFirstSynced = pPager-&gt;pFirst;</div><div class="line">  return rc;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>下图可进一步描述该过程：<br><img src="http://images.cnblogs.com/cnblogs_com/hustcat/2009/sqlite04-03.GIF" alt=""><br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div></pre></td><td class="code"><pre><div class="line">//虚拟机停机指令</div><div class="line">case OP_Halt: &#123;            /* no-push */</div><div class="line">  p-&gt;pTos = pTos;</div><div class="line">  p-&gt;rc = pOp-&gt;p1;</div><div class="line">  p-&gt;pc = pc;</div><div class="line">  p-&gt;errorAction = pOp-&gt;p2;</div><div class="line">  if( pOp-&gt;p3 )&#123;</div><div class="line">    sqlite3SetString(&amp;p-&gt;zErrMsg, pOp-&gt;p3, (char*)0);</div><div class="line">  &#125;</div><div class="line">  //设置虚拟机状态SQLITE_MAGIC_RUN 为 SQLITE_MAGIC_HALT,</div><div class="line">  //并提交事务</div><div class="line">  rc = sqlite3VdbeHalt(p);</div><div class="line">  assert( rc==SQLITE_BUSY || rc==SQLITE_OK );</div><div class="line">  if( rc==SQLITE_BUSY )&#123;</div><div class="line">    p-&gt;rc = SQLITE_BUSY;</div><div class="line">    return SQLITE_BUSY;</div><div class="line">  &#125;</div><div class="line">  return p-&gt;rc ? SQLITE_ERROR : SQLITE_DONE;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//当虚拟机要停机时,调用该函数,如果VDBE改变了数据库且为自动</div><div class="line">//提交模式，则提交这些改变</div><div class="line">int sqlite3VdbeHalt(Vdbe *p)&#123;</div><div class="line">  sqlite3 *db = p-&gt;db;</div><div class="line">  int i;</div><div class="line">  int (*xFunc)(Btree *pBt) = 0;  /* Function to call on each btree backend */</div><div class="line">  int isSpecialError;            /* Set to true if SQLITE_NOMEM or IOERR */</div><div class="line"></div><div class="line">  /* This function contains the logic that determines if a statement or</div><div class="line">  ** transaction will be committed or rolled back as a result of the</div><div class="line">  ** execution of this virtual machine. </div><div class="line">  **</div><div class="line">  ** Special errors:</div><div class="line">  **</div><div class="line">  **     If an SQLITE_NOMEM error has occured in a statement that writes to</div><div class="line">  **     the database, then either a statement or transaction must be rolled</div><div class="line">  **     back to ensure the tree-structures are in a consistent state. A</div><div class="line">  **     statement transaction is rolled back if one is open, otherwise the</div><div class="line">  **     entire transaction must be rolled back.</div><div class="line">  **</div><div class="line">  **     If an SQLITE_IOERR error has occured in a statement that writes to</div><div class="line">  **     the database, then the entire transaction must be rolled back. The</div><div class="line">  **     I/O error may have caused garbage to be written to the journal </div><div class="line">  **     file. Were the transaction to continue and eventually be rolled </div><div class="line">  **     back that garbage might end up in the database file.</div><div class="line">  **     </div><div class="line">  **     In both of the above cases, the Vdbe.errorAction variable is </div><div class="line">  **     ignored. If the sqlite3.autoCommit flag is false and a transaction</div><div class="line">  **     is rolled back, it will be set to true.</div><div class="line">  **</div><div class="line">  ** Other errors:</div><div class="line">  **</div><div class="line">  ** No error:</div><div class="line">  **</div><div class="line">  */</div><div class="line"></div><div class="line">  if( sqlite3MallocFailed() )&#123;</div><div class="line">    p-&gt;rc = SQLITE_NOMEM;</div><div class="line">  &#125;</div><div class="line">  if( p-&gt;magic!=VDBE_MAGIC_RUN )&#123;</div><div class="line">    /* Already halted.  Nothing to do. */</div><div class="line">    assert( p-&gt;magic==VDBE_MAGIC_HALT );</div><div class="line">    return SQLITE_OK;</div><div class="line">  &#125;</div><div class="line">  //释放虚拟机中所有的游标</div><div class="line">  closeAllCursors(p);</div><div class="line">  checkActiveVdbeCnt(db);</div><div class="line"></div><div class="line">  /* No commit or rollback needed if the program never started */</div><div class="line">  if( p-&gt;pc&gt;=0 )&#123;</div><div class="line"></div><div class="line">    /* Check for one of the special errors - SQLITE_NOMEM or SQLITE_IOERR */</div><div class="line">    isSpecialError = ((p-&gt;rc==SQLITE_NOMEM || p-&gt;rc==SQLITE_IOERR)?1:0);</div><div class="line">    if( isSpecialError )&#123;</div><div class="line">      /* This loop does static analysis of the query to see which of the</div><div class="line">      ** following three categories it falls into:</div><div class="line">      **</div><div class="line">      **     Read-only</div><div class="line">      **     Query with statement journal</div><div class="line">      **     Query without statement journal</div><div class="line">      **</div><div class="line">      ** We could do something more elegant than this static analysis (i.e.</div><div class="line">      ** store the type of query as part of the compliation phase), but </div><div class="line">      ** handling malloc() or IO failure is a fairly obscure edge case so </div><div class="line">      ** this is probably easier. Todo: Might be an opportunity to reduce </div><div class="line">      ** code size a very small amount though</div><div class="line">      */</div><div class="line">      int isReadOnly = 1;</div><div class="line">      int isStatement = 0;</div><div class="line">      assert(p-&gt;aOp || p-&gt;nOp==0);</div><div class="line">      for(i=0; i&lt;p-&gt;nOp; i++)&#123; </div><div class="line">        switch( p-&gt;aOp[i].opcode )&#123;</div><div class="line">          case OP_Transaction:</div><div class="line">            isReadOnly = 0;</div><div class="line">            break;</div><div class="line">          case OP_Statement:</div><div class="line">            isStatement = 1;</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">  </div><div class="line">      /* If the query was read-only, we need do no rollback at all. Otherwise,</div><div class="line">      ** proceed with the special handling.</div><div class="line">      */</div><div class="line">      if( !isReadOnly )&#123;</div><div class="line">        if( p-&gt;rc==SQLITE_NOMEM &amp;&amp; isStatement )&#123;</div><div class="line">          xFunc = sqlite3BtreeRollbackStmt;</div><div class="line">        &#125;else&#123;</div><div class="line">          /* We are forced to roll back the active transaction. Before doing</div><div class="line">          ** so, abort any other statements this handle currently has active.</div><div class="line">          */</div><div class="line">          sqlite3AbortOtherActiveVdbes(db, p);</div><div class="line">          sqlite3RollbackAll(db);</div><div class="line">          db-&gt;autoCommit = 1;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">    /* If the auto-commit flag is set and this is the only active vdbe, then</div><div class="line">    ** we do either a commit or rollback of the current transaction. </div><div class="line">    **</div><div class="line">    ** Note: This block also runs if one of the special errors handled </div><div class="line">    ** above has occured. </div><div class="line">    */</div><div class="line">    //如果自动提交事务，则提交事务</div><div class="line">    if( db-&gt;autoCommit &amp;&amp; db-&gt;activeVdbeCnt==1 )&#123;</div><div class="line">      if( p-&gt;rc==SQLITE_OK || (p-&gt;errorAction==OE_Fail &amp;&amp; !isSpecialError) )&#123;</div><div class="line">    /* The auto-commit flag is true, and the vdbe program was </div><div class="line">        ** successful or hit an 'OR FAIL' constraint. This means a commit </div><div class="line">        ** is required.</div><div class="line">        */</div><div class="line">        //提交事务</div><div class="line">        int rc = vdbeCommit(db);</div><div class="line">        if( rc==SQLITE_BUSY )&#123;</div><div class="line">          return SQLITE_BUSY;</div><div class="line">        &#125;else if( rc!=SQLITE_OK )&#123;</div><div class="line">          p-&gt;rc = rc;</div><div class="line">          sqlite3RollbackAll(db);</div><div class="line">        &#125;else&#123;</div><div class="line">          sqlite3CommitInternalChanges(db);</div><div class="line">        &#125;</div><div class="line">      &#125;else&#123;</div><div class="line">        sqlite3RollbackAll(db);</div><div class="line">      &#125;</div><div class="line">    &#125;else if( !xFunc )&#123;</div><div class="line">      if( p-&gt;rc==SQLITE_OK || p-&gt;errorAction==OE_Fail )&#123;</div><div class="line">        xFunc = sqlite3BtreeCommitStmt;</div><div class="line">      &#125;else if( p-&gt;errorAction==OE_Abort )&#123;</div><div class="line">        xFunc = sqlite3BtreeRollbackStmt;</div><div class="line">      &#125;else&#123;</div><div class="line">        sqlite3AbortOtherActiveVdbes(db, p);</div><div class="line">        sqlite3RollbackAll(db);</div><div class="line">        db-&gt;autoCommit = 1;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">    /* If xFunc is not NULL, then it is one of sqlite3BtreeRollbackStmt or</div><div class="line">    ** sqlite3BtreeCommitStmt. Call it once on each backend. If an error occurs</div><div class="line">    ** and the return code is still SQLITE_OK, set the return code to the new</div><div class="line">    ** error value.</div><div class="line">    */</div><div class="line">    assert(!xFunc ||</div><div class="line">      xFunc==sqlite3BtreeCommitStmt ||</div><div class="line">      xFunc==sqlite3BtreeRollbackStmt</div><div class="line">    );</div><div class="line">    for(i=0; xFunc &amp;&amp; i&lt;db-&gt;nDb; i++)&#123; </div><div class="line">      int rc;</div><div class="line">      Btree *pBt = db-&gt;aDb[i].pBt;</div><div class="line">      if( pBt )&#123;</div><div class="line">        rc = xFunc(pBt);</div><div class="line">        if( rc &amp;&amp; (p-&gt;rc==SQLITE_OK || p-&gt;rc==SQLITE_CONSTRAINT) )&#123;</div><div class="line">          p-&gt;rc = rc;</div><div class="line">          sqlite3SetString(&amp;p-&gt;zErrMsg, 0);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">    /* If this was an INSERT, UPDATE or DELETE and the statement was committed, </div><div class="line">    ** set the change counter. </div><div class="line">    */</div><div class="line">    if( p-&gt;changeCntOn &amp;&amp; p-&gt;pc&gt;=0 )&#123;</div><div class="line">      if( !xFunc || xFunc==sqlite3BtreeCommitStmt )&#123;</div><div class="line">        sqlite3VdbeSetChanges(db, p-&gt;nChange);</div><div class="line">      &#125;else&#123;</div><div class="line">        sqlite3VdbeSetChanges(db, 0);</div><div class="line">      &#125;</div><div class="line">      p-&gt;nChange = 0;</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">    /* Rollback or commit any schema changes that occurred. */</div><div class="line">    if( p-&gt;rc!=SQLITE_OK &amp;&amp; db-&gt;flags&amp;SQLITE_InternChanges )&#123;</div><div class="line">      sqlite3ResetInternalSchema(db, 0);</div><div class="line">      db-&gt;flags = (db-&gt;flags | SQLITE_InternChanges);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  /* We have successfully halted and closed the VM.  Record this fact. */</div><div class="line">  if( p-&gt;pc&gt;=0 )&#123;</div><div class="line">    db-&gt;activeVdbeCnt--;</div><div class="line">  &#125;</div><div class="line">  p-&gt;magic = VDBE_MAGIC_HALT;</div><div class="line">  checkActiveVdbeCnt(db);</div><div class="line"></div><div class="line">  return SQLITE_OK;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//提交事务,主要调用:</div><div class="line">//sqlite3BtreeSync()---同步btree, sqlite3BtreeCommit()---提交事务</div><div class="line">static int vdbeCommit(sqlite3 *db)&#123;</div><div class="line">  int i;</div><div class="line">  int nTrans = 0;  /* Number of databases with an active write-transaction */</div><div class="line">  int rc = SQLITE_OK;</div><div class="line">  int needXcommit = 0;</div><div class="line"></div><div class="line">  for(i=0; i&lt;db-&gt;nDb; i++)&#123; </div><div class="line">    Btree *pBt = db-&gt;aDb[i].pBt;</div><div class="line">    if( pBt &amp;&amp; sqlite3BtreeIsInTrans(pBt) )&#123;</div><div class="line">      needXcommit = 1;</div><div class="line">      if( i!=1 ) nTrans++;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  /* If there are any write-transactions at all, invoke the commit hook */</div><div class="line">  if( needXcommit &amp;&amp; db-&gt;xCommitCallback )&#123;</div><div class="line">    sqlite3SafetyOff(db);</div><div class="line">    rc = db-&gt;xCommitCallback(db-&gt;pCommitArg);</div><div class="line">    sqlite3SafetyOn(db);</div><div class="line">    if( rc )&#123;</div><div class="line">      return SQLITE_CONSTRAINT;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  /* The simple case - no more than one database file (not counting the</div><div class="line">  ** TEMP database) has a transaction active.   There is no need for the</div><div class="line">  ** master-journal.</div><div class="line">  **</div><div class="line">  ** If the return value of sqlite3BtreeGetFilename() is a zero length</div><div class="line">  ** string, it means the main database is :memory:.  In that case we do</div><div class="line">  ** not support atomic multi-file commits, so use the simple case then</div><div class="line">  ** too.</div><div class="line">  */</div><div class="line">  //简单的情况,只有一个数据库文件,不需要master-journal</div><div class="line">  if( 0==strlen(sqlite3BtreeGetFilename(db-&gt;aDb[0].pBt)) || nTrans&lt;=1 )&#123;</div><div class="line">    for(i=0; rc==SQLITE_OK &amp;&amp; i&lt;db-&gt;nDb; i++)&#123; </div><div class="line">      Btree *pBt = db-&gt;aDb[i].pBt;</div><div class="line">      if( pBt )&#123;</div><div class="line">          //同步btree</div><div class="line">        rc = sqlite3BtreeSync(pBt, 0);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /* Do the commit only if all databases successfully synced */</div><div class="line">    //commite事务</div><div class="line">    if( rc==SQLITE_OK )&#123;</div><div class="line">      for(i=0; i&lt;db-&gt;nDb; i++)&#123;</div><div class="line">        Btree *pBt = db-&gt;aDb[i].pBt;</div><div class="line">        if( pBt )&#123;</div><div class="line">          sqlite3BtreeCommit(pBt);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  /* The complex case - There is a multi-file write-transaction active.</div><div class="line">  ** This requires a master journal file to ensure the transaction is</div><div class="line">  ** committed atomicly.</div><div class="line">  */</div><div class="line">#ifndef SQLITE_OMIT_DISKIO</div><div class="line">  else&#123;</div><div class="line">    int needSync = 0;</div><div class="line">    char *zMaster = 0;   /* File-name for the master journal */</div><div class="line">    char const *zMainFile = sqlite3BtreeGetFilename(db-&gt;aDb[0].pBt);</div><div class="line">    OsFile *master = 0;</div><div class="line"></div><div class="line">    /* Select a master journal file name */</div><div class="line">    do &#123;</div><div class="line">      u32 random;</div><div class="line">      sqliteFree(zMaster);</div><div class="line">      sqlite3Randomness(sizeof(random), &amp;random);</div><div class="line">      zMaster = sqlite3MPrintf("%s-mj%08X", zMainFile, random&amp;0x7fffffff);</div><div class="line">      if( !zMaster )&#123;</div><div class="line">        return SQLITE_NOMEM;</div><div class="line">      &#125;</div><div class="line">    &#125;while( sqlite3OsFileExists(zMaster) );</div><div class="line"></div><div class="line">    /* Open the master journal. */</div><div class="line">    rc = sqlite3OsOpenExclusive(zMaster, &amp;master, 0);</div><div class="line">    if( rc!=SQLITE_OK )&#123;</div><div class="line">      sqliteFree(zMaster);</div><div class="line">      return rc;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    /* Write the name of each database file in the transaction into the new</div><div class="line">    ** master journal file. If an error occurs at this point close</div><div class="line">    ** and delete the master journal file. All the individual journal files</div><div class="line">    ** still have 'null' as the master journal pointer, so they will roll</div><div class="line">    ** back independently if a failure occurs.</div><div class="line">    */</div><div class="line">    for(i=0; i&lt;db-&gt;nDb; i++)&#123; </div><div class="line">      Btree *pBt = db-&gt;aDb[i].pBt;</div><div class="line">      if( i==1 ) continue;   /* Ignore the TEMP database */</div><div class="line">      if( pBt &amp;&amp; sqlite3BtreeIsInTrans(pBt) )&#123;</div><div class="line">        char const *zFile = sqlite3BtreeGetJournalname(pBt);</div><div class="line">        if( zFile[0]==0 ) continue;  /* Ignore :memory: databases */</div><div class="line">        if( !needSync &amp;&amp; !sqlite3BtreeSyncDisabled(pBt) )&#123;</div><div class="line">          needSync = 1;</div><div class="line">        &#125;</div><div class="line">        rc = sqlite3OsWrite(master, zFile, strlen(zFile)+1);</div><div class="line">        if( rc!=SQLITE_OK )&#123;</div><div class="line">          sqlite3OsClose(&amp;master);</div><div class="line">          sqlite3OsDelete(zMaster);</div><div class="line">          sqliteFree(zMaster);</div><div class="line">          return rc;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    /* Sync the master journal file. Before doing this, open the directory</div><div class="line">    ** the master journal file is store in so that it gets synced too.</div><div class="line">    */</div><div class="line">    zMainFile = sqlite3BtreeGetDirname(db-&gt;aDb[0].pBt);</div><div class="line">    rc = sqlite3OsOpenDirectory(master, zMainFile);</div><div class="line">    if( rc!=SQLITE_OK ||</div><div class="line">          (needSync &amp;&amp; (rc=sqlite3OsSync(master,0))!=SQLITE_OK) )&#123;</div><div class="line">      sqlite3OsClose(&amp;master);</div><div class="line">      sqlite3OsDelete(zMaster);</div><div class="line">      sqliteFree(zMaster);</div><div class="line">      return rc;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /* Sync all the db files involved in the transaction. The same call</div><div class="line">    ** sets the master journal pointer in each individual journal. If</div><div class="line">    ** an error occurs here, do not delete the master journal file.</div><div class="line">    **</div><div class="line">    ** If the error occurs during the first call to sqlite3BtreeSync(),</div><div class="line">    ** then there is a chance that the master journal file will be</div><div class="line">    ** orphaned. But we cannot delete it, in case the master journal</div><div class="line">    ** file name was written into the journal file before the failure</div><div class="line">    ** occured.</div><div class="line">    */</div><div class="line">    for(i=0; i&lt;db-&gt;nDb; i++)&#123; </div><div class="line">      Btree *pBt = db-&gt;aDb[i].pBt;</div><div class="line">      if( pBt &amp;&amp; sqlite3BtreeIsInTrans(pBt) )&#123;</div><div class="line">        rc = sqlite3BtreeSync(pBt, zMaster);</div><div class="line">        if( rc!=SQLITE_OK )&#123;</div><div class="line">          sqlite3OsClose(&amp;master);</div><div class="line">          sqliteFree(zMaster);</div><div class="line">          return rc;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    sqlite3OsClose(&amp;master);</div><div class="line"></div><div class="line">    /* Delete the master journal file. This commits the transaction. After</div><div class="line">    ** doing this the directory is synced again before any individual</div><div class="line">    ** transaction files are deleted.</div><div class="line">    */</div><div class="line">    rc = sqlite3OsDelete(zMaster);</div><div class="line">    assert( rc==SQLITE_OK );</div><div class="line">    sqliteFree(zMaster);</div><div class="line">    zMaster = 0;</div><div class="line">    rc = sqlite3OsSyncDirectory(zMainFile);</div><div class="line">    if( rc!=SQLITE_OK )&#123;</div><div class="line">      /* This is not good. The master journal file has been deleted, but</div><div class="line">      ** the directory sync failed. There is no completely safe course of</div><div class="line">      ** action from here. The individual journals contain the name of the</div><div class="line">      ** master journal file, but there is no way of knowing if that</div><div class="line">      ** master journal exists now or if it will exist after the operating</div><div class="line">      ** system crash that may follow the fsync() failure.</div><div class="line">      */</div><div class="line">      return rc;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /* All files and directories have already been synced, so the following</div><div class="line">    ** calls to sqlite3BtreeCommit() are only closing files and deleting</div><div class="line">    ** journals. If something goes wrong while this is happening we don't</div><div class="line">    ** really care. The integrity of the transaction is already guaranteed,</div><div class="line">    ** but some stray 'cold' journals may be lying around. Returning an</div><div class="line">    ** error code won't help matters.</div><div class="line">    */</div><div class="line">    for(i=0; i&lt;db-&gt;nDb; i++)&#123; </div><div class="line">      Btree *pBt = db-&gt;aDb[i].pBt;</div><div class="line">      if( pBt )&#123;</div><div class="line">        sqlite3BtreeCommit(pBt);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">#endif</div><div class="line"></div><div class="line">  return rc;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="SQLite-Version3-3-6源代码文件结构"><a href="#SQLite-Version3-3-6源代码文件结构" class="headerlink" title="SQLite Version3.3.6源代码文件结构"></a>SQLite Version3.3.6源代码文件结构</h1><h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><ul>
<li><a href="http://pan.baidu.com/s/1gd4Sk51" target="_blank" rel="external">The Definitive Guide to SQLite</a> 密码：stno</li>
<li><a href="http://www.cnblogs.com/hustcat/archive/2009/02/13/1390340.html" target="_blank" rel="external"> SQLite入门与分析</a></li>
<li><a href="http://www.sqlite.org/atomiccommit.html" target="_blank" rel="external">sqlite官网</a></li>
</ul>

      

      
        <div class="page-reward">
          <a href="javascript:;" class="page-reward-btn tooltip-top">
            <div class="tooltip tooltip-east">
            <span class="tooltip-item">
              赏
            </span>
            <span class="tooltip-content">
              <span class="tooltip-text">
                <span class="tooltip-inner">
                  <p class="reward-p"><i class="icon icon-quo-left"></i>谢谢你请我吃糖果<i class="icon icon-quo-right"></i></p>
                  <div class="reward-box">
                    
                    
                  </div>
                </span>
              </span>
            </span>
          </div>
          </a>
        </div>
      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color2">sqlite</a>
        		</li>
      		
		</ul>
	</div>

      
	<div class="article-category tagcloud">
		<i class="icon-book icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="/categories/android/" class="article-tag-list-link color3">android</a>
        		</li>
      		
		</ul>
	</div>


      

      
        
<div class="share-btn share-icons tooltip-left">
  <div class="tooltip tooltip-east">
    <span class="tooltip-item">
      <a href="javascript:;" class="share-sns share-outer">
        <i class="icon icon-share"></i>
      </a>
    </span>
    <span class="tooltip-content">
      <div class="share-wrap">
        <div class="share-icons">
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="icon icon-weibo"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="icon icon-weixin"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="icon icon-qq"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="icon icon-douban"></i>
          </a>
          <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a>
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="icon icon-facebook"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="icon icon-twitter"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="icon icon-google"></i>
          </a>
        </div>
      </div>
    </span>
  </div>
</div>

<div class="page-modal wx-share js-wx-box">
    <a class="close js-modal-close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="http://s.jiathis.com/qrcode.php?url=http://yoursite.com/2015/11/18/android_sqlite/" alt="微信分享二维码">
    </div>
</div>

<div class="mask js-mask"></div>
      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

  
<nav id="article-nav">
  
    <a href="/2015/11/19/study_speech_dabing/" id="article-nav-newer" class="article-nav-link-wrap">
      <i class="icon-circle-left"></i>
      <div class="article-nav-title">
        
          大兵在一席的演讲
        
      </div>
    </a>
  
  
    <a href="/2015/11/18/vc_svn_guidance/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">svn常用命令行及常见问题</div>
      <i class="icon-circle-right"></i>
    </a>
  
</nav>


<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
        <div class="toc-container tooltip-left">
            <i class="icon-font icon-category"></i>
            <div class="tooltip tooltip-east">
                <span class="tooltip-item">
                </span>
                <span class="tooltip-content">
                    <div class="toc-article">
                    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#简介"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、SQLite介绍"><span class="toc-number">1.1.</span> <span class="toc-text">1、SQLite介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、架构-architecture"><span class="toc-number">1.2.</span> <span class="toc-text">2、架构(architecture)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1、接口-Interface"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1、接口(Interface)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2、编译器-Compiler"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2、编译器(Compiler)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3、虚拟机-Virtual-Machine"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.3、虚拟机(Virtual Machine)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4、后端-Back-End"><span class="toc-number">1.2.4.</span> <span class="toc-text">2.4、后端(Back-End)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3、SQLite的特点-SQLite’s-Features-and-Philosophy"><span class="toc-number">1.3.</span> <span class="toc-text">3、SQLite的特点(SQLite’s Features and Philosophy)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#设计与概念"><span class="toc-number">2.</span> <span class="toc-text">设计与概念</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、-API"><span class="toc-number">2.1.</span> <span class="toc-text">1、 API</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1、SQLite-Version-3的一些新特点："><span class="toc-number">2.1.1.</span> <span class="toc-text">1.1、SQLite Version 3的一些新特点：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2、主要的数据结构-The-Principal-Data-Structures"><span class="toc-number">2.1.2.</span> <span class="toc-text">1.2、主要的数据结构(The Principal Data Structures)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3、Connections和Statements"><span class="toc-number">2.1.3.</span> <span class="toc-text">1.3、Connections和Statements</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4、B-tree和pager"><span class="toc-number">2.1.4.</span> <span class="toc-text">1.4、B-tree和pager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5、核心API"><span class="toc-number">2.1.5.</span> <span class="toc-text">1.5、核心API</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、事务-Transaction"><span class="toc-number">2.2.</span> <span class="toc-text">2、事务(Transaction)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1、事务的周期-Transaction-Lifecycles"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.1、事务的周期(Transaction Lifecycles)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2、锁的状态-Lock-States"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2、锁的状态(Lock States)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3、读事务-Read-Transactions"><span class="toc-number">2.2.3.</span> <span class="toc-text">2.3、读事务(Read Transactions)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4、写事务（Write-Transactions）"><span class="toc-number">2.2.4.</span> <span class="toc-text">2.4、写事务（Write Transactions）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#内核解析"><span class="toc-number">3.</span> <span class="toc-text">内核解析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、虚拟机（Virtual-Machine）"><span class="toc-number">3.1.</span> <span class="toc-text">1、虚拟机（Virtual Machine）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1、栈-Stack"><span class="toc-number">3.1.1.</span> <span class="toc-text">1.1、栈(Stack)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2、程序体-Program-Body"><span class="toc-number">3.1.2.</span> <span class="toc-text">1.2、程序体(Program Body)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3、程序开始与停止"><span class="toc-number">3.2.</span> <span class="toc-text">1.3、程序开始与停止</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4指令的类型-Instruction-Types"><span class="toc-number">3.3.</span> <span class="toc-text">1.4指令的类型(Instruction Types)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-5、程序的执行-Program-execution"><span class="toc-number">3.4.</span> <span class="toc-text">1.5、程序的执行(Program execution)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、B-tree和Pager"><span class="toc-number">3.5.</span> <span class="toc-text">2、B-tree和Pager</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1、数据库文件格式（Database-File-Format）"><span class="toc-number">3.5.1.</span> <span class="toc-text">2.1、数据库文件格式（Database File Format）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1、页面重用及回收-Page-Reuse-and-Vacuum"><span class="toc-number">3.5.2.</span> <span class="toc-text">2.1、页面重用及回收(Page Reuse and Vacuum )</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2、B-Tree记录"><span class="toc-number">3.5.3.</span> <span class="toc-text">2.2、B-Tree记录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3、记录和域（Records-and-Fields）"><span class="toc-number">3.5.4.</span> <span class="toc-text">2.3、记录和域（Records and Fields）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4、层次数据组织-Hierarchical-Data-Organization"><span class="toc-number">3.5.5.</span> <span class="toc-text">2.4、层次数据组织(Hierarchical Data Organization)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5、B-Tree-API"><span class="toc-number">3.5.6.</span> <span class="toc-text">2.5、B-Tree API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6、实例分析"><span class="toc-number">3.5.7.</span> <span class="toc-text">2.6、实例分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3、编译器（Compiler）"><span class="toc-number">3.6.</span> <span class="toc-text">3、编译器（Compiler）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1、分词器-Tokenizer"><span class="toc-number">3.6.1.</span> <span class="toc-text">3.1、分词器(Tokenizer)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2、分析器-Parser"><span class="toc-number">3.6.2.</span> <span class="toc-text">3.2、分析器(Parser)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3、代码生成器（Code-Generator）"><span class="toc-number">3.6.3.</span> <span class="toc-text">3.3、代码生成器（Code Generator）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4、查询优化"><span class="toc-number">3.6.4.</span> <span class="toc-text">3.4、查询优化</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Page-Cache之事务处理"><span class="toc-number">4.</span> <span class="toc-text">Page Cache之事务处理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SQLite-Version3-3-6源代码文件结构"><span class="toc-number">5.</span> <span class="toc-text">SQLite Version3.3.6源代码文件结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#参考文档"><span class="toc-number">5.0.1.</span> <span class="toc-text">参考文档</span></a></li></ol></li></ol></li></ol>
                    </div>
                </span>
            </div>
        </div>
        
    </div>
</aside>



  
  
  

  

  


          </div>
        </div>
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 ARESXIONG
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		mathjax: false,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		toc_hide_index: true,
		root: "/",
		innerArchive: true,
		showTags: false
	}
</script>

<script>!function(t){function n(e){if(r[e])return r[e].exports;var i=r[e]={exports:{},id:e,loaded:!1};return t[e].call(i.exports,i,i.exports,n),i.loaded=!0,i.exports}var r={};n.m=t,n.c=r,n.p="./",n(0)}([function(t,n,r){r(195),t.exports=r(191)},function(t,n,r){var e=r(3),i=r(52),o=r(27),u=r(28),c=r(53),f="prototype",a=function(t,n,r){var s,l,h,v,p=t&a.F,d=t&a.G,y=t&a.S,g=t&a.P,b=t&a.B,m=d?e:y?e[n]||(e[n]={}):(e[n]||{})[f],x=d?i:i[n]||(i[n]={}),w=x[f]||(x[f]={});d&&(r=n);for(s in r)l=!p&&m&&void 0!==m[s],h=(l?m:r)[s],v=b&&l?c(h,e):g&&"function"==typeof h?c(Function.call,h):h,m&&u(m,s,h,t&a.U),x[s]!=h&&o(x,s,v),g&&w[s]!=h&&(w[s]=h)};e.core=i,a.F=1,a.G=2,a.S=4,a.P=8,a.B=16,a.W=32,a.U=64,a.R=128,t.exports=a},function(t,n,r){var e=r(6);t.exports=function(t){if(!e(t))throw TypeError(t+" is not an object!");return t}},function(t,n){var r=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n){var r=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n,r){var e=r(126)("wks"),i=r(76),o=r(3).Symbol,u="function"==typeof o;(t.exports=function(t){return e[t]||(e[t]=u&&o[t]||(u?o:i)("Symbol."+t))}).store=e},function(t,n){var r={}.hasOwnProperty;t.exports=function(t,n){return r.call(t,n)}},function(t,n,r){var e=r(94),i=r(33);t.exports=function(t){return e(i(t))}},function(t,n,r){t.exports=!r(4)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(2),i=r(167),o=r(50),u=Object.defineProperty;n.f=r(10)?Object.defineProperty:function(t,n,r){if(e(t),n=o(n,!0),e(r),i)try{return u(t,n,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(t[n]=r.value),t}},function(t,n,r){t.exports=!r(18)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(14),i=r(22);t.exports=r(12)?function(t,n,r){return e.f(t,n,i(1,r))}:function(t,n,r){return t[n]=r,t}},function(t,n,r){var e=r(20),i=r(58),o=r(42),u=Object.defineProperty;n.f=r(12)?Object.defineProperty:function(t,n,r){if(e(t),n=o(n,!0),e(r),i)try{return u(t,n,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(t[n]=r.value),t}},function(t,n,r){var e=r(40)("wks"),i=r(23),o=r(5).Symbol,u="function"==typeof o;(t.exports=function(t){return e[t]||(e[t]=u&&o[t]||(u?o:i)("Symbol."+t))}).store=e},function(t,n,r){var e=r(67),i=Math.min;t.exports=function(t){return t>0?i(e(t),9007199254740991):0}},function(t,n,r){var e=r(46);t.exports=function(t){return Object(e(t))}},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n,r){var e=r(63),i=r(34);t.exports=Object.keys||function(t){return e(t,i)}},function(t,n,r){var e=r(21);t.exports=function(t){if(!e(t))throw TypeError(t+" is not an object!");return t}},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var r=0,e=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++r+e).toString(36))}},function(t,n){var r={}.hasOwnProperty;t.exports=function(t,n){return r.call(t,n)}},function(t,n){var r=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=r)},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n,r){var e=r(11),i=r(66);t.exports=r(10)?function(t,n,r){return e.f(t,n,i(1,r))}:function(t,n,r){return t[n]=r,t}},function(t,n,r){var e=r(3),i=r(27),o=r(24),u=r(76)("src"),c="toString",f=Function[c],a=(""+f).split(c);r(52).inspectSource=function(t){return f.call(t)},(t.exports=function(t,n,r,c){var f="function"==typeof r;f&&(o(r,"name")||i(r,"name",n)),t[n]!==r&&(f&&(o(r,u)||i(r,u,t[n]?""+t[n]:a.join(String(n)))),t===e?t[n]=r:c?t[n]?t[n]=r:i(t,n,r):(delete t[n],i(t,n,r)))})(Function.prototype,c,function(){return"function"==typeof this&&this[u]||f.call(this)})},function(t,n,r){var e=r(1),i=r(4),o=r(46),u=function(t,n,r,e){var i=String(o(t)),u="<"+n;return""!==r&&(u+=" "+r+'="'+String(e).replace(/"/g,"&quot;")+'"'),u+">"+i+"</"+n+">"};t.exports=function(t,n){var r={};r[t]=n(u),e(e.P+e.F*i(function(){var n=""[t]('"');return n!==n.toLowerCase()||n.split('"').length>3}),"String",r)}},function(t,n,r){var e=r(115),i=r(46);t.exports=function(t){return e(i(t))}},function(t,n,r){var e=r(116),i=r(66),o=r(30),u=r(50),c=r(24),f=r(167),a=Object.getOwnPropertyDescriptor;n.f=r(10)?a:function(t,n){if(t=o(t),n=u(n,!0),f)try{return a(t,n)}catch(t){}if(c(t,n))return i(!e.f.call(t,n),t[n])}},function(t,n,r){var e=r(24),i=r(17),o=r(145)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=i(t),e(t,o)?t[o]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n){t.exports={}},function(t,n){t.exports=!0},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,r){var e=r(14).f,i=r(8),o=r(15)("toStringTag");t.exports=function(t,n,r){t&&!i(t=r?t:t.prototype,o)&&e(t,o,{configurable:!0,value:n})}},function(t,n,r){var e=r(40)("keys"),i=r(23);t.exports=function(t){return e[t]||(e[t]=i(t))}},function(t,n,r){var e=r(5),i="__core-js_shared__",o=e[i]||(e[i]={});t.exports=function(t){return o[t]||(o[t]={})}},function(t,n){var r=Math.ceil,e=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?e:r)(t)}},function(t,n,r){var e=r(21);t.exports=function(t,n){if(!e(t))return t;var r,i;if(n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;if("function"==typeof(r=t.valueOf)&&!e(i=r.call(t)))return i;if(!n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;throw TypeError("Can't convert object to primitive value")}},function(t,n,r){var e=r(5),i=r(25),o=r(36),u=r(44),c=r(14).f;t.exports=function(t){var n=i.Symbol||(i.Symbol=o?{}:e.Symbol||{});"_"==t.charAt(0)||t in n||c(n,t,{value:u.f(t)})}},function(t,n,r){n.f=r(15)},function(t,n){var r={}.toString;t.exports=function(t){return r.call(t).slice(8,-1)}},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n,r){var e=r(4);t.exports=function(t,n){return!!t&&e(function(){n?t.call(null,function(){},1):t.call(null)})}},function(t,n,r){var e=r(53),i=r(115),o=r(17),u=r(16),c=r(203);t.exports=function(t,n){var r=1==t,f=2==t,a=3==t,s=4==t,l=6==t,h=5==t||l,v=n||c;return function(n,c,p){for(var d,y,g=o(n),b=i(g),m=e(c,p,3),x=u(b.length),w=0,S=r?v(n,x):f?v(n,0):void 0;x>w;w++)if((h||w in b)&&(d=b[w],y=m(d,w,g),t))if(r)S[w]=y;else if(y)switch(t){case 3:return!0;case 5:return d;case 6:return w;case 2:S.push(d)}else if(s)return!1;return l?-1:a||s?s:S}}},function(t,n,r){var e=r(1),i=r(52),o=r(4);t.exports=function(t,n){var r=(i.Object||{})[t]||Object[t],u={};u[t]=n(r),e(e.S+e.F*o(function(){r(1)}),"Object",u)}},function(t,n,r){var e=r(6);t.exports=function(t,n){if(!e(t))return t;var r,i;if(n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;if("function"==typeof(r=t.valueOf)&&!e(i=r.call(t)))return i;if(!n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;throw TypeError("Can't convert object to primitive value")}},function(t,n,r){var e=r(5),i=r(25),o=r(91),u=r(13),c="prototype",f=function(t,n,r){var a,s,l,h=t&f.F,v=t&f.G,p=t&f.S,d=t&f.P,y=t&f.B,g=t&f.W,b=v?i:i[n]||(i[n]={}),m=b[c],x=v?e:p?e[n]:(e[n]||{})[c];v&&(r=n);for(a in r)(s=!h&&x&&void 0!==x[a])&&a in b||(l=s?x[a]:r[a],b[a]=v&&"function"!=typeof x[a]?r[a]:y&&s?o(l,e):g&&x[a]==l?function(t){var n=function(n,r,e){if(this instanceof t){switch(arguments.length){case 0:return new t;case 1:return new t(n);case 2:return new t(n,r)}return new t(n,r,e)}return t.apply(this,arguments)};return n[c]=t[c],n}(l):d&&"function"==typeof l?o(Function.call,l):l,d&&((b.virtual||(b.virtual={}))[a]=l,t&f.R&&m&&!m[a]&&u(m,a,l)))};f.F=1,f.G=2,f.S=4,f.P=8,f.B=16,f.W=32,f.U=64,f.R=128,t.exports=f},function(t,n){var r=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=r)},function(t,n,r){var e=r(26);t.exports=function(t,n,r){if(e(t),void 0===n)return t;switch(r){case 1:return function(r){return t.call(n,r)};case 2:return function(r,e){return t.call(n,r,e)};case 3:return function(r,e,i){return t.call(n,r,e,i)}}return function(){return t.apply(n,arguments)}}},function(t,n,r){var e=r(183),i=r(1),o=r(126)("metadata"),u=o.store||(o.store=new(r(186))),c=function(t,n,r){var i=u.get(t);if(!i){if(!r)return;u.set(t,i=new e)}var o=i.get(n);if(!o){if(!r)return;i.set(n,o=new e)}return o},f=function(t,n,r){var e=c(n,r,!1);return void 0!==e&&e.has(t)},a=function(t,n,r){var e=c(n,r,!1);return void 0===e?void 0:e.get(t)},s=function(t,n,r,e){c(r,e,!0).set(t,n)},l=function(t,n){var r=c(t,n,!1),e=[];return r&&r.forEach(function(t,n){e.push(n)}),e},h=function(t){return void 0===t||"symbol"==typeof t?t:String(t)},v=function(t){i(i.S,"Reflect",t)};t.exports={store:u,map:c,has:f,get:a,set:s,keys:l,key:h,exp:v}},function(t,n,r){"use strict";if(r(10)){var e=r(69),i=r(3),o=r(4),u=r(1),c=r(127),f=r(152),a=r(53),s=r(68),l=r(66),h=r(27),v=r(73),p=r(67),d=r(16),y=r(75),g=r(50),b=r(24),m=r(180),x=r(114),w=r(6),S=r(17),_=r(137),O=r(70),E=r(32),P=r(71).f,j=r(154),F=r(76),M=r(7),A=r(48),N=r(117),T=r(146),I=r(155),k=r(80),L=r(123),R=r(74),C=r(130),D=r(160),U=r(11),W=r(31),G=U.f,B=W.f,V=i.RangeError,z=i.TypeError,q=i.Uint8Array,K="ArrayBuffer",J="Shared"+K,Y="BYTES_PER_ELEMENT",H="prototype",$=Array[H],X=f.ArrayBuffer,Q=f.DataView,Z=A(0),tt=A(2),nt=A(3),rt=A(4),et=A(5),it=A(6),ot=N(!0),ut=N(!1),ct=I.values,ft=I.keys,at=I.entries,st=$.lastIndexOf,lt=$.reduce,ht=$.reduceRight,vt=$.join,pt=$.sort,dt=$.slice,yt=$.toString,gt=$.toLocaleString,bt=M("iterator"),mt=M("toStringTag"),xt=F("typed_constructor"),wt=F("def_constructor"),St=c.CONSTR,_t=c.TYPED,Ot=c.VIEW,Et="Wrong length!",Pt=A(1,function(t,n){return Tt(T(t,t[wt]),n)}),jt=o(function(){return 1===new q(new Uint16Array([1]).buffer)[0]}),Ft=!!q&&!!q[H].set&&o(function(){new q(1).set({})}),Mt=function(t,n){if(void 0===t)throw z(Et);var r=+t,e=d(t);if(n&&!m(r,e))throw V(Et);return e},At=function(t,n){var r=p(t);if(r<0||r%n)throw V("Wrong offset!");return r},Nt=function(t){if(w(t)&&_t in t)return t;throw z(t+" is not a typed array!")},Tt=function(t,n){if(!(w(t)&&xt in t))throw z("It is not a typed array constructor!");return new t(n)},It=function(t,n){return kt(T(t,t[wt]),n)},kt=function(t,n){for(var r=0,e=n.length,i=Tt(t,e);e>r;)i[r]=n[r++];return i},Lt=function(t,n,r){G(t,n,{get:function(){return this._d[r]}})},Rt=function(t){var n,r,e,i,o,u,c=S(t),f=arguments.length,s=f>1?arguments[1]:void 0,l=void 0!==s,h=j(c);if(void 0!=h&&!_(h)){for(u=h.call(c),e=[],n=0;!(o=u.next()).done;n++)e.push(o.value);c=e}for(l&&f>2&&(s=a(s,arguments[2],2)),n=0,r=d(c.length),i=Tt(this,r);r>n;n++)i[n]=l?s(c[n],n):c[n];return i},Ct=function(){for(var t=0,n=arguments.length,r=Tt(this,n);n>t;)r[t]=arguments[t++];return r},Dt=!!q&&o(function(){gt.call(new q(1))}),Ut=function(){return gt.apply(Dt?dt.call(Nt(this)):Nt(this),arguments)},Wt={copyWithin:function(t,n){return D.call(Nt(this),t,n,arguments.length>2?arguments[2]:void 0)},every:function(t){return rt(Nt(this),t,arguments.length>1?arguments[1]:void 0)},fill:function(t){return C.apply(Nt(this),arguments)},filter:function(t){return It(this,tt(Nt(this),t,arguments.length>1?arguments[1]:void 0))},find:function(t){return et(Nt(this),t,arguments.length>1?arguments[1]:void 0)},findIndex:function(t){return it(Nt(this),t,arguments.length>1?arguments[1]:void 0)},forEach:function(t){Z(Nt(this),t,arguments.length>1?arguments[1]:void 0)},indexOf:function(t){return ut(Nt(this),t,arguments.length>1?arguments[1]:void 0)},includes:function(t){return ot(Nt(this),t,arguments.length>1?arguments[1]:void 0)},join:function(t){return vt.apply(Nt(this),arguments)},lastIndexOf:function(t){return st.apply(Nt(this),arguments)},map:function(t){return Pt(Nt(this),t,arguments.length>1?arguments[1]:void 0)},reduce:function(t){return lt.apply(Nt(this),arguments)},reduceRight:function(t){return ht.apply(Nt(this),arguments)},reverse:function(){for(var t,n=this,r=Nt(n).length,e=Math.floor(r/2),i=0;i<e;)t=n[i],n[i++]=n[--r],n[r]=t;return n},some:function(t){return nt(Nt(this),t,arguments.length>1?arguments[1]:void 0)},sort:function(t){return pt.call(Nt(this),t)},subarray:function(t,n){var r=Nt(this),e=r.length,i=y(t,e);return new(T(r,r[wt]))(r.buffer,r.byteOffset+i*r.BYTES_PER_ELEMENT,d((void 0===n?e:y(n,e))-i))}},Gt=function(t,n){return It(this,dt.call(Nt(this),t,n))},Bt=function(t){Nt(this);var n=At(arguments[1],1),r=this.length,e=S(t),i=d(e.length),o=0;if(i+n>r)throw V(Et);for(;o<i;)this[n+o]=e[o++]},Vt={entries:function(){return at.call(Nt(this))},keys:function(){return ft.call(Nt(this))},values:function(){return ct.call(Nt(this))}},zt=function(t,n){return w(t)&&t[_t]&&"symbol"!=typeof n&&n in t&&String(+n)==String(n)},qt=function(t,n){return zt(t,n=g(n,!0))?l(2,t[n]):B(t,n)},Kt=function(t,n,r){return!(zt(t,n=g(n,!0))&&w(r)&&b(r,"value"))||b(r,"get")||b(r,"set")||r.configurable||b(r,"writable")&&!r.writable||b(r,"enumerable")&&!r.enumerable?G(t,n,r):(t[n]=r.value,t)};St||(W.f=qt,U.f=Kt),u(u.S+u.F*!St,"Object",{getOwnPropertyDescriptor:qt,defineProperty:Kt}),o(function(){yt.call({})})&&(yt=gt=function(){return vt.call(this)});var Jt=v({},Wt);v(Jt,Vt),h(Jt,bt,Vt.values),v(Jt,{slice:Gt,set:Bt,constructor:function(){},toString:yt,toLocaleString:Ut}),Lt(Jt,"buffer","b"),Lt(Jt,"byteOffset","o"),Lt(Jt,"byteLength","l"),Lt(Jt,"length","e"),G(Jt,mt,{get:function(){return this[_t]}}),t.exports=function(t,n,r,f){f=!!f;var a=t+(f?"Clamped":"")+"Array",l="Uint8Array"!=a,v="get"+t,p="set"+t,y=i[a],g=y||{},b=y&&E(y),m=!y||!c.ABV,S={},_=y&&y[H],j=function(t,r){var e=t._d;return e.v[v](r*n+e.o,jt)},F=function(t,r,e){var i=t._d;f&&(e=(e=Math.round(e))<0?0:e>255?255:255&e),i.v[p](r*n+i.o,e,jt)},M=function(t,n){G(t,n,{get:function(){return j(this,n)},set:function(t){return F(this,n,t)},enumerable:!0})};m?(y=r(function(t,r,e,i){s(t,y,a,"_d");var o,u,c,f,l=0,v=0;if(w(r)){if(!(r instanceof X||(f=x(r))==K||f==J))return _t in r?kt(y,r):Rt.call(y,r);o=r,v=At(e,n);var p=r.byteLength;if(void 0===i){if(p%n)throw V(Et);if((u=p-v)<0)throw V(Et)}else if((u=d(i)*n)+v>p)throw V(Et);c=u/n}else c=Mt(r,!0),u=c*n,o=new X(u);for(h(t,"_d",{b:o,o:v,l:u,e:c,v:new Q(o)});l<c;)M(t,l++)}),_=y[H]=O(Jt),h(_,"constructor",y)):L(function(t){new y(null),new y(t)},!0)||(y=r(function(t,r,e,i){s(t,y,a);var o;return w(r)?r instanceof X||(o=x(r))==K||o==J?void 0!==i?new g(r,At(e,n),i):void 0!==e?new g(r,At(e,n)):new g(r):_t in r?kt(y,r):Rt.call(y,r):new g(Mt(r,l))}),Z(b!==Function.prototype?P(g).concat(P(b)):P(g),function(t){t in y||h(y,t,g[t])}),y[H]=_,e||(_.constructor=y));var A=_[bt],N=!!A&&("values"==A.name||void 0==A.name),T=Vt.values;h(y,xt,!0),h(_,_t,a),h(_,Ot,!0),h(_,wt,y),(f?new y(1)[mt]==a:mt in _)||G(_,mt,{get:function(){return a}}),S[a]=y,u(u.G+u.W+u.F*(y!=g),S),u(u.S,a,{BYTES_PER_ELEMENT:n,from:Rt,of:Ct}),Y in _||h(_,Y,n),u(u.P,a,Wt),R(a),u(u.P+u.F*Ft,a,{set:Bt}),u(u.P+u.F*!N,a,Vt),u(u.P+u.F*(_.toString!=yt),a,{toString:yt}),u(u.P+u.F*o(function(){new y(1).slice()}),a,{slice:Gt}),u(u.P+u.F*(o(function(){return[1,2].toLocaleString()!=new y([1,2]).toLocaleString()})||!o(function(){_.toLocaleString.call([1,2])})),a,{toLocaleString:Ut}),k[a]=N?A:T,e||N||h(_,bt,T)}}else t.exports=function(){}},function(t,n){var r={}.toString;t.exports=function(t){return r.call(t).slice(8,-1)}},function(t,n,r){var e=r(21),i=r(5).document,o=e(i)&&e(i.createElement);t.exports=function(t){return o?i.createElement(t):{}}},function(t,n,r){t.exports=!r(12)&&!r(18)(function(){return 7!=Object.defineProperty(r(57)("div"),"a",{get:function(){return 7}}).a})},function(t,n,r){"use strict";var e=r(36),i=r(51),o=r(64),u=r(13),c=r(8),f=r(35),a=r(96),s=r(38),l=r(103),h=r(15)("iterator"),v=!([].keys&&"next"in[].keys()),p="keys",d="values",y=function(){return this};t.exports=function(t,n,r,g,b,m,x){a(r,n,g);var w,S,_,O=function(t){if(!v&&t in F)return F[t];switch(t){case p:case d:return function(){return new r(this,t)}}return function(){return new r(this,t)}},E=n+" Iterator",P=b==d,j=!1,F=t.prototype,M=F[h]||F["@@iterator"]||b&&F[b],A=M||O(b),N=b?P?O("entries"):A:void 0,T="Array"==n?F.entries||M:M;if(T&&(_=l(T.call(new t)))!==Object.prototype&&(s(_,E,!0),e||c(_,h)||u(_,h,y)),P&&M&&M.name!==d&&(j=!0,A=function(){return M.call(this)}),e&&!x||!v&&!j&&F[h]||u(F,h,A),f[n]=A,f[E]=y,b)if(w={values:P?A:O(d),keys:m?A:O(p),entries:N},x)for(S in w)S in F||o(F,S,w[S]);else i(i.P+i.F*(v||j),n,w);return w}},function(t,n,r){var e=r(20),i=r(100),o=r(34),u=r(39)("IE_PROTO"),c=function(){},f="prototype",a=function(){var t,n=r(57)("iframe"),e=o.length;for(n.style.display="none",r(93).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write("<script>document.F=Object<\/script>"),t.close(),a=t.F;e--;)delete a[f][o[e]];return a()};t.exports=Object.create||function(t,n){var r;return null!==t?(c[f]=e(t),r=new c,c[f]=null,r[u]=t):r=a(),void 0===n?r:i(r,n)}},function(t,n,r){var e=r(63),i=r(34).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return e(t,i)}},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,r){var e=r(8),i=r(9),o=r(90)(!1),u=r(39)("IE_PROTO");t.exports=function(t,n){var r,c=i(t),f=0,a=[];for(r in c)r!=u&&e(c,r)&&a.push(r);for(;n.length>f;)e(c,r=n[f++])&&(~o(a,r)||a.push(r));return a}},function(t,n,r){t.exports=r(13)},function(t,n,r){var e=r(76)("meta"),i=r(6),o=r(24),u=r(11).f,c=0,f=Object.isExtensible||function(){return!0},a=!r(4)(function(){return f(Object.preventExtensions({}))}),s=function(t){u(t,e,{value:{i:"O"+ ++c,w:{}}})},l=function(t,n){if(!i(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!o(t,e)){if(!f(t))return"F";if(!n)return"E";s(t)}return t[e].i},h=function(t,n){if(!o(t,e)){if(!f(t))return!0;if(!n)return!1;s(t)}return t[e].w},v=function(t){return a&&p.NEED&&f(t)&&!o(t,e)&&s(t),t},p=t.exports={KEY:e,NEED:!1,fastKey:l,getWeak:h,onFreeze:v}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var r=Math.ceil,e=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?e:r)(t)}},function(t,n){t.exports=function(t,n,r,e){if(!(t instanceof n)||void 0!==e&&e in t)throw TypeError(r+": incorrect invocation!");return t}},function(t,n){t.exports=!1},function(t,n,r){var e=r(2),i=r(173),o=r(133),u=r(145)("IE_PROTO"),c=function(){},f="prototype",a=function(){var t,n=r(132)("iframe"),e=o.length;for(n.style.display="none",r(135).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write("<script>document.F=Object<\/script>"),t.close(),a=t.F;e--;)delete a[f][o[e]];return a()};t.exports=Object.create||function(t,n){var r;return null!==t?(c[f]=e(t),r=new c,c[f]=null,r[u]=t):r=a(),void 0===n?r:i(r,n)}},function(t,n,r){var e=r(175),i=r(133).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return e(t,i)}},function(t,n,r){var e=r(175),i=r(133);t.exports=Object.keys||function(t){return e(t,i)}},function(t,n,r){var e=r(28);t.exports=function(t,n,r){for(var i in n)e(t,i,n[i],r);return t}},function(t,n,r){"use strict";var e=r(3),i=r(11),o=r(10),u=r(7)("species");t.exports=function(t){var n=e[t];o&&n&&!n[u]&&i.f(n,u,{configurable:!0,get:function(){return this}})}},function(t,n,r){var e=r(67),i=Math.max,o=Math.min;t.exports=function(t,n){return t=e(t),t<0?i(t+n,0):o(t,n)}},function(t,n){var r=0,e=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++r+e).toString(36))}},function(t,n,r){var e=r(33);t.exports=function(t){return Object(e(t))}},function(t,n,r){var e=r(7)("unscopables"),i=Array.prototype;void 0==i[e]&&r(27)(i,e,{}),t.exports=function(t){i[e][t]=!0}},function(t,n,r){var e=r(53),i=r(169),o=r(137),u=r(2),c=r(16),f=r(154),a={},s={},n=t.exports=function(t,n,r,l,h){var v,p,d,y,g=h?function(){return t}:f(t),b=e(r,l,n?2:1),m=0;if("function"!=typeof g)throw TypeError(t+" is not iterable!");if(o(g)){for(v=c(t.length);v>m;m++)if((y=n?b(u(p=t[m])[0],p[1]):b(t[m]))===a||y===s)return y}else for(d=g.call(t);!(p=d.next()).done;)if((y=i(d,b,p.value,n))===a||y===s)return y};n.BREAK=a,n.RETURN=s},function(t,n){t.exports={}},function(t,n,r){var e=r(11).f,i=r(24),o=r(7)("toStringTag");t.exports=function(t,n,r){t&&!i(t=r?t:t.prototype,o)&&e(t,o,{configurable:!0,value:n})}},function(t,n,r){var e=r(1),i=r(46),o=r(4),u=r(150),c="["+u+"]",f="​",a=RegExp("^"+c+c+"*"),s=RegExp(c+c+"*$"),l=function(t,n,r){var i={},c=o(function(){return!!u[t]()||f[t]()!=f}),a=i[t]=c?n(h):u[t];r&&(i[r]=a),e(e.P+e.F*c,"String",i)},h=l.trim=function(t,n){return t=String(i(t)),1&n&&(t=t.replace(a,"")),2&n&&(t=t.replace(s,"")),t};t.exports=l},function(t,n,r){t.exports={default:r(86),__esModule:!0}},function(t,n,r){t.exports={default:r(87),__esModule:!0}},function(t,n,r){"use strict";function e(t){return t&&t.__esModule?t:{default:t}}n.__esModule=!0;var i=r(84),o=e(i),u=r(83),c=e(u),f="function"==typeof c.default&&"symbol"==typeof o.default?function(t){return typeof t}:function(t){return t&&"function"==typeof c.default&&t.constructor===c.default&&t!==c.default.prototype?"symbol":typeof t};n.default="function"==typeof c.default&&"symbol"===f(o.default)?function(t){return void 0===t?"undefined":f(t)}:function(t){return t&&"function"==typeof c.default&&t.constructor===c.default&&t!==c.default.prototype?"symbol":void 0===t?"undefined":f(t)}},function(t,n,r){r(110),r(108),r(111),r(112),t.exports=r(25).Symbol},function(t,n,r){r(109),r(113),t.exports=r(44).f("iterator")},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n){t.exports=function(){}},function(t,n,r){var e=r(9),i=r(106),o=r(105);t.exports=function(t){return function(n,r,u){var c,f=e(n),a=i(f.length),s=o(u,a);if(t&&r!=r){for(;a>s;)if((c=f[s++])!=c)return!0}else for(;a>s;s++)if((t||s in f)&&f[s]===r)return t||s||0;return!t&&-1}}},function(t,n,r){var e=r(88);t.exports=function(t,n,r){if(e(t),void 0===n)return t;switch(r){case 1:return function(r){return t.call(n,r)};case 2:return function(r,e){return t.call(n,r,e)};case 3:return function(r,e,i){return t.call(n,r,e,i)}}return function(){return t.apply(n,arguments)}}},function(t,n,r){var e=r(19),i=r(62),o=r(37);t.exports=function(t){var n=e(t),r=i.f;if(r)for(var u,c=r(t),f=o.f,a=0;c.length>a;)f.call(t,u=c[a++])&&n.push(u);return n}},function(t,n,r){t.exports=r(5).document&&document.documentElement},function(t,n,r){var e=r(56);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==e(t)?t.split(""):Object(t)}},function(t,n,r){var e=r(56);t.exports=Array.isArray||function(t){return"Array"==e(t)}},function(t,n,r){"use strict";var e=r(60),i=r(22),o=r(38),u={};r(13)(u,r(15)("iterator"),function(){return this}),t.exports=function(t,n,r){t.prototype=e(u,{next:i(1,r)}),o(t,n+" Iterator")}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n,r){var e=r(19),i=r(9);t.exports=function(t,n){for(var r,o=i(t),u=e(o),c=u.length,f=0;c>f;)if(o[r=u[f++]]===n)return r}},function(t,n,r){var e=r(23)("meta"),i=r(21),o=r(8),u=r(14).f,c=0,f=Object.isExtensible||function(){return!0},a=!r(18)(function(){return f(Object.preventExtensions({}))}),s=function(t){u(t,e,{value:{i:"O"+ ++c,w:{}}})},l=function(t,n){if(!i(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!o(t,e)){if(!f(t))return"F";if(!n)return"E";s(t)}return t[e].i},h=function(t,n){if(!o(t,e)){if(!f(t))return!0;if(!n)return!1;s(t)}return t[e].w},v=function(t){return a&&p.NEED&&f(t)&&!o(t,e)&&s(t),t},p=t.exports={KEY:e,NEED:!1,fastKey:l,getWeak:h,onFreeze:v}},function(t,n,r){var e=r(14),i=r(20),o=r(19);t.exports=r(12)?Object.defineProperties:function(t,n){i(t);for(var r,u=o(n),c=u.length,f=0;c>f;)e.f(t,r=u[f++],n[r]);return t}},function(t,n,r){var e=r(37),i=r(22),o=r(9),u=r(42),c=r(8),f=r(58),a=Object.getOwnPropertyDescriptor;n.f=r(12)?a:function(t,n){if(t=o(t),n=u(n,!0),f)try{return a(t,n)}catch(t){}if(c(t,n))return i(!e.f.call(t,n),t[n])}},function(t,n,r){var e=r(9),i=r(61).f,o={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],c=function(t){try{return i(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==o.call(t)?c(t):i(e(t))}},function(t,n,r){var e=r(8),i=r(77),o=r(39)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=i(t),e(t,o)?t[o]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n,r){var e=r(41),i=r(33);t.exports=function(t){return function(n,r){var o,u,c=String(i(n)),f=e(r),a=c.length;return f<0||f>=a?t?"":void 0:(o=c.charCodeAt(f),o<55296||o>56319||f+1===a||(u=c.charCodeAt(f+1))<56320||u>57343?t?c.charAt(f):o:t?c.slice(f,f+2):u-56320+(o-55296<<10)+65536)}}},function(t,n,r){var e=r(41),i=Math.max,o=Math.min;t.exports=function(t,n){return t=e(t),t<0?i(t+n,0):o(t,n)}},function(t,n,r){var e=r(41),i=Math.min;t.exports=function(t){return t>0?i(e(t),9007199254740991):0}},function(t,n,r){"use strict";var e=r(89),i=r(97),o=r(35),u=r(9);t.exports=r(59)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,r=this._i++;return!t||r>=t.length?(this._t=void 0,i(1)):"keys"==n?i(0,r):"values"==n?i(0,t[r]):i(0,[r,t[r]])},"values"),o.Arguments=o.Array,e("keys"),e("values"),e("entries")},function(t,n){},function(t,n,r){"use strict";var e=r(104)(!0);r(59)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,r=this._i;return r>=n.length?{value:void 0,done:!0}:(t=e(n,r),this._i+=t.length,{value:t,done:!1})})},function(t,n,r){"use strict";var e=r(5),i=r(8),o=r(12),u=r(51),c=r(64),f=r(99).KEY,a=r(18),s=r(40),l=r(38),h=r(23),v=r(15),p=r(44),d=r(43),y=r(98),g=r(92),b=r(95),m=r(20),x=r(9),w=r(42),S=r(22),_=r(60),O=r(102),E=r(101),P=r(14),j=r(19),F=E.f,M=P.f,A=O.f,N=e.Symbol,T=e.JSON,I=T&&T.stringify,k="prototype",L=v("_hidden"),R=v("toPrimitive"),C={}.propertyIsEnumerable,D=s("symbol-registry"),U=s("symbols"),W=s("op-symbols"),G=Object[k],B="function"==typeof N,V=e.QObject,z=!V||!V[k]||!V[k].findChild,q=o&&a(function(){return 7!=_(M({},"a",{get:function(){return M(this,"a",{value:7}).a}})).a})?function(t,n,r){var e=F(G,n);e&&delete G[n],M(t,n,r),e&&t!==G&&M(G,n,e)}:M,K=function(t){var n=U[t]=_(N[k]);return n._k=t,n},J=B&&"symbol"==typeof N.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof N},Y=function(t,n,r){return t===G&&Y(W,n,r),m(t),n=w(n,!0),m(r),i(U,n)?(r.enumerable?(i(t,L)&&t[L][n]&&(t[L][n]=!1),r=_(r,{enumerable:S(0,!1)})):(i(t,L)||M(t,L,S(1,{})),t[L][n]=!0),q(t,n,r)):M(t,n,r)},H=function(t,n){m(t);for(var r,e=g(n=x(n)),i=0,o=e.length;o>i;)Y(t,r=e[i++],n[r]);return t},$=function(t,n){return void 0===n?_(t):H(_(t),n)},X=function(t){var n=C.call(this,t=w(t,!0));return!(this===G&&i(U,t)&&!i(W,t))&&(!(n||!i(this,t)||!i(U,t)||i(this,L)&&this[L][t])||n)},Q=function(t,n){if(t=x(t),n=w(n,!0),t!==G||!i(U,n)||i(W,n)){var r=F(t,n);return!r||!i(U,n)||i(t,L)&&t[L][n]||(r.enumerable=!0),r}},Z=function(t){for(var n,r=A(x(t)),e=[],o=0;r.length>o;)i(U,n=r[o++])||n==L||n==f||e.push(n);return e},tt=function(t){for(var n,r=t===G,e=A(r?W:x(t)),o=[],u=0;e.length>u;)!i(U,n=e[u++])||r&&!i(G,n)||o.push(U[n]);return o};B||(N=function(){if(this instanceof N)throw TypeError("Symbol is not a constructor!");var t=h(arguments.length>0?arguments[0]:void 0),n=function(r){this===G&&n.call(W,r),i(this,L)&&i(this[L],t)&&(this[L][t]=!1),q(this,t,S(1,r))};return o&&z&&q(G,t,{configurable:!0,set:n}),K(t)},c(N[k],"toString",function(){return this._k}),E.f=Q,P.f=Y,r(61).f=O.f=Z,r(37).f=X,r(62).f=tt,o&&!r(36)&&c(G,"propertyIsEnumerable",X,!0),p.f=function(t){return K(v(t))}),u(u.G+u.W+u.F*!B,{Symbol:N});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),rt=0;nt.length>rt;)v(nt[rt++]);for(var nt=j(v.store),rt=0;nt.length>rt;)d(nt[rt++]);u(u.S+u.F*!B,"Symbol",{for:function(t){return i(D,t+="")?D[t]:D[t]=N(t)},keyFor:function(t){if(J(t))return y(D,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){z=!0},useSimple:function(){z=!1}}),u(u.S+u.F*!B,"Object",{create:$,defineProperty:Y,defineProperties:H,getOwnPropertyDescriptor:Q,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),T&&u(u.S+u.F*(!B||a(function(){var t=N();return"[null]"!=I([t])||"{}"!=I({a:t})||"{}"!=I(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!J(t)){for(var n,r,e=[t],i=1;arguments.length>i;)e.push(arguments[i++]);return n=e[1],"function"==typeof n&&(r=n),!r&&b(n)||(n=function(t,n){if(r&&(n=r.call(this,t,n)),!J(n))return n}),e[1]=n,I.apply(T,e)}}}),N[k][R]||r(13)(N[k],R,N[k].valueOf),l(N,"Symbol"),l(Math,"Math",!0),l(e.JSON,"JSON",!0)},function(t,n,r){r(43)("asyncIterator")},function(t,n,r){r(43)("observable")},function(t,n,r){r(107);for(var e=r(5),i=r(13),o=r(35),u=r(15)("toStringTag"),c=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],f=0;f<5;f++){var a=c[f],s=e[a],l=s&&s.prototype;l&&!l[u]&&i(l,u,a),o[a]=o.Array}},function(t,n,r){var e=r(45),i=r(7)("toStringTag"),o="Arguments"==e(function(){return arguments}()),u=function(t,n){try{return t[n]}catch(t){}};t.exports=function(t){var n,r,c;return void 0===t?"Undefined":null===t?"Null":"string"==typeof(r=u(n=Object(t),i))?r:o?e(n):"Object"==(c=e(n))&&"function"==typeof n.callee?"Arguments":c}},function(t,n,r){var e=r(45);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==e(t)?t.split(""):Object(t)}},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,r){var e=r(30),i=r(16),o=r(75);t.exports=function(t){return function(n,r,u){var c,f=e(n),a=i(f.length),s=o(u,a);if(t&&r!=r){for(;a>s;)if((c=f[s++])!=c)return!0}else for(;a>s;s++)if((t||s in f)&&f[s]===r)return t||s||0;return!t&&-1}}},function(t,n,r){"use strict";var e=r(3),i=r(1),o=r(28),u=r(73),c=r(65),f=r(79),a=r(68),s=r(6),l=r(4),h=r(123),v=r(81),p=r(136);t.exports=function(t,n,r,d,y,g){var b=e[t],m=b,x=y?"set":"add",w=m&&m.prototype,S={},_=function(t){var n=w[t];o(w,t,"delete"==t?function(t){return!(g&&!s(t))&&n.call(this,0===t?0:t)}:"has"==t?function(t){return!(g&&!s(t))&&n.call(this,0===t?0:t)}:"get"==t?function(t){return g&&!s(t)?void 0:n.call(this,0===t?0:t)}:"add"==t?function(t){return n.call(this,0===t?0:t),this}:function(t,r){return n.call(this,0===t?0:t,r),this})};if("function"==typeof m&&(g||w.forEach&&!l(function(){(new m).entries().next()}))){var O=new m,E=O[x](g?{}:-0,1)!=O,P=l(function(){O.has(1)}),j=h(function(t){new m(t)}),F=!g&&l(function(){for(var t=new m,n=5;n--;)t[x](n,n);return!t.has(-0)});j||(m=n(function(n,r){a(n,m,t);var e=p(new b,n,m);return void 0!=r&&f(r,y,e[x],e),e}),m.prototype=w,w.constructor=m),(P||F)&&(_("delete"),_("has"),y&&_("get")),(F||E)&&_(x),g&&w.clear&&delete w.clear}else m=d.getConstructor(n,t,y,x),u(m.prototype,r),c.NEED=!0;return v(m,t),S[t]=m,i(i.G+i.W+i.F*(m!=b),S),g||d.setStrong(m,t,y),m}},function(t,n,r){"use strict";var e=r(27),i=r(28),o=r(4),u=r(46),c=r(7);t.exports=function(t,n,r){var f=c(t),a=r(u,f,""[t]),s=a[0],l=a[1];o(function(){var n={};return n[f]=function(){return 7},7!=""[t](n)})&&(i(String.prototype,t,s),e(RegExp.prototype,f,2==n?function(t,n){return l.call(t,this,n)}:function(t){return l.call(t,this)}))}
},function(t,n,r){"use strict";var e=r(2);t.exports=function(){var t=e(this),n="";return t.global&&(n+="g"),t.ignoreCase&&(n+="i"),t.multiline&&(n+="m"),t.unicode&&(n+="u"),t.sticky&&(n+="y"),n}},function(t,n){t.exports=function(t,n,r){var e=void 0===r;switch(n.length){case 0:return e?t():t.call(r);case 1:return e?t(n[0]):t.call(r,n[0]);case 2:return e?t(n[0],n[1]):t.call(r,n[0],n[1]);case 3:return e?t(n[0],n[1],n[2]):t.call(r,n[0],n[1],n[2]);case 4:return e?t(n[0],n[1],n[2],n[3]):t.call(r,n[0],n[1],n[2],n[3])}return t.apply(r,n)}},function(t,n,r){var e=r(6),i=r(45),o=r(7)("match");t.exports=function(t){var n;return e(t)&&(void 0!==(n=t[o])?!!n:"RegExp"==i(t))}},function(t,n,r){var e=r(7)("iterator"),i=!1;try{var o=[7][e]();o.return=function(){i=!0},Array.from(o,function(){throw 2})}catch(t){}t.exports=function(t,n){if(!n&&!i)return!1;var r=!1;try{var o=[7],u=o[e]();u.next=function(){return{done:r=!0}},o[e]=function(){return u},t(o)}catch(t){}return r}},function(t,n,r){t.exports=r(69)||!r(4)(function(){var t=Math.random();__defineSetter__.call(null,t,function(){}),delete r(3)[t]})},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,r){var e=r(3),i="__core-js_shared__",o=e[i]||(e[i]={});t.exports=function(t){return o[t]||(o[t]={})}},function(t,n,r){for(var e,i=r(3),o=r(27),u=r(76),c=u("typed_array"),f=u("view"),a=!(!i.ArrayBuffer||!i.DataView),s=a,l=0,h="Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array".split(",");l<9;)(e=i[h[l++]])?(o(e.prototype,c,!0),o(e.prototype,f,!0)):s=!1;t.exports={ABV:a,CONSTR:s,TYPED:c,VIEW:f}},function(t,n){"use strict";var r={versions:function(){var t=window.navigator.userAgent;return{trident:t.indexOf("Trident")>-1,presto:t.indexOf("Presto")>-1,webKit:t.indexOf("AppleWebKit")>-1,gecko:t.indexOf("Gecko")>-1&&-1==t.indexOf("KHTML"),mobile:!!t.match(/AppleWebKit.*Mobile.*/),ios:!!t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:t.indexOf("Android")>-1||t.indexOf("Linux")>-1,iPhone:t.indexOf("iPhone")>-1||t.indexOf("Mac")>-1,iPad:t.indexOf("iPad")>-1,webApp:-1==t.indexOf("Safari"),weixin:-1==t.indexOf("MicroMessenger")}}()};t.exports=r},function(t,n,r){"use strict";var e=r(85),i=function(t){return t&&t.__esModule?t:{default:t}}(e),o=function(){function t(t,n,e){return n||e?String.fromCharCode(n||e):r[t]||t}function n(t){return e[t]}var r={"&quot;":'"',"&lt;":"<","&gt;":">","&amp;":"&","&nbsp;":" "},e={};for(var u in r)e[r[u]]=u;return r["&apos;"]="'",e["'"]="&#39;",{encode:function(t){return t?(""+t).replace(/['<> "&]/g,n).replace(/\r?\n/g,"<br/>").replace(/\s/g,"&nbsp;"):""},decode:function(n){return n?(""+n).replace(/<br\s*\/?>/gi,"\n").replace(/&quot;|&lt;|&gt;|&amp;|&nbsp;|&apos;|&#(\d+);|&#(\d+)/g,t).replace(/\u00a0/g," "):""},encodeBase16:function(t){if(!t)return t;t+="";for(var n=[],r=0,e=t.length;e>r;r++)n.push(t.charCodeAt(r).toString(16).toUpperCase());return n.join("")},encodeBase16forJSON:function(t){if(!t)return t;t=t.replace(/[\u4E00-\u9FBF]/gi,function(t){return escape(t).replace("%u","\\u")});for(var n=[],r=0,e=t.length;e>r;r++)n.push(t.charCodeAt(r).toString(16).toUpperCase());return n.join("")},decodeBase16:function(t){if(!t)return t;t+="";for(var n=[],r=0,e=t.length;e>r;r+=2)n.push(String.fromCharCode("0x"+t.slice(r,r+2)));return n.join("")},encodeObject:function(t){if(t instanceof Array)for(var n=0,r=t.length;r>n;n++)t[n]=o.encodeObject(t[n]);else if("object"==(void 0===t?"undefined":(0,i.default)(t)))for(var e in t)t[e]=o.encodeObject(t[e]);else if("string"==typeof t)return o.encode(t);return t},loadScript:function(t){var n=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(n),n.setAttribute("src",t)},addLoadEvent:function(t){var n=window.onload;"function"!=typeof window.onload?window.onload=t:window.onload=function(){n(),t()}}}}();t.exports=o},function(t,n,r){"use strict";var e=r(17),i=r(75),o=r(16);t.exports=function(t){for(var n=e(this),r=o(n.length),u=arguments.length,c=i(u>1?arguments[1]:void 0,r),f=u>2?arguments[2]:void 0,a=void 0===f?r:i(f,r);a>c;)n[c++]=t;return n}},function(t,n,r){"use strict";var e=r(11),i=r(66);t.exports=function(t,n,r){n in t?e.f(t,n,i(0,r)):t[n]=r}},function(t,n,r){var e=r(6),i=r(3).document,o=e(i)&&e(i.createElement);t.exports=function(t){return o?i.createElement(t):{}}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n,r){var e=r(7)("match");t.exports=function(t){var n=/./;try{"/./"[t](n)}catch(r){try{return n[e]=!1,!"/./"[t](n)}catch(t){}}return!0}},function(t,n,r){t.exports=r(3).document&&document.documentElement},function(t,n,r){var e=r(6),i=r(144).set;t.exports=function(t,n,r){var o,u=n.constructor;return u!==r&&"function"==typeof u&&(o=u.prototype)!==r.prototype&&e(o)&&i&&i(t,o),t}},function(t,n,r){var e=r(80),i=r(7)("iterator"),o=Array.prototype;t.exports=function(t){return void 0!==t&&(e.Array===t||o[i]===t)}},function(t,n,r){var e=r(45);t.exports=Array.isArray||function(t){return"Array"==e(t)}},function(t,n,r){"use strict";var e=r(70),i=r(66),o=r(81),u={};r(27)(u,r(7)("iterator"),function(){return this}),t.exports=function(t,n,r){t.prototype=e(u,{next:i(1,r)}),o(t,n+" Iterator")}},function(t,n,r){"use strict";var e=r(69),i=r(1),o=r(28),u=r(27),c=r(24),f=r(80),a=r(139),s=r(81),l=r(32),h=r(7)("iterator"),v=!([].keys&&"next"in[].keys()),p="keys",d="values",y=function(){return this};t.exports=function(t,n,r,g,b,m,x){a(r,n,g);var w,S,_,O=function(t){if(!v&&t in F)return F[t];switch(t){case p:case d:return function(){return new r(this,t)}}return function(){return new r(this,t)}},E=n+" Iterator",P=b==d,j=!1,F=t.prototype,M=F[h]||F["@@iterator"]||b&&F[b],A=M||O(b),N=b?P?O("entries"):A:void 0,T="Array"==n?F.entries||M:M;if(T&&(_=l(T.call(new t)))!==Object.prototype&&(s(_,E,!0),e||c(_,h)||u(_,h,y)),P&&M&&M.name!==d&&(j=!0,A=function(){return M.call(this)}),e&&!x||!v&&!j&&F[h]||u(F,h,A),f[n]=A,f[E]=y,b)if(w={values:P?A:O(d),keys:m?A:O(p),entries:N},x)for(S in w)S in F||o(F,S,w[S]);else i(i.P+i.F*(v||j),n,w);return w}},function(t,n){var r=Math.expm1;t.exports=!r||r(10)>22025.465794806718||r(10)<22025.465794806718||-2e-17!=r(-2e-17)?function(t){return 0==(t=+t)?t:t>-1e-6&&t<1e-6?t+t*t/2:Math.exp(t)-1}:r},function(t,n){t.exports=Math.sign||function(t){return 0==(t=+t)||t!=t?t:t<0?-1:1}},function(t,n,r){var e=r(3),i=r(151).set,o=e.MutationObserver||e.WebKitMutationObserver,u=e.process,c=e.Promise,f="process"==r(45)(u);t.exports=function(){var t,n,r,a=function(){var e,i;for(f&&(e=u.domain)&&e.exit();t;){i=t.fn,t=t.next;try{i()}catch(e){throw t?r():n=void 0,e}}n=void 0,e&&e.enter()};if(f)r=function(){u.nextTick(a)};else if(o){var s=!0,l=document.createTextNode("");new o(a).observe(l,{characterData:!0}),r=function(){l.data=s=!s}}else if(c&&c.resolve){var h=c.resolve();r=function(){h.then(a)}}else r=function(){i.call(e,a)};return function(e){var i={fn:e,next:void 0};n&&(n.next=i),t||(t=i,r()),n=i}}},function(t,n,r){var e=r(6),i=r(2),o=function(t,n){if(i(t),!e(n)&&null!==n)throw TypeError(n+": can't set as prototype!")};t.exports={set:Object.setPrototypeOf||("__proto__"in{}?function(t,n,e){try{e=r(53)(Function.call,r(31).f(Object.prototype,"__proto__").set,2),e(t,[]),n=!(t instanceof Array)}catch(t){n=!0}return function(t,r){return o(t,r),n?t.__proto__=r:e(t,r),t}}({},!1):void 0),check:o}},function(t,n,r){var e=r(126)("keys"),i=r(76);t.exports=function(t){return e[t]||(e[t]=i(t))}},function(t,n,r){var e=r(2),i=r(26),o=r(7)("species");t.exports=function(t,n){var r,u=e(t).constructor;return void 0===u||void 0==(r=e(u)[o])?n:i(r)}},function(t,n,r){var e=r(67),i=r(46);t.exports=function(t){return function(n,r){var o,u,c=String(i(n)),f=e(r),a=c.length;return f<0||f>=a?t?"":void 0:(o=c.charCodeAt(f),o<55296||o>56319||f+1===a||(u=c.charCodeAt(f+1))<56320||u>57343?t?c.charAt(f):o:t?c.slice(f,f+2):u-56320+(o-55296<<10)+65536)}}},function(t,n,r){var e=r(122),i=r(46);t.exports=function(t,n,r){if(e(n))throw TypeError("String#"+r+" doesn't accept regex!");return String(i(t))}},function(t,n,r){"use strict";var e=r(67),i=r(46);t.exports=function(t){var n=String(i(this)),r="",o=e(t);if(o<0||o==1/0)throw RangeError("Count can't be negative");for(;o>0;(o>>>=1)&&(n+=n))1&o&&(r+=n);return r}},function(t,n){t.exports="\t\n\v\f\r   ᠎             　\u2028\u2029\ufeff"},function(t,n,r){var e,i,o,u=r(53),c=r(121),f=r(135),a=r(132),s=r(3),l=s.process,h=s.setImmediate,v=s.clearImmediate,p=s.MessageChannel,d=0,y={},g="onreadystatechange",b=function(){var t=+this;if(y.hasOwnProperty(t)){var n=y[t];delete y[t],n()}},m=function(t){b.call(t.data)};h&&v||(h=function(t){for(var n=[],r=1;arguments.length>r;)n.push(arguments[r++]);return y[++d]=function(){c("function"==typeof t?t:Function(t),n)},e(d),d},v=function(t){delete y[t]},"process"==r(45)(l)?e=function(t){l.nextTick(u(b,t,1))}:p?(i=new p,o=i.port2,i.port1.onmessage=m,e=u(o.postMessage,o,1)):s.addEventListener&&"function"==typeof postMessage&&!s.importScripts?(e=function(t){s.postMessage(t+"","*")},s.addEventListener("message",m,!1)):e=g in a("script")?function(t){f.appendChild(a("script"))[g]=function(){f.removeChild(this),b.call(t)}}:function(t){setTimeout(u(b,t,1),0)}),t.exports={set:h,clear:v}},function(t,n,r){"use strict";var e=r(3),i=r(10),o=r(69),u=r(127),c=r(27),f=r(73),a=r(4),s=r(68),l=r(67),h=r(16),v=r(71).f,p=r(11).f,d=r(130),y=r(81),g="ArrayBuffer",b="DataView",m="prototype",x="Wrong length!",w="Wrong index!",S=e[g],_=e[b],O=e.Math,E=e.RangeError,P=e.Infinity,j=S,F=O.abs,M=O.pow,A=O.floor,N=O.log,T=O.LN2,I="buffer",k="byteLength",L="byteOffset",R=i?"_b":I,C=i?"_l":k,D=i?"_o":L,U=function(t,n,r){var e,i,o,u=Array(r),c=8*r-n-1,f=(1<<c)-1,a=f>>1,s=23===n?M(2,-24)-M(2,-77):0,l=0,h=t<0||0===t&&1/t<0?1:0;for(t=F(t),t!=t||t===P?(i=t!=t?1:0,e=f):(e=A(N(t)/T),t*(o=M(2,-e))<1&&(e--,o*=2),t+=e+a>=1?s/o:s*M(2,1-a),t*o>=2&&(e++,o/=2),e+a>=f?(i=0,e=f):e+a>=1?(i=(t*o-1)*M(2,n),e+=a):(i=t*M(2,a-1)*M(2,n),e=0));n>=8;u[l++]=255&i,i/=256,n-=8);for(e=e<<n|i,c+=n;c>0;u[l++]=255&e,e/=256,c-=8);return u[--l]|=128*h,u},W=function(t,n,r){var e,i=8*r-n-1,o=(1<<i)-1,u=o>>1,c=i-7,f=r-1,a=t[f--],s=127&a;for(a>>=7;c>0;s=256*s+t[f],f--,c-=8);for(e=s&(1<<-c)-1,s>>=-c,c+=n;c>0;e=256*e+t[f],f--,c-=8);if(0===s)s=1-u;else{if(s===o)return e?NaN:a?-P:P;e+=M(2,n),s-=u}return(a?-1:1)*e*M(2,s-n)},G=function(t){return t[3]<<24|t[2]<<16|t[1]<<8|t[0]},B=function(t){return[255&t]},V=function(t){return[255&t,t>>8&255]},z=function(t){return[255&t,t>>8&255,t>>16&255,t>>24&255]},q=function(t){return U(t,52,8)},K=function(t){return U(t,23,4)},J=function(t,n,r){p(t[m],n,{get:function(){return this[r]}})},Y=function(t,n,r,e){var i=+r,o=l(i);if(i!=o||o<0||o+n>t[C])throw E(w);var u=t[R]._b,c=o+t[D],f=u.slice(c,c+n);return e?f:f.reverse()},H=function(t,n,r,e,i,o){var u=+r,c=l(u);if(u!=c||c<0||c+n>t[C])throw E(w);for(var f=t[R]._b,a=c+t[D],s=e(+i),h=0;h<n;h++)f[a+h]=s[o?h:n-h-1]},$=function(t,n){s(t,S,g);var r=+n,e=h(r);if(r!=e)throw E(x);return e};if(u.ABV){if(!a(function(){new S})||!a(function(){new S(.5)})){S=function(t){return new j($(this,t))};for(var X,Q=S[m]=j[m],Z=v(j),tt=0;Z.length>tt;)(X=Z[tt++])in S||c(S,X,j[X]);o||(Q.constructor=S)}var nt=new _(new S(2)),rt=_[m].setInt8;nt.setInt8(0,2147483648),nt.setInt8(1,2147483649),!nt.getInt8(0)&&nt.getInt8(1)||f(_[m],{setInt8:function(t,n){rt.call(this,t,n<<24>>24)},setUint8:function(t,n){rt.call(this,t,n<<24>>24)}},!0)}else S=function(t){var n=$(this,t);this._b=d.call(Array(n),0),this[C]=n},_=function(t,n,r){s(this,_,b),s(t,S,b);var e=t[C],i=l(n);if(i<0||i>e)throw E("Wrong offset!");if(r=void 0===r?e-i:h(r),i+r>e)throw E(x);this[R]=t,this[D]=i,this[C]=r},i&&(J(S,k,"_l"),J(_,I,"_b"),J(_,k,"_l"),J(_,L,"_o")),f(_[m],{getInt8:function(t){return Y(this,1,t)[0]<<24>>24},getUint8:function(t){return Y(this,1,t)[0]},getInt16:function(t){var n=Y(this,2,t,arguments[1]);return(n[1]<<8|n[0])<<16>>16},getUint16:function(t){var n=Y(this,2,t,arguments[1]);return n[1]<<8|n[0]},getInt32:function(t){return G(Y(this,4,t,arguments[1]))},getUint32:function(t){return G(Y(this,4,t,arguments[1]))>>>0},getFloat32:function(t){return W(Y(this,4,t,arguments[1]),23,4)},getFloat64:function(t){return W(Y(this,8,t,arguments[1]),52,8)},setInt8:function(t,n){H(this,1,t,B,n)},setUint8:function(t,n){H(this,1,t,B,n)},setInt16:function(t,n){H(this,2,t,V,n,arguments[2])},setUint16:function(t,n){H(this,2,t,V,n,arguments[2])},setInt32:function(t,n){H(this,4,t,z,n,arguments[2])},setUint32:function(t,n){H(this,4,t,z,n,arguments[2])},setFloat32:function(t,n){H(this,4,t,K,n,arguments[2])},setFloat64:function(t,n){H(this,8,t,q,n,arguments[2])}});y(S,g),y(_,b),c(_[m],u.VIEW,!0),n[g]=S,n[b]=_},function(t,n,r){var e=r(3),i=r(52),o=r(69),u=r(182),c=r(11).f;t.exports=function(t){var n=i.Symbol||(i.Symbol=o?{}:e.Symbol||{});"_"==t.charAt(0)||t in n||c(n,t,{value:u.f(t)})}},function(t,n,r){var e=r(114),i=r(7)("iterator"),o=r(80);t.exports=r(52).getIteratorMethod=function(t){if(void 0!=t)return t[i]||t["@@iterator"]||o[e(t)]}},function(t,n,r){"use strict";var e=r(78),i=r(170),o=r(80),u=r(30);t.exports=r(140)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,r=this._i++;return!t||r>=t.length?(this._t=void 0,i(1)):"keys"==n?i(0,r):"values"==n?i(0,t[r]):i(0,[r,t[r]])},"values"),o.Arguments=o.Array,e("keys"),e("values"),e("entries")},function(t,n){function r(t,n){t.classList?t.classList.add(n):t.className+=" "+n}t.exports=r},function(t,n){function r(t,n){if(t.classList)t.classList.remove(n);else{var r=new RegExp("(^|\\b)"+n.split(" ").join("|")+"(\\b|$)","gi");t.className=t.className.replace(r," ")}}t.exports=r},function(t,n){function r(){throw new Error("setTimeout has not been defined")}function e(){throw new Error("clearTimeout has not been defined")}function i(t){if(s===setTimeout)return setTimeout(t,0);if((s===r||!s)&&setTimeout)return s=setTimeout,setTimeout(t,0);try{return s(t,0)}catch(n){try{return s.call(null,t,0)}catch(n){return s.call(this,t,0)}}}function o(t){if(l===clearTimeout)return clearTimeout(t);if((l===e||!l)&&clearTimeout)return l=clearTimeout,clearTimeout(t);try{return l(t)}catch(n){try{return l.call(null,t)}catch(n){return l.call(this,t)}}}function u(){d&&v&&(d=!1,v.length?p=v.concat(p):y=-1,p.length&&c())}function c(){if(!d){var t=i(u);d=!0;for(var n=p.length;n;){for(v=p,p=[];++y<n;)v&&v[y].run();y=-1,n=p.length}v=null,d=!1,o(t)}}function f(t,n){this.fun=t,this.array=n}function a(){}var s,l,h=t.exports={};!function(){try{s="function"==typeof setTimeout?setTimeout:r}catch(t){s=r}try{l="function"==typeof clearTimeout?clearTimeout:e}catch(t){l=e}}();var v,p=[],d=!1,y=-1;h.nextTick=function(t){var n=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)n[r-1]=arguments[r];p.push(new f(t,n)),1!==p.length||d||i(c)},f.prototype.run=function(){this.fun.apply(null,this.array)},h.title="browser",h.browser=!0,h.env={},h.argv=[],h.version="",h.versions={},h.on=a,h.addListener=a,h.once=a,h.off=a,h.removeListener=a,h.removeAllListeners=a,h.emit=a,h.prependListener=a,h.prependOnceListener=a,h.listeners=function(t){return[]},h.binding=function(t){throw new Error("process.binding is not supported")},h.cwd=function(){return"/"},h.chdir=function(t){throw new Error("process.chdir is not supported")},h.umask=function(){return 0}},function(t,n,r){var e=r(45);t.exports=function(t,n){if("number"!=typeof t&&"Number"!=e(t))throw TypeError(n);return+t}},function(t,n,r){"use strict";var e=r(17),i=r(75),o=r(16);t.exports=[].copyWithin||function(t,n){var r=e(this),u=o(r.length),c=i(t,u),f=i(n,u),a=arguments.length>2?arguments[2]:void 0,s=Math.min((void 0===a?u:i(a,u))-f,u-c),l=1;for(f<c&&c<f+s&&(l=-1,f+=s-1,c+=s-1);s-- >0;)f in r?r[c]=r[f]:delete r[c],c+=l,f+=l;return r}},function(t,n,r){var e=r(79);t.exports=function(t,n){var r=[];return e(t,!1,r.push,r,n),r}},function(t,n,r){var e=r(26),i=r(17),o=r(115),u=r(16);t.exports=function(t,n,r,c,f){e(n);var a=i(t),s=o(a),l=u(a.length),h=f?l-1:0,v=f?-1:1;if(r<2)for(;;){if(h in s){c=s[h],h+=v;break}if(h+=v,f?h<0:l<=h)throw TypeError("Reduce of empty array with no initial value")}for(;f?h>=0:l>h;h+=v)h in s&&(c=n(c,s[h],h,a));return c}},function(t,n,r){"use strict";var e=r(26),i=r(6),o=r(121),u=[].slice,c={},f=function(t,n,r){if(!(n in c)){for(var e=[],i=0;i<n;i++)e[i]="a["+i+"]";c[n]=Function("F,a","return new F("+e.join(",")+")")}return c[n](t,r)};t.exports=Function.bind||function(t){var n=e(this),r=u.call(arguments,1),c=function(){var e=r.concat(u.call(arguments));return this instanceof c?f(n,e.length,e):o(n,e,t)};return i(n.prototype)&&(c.prototype=n.prototype),c}},function(t,n,r){"use strict";var e=r(11).f,i=r(70),o=r(73),u=r(53),c=r(68),f=r(46),a=r(79),s=r(140),l=r(170),h=r(74),v=r(10),p=r(65).fastKey,d=v?"_s":"size",y=function(t,n){var r,e=p(n);if("F"!==e)return t._i[e];for(r=t._f;r;r=r.n)if(r.k==n)return r};t.exports={getConstructor:function(t,n,r,s){var l=t(function(t,e){c(t,l,n,"_i"),t._i=i(null),t._f=void 0,t._l=void 0,t[d]=0,void 0!=e&&a(e,r,t[s],t)});return o(l.prototype,{clear:function(){for(var t=this,n=t._i,r=t._f;r;r=r.n)r.r=!0,r.p&&(r.p=r.p.n=void 0),delete n[r.i];t._f=t._l=void 0,t[d]=0},delete:function(t){var n=this,r=y(n,t);if(r){var e=r.n,i=r.p;delete n._i[r.i],r.r=!0,i&&(i.n=e),e&&(e.p=i),n._f==r&&(n._f=e),n._l==r&&(n._l=i),n[d]--}return!!r},forEach:function(t){c(this,l,"forEach");for(var n,r=u(t,arguments.length>1?arguments[1]:void 0,3);n=n?n.n:this._f;)for(r(n.v,n.k,this);n&&n.r;)n=n.p},has:function(t){return!!y(this,t)}}),v&&e(l.prototype,"size",{get:function(){return f(this[d])}}),l},def:function(t,n,r){var e,i,o=y(t,n);return o?o.v=r:(t._l=o={i:i=p(n,!0),k:n,v:r,p:e=t._l,n:void 0,r:!1},t._f||(t._f=o),e&&(e.n=o),t[d]++,"F"!==i&&(t._i[i]=o)),t},getEntry:y,setStrong:function(t,n,r){s(t,n,function(t,n){this._t=t,this._k=n,this._l=void 0},function(){for(var t=this,n=t._k,r=t._l;r&&r.r;)r=r.p;return t._t&&(t._l=r=r?r.n:t._t._f)?"keys"==n?l(0,r.k):"values"==n?l(0,r.v):l(0,[r.k,r.v]):(t._t=void 0,l(1))},r?"entries":"values",!r,!0),h(n)}}},function(t,n,r){var e=r(114),i=r(161);t.exports=function(t){return function(){if(e(this)!=t)throw TypeError(t+"#toJSON isn't generic");return i(this)}}},function(t,n,r){"use strict";var e=r(73),i=r(65).getWeak,o=r(2),u=r(6),c=r(68),f=r(79),a=r(48),s=r(24),l=a(5),h=a(6),v=0,p=function(t){return t._l||(t._l=new d)},d=function(){this.a=[]},y=function(t,n){return l(t.a,function(t){return t[0]===n})};d.prototype={get:function(t){var n=y(this,t);if(n)return n[1]},has:function(t){return!!y(this,t)},set:function(t,n){var r=y(this,t);r?r[1]=n:this.a.push([t,n])},delete:function(t){var n=h(this.a,function(n){return n[0]===t});return~n&&this.a.splice(n,1),!!~n}},t.exports={getConstructor:function(t,n,r,o){var a=t(function(t,e){c(t,a,n,"_i"),t._i=v++,t._l=void 0,void 0!=e&&f(e,r,t[o],t)});return e(a.prototype,{delete:function(t){if(!u(t))return!1;var n=i(t);return!0===n?p(this).delete(t):n&&s(n,this._i)&&delete n[this._i]},has:function(t){if(!u(t))return!1;var n=i(t);return!0===n?p(this).has(t):n&&s(n,this._i)}}),a},def:function(t,n,r){var e=i(o(n),!0);return!0===e?p(t).set(n,r):e[t._i]=r,t},ufstore:p}},function(t,n,r){t.exports=!r(10)&&!r(4)(function(){return 7!=Object.defineProperty(r(132)("div"),"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(6),i=Math.floor;t.exports=function(t){return!e(t)&&isFinite(t)&&i(t)===t}},function(t,n,r){var e=r(2);t.exports=function(t,n,r,i){try{return i?n(e(r)[0],r[1]):n(r)}catch(n){var o=t.return;throw void 0!==o&&e(o.call(t)),n}}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n){t.exports=Math.log1p||function(t){return(t=+t)>-1e-8&&t<1e-8?t-t*t/2:Math.log(1+t)}},function(t,n,r){"use strict";var e=r(72),i=r(125),o=r(116),u=r(17),c=r(115),f=Object.assign;t.exports=!f||r(4)(function(){var t={},n={},r=Symbol(),e="abcdefghijklmnopqrst";return t[r]=7,e.split("").forEach(function(t){n[t]=t}),7!=f({},t)[r]||Object.keys(f({},n)).join("")!=e})?function(t,n){for(var r=u(t),f=arguments.length,a=1,s=i.f,l=o.f;f>a;)for(var h,v=c(arguments[a++]),p=s?e(v).concat(s(v)):e(v),d=p.length,y=0;d>y;)l.call(v,h=p[y++])&&(r[h]=v[h]);return r}:f},function(t,n,r){var e=r(11),i=r(2),o=r(72);t.exports=r(10)?Object.defineProperties:function(t,n){i(t);for(var r,u=o(n),c=u.length,f=0;c>f;)e.f(t,r=u[f++],n[r]);return t}},function(t,n,r){var e=r(30),i=r(71).f,o={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],c=function(t){try{return i(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==o.call(t)?c(t):i(e(t))}},function(t,n,r){var e=r(24),i=r(30),o=r(117)(!1),u=r(145)("IE_PROTO");t.exports=function(t,n){var r,c=i(t),f=0,a=[];for(r in c)r!=u&&e(c,r)&&a.push(r);for(;n.length>f;)e(c,r=n[f++])&&(~o(a,r)||a.push(r));return a}},function(t,n,r){var e=r(72),i=r(30),o=r(116).f;t.exports=function(t){return function(n){for(var r,u=i(n),c=e(u),f=c.length,a=0,s=[];f>a;)o.call(u,r=c[a++])&&s.push(t?[r,u[r]]:u[r]);return s}}},function(t,n,r){var e=r(71),i=r(125),o=r(2),u=r(3).Reflect;t.exports=u&&u.ownKeys||function(t){var n=e.f(o(t)),r=i.f;return r?n.concat(r(t)):n}},function(t,n,r){var e=r(3).parseFloat,i=r(82).trim;t.exports=1/e(r(150)+"-0")!=-1/0?function(t){var n=i(String(t),3),r=e(n);return 0===r&&"-"==n.charAt(0)?-0:r}:e},function(t,n,r){var e=r(3).parseInt,i=r(82).trim,o=r(150),u=/^[\-+]?0[xX]/;t.exports=8!==e(o+"08")||22!==e(o+"0x16")?function(t,n){var r=i(String(t),3);return e(r,n>>>0||(u.test(r)?16:10))}:e},function(t,n){t.exports=Object.is||function(t,n){return t===n?0!==t||1/t==1/n:t!=t&&n!=n}},function(t,n,r){var e=r(16),i=r(149),o=r(46);t.exports=function(t,n,r,u){var c=String(o(t)),f=c.length,a=void 0===r?" ":String(r),s=e(n);if(s<=f||""==a)return c;var l=s-f,h=i.call(a,Math.ceil(l/a.length));return h.length>l&&(h=h.slice(0,l)),u?h+c:c+h}},function(t,n,r){n.f=r(7)},function(t,n,r){"use strict";var e=r(164);t.exports=r(118)("Map",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{get:function(t){var n=e.getEntry(this,t);return n&&n.v},set:function(t,n){return e.def(this,0===t?0:t,n)}},e,!0)},function(t,n,r){r(10)&&"g"!=/./g.flags&&r(11).f(RegExp.prototype,"flags",{configurable:!0,get:r(120)})},function(t,n,r){"use strict";var e=r(164);t.exports=r(118)("Set",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{add:function(t){return e.def(this,t=0===t?0:t,t)}},e)},function(t,n,r){"use strict";var e,i=r(48)(0),o=r(28),u=r(65),c=r(172),f=r(166),a=r(6),s=u.getWeak,l=Object.isExtensible,h=f.ufstore,v={},p=function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},d={get:function(t){if(a(t)){var n=s(t);return!0===n?h(this).get(t):n?n[this._i]:void 0}},set:function(t,n){return f.def(this,t,n)}},y=t.exports=r(118)("WeakMap",p,d,f,!0,!0);7!=(new y).set((Object.freeze||Object)(v),7).get(v)&&(e=f.getConstructor(p),c(e.prototype,d),u.NEED=!0,i(["delete","has","get","set"],function(t){var n=y.prototype,r=n[t];o(n,t,function(n,i){if(a(n)&&!l(n)){this._f||(this._f=new e);var o=this._f[t](n,i);return"set"==t?this:o}return r.call(this,n,i)})}))},,,,function(t,n){"use strict";function r(){var t=document.querySelector("#page-nav");if(t&&!document.querySelector("#page-nav .extend.prev")&&(t.innerHTML='<a class="extend prev disabled" rel="prev">&laquo; Prev</a>'+t.innerHTML),t&&!document.querySelector("#page-nav .extend.next")&&(t.innerHTML=t.innerHTML+'<a class="extend next disabled" rel="next">Next &raquo;</a>'),yiliaConfig&&yiliaConfig.open_in_new){document.querySelectorAll(".article-entry a:not(.article-more-a)").forEach(function(t){var n=t.getAttribute("target");n&&""!==n||t.setAttribute("target","_blank")})}if(yiliaConfig&&yiliaConfig.open_in_new){document.querySelectorAll(".toc-number").forEach(function(t){t.style.display="none"})}var n=document.querySelector("#js-aboutme");n&&0!==n.length&&(n.innerHTML=n.innerText)}t.exports={init:r}},function(t,n,r){"use strict";function e(t){return t&&t.__esModule?t:{default:t}}function i(t,n){var r=/\/|index.html/g;return t.replace(r,"")===n.replace(r,"")}function o(){for(var t=document.querySelectorAll(".js-header-menu li a"),n=window.location.pathname,r=0,e=t.length;r<e;r++){var o=t[r];i(n,o.getAttribute("href"))&&(0,h.default)(o,"active")}}function u(t){for(var n=t.offsetLeft,r=t.offsetParent;null!==r;)n+=r.offsetLeft,r=r.offsetParent;return n}function c(t){for(var n=t.offsetTop,r=t.offsetParent;null!==r;)n+=r.offsetTop,r=r.offsetParent;return n}function f(t,n,r,e,i){var o=u(t),f=c(t)-n;if(f-r<=i){var a=t.$newDom;a||(a=t.cloneNode(!0),(0,d.default)(t,a),t.$newDom=a,a.style.position="fixed",a.style.top=(r||f)+"px",a.style.left=o+"px",a.style.zIndex=e||2,a.style.width="100%",a.style.color="#fff"),a.style.visibility="visible",t.style.visibility="hidden"}else{t.style.visibility="visible";var s=t.$newDom;s&&(s.style.visibility="hidden")}}function a(){var t=document.querySelector(".js-overlay"),n=document.querySelector(".js-header-menu");f(t,document.body.scrollTop,-63,2,0),f(n,document.body.scrollTop,1,3,0)}function s(){document.querySelector("#container").addEventListener("scroll",function(t){a()}),window.addEventListener("scroll",function(t){a()}),a()}var l=r(156),h=e(l),v=r(157),p=(e(v),r(382)),d=e(p),y=r(128),g=e(y),b=r(190),m=e(b),x=r(129);(function(){g.default.versions.mobile&&window.screen.width<800&&(o(),s())})(),(0,x.addLoadEvent)(function(){m.default.init()}),t.exports={}},,,,function(t,n,r){(function(t){"use strict";function n(t,n,r){t[n]||Object[e](t,n,{writable:!0,configurable:!0,value:r})}if(r(381),r(391),r(198),t._babelPolyfill)throw new Error("only one instance of babel-polyfill is allowed");t._babelPolyfill=!0;var e="defineProperty";n(String.prototype,"padLeft","".padStart),n(String.prototype,"padRight","".padEnd),"pop,reverse,shift,keys,values,entries,indexOf,every,some,forEach,map,filter,find,findIndex,includes,join,slice,concat,push,splice,unshift,sort,lastIndexOf,reduce,reduceRight,copyWithin,fill".split(",").forEach(function(t){[][t]&&n(Array,t,Function.call.bind([][t]))})}).call(n,function(){return this}())},,,function(t,n,r){r(210),t.exports=r(52).RegExp.escape},,,,function(t,n,r){var e=r(6),i=r(138),o=r(7)("species");t.exports=function(t){var n;return i(t)&&(n=t.constructor,"function"!=typeof n||n!==Array&&!i(n.prototype)||(n=void 0),e(n)&&null===(n=n[o])&&(n=void 0)),void 0===n?Array:n}},function(t,n,r){var e=r(202);t.exports=function(t,n){return new(e(t))(n)}},function(t,n,r){"use strict";var e=r(2),i=r(50),o="number";t.exports=function(t){if("string"!==t&&t!==o&&"default"!==t)throw TypeError("Incorrect hint");return i(e(this),t!=o)}},function(t,n,r){var e=r(72),i=r(125),o=r(116);t.exports=function(t){var n=e(t),r=i.f;if(r)for(var u,c=r(t),f=o.f,a=0;c.length>a;)f.call(t,u=c[a++])&&n.push(u);return n}},function(t,n,r){var e=r(72),i=r(30);t.exports=function(t,n){for(var r,o=i(t),u=e(o),c=u.length,f=0;c>f;)if(o[r=u[f++]]===n)return r}},function(t,n,r){"use strict";var e=r(208),i=r(121),o=r(26);t.exports=function(){for(var t=o(this),n=arguments.length,r=Array(n),u=0,c=e._,f=!1;n>u;)(r[u]=arguments[u++])===c&&(f=!0);return function(){var e,o=this,u=arguments.length,a=0,s=0;if(!f&&!u)return i(t,r,o);if(e=r.slice(),f)for(;n>a;a++)e[a]===c&&(e[a]=arguments[s++]);for(;u>s;)e.push(arguments[s++]);return i(t,e,o)}}},function(t,n,r){t.exports=r(3)},function(t,n){t.exports=function(t,n){var r=n===Object(n)?function(t){return n[t]}:n;return function(n){return String(n).replace(t,r)}}},function(t,n,r){var e=r(1),i=r(209)(/[\\^$*+?.()|[\]{}]/g,"\\$&");e(e.S,"RegExp",{escape:function(t){return i(t)}})},function(t,n,r){var e=r(1);e(e.P,"Array",{copyWithin:r(160)}),r(78)("copyWithin")},function(t,n,r){"use strict";var e=r(1),i=r(48)(4);e(e.P+e.F*!r(47)([].every,!0),"Array",{every:function(t){return i(this,t,arguments[1])}})},function(t,n,r){var e=r(1);e(e.P,"Array",{fill:r(130)}),r(78)("fill")},function(t,n,r){"use strict";var e=r(1),i=r(48)(2);e(e.P+e.F*!r(47)([].filter,!0),"Array",{filter:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(6),o="findIndex",u=!0;o in[]&&Array(1)[o](function(){u=!1}),e(e.P+e.F*u,"Array",{findIndex:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(78)(o)},function(t,n,r){"use strict";var e=r(1),i=r(48)(5),o="find",u=!0;o in[]&&Array(1)[o](function(){u=!1}),e(e.P+e.F*u,"Array",{find:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(78)(o)},function(t,n,r){"use strict";var e=r(1),i=r(48)(0),o=r(47)([].forEach,!0);e(e.P+e.F*!o,"Array",{forEach:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(53),i=r(1),o=r(17),u=r(169),c=r(137),f=r(16),a=r(131),s=r(154);i(i.S+i.F*!r(123)(function(t){Array.from(t)}),"Array",{from:function(t){var n,r,i,l,h=o(t),v="function"==typeof this?this:Array,p=arguments.length,d=p>1?arguments[1]:void 0,y=void 0!==d,g=0,b=s(h);if(y&&(d=e(d,p>2?arguments[2]:void 0,2)),void 0==b||v==Array&&c(b))for(n=f(h.length),r=new v(n);n>g;g++)a(r,g,y?d(h[g],g):h[g]);else for(l=b.call(h),r=new v;!(i=l.next()).done;g++)a(r,g,y?u(l,d,[i.value,g],!0):i.value);return r.length=g,r}})},function(t,n,r){"use strict";var e=r(1),i=r(117)(!1),o=[].indexOf,u=!!o&&1/[1].indexOf(1,-0)<0;e(e.P+e.F*(u||!r(47)(o)),"Array",{indexOf:function(t){return u?o.apply(this,arguments)||0:i(this,t,arguments[1])}})},function(t,n,r){var e=r(1);e(e.S,"Array",{isArray:r(138)})},function(t,n,r){"use strict";var e=r(1),i=r(30),o=[].join;e(e.P+e.F*(r(115)!=Object||!r(47)(o)),"Array",{join:function(t){return o.call(i(this),void 0===t?",":t)}})},function(t,n,r){"use strict";var e=r(1),i=r(30),o=r(67),u=r(16),c=[].lastIndexOf,f=!!c&&1/[1].lastIndexOf(1,-0)<0;e(e.P+e.F*(f||!r(47)(c)),"Array",{lastIndexOf:function(t){if(f)return c.apply(this,arguments)||0;var n=i(this),r=u(n.length),e=r-1;for(arguments.length>1&&(e=Math.min(e,o(arguments[1]))),e<0&&(e=r+e);e>=0;e--)if(e in n&&n[e]===t)return e||0;return-1}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(1);e(e.P+e.F*!r(47)([].map,!0),"Array",{map:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(131);e(e.S+e.F*r(4)(function(){function t(){}return!(Array.of.call(t)instanceof t)}),"Array",{of:function(){for(var t=0,n=arguments.length,r=new("function"==typeof this?this:Array)(n);n>t;)i(r,t,arguments[t++]);return r.length=n,r}})},function(t,n,r){"use strict";var e=r(1),i=r(162);e(e.P+e.F*!r(47)([].reduceRight,!0),"Array",{reduceRight:function(t){return i(this,t,arguments.length,arguments[1],!0)}})},function(t,n,r){"use strict";var e=r(1),i=r(162);e(e.P+e.F*!r(47)([].reduce,!0),"Array",{reduce:function(t){return i(this,t,arguments.length,arguments[1],!1)}})},function(t,n,r){"use strict";var e=r(1),i=r(135),o=r(45),u=r(75),c=r(16),f=[].slice;e(e.P+e.F*r(4)(function(){i&&f.call(i)}),"Array",{slice:function(t,n){var r=c(this.length),e=o(this);if(n=void 0===n?r:n,"Array"==e)return f.call(this,t,n);for(var i=u(t,r),a=u(n,r),s=c(a-i),l=Array(s),h=0;h<s;h++)l[h]="String"==e?this.charAt(i+h):this[i+h];return l}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(3);e(e.P+e.F*!r(47)([].some,!0),"Array",{some:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(26),o=r(17),u=r(4),c=[].sort,f=[1,2,3];e(e.P+e.F*(u(function(){f.sort(void 0)})||!u(function(){f.sort(null)})||!r(47)(c)),"Array",{sort:function(t){return void 0===t?c.call(o(this)):c.call(o(this),i(t))}})},function(t,n,r){r(74)("Array")},function(t,n,r){var e=r(1);e(e.S,"Date",{now:function(){return(new Date).getTime()}})},function(t,n,r){"use strict";var e=r(1),i=r(4),o=Date.prototype.getTime,u=function(t){return t>9?t:"0"+t};e(e.P+e.F*(i(function(){return"0385-07-25T07:06:39.999Z"!=new Date(-5e13-1).toISOString()})||!i(function(){new Date(NaN).toISOString()})),"Date",{toISOString:function(){
if(!isFinite(o.call(this)))throw RangeError("Invalid time value");var t=this,n=t.getUTCFullYear(),r=t.getUTCMilliseconds(),e=n<0?"-":n>9999?"+":"";return e+("00000"+Math.abs(n)).slice(e?-6:-4)+"-"+u(t.getUTCMonth()+1)+"-"+u(t.getUTCDate())+"T"+u(t.getUTCHours())+":"+u(t.getUTCMinutes())+":"+u(t.getUTCSeconds())+"."+(r>99?r:"0"+u(r))+"Z"}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(50);e(e.P+e.F*r(4)(function(){return null!==new Date(NaN).toJSON()||1!==Date.prototype.toJSON.call({toISOString:function(){return 1}})}),"Date",{toJSON:function(t){var n=i(this),r=o(n);return"number"!=typeof r||isFinite(r)?n.toISOString():null}})},function(t,n,r){var e=r(7)("toPrimitive"),i=Date.prototype;e in i||r(27)(i,e,r(204))},function(t,n,r){var e=Date.prototype,i="Invalid Date",o="toString",u=e[o],c=e.getTime;new Date(NaN)+""!=i&&r(28)(e,o,function(){var t=c.call(this);return t===t?u.call(this):i})},function(t,n,r){var e=r(1);e(e.P,"Function",{bind:r(163)})},function(t,n,r){"use strict";var e=r(6),i=r(32),o=r(7)("hasInstance"),u=Function.prototype;o in u||r(11).f(u,o,{value:function(t){if("function"!=typeof this||!e(t))return!1;if(!e(this.prototype))return t instanceof this;for(;t=i(t);)if(this.prototype===t)return!0;return!1}})},function(t,n,r){var e=r(11).f,i=r(66),o=r(24),u=Function.prototype,c="name",f=Object.isExtensible||function(){return!0};c in u||r(10)&&e(u,c,{configurable:!0,get:function(){try{var t=this,n=(""+t).match(/^\s*function ([^ (]*)/)[1];return o(t,c)||!f(t)||e(t,c,i(5,n)),n}catch(t){return""}}})},function(t,n,r){var e=r(1),i=r(171),o=Math.sqrt,u=Math.acosh;e(e.S+e.F*!(u&&710==Math.floor(u(Number.MAX_VALUE))&&u(1/0)==1/0),"Math",{acosh:function(t){return(t=+t)<1?NaN:t>94906265.62425156?Math.log(t)+Math.LN2:i(t-1+o(t-1)*o(t+1))}})},function(t,n,r){function e(t){return isFinite(t=+t)&&0!=t?t<0?-e(-t):Math.log(t+Math.sqrt(t*t+1)):t}var i=r(1),o=Math.asinh;i(i.S+i.F*!(o&&1/o(0)>0),"Math",{asinh:e})},function(t,n,r){var e=r(1),i=Math.atanh;e(e.S+e.F*!(i&&1/i(-0)<0),"Math",{atanh:function(t){return 0==(t=+t)?t:Math.log((1+t)/(1-t))/2}})},function(t,n,r){var e=r(1),i=r(142);e(e.S,"Math",{cbrt:function(t){return i(t=+t)*Math.pow(Math.abs(t),1/3)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{clz32:function(t){return(t>>>=0)?31-Math.floor(Math.log(t+.5)*Math.LOG2E):32}})},function(t,n,r){var e=r(1),i=Math.exp;e(e.S,"Math",{cosh:function(t){return(i(t=+t)+i(-t))/2}})},function(t,n,r){var e=r(1),i=r(141);e(e.S+e.F*(i!=Math.expm1),"Math",{expm1:i})},function(t,n,r){var e=r(1),i=r(142),o=Math.pow,u=o(2,-52),c=o(2,-23),f=o(2,127)*(2-c),a=o(2,-126),s=function(t){return t+1/u-1/u};e(e.S,"Math",{fround:function(t){var n,r,e=Math.abs(t),o=i(t);return e<a?o*s(e/a/c)*a*c:(n=(1+c/u)*e,r=n-(n-e),r>f||r!=r?o*(1/0):o*r)}})},function(t,n,r){var e=r(1),i=Math.abs;e(e.S,"Math",{hypot:function(t,n){for(var r,e,o=0,u=0,c=arguments.length,f=0;u<c;)r=i(arguments[u++]),f<r?(e=f/r,o=o*e*e+1,f=r):r>0?(e=r/f,o+=e*e):o+=r;return f===1/0?1/0:f*Math.sqrt(o)}})},function(t,n,r){var e=r(1),i=Math.imul;e(e.S+e.F*r(4)(function(){return-5!=i(4294967295,5)||2!=i.length}),"Math",{imul:function(t,n){var r=65535,e=+t,i=+n,o=r&e,u=r&i;return 0|o*u+((r&e>>>16)*u+o*(r&i>>>16)<<16>>>0)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{log10:function(t){return Math.log(t)/Math.LN10}})},function(t,n,r){var e=r(1);e(e.S,"Math",{log1p:r(171)})},function(t,n,r){var e=r(1);e(e.S,"Math",{log2:function(t){return Math.log(t)/Math.LN2}})},function(t,n,r){var e=r(1);e(e.S,"Math",{sign:r(142)})},function(t,n,r){var e=r(1),i=r(141),o=Math.exp;e(e.S+e.F*r(4)(function(){return-2e-17!=!Math.sinh(-2e-17)}),"Math",{sinh:function(t){return Math.abs(t=+t)<1?(i(t)-i(-t))/2:(o(t-1)-o(-t-1))*(Math.E/2)}})},function(t,n,r){var e=r(1),i=r(141),o=Math.exp;e(e.S,"Math",{tanh:function(t){var n=i(t=+t),r=i(-t);return n==1/0?1:r==1/0?-1:(n-r)/(o(t)+o(-t))}})},function(t,n,r){var e=r(1);e(e.S,"Math",{trunc:function(t){return(t>0?Math.floor:Math.ceil)(t)}})},function(t,n,r){"use strict";var e=r(3),i=r(24),o=r(45),u=r(136),c=r(50),f=r(4),a=r(71).f,s=r(31).f,l=r(11).f,h=r(82).trim,v="Number",p=e[v],d=p,y=p.prototype,g=o(r(70)(y))==v,b="trim"in String.prototype,m=function(t){var n=c(t,!1);if("string"==typeof n&&n.length>2){n=b?n.trim():h(n,3);var r,e,i,o=n.charCodeAt(0);if(43===o||45===o){if(88===(r=n.charCodeAt(2))||120===r)return NaN}else if(48===o){switch(n.charCodeAt(1)){case 66:case 98:e=2,i=49;break;case 79:case 111:e=8,i=55;break;default:return+n}for(var u,f=n.slice(2),a=0,s=f.length;a<s;a++)if((u=f.charCodeAt(a))<48||u>i)return NaN;return parseInt(f,e)}}return+n};if(!p(" 0o1")||!p("0b1")||p("+0x1")){p=function(t){var n=arguments.length<1?0:t,r=this;return r instanceof p&&(g?f(function(){y.valueOf.call(r)}):o(r)!=v)?u(new d(m(n)),r,p):m(n)};for(var x,w=r(10)?a(d):"MAX_VALUE,MIN_VALUE,NaN,NEGATIVE_INFINITY,POSITIVE_INFINITY,EPSILON,isFinite,isInteger,isNaN,isSafeInteger,MAX_SAFE_INTEGER,MIN_SAFE_INTEGER,parseFloat,parseInt,isInteger".split(","),S=0;w.length>S;S++)i(d,x=w[S])&&!i(p,x)&&l(p,x,s(d,x));p.prototype=y,y.constructor=p,r(28)(e,v,p)}},function(t,n,r){var e=r(1);e(e.S,"Number",{EPSILON:Math.pow(2,-52)})},function(t,n,r){var e=r(1),i=r(3).isFinite;e(e.S,"Number",{isFinite:function(t){return"number"==typeof t&&i(t)}})},function(t,n,r){var e=r(1);e(e.S,"Number",{isInteger:r(168)})},function(t,n,r){var e=r(1);e(e.S,"Number",{isNaN:function(t){return t!=t}})},function(t,n,r){var e=r(1),i=r(168),o=Math.abs;e(e.S,"Number",{isSafeInteger:function(t){return i(t)&&o(t)<=9007199254740991}})},function(t,n,r){var e=r(1);e(e.S,"Number",{MAX_SAFE_INTEGER:9007199254740991})},function(t,n,r){var e=r(1);e(e.S,"Number",{MIN_SAFE_INTEGER:-9007199254740991})},function(t,n,r){var e=r(1),i=r(178);e(e.S+e.F*(Number.parseFloat!=i),"Number",{parseFloat:i})},function(t,n,r){var e=r(1),i=r(179);e(e.S+e.F*(Number.parseInt!=i),"Number",{parseInt:i})},function(t,n,r){"use strict";var e=r(1),i=r(67),o=r(159),u=r(149),c=1..toFixed,f=Math.floor,a=[0,0,0,0,0,0],s="Number.toFixed: incorrect invocation!",l="0",h=function(t,n){for(var r=-1,e=n;++r<6;)e+=t*a[r],a[r]=e%1e7,e=f(e/1e7)},v=function(t){for(var n=6,r=0;--n>=0;)r+=a[n],a[n]=f(r/t),r=r%t*1e7},p=function(){for(var t=6,n="";--t>=0;)if(""!==n||0===t||0!==a[t]){var r=String(a[t]);n=""===n?r:n+u.call(l,7-r.length)+r}return n},d=function(t,n,r){return 0===n?r:n%2==1?d(t,n-1,r*t):d(t*t,n/2,r)},y=function(t){for(var n=0,r=t;r>=4096;)n+=12,r/=4096;for(;r>=2;)n+=1,r/=2;return n};e(e.P+e.F*(!!c&&("0.000"!==8e-5.toFixed(3)||"1"!==.9.toFixed(0)||"1.25"!==1.255.toFixed(2)||"1000000000000000128"!==(0xde0b6b3a7640080).toFixed(0))||!r(4)(function(){c.call({})})),"Number",{toFixed:function(t){var n,r,e,c,f=o(this,s),a=i(t),g="",b=l;if(a<0||a>20)throw RangeError(s);if(f!=f)return"NaN";if(f<=-1e21||f>=1e21)return String(f);if(f<0&&(g="-",f=-f),f>1e-21)if(n=y(f*d(2,69,1))-69,r=n<0?f*d(2,-n,1):f/d(2,n,1),r*=4503599627370496,(n=52-n)>0){for(h(0,r),e=a;e>=7;)h(1e7,0),e-=7;for(h(d(10,e,1),0),e=n-1;e>=23;)v(1<<23),e-=23;v(1<<e),h(1,1),v(2),b=p()}else h(0,r),h(1<<-n,0),b=p()+u.call(l,a);return a>0?(c=b.length,b=g+(c<=a?"0."+u.call(l,a-c)+b:b.slice(0,c-a)+"."+b.slice(c-a))):b=g+b,b}})},function(t,n,r){"use strict";var e=r(1),i=r(4),o=r(159),u=1..toPrecision;e(e.P+e.F*(i(function(){return"1"!==u.call(1,void 0)})||!i(function(){u.call({})})),"Number",{toPrecision:function(t){var n=o(this,"Number#toPrecision: incorrect invocation!");return void 0===t?u.call(n):u.call(n,t)}})},function(t,n,r){var e=r(1);e(e.S+e.F,"Object",{assign:r(172)})},function(t,n,r){var e=r(1);e(e.S,"Object",{create:r(70)})},function(t,n,r){var e=r(1);e(e.S+e.F*!r(10),"Object",{defineProperties:r(173)})},function(t,n,r){var e=r(1);e(e.S+e.F*!r(10),"Object",{defineProperty:r(11).f})},function(t,n,r){var e=r(6),i=r(65).onFreeze;r(49)("freeze",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(30),i=r(31).f;r(49)("getOwnPropertyDescriptor",function(){return function(t,n){return i(e(t),n)}})},function(t,n,r){r(49)("getOwnPropertyNames",function(){return r(174).f})},function(t,n,r){var e=r(17),i=r(32);r(49)("getPrototypeOf",function(){return function(t){return i(e(t))}})},function(t,n,r){var e=r(6);r(49)("isExtensible",function(t){return function(n){return!!e(n)&&(!t||t(n))}})},function(t,n,r){var e=r(6);r(49)("isFrozen",function(t){return function(n){return!e(n)||!!t&&t(n)}})},function(t,n,r){var e=r(6);r(49)("isSealed",function(t){return function(n){return!e(n)||!!t&&t(n)}})},function(t,n,r){var e=r(1);e(e.S,"Object",{is:r(180)})},function(t,n,r){var e=r(17),i=r(72);r(49)("keys",function(){return function(t){return i(e(t))}})},function(t,n,r){var e=r(6),i=r(65).onFreeze;r(49)("preventExtensions",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(6),i=r(65).onFreeze;r(49)("seal",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(1);e(e.S,"Object",{setPrototypeOf:r(144).set})},function(t,n,r){"use strict";var e=r(114),i={};i[r(7)("toStringTag")]="z",i+""!="[object z]"&&r(28)(Object.prototype,"toString",function(){return"[object "+e(this)+"]"},!0)},function(t,n,r){var e=r(1),i=r(178);e(e.G+e.F*(parseFloat!=i),{parseFloat:i})},function(t,n,r){var e=r(1),i=r(179);e(e.G+e.F*(parseInt!=i),{parseInt:i})},function(t,n,r){"use strict";var e,i,o,u=r(69),c=r(3),f=r(53),a=r(114),s=r(1),l=r(6),h=r(26),v=r(68),p=r(79),d=r(146),y=r(151).set,g=r(143)(),b="Promise",m=c.TypeError,x=c.process,w=c[b],x=c.process,S="process"==a(x),_=function(){},O=!!function(){try{var t=w.resolve(1),n=(t.constructor={})[r(7)("species")]=function(t){t(_,_)};return(S||"function"==typeof PromiseRejectionEvent)&&t.then(_)instanceof n}catch(t){}}(),E=function(t,n){return t===n||t===w&&n===o},P=function(t){var n;return!(!l(t)||"function"!=typeof(n=t.then))&&n},j=function(t){return E(w,t)?new F(t):new i(t)},F=i=function(t){var n,r;this.promise=new t(function(t,e){if(void 0!==n||void 0!==r)throw m("Bad Promise constructor");n=t,r=e}),this.resolve=h(n),this.reject=h(r)},M=function(t){try{t()}catch(t){return{error:t}}},A=function(t,n){if(!t._n){t._n=!0;var r=t._c;g(function(){for(var e=t._v,i=1==t._s,o=0;r.length>o;)!function(n){var r,o,u=i?n.ok:n.fail,c=n.resolve,f=n.reject,a=n.domain;try{u?(i||(2==t._h&&I(t),t._h=1),!0===u?r=e:(a&&a.enter(),r=u(e),a&&a.exit()),r===n.promise?f(m("Promise-chain cycle")):(o=P(r))?o.call(r,c,f):c(r)):f(e)}catch(t){f(t)}}(r[o++]);t._c=[],t._n=!1,n&&!t._h&&N(t)})}},N=function(t){y.call(c,function(){var n,r,e,i=t._v;if(T(t)&&(n=M(function(){S?x.emit("unhandledRejection",i,t):(r=c.onunhandledrejection)?r({promise:t,reason:i}):(e=c.console)&&e.error&&e.error("Unhandled promise rejection",i)}),t._h=S||T(t)?2:1),t._a=void 0,n)throw n.error})},T=function(t){if(1==t._h)return!1;for(var n,r=t._a||t._c,e=0;r.length>e;)if(n=r[e++],n.fail||!T(n.promise))return!1;return!0},I=function(t){y.call(c,function(){var n;S?x.emit("rejectionHandled",t):(n=c.onrejectionhandled)&&n({promise:t,reason:t._v})})},k=function(t){var n=this;n._d||(n._d=!0,n=n._w||n,n._v=t,n._s=2,n._a||(n._a=n._c.slice()),A(n,!0))},L=function(t){var n,r=this;if(!r._d){r._d=!0,r=r._w||r;try{if(r===t)throw m("Promise can't be resolved itself");(n=P(t))?g(function(){var e={_w:r,_d:!1};try{n.call(t,f(L,e,1),f(k,e,1))}catch(t){k.call(e,t)}}):(r._v=t,r._s=1,A(r,!1))}catch(t){k.call({_w:r,_d:!1},t)}}};O||(w=function(t){v(this,w,b,"_h"),h(t),e.call(this);try{t(f(L,this,1),f(k,this,1))}catch(t){k.call(this,t)}},e=function(t){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1},e.prototype=r(73)(w.prototype,{then:function(t,n){var r=j(d(this,w));return r.ok="function"!=typeof t||t,r.fail="function"==typeof n&&n,r.domain=S?x.domain:void 0,this._c.push(r),this._a&&this._a.push(r),this._s&&A(this,!1),r.promise},catch:function(t){return this.then(void 0,t)}}),F=function(){var t=new e;this.promise=t,this.resolve=f(L,t,1),this.reject=f(k,t,1)}),s(s.G+s.W+s.F*!O,{Promise:w}),r(81)(w,b),r(74)(b),o=r(52)[b],s(s.S+s.F*!O,b,{reject:function(t){var n=j(this);return(0,n.reject)(t),n.promise}}),s(s.S+s.F*(u||!O),b,{resolve:function(t){if(t instanceof w&&E(t.constructor,this))return t;var n=j(this);return(0,n.resolve)(t),n.promise}}),s(s.S+s.F*!(O&&r(123)(function(t){w.all(t).catch(_)})),b,{all:function(t){var n=this,r=j(n),e=r.resolve,i=r.reject,o=M(function(){var r=[],o=0,u=1;p(t,!1,function(t){var c=o++,f=!1;r.push(void 0),u++,n.resolve(t).then(function(t){f||(f=!0,r[c]=t,--u||e(r))},i)}),--u||e(r)});return o&&i(o.error),r.promise},race:function(t){var n=this,r=j(n),e=r.reject,i=M(function(){p(t,!1,function(t){n.resolve(t).then(r.resolve,e)})});return i&&e(i.error),r.promise}})},function(t,n,r){var e=r(1),i=r(26),o=r(2),u=(r(3).Reflect||{}).apply,c=Function.apply;e(e.S+e.F*!r(4)(function(){u(function(){})}),"Reflect",{apply:function(t,n,r){var e=i(t),f=o(r);return u?u(e,n,f):c.call(e,n,f)}})},function(t,n,r){var e=r(1),i=r(70),o=r(26),u=r(2),c=r(6),f=r(4),a=r(163),s=(r(3).Reflect||{}).construct,l=f(function(){function t(){}return!(s(function(){},[],t)instanceof t)}),h=!f(function(){s(function(){})});e(e.S+e.F*(l||h),"Reflect",{construct:function(t,n){o(t),u(n);var r=arguments.length<3?t:o(arguments[2]);if(h&&!l)return s(t,n,r);if(t==r){switch(n.length){case 0:return new t;case 1:return new t(n[0]);case 2:return new t(n[0],n[1]);case 3:return new t(n[0],n[1],n[2]);case 4:return new t(n[0],n[1],n[2],n[3])}var e=[null];return e.push.apply(e,n),new(a.apply(t,e))}var f=r.prototype,v=i(c(f)?f:Object.prototype),p=Function.apply.call(t,v,n);return c(p)?p:v}})},function(t,n,r){var e=r(11),i=r(1),o=r(2),u=r(50);i(i.S+i.F*r(4)(function(){Reflect.defineProperty(e.f({},1,{value:1}),1,{value:2})}),"Reflect",{defineProperty:function(t,n,r){o(t),n=u(n,!0),o(r);try{return e.f(t,n,r),!0}catch(t){return!1}}})},function(t,n,r){var e=r(1),i=r(31).f,o=r(2);e(e.S,"Reflect",{deleteProperty:function(t,n){var r=i(o(t),n);return!(r&&!r.configurable)&&delete t[n]}})},function(t,n,r){"use strict";var e=r(1),i=r(2),o=function(t){this._t=i(t),this._i=0;var n,r=this._k=[];for(n in t)r.push(n)};r(139)(o,"Object",function(){var t,n=this,r=n._k;do{if(n._i>=r.length)return{value:void 0,done:!0}}while(!((t=r[n._i++])in n._t));return{value:t,done:!1}}),e(e.S,"Reflect",{enumerate:function(t){return new o(t)}})},function(t,n,r){var e=r(31),i=r(1),o=r(2);i(i.S,"Reflect",{getOwnPropertyDescriptor:function(t,n){return e.f(o(t),n)}})},function(t,n,r){var e=r(1),i=r(32),o=r(2);e(e.S,"Reflect",{getPrototypeOf:function(t){return i(o(t))}})},function(t,n,r){function e(t,n){var r,c,s=arguments.length<3?t:arguments[2];return a(t)===s?t[n]:(r=i.f(t,n))?u(r,"value")?r.value:void 0!==r.get?r.get.call(s):void 0:f(c=o(t))?e(c,n,s):void 0}var i=r(31),o=r(32),u=r(24),c=r(1),f=r(6),a=r(2);c(c.S,"Reflect",{get:e})},function(t,n,r){var e=r(1);e(e.S,"Reflect",{has:function(t,n){return n in t}})},function(t,n,r){var e=r(1),i=r(2),o=Object.isExtensible;e(e.S,"Reflect",{isExtensible:function(t){return i(t),!o||o(t)}})},function(t,n,r){var e=r(1);e(e.S,"Reflect",{ownKeys:r(177)})},function(t,n,r){var e=r(1),i=r(2),o=Object.preventExtensions;e(e.S,"Reflect",{preventExtensions:function(t){i(t);try{return o&&o(t),!0}catch(t){return!1}}})},function(t,n,r){var e=r(1),i=r(144);i&&e(e.S,"Reflect",{setPrototypeOf:function(t,n){i.check(t,n);try{return i.set(t,n),!0}catch(t){return!1}}})},function(t,n,r){function e(t,n,r){var f,h,v=arguments.length<4?t:arguments[3],p=o.f(s(t),n);if(!p){if(l(h=u(t)))return e(h,n,r,v);p=a(0)}return c(p,"value")?!(!1===p.writable||!l(v)||(f=o.f(v,n)||a(0),f.value=r,i.f(v,n,f),0)):void 0!==p.set&&(p.set.call(v,r),!0)}var i=r(11),o=r(31),u=r(32),c=r(24),f=r(1),a=r(66),s=r(2),l=r(6);f(f.S,"Reflect",{set:e})},function(t,n,r){var e=r(3),i=r(136),o=r(11).f,u=r(71).f,c=r(122),f=r(120),a=e.RegExp,s=a,l=a.prototype,h=/a/g,v=/a/g,p=new a(h)!==h;if(r(10)&&(!p||r(4)(function(){return v[r(7)("match")]=!1,a(h)!=h||a(v)==v||"/a/i"!=a(h,"i")}))){a=function(t,n){var r=this instanceof a,e=c(t),o=void 0===n;return!r&&e&&t.constructor===a&&o?t:i(p?new s(e&&!o?t.source:t,n):s((e=t instanceof a)?t.source:t,e&&o?f.call(t):n),r?this:l,a)};for(var d=u(s),y=0;d.length>y;)!function(t){t in a||o(a,t,{configurable:!0,get:function(){return s[t]},set:function(n){s[t]=n}})}(d[y++]);l.constructor=a,a.prototype=l,r(28)(e,"RegExp",a)}r(74)("RegExp")},function(t,n,r){r(119)("match",1,function(t,n,r){return[function(r){"use strict";var e=t(this),i=void 0==r?void 0:r[n];return void 0!==i?i.call(r,e):new RegExp(r)[n](String(e))},r]})},function(t,n,r){r(119)("replace",2,function(t,n,r){return[function(e,i){"use strict";var o=t(this),u=void 0==e?void 0:e[n];return void 0!==u?u.call(e,o,i):r.call(String(o),e,i)},r]})},function(t,n,r){r(119)("search",1,function(t,n,r){return[function(r){"use strict";var e=t(this),i=void 0==r?void 0:r[n];return void 0!==i?i.call(r,e):new RegExp(r)[n](String(e))},r]})},function(t,n,r){r(119)("split",2,function(t,n,e){"use strict";var i=r(122),o=e,u=[].push,c="split",f="length",a="lastIndex";if("c"=="abbc"[c](/(b)*/)[1]||4!="test"[c](/(?:)/,-1)[f]||2!="ab"[c](/(?:ab)*/)[f]||4!="."[c](/(.?)(.?)/)[f]||"."[c](/()()/)[f]>1||""[c](/.?/)[f]){var s=void 0===/()??/.exec("")[1];e=function(t,n){var r=String(this);if(void 0===t&&0===n)return[];if(!i(t))return o.call(r,t,n);var e,c,l,h,v,p=[],d=(t.ignoreCase?"i":"")+(t.multiline?"m":"")+(t.unicode?"u":"")+(t.sticky?"y":""),y=0,g=void 0===n?4294967295:n>>>0,b=new RegExp(t.source,d+"g");for(s||(e=new RegExp("^"+b.source+"$(?!\\s)",d));(c=b.exec(r))&&!((l=c.index+c[0][f])>y&&(p.push(r.slice(y,c.index)),!s&&c[f]>1&&c[0].replace(e,function(){for(v=1;v<arguments[f]-2;v++)void 0===arguments[v]&&(c[v]=void 0)}),c[f]>1&&c.index<r[f]&&u.apply(p,c.slice(1)),h=c[0][f],y=l,p[f]>=g));)b[a]===c.index&&b[a]++;return y===r[f]?!h&&b.test("")||p.push(""):p.push(r.slice(y)),p[f]>g?p.slice(0,g):p}}else"0"[c](void 0,0)[f]&&(e=function(t,n){return void 0===t&&0===n?[]:o.call(this,t,n)});return[function(r,i){var o=t(this),u=void 0==r?void 0:r[n];return void 0!==u?u.call(r,o,i):e.call(String(o),r,i)},e]})},function(t,n,r){"use strict";r(184);var e=r(2),i=r(120),o=r(10),u="toString",c=/./[u],f=function(t){r(28)(RegExp.prototype,u,t,!0)};r(4)(function(){return"/a/b"!=c.call({source:"a",flags:"b"})})?f(function(){var t=e(this);return"/".concat(t.source,"/","flags"in t?t.flags:!o&&t instanceof RegExp?i.call(t):void 0)}):c.name!=u&&f(function(){return c.call(this)})},function(t,n,r){"use strict";r(29)("anchor",function(t){return function(n){return t(this,"a","name",n)}})},function(t,n,r){"use strict";r(29)("big",function(t){return function(){return t(this,"big","","")}})},function(t,n,r){"use strict";r(29)("blink",function(t){return function(){return t(this,"blink","","")}})},function(t,n,r){"use strict";r(29)("bold",function(t){return function(){return t(this,"b","","")}})},function(t,n,r){"use strict";var e=r(1),i=r(147)(!1);e(e.P,"String",{codePointAt:function(t){return i(this,t)}})},function(t,n,r){"use strict";var e=r(1),i=r(16),o=r(148),u="endsWith",c=""[u];e(e.P+e.F*r(134)(u),"String",{endsWith:function(t){var n=o(this,t,u),r=arguments.length>1?arguments[1]:void 0,e=i(n.length),f=void 0===r?e:Math.min(i(r),e),a=String(t);return c?c.call(n,a,f):n.slice(f-a.length,f)===a}})},function(t,n,r){"use strict";r(29)("fixed",function(t){return function(){return t(this,"tt","","")}})},function(t,n,r){"use strict";r(29)("fontcolor",function(t){return function(n){return t(this,"font","color",n)}})},function(t,n,r){"use strict";r(29)("fontsize",function(t){return function(n){return t(this,"font","size",n)}})},function(t,n,r){var e=r(1),i=r(75),o=String.fromCharCode,u=String.fromCodePoint;e(e.S+e.F*(!!u&&1!=u.length),"String",{fromCodePoint:function(t){for(var n,r=[],e=arguments.length,u=0;e>u;){if(n=+arguments[u++],i(n,1114111)!==n)throw RangeError(n+" is not a valid code point");r.push(n<65536?o(n):o(55296+((n-=65536)>>10),n%1024+56320))}return r.join("")}})},function(t,n,r){"use strict";var e=r(1),i=r(148),o="includes";e(e.P+e.F*r(134)(o),"String",{includes:function(t){return!!~i(this,t,o).indexOf(t,arguments.length>1?arguments[1]:void 0)}})},function(t,n,r){"use strict";r(29)("italics",function(t){return function(){return t(this,"i","","")}})},function(t,n,r){"use strict";var e=r(147)(!0);r(140)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,r=this._i;return r>=n.length?{value:void 0,done:!0}:(t=e(n,r),this._i+=t.length,{value:t,done:!1})})},function(t,n,r){"use strict";r(29)("link",function(t){return function(n){return t(this,"a","href",n)}})},function(t,n,r){var e=r(1),i=r(30),o=r(16);e(e.S,"String",{raw:function(t){for(var n=i(t.raw),r=o(n.length),e=arguments.length,u=[],c=0;r>c;)u.push(String(n[c++])),c<e&&u.push(String(arguments[c]));return u.join("")}})},function(t,n,r){var e=r(1);e(e.P,"String",{repeat:r(149)})},function(t,n,r){"use strict";r(29)("small",function(t){return function(){return t(this,"small","","")}})},function(t,n,r){"use strict";var e=r(1),i=r(16),o=r(148),u="startsWith",c=""[u];e(e.P+e.F*r(134)(u),"String",{startsWith:function(t){var n=o(this,t,u),r=i(Math.min(arguments.length>1?arguments[1]:void 0,n.length)),e=String(t);return c?c.call(n,e,r):n.slice(r,r+e.length)===e}})},function(t,n,r){"use strict";r(29)("strike",function(t){return function(){return t(this,"strike","","")}})},function(t,n,r){"use strict";r(29)("sub",function(t){return function(){return t(this,"sub","","")}})},function(t,n,r){"use strict";r(29)("sup",function(t){return function(){return t(this,"sup","","")}})},function(t,n,r){"use strict";r(82)("trim",function(t){return function(){return t(this,3)}})},function(t,n,r){"use strict";var e=r(3),i=r(24),o=r(10),u=r(1),c=r(28),f=r(65).KEY,a=r(4),s=r(126),l=r(81),h=r(76),v=r(7),p=r(182),d=r(153),y=r(206),g=r(205),b=r(138),m=r(2),x=r(30),w=r(50),S=r(66),_=r(70),O=r(174),E=r(31),P=r(11),j=r(72),F=E.f,M=P.f,A=O.f,N=e.Symbol,T=e.JSON,I=T&&T.stringify,k="prototype",L=v("_hidden"),R=v("toPrimitive"),C={}.propertyIsEnumerable,D=s("symbol-registry"),U=s("symbols"),W=s("op-symbols"),G=Object[k],B="function"==typeof N,V=e.QObject,z=!V||!V[k]||!V[k].findChild,q=o&&a(function(){return 7!=_(M({},"a",{get:function(){return M(this,"a",{value:7}).a}})).a})?function(t,n,r){var e=F(G,n);e&&delete G[n],M(t,n,r),e&&t!==G&&M(G,n,e)}:M,K=function(t){var n=U[t]=_(N[k]);return n._k=t,n},J=B&&"symbol"==typeof N.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof N},Y=function(t,n,r){return t===G&&Y(W,n,r),m(t),n=w(n,!0),m(r),i(U,n)?(r.enumerable?(i(t,L)&&t[L][n]&&(t[L][n]=!1),r=_(r,{enumerable:S(0,!1)})):(i(t,L)||M(t,L,S(1,{})),t[L][n]=!0),q(t,n,r)):M(t,n,r)},H=function(t,n){m(t);for(var r,e=g(n=x(n)),i=0,o=e.length;o>i;)Y(t,r=e[i++],n[r]);return t},$=function(t,n){return void 0===n?_(t):H(_(t),n)},X=function(t){var n=C.call(this,t=w(t,!0));return!(this===G&&i(U,t)&&!i(W,t))&&(!(n||!i(this,t)||!i(U,t)||i(this,L)&&this[L][t])||n)},Q=function(t,n){if(t=x(t),n=w(n,!0),t!==G||!i(U,n)||i(W,n)){var r=F(t,n);return!r||!i(U,n)||i(t,L)&&t[L][n]||(r.enumerable=!0),r}},Z=function(t){for(var n,r=A(x(t)),e=[],o=0;r.length>o;)i(U,n=r[o++])||n==L||n==f||e.push(n);return e},tt=function(t){for(var n,r=t===G,e=A(r?W:x(t)),o=[],u=0;e.length>u;)!i(U,n=e[u++])||r&&!i(G,n)||o.push(U[n]);return o};B||(N=function(){if(this instanceof N)throw TypeError("Symbol is not a constructor!");var t=h(arguments.length>0?arguments[0]:void 0),n=function(r){this===G&&n.call(W,r),i(this,L)&&i(this[L],t)&&(this[L][t]=!1),q(this,t,S(1,r))};return o&&z&&q(G,t,{configurable:!0,set:n}),K(t)},c(N[k],"toString",function(){return this._k}),E.f=Q,P.f=Y,r(71).f=O.f=Z,r(116).f=X,r(125).f=tt,o&&!r(69)&&c(G,"propertyIsEnumerable",X,!0),p.f=function(t){return K(v(t))}),u(u.G+u.W+u.F*!B,{Symbol:N});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),rt=0;nt.length>rt;)v(nt[rt++]);for(var nt=j(v.store),rt=0;nt.length>rt;)d(nt[rt++]);u(u.S+u.F*!B,"Symbol",{for:function(t){return i(D,t+="")?D[t]:D[t]=N(t)},keyFor:function(t){if(J(t))return y(D,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){z=!0},useSimple:function(){z=!1}}),u(u.S+u.F*!B,"Object",{create:$,defineProperty:Y,defineProperties:H,getOwnPropertyDescriptor:Q,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),T&&u(u.S+u.F*(!B||a(function(){var t=N();return"[null]"!=I([t])||"{}"!=I({a:t})||"{}"!=I(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!J(t)){for(var n,r,e=[t],i=1;arguments.length>i;)e.push(arguments[i++]);return n=e[1],"function"==typeof n&&(r=n),!r&&b(n)||(n=function(t,n){if(r&&(n=r.call(this,t,n)),!J(n))return n}),e[1]=n,I.apply(T,e)}}}),N[k][R]||r(27)(N[k],R,N[k].valueOf),l(N,"Symbol"),l(Math,"Math",!0),l(e.JSON,"JSON",!0)},function(t,n,r){"use strict";var e=r(1),i=r(127),o=r(152),u=r(2),c=r(75),f=r(16),a=r(6),s=r(3).ArrayBuffer,l=r(146),h=o.ArrayBuffer,v=o.DataView,p=i.ABV&&s.isView,d=h.prototype.slice,y=i.VIEW,g="ArrayBuffer";e(e.G+e.W+e.F*(s!==h),{ArrayBuffer:h}),e(e.S+e.F*!i.CONSTR,g,{isView:function(t){return p&&p(t)||a(t)&&y in t}}),e(e.P+e.U+e.F*r(4)(function(){return!new h(2).slice(1,void 0).byteLength}),g,{slice:function(t,n){if(void 0!==d&&void 0===n)return d.call(u(this),t);for(var r=u(this).byteLength,e=c(t,r),i=c(void 0===n?r:n,r),o=new(l(this,h))(f(i-e)),a=new v(this),s=new v(o),p=0;e<i;)s.setUint8(p++,a.getUint8(e++));return o}}),r(74)(g)},function(t,n,r){var e=r(1);e(e.G+e.W+e.F*!r(127).ABV,{DataView:r(152).DataView})},function(t,n,r){r(55)("Float32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Float64",8,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Int16",2,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Int32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Int8",1,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint16",2,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint8",1,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint8",1,function(t){return function(n,r,e){return t(this,n,r,e)}},!0)},function(t,n,r){"use strict";var e=r(166);r(118)("WeakSet",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{add:function(t){return e.def(this,t,!0)}},e,!1,!0)},function(t,n,r){"use strict";var e=r(1),i=r(117)(!0);e(e.P,"Array",{includes:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(78)("includes")},function(t,n,r){var e=r(1),i=r(143)(),o=r(3).process,u="process"==r(45)(o);e(e.G,{asap:function(t){var n=u&&o.domain;i(n?n.bind(t):t)}})},function(t,n,r){var e=r(1),i=r(45);e(e.S,"Error",{isError:function(t){return"Error"===i(t)}})},function(t,n,r){var e=r(1);e(e.P+e.R,"Map",{toJSON:r(165)("Map")})},function(t,n,r){var e=r(1);e(e.S,"Math",{iaddh:function(t,n,r,e){var i=t>>>0,o=n>>>0,u=r>>>0;return o+(e>>>0)+((i&u|(i|u)&~(i+u>>>0))>>>31)|0}})},function(t,n,r){var e=r(1);e(e.S,"Math",{imulh:function(t,n){var r=65535,e=+t,i=+n,o=e&r,u=i&r,c=e>>16,f=i>>16,a=(c*u>>>0)+(o*u>>>16);return c*f+(a>>16)+((o*f>>>0)+(a&r)>>16)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{isubh:function(t,n,r,e){var i=t>>>0,o=n>>>0,u=r>>>0;return o-(e>>>0)-((~i&u|~(i^u)&i-u>>>0)>>>31)|0}})},function(t,n,r){var e=r(1);e(e.S,"Math",{umulh:function(t,n){var r=65535,e=+t,i=+n,o=e&r,u=i&r,c=e>>>16,f=i>>>16,a=(c*u>>>0)+(o*u>>>16);return c*f+(a>>>16)+((o*f>>>0)+(a&r)>>>16)}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(26),u=r(11);r(10)&&e(e.P+r(124),"Object",{__defineGetter__:function(t,n){u.f(i(this),t,{get:o(n),enumerable:!0,configurable:!0})}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(26),u=r(11);r(10)&&e(e.P+r(124),"Object",{__defineSetter__:function(t,n){u.f(i(this),t,{set:o(n),enumerable:!0,configurable:!0})}})},function(t,n,r){var e=r(1),i=r(176)(!0);e(e.S,"Object",{entries:function(t){return i(t)}})},function(t,n,r){var e=r(1),i=r(177),o=r(30),u=r(31),c=r(131);e(e.S,"Object",{getOwnPropertyDescriptors:function(t){for(var n,r=o(t),e=u.f,f=i(r),a={},s=0;f.length>s;)c(a,n=f[s++],e(r,n));return a}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(50),u=r(32),c=r(31).f;r(10)&&e(e.P+r(124),"Object",{__lookupGetter__:function(t){var n,r=i(this),e=o(t,!0);do{if(n=c(r,e))return n.get}while(r=u(r))}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(50),u=r(32),c=r(31).f;r(10)&&e(e.P+r(124),"Object",{__lookupSetter__:function(t){var n,r=i(this),e=o(t,!0);do{if(n=c(r,e))return n.set}while(r=u(r))}})},function(t,n,r){var e=r(1),i=r(176)(!1);e(e.S,"Object",{values:function(t){return i(t)}})},function(t,n,r){"use strict";var e=r(1),i=r(3),o=r(52),u=r(143)(),c=r(7)("observable"),f=r(26),a=r(2),s=r(68),l=r(73),h=r(27),v=r(79),p=v.RETURN,d=function(t){return null==t?void 0:f(t)},y=function(t){var n=t._c;n&&(t._c=void 0,n())},g=function(t){return void 0===t._o},b=function(t){g(t)||(t._o=void 0,y(t))},m=function(t,n){a(t),this._c=void 0,this._o=t,t=new x(this);try{var r=n(t),e=r;null!=r&&("function"==typeof r.unsubscribe?r=function(){e.unsubscribe()}:f(r),this._c=r)}catch(n){return void t.error(n)}g(this)&&y(this)};m.prototype=l({},{unsubscribe:function(){b(this)}});var x=function(t){this._s=t};x.prototype=l({},{next:function(t){var n=this._s;if(!g(n)){var r=n._o;try{var e=d(r.next);if(e)return e.call(r,t)}catch(t){try{b(n)}finally{throw t}}}},error:function(t){var n=this._s;if(g(n))throw t;var r=n._o;n._o=void 0;try{var e=d(r.error);if(!e)throw t;t=e.call(r,t)}catch(t){try{y(n)}finally{throw t}}return y(n),t},complete:function(t){var n=this._s;if(!g(n)){var r=n._o;n._o=void 0;try{var e=d(r.complete);t=e?e.call(r,t):void 0}catch(t){try{y(n)}finally{throw t}}return y(n),t}}});var w=function(t){s(this,w,"Observable","_f")._f=f(t)};l(w.prototype,{subscribe:function(t){return new m(t,this._f)},forEach:function(t){var n=this;return new(o.Promise||i.Promise)(function(r,e){f(t);var i=n.subscribe({next:function(n){try{return t(n)}catch(t){e(t),i.unsubscribe()}},error:e,complete:r})})}}),l(w,{from:function(t){var n="function"==typeof this?this:w,r=d(a(t)[c]);if(r){var e=a(r.call(t));return e.constructor===n?e:new n(function(t){return e.subscribe(t)})}return new n(function(n){var r=!1;return u(function(){if(!r){try{if(v(t,!1,function(t){if(n.next(t),r)return p})===p)return}catch(t){if(r)throw t;return void n.error(t)}n.complete()}}),function(){r=!0}})},of:function(){for(var t=0,n=arguments.length,r=Array(n);t<n;)r[t]=arguments[t++];return new("function"==typeof this?this:w)(function(t){var n=!1;return u(function(){if(!n){for(var e=0;e<r.length;++e)if(t.next(r[e]),n)return;t.complete()}}),function(){n=!0}})}}),h(w.prototype,c,function(){return this}),e(e.G,{Observable:w}),r(74)("Observable")},function(t,n,r){var e=r(54),i=r(2),o=e.key,u=e.set;e.exp({defineMetadata:function(t,n,r,e){u(t,n,i(r),o(e))}})},function(t,n,r){var e=r(54),i=r(2),o=e.key,u=e.map,c=e.store;e.exp({deleteMetadata:function(t,n){var r=arguments.length<3?void 0:o(arguments[2]),e=u(i(n),r,!1);if(void 0===e||!e.delete(t))return!1;if(e.size)return!0;var f=c.get(n);return f.delete(r),!!f.size||c.delete(n)}})},function(t,n,r){var e=r(185),i=r(161),o=r(54),u=r(2),c=r(32),f=o.keys,a=o.key,s=function(t,n){var r=f(t,n),o=c(t);if(null===o)return r;var u=s(o,n);return u.length?r.length?i(new e(r.concat(u))):u:r};o.exp({getMetadataKeys:function(t){return s(u(t),arguments.length<2?void 0:a(arguments[1]))}})},function(t,n,r){var e=r(54),i=r(2),o=r(32),u=e.has,c=e.get,f=e.key,a=function(t,n,r){if(u(t,n,r))return c(t,n,r);var e=o(n);return null!==e?a(t,e,r):void 0};e.exp({getMetadata:function(t,n){return a(t,i(n),arguments.length<3?void 0:f(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=e.keys,u=e.key;e.exp({getOwnMetadataKeys:function(t){
return o(i(t),arguments.length<2?void 0:u(arguments[1]))}})},function(t,n,r){var e=r(54),i=r(2),o=e.get,u=e.key;e.exp({getOwnMetadata:function(t,n){return o(t,i(n),arguments.length<3?void 0:u(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=r(32),u=e.has,c=e.key,f=function(t,n,r){if(u(t,n,r))return!0;var e=o(n);return null!==e&&f(t,e,r)};e.exp({hasMetadata:function(t,n){return f(t,i(n),arguments.length<3?void 0:c(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=e.has,u=e.key;e.exp({hasOwnMetadata:function(t,n){return o(t,i(n),arguments.length<3?void 0:u(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=r(26),u=e.key,c=e.set;e.exp({metadata:function(t,n){return function(r,e){c(t,n,(void 0!==e?i:o)(r),u(e))}}})},function(t,n,r){var e=r(1);e(e.P+e.R,"Set",{toJSON:r(165)("Set")})},function(t,n,r){"use strict";var e=r(1),i=r(147)(!0);e(e.P,"String",{at:function(t){return i(this,t)}})},function(t,n,r){"use strict";var e=r(1),i=r(46),o=r(16),u=r(122),c=r(120),f=RegExp.prototype,a=function(t,n){this._r=t,this._s=n};r(139)(a,"RegExp String",function(){var t=this._r.exec(this._s);return{value:t,done:null===t}}),e(e.P,"String",{matchAll:function(t){if(i(this),!u(t))throw TypeError(t+" is not a regexp!");var n=String(this),r="flags"in f?String(t.flags):c.call(t),e=new RegExp(t.source,~r.indexOf("g")?r:"g"+r);return e.lastIndex=o(t.lastIndex),new a(e,n)}})},function(t,n,r){"use strict";var e=r(1),i=r(181);e(e.P,"String",{padEnd:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0,!1)}})},function(t,n,r){"use strict";var e=r(1),i=r(181);e(e.P,"String",{padStart:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0,!0)}})},function(t,n,r){"use strict";r(82)("trimLeft",function(t){return function(){return t(this,1)}},"trimStart")},function(t,n,r){"use strict";r(82)("trimRight",function(t){return function(){return t(this,2)}},"trimEnd")},function(t,n,r){r(153)("asyncIterator")},function(t,n,r){r(153)("observable")},function(t,n,r){var e=r(1);e(e.S,"System",{global:r(3)})},function(t,n,r){for(var e=r(155),i=r(28),o=r(3),u=r(27),c=r(80),f=r(7),a=f("iterator"),s=f("toStringTag"),l=c.Array,h=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],v=0;v<5;v++){var p,d=h[v],y=o[d],g=y&&y.prototype;if(g){g[a]||u(g,a,l),g[s]||u(g,s,d),c[d]=l;for(p in e)g[p]||i(g,p,e[p],!0)}}},function(t,n,r){var e=r(1),i=r(151);e(e.G+e.B,{setImmediate:i.set,clearImmediate:i.clear})},function(t,n,r){var e=r(3),i=r(1),o=r(121),u=r(207),c=e.navigator,f=!!c&&/MSIE .\./.test(c.userAgent),a=function(t){return f?function(n,r){return t(o(u,[].slice.call(arguments,2),"function"==typeof n?n:Function(n)),r)}:t};i(i.G+i.B+i.F*f,{setTimeout:a(e.setTimeout),setInterval:a(e.setInterval)})},function(t,n,r){r(330),r(269),r(271),r(270),r(273),r(275),r(280),r(274),r(272),r(282),r(281),r(277),r(278),r(276),r(268),r(279),r(283),r(284),r(236),r(238),r(237),r(286),r(285),r(256),r(266),r(267),r(257),r(258),r(259),r(260),r(261),r(262),r(263),r(264),r(265),r(239),r(240),r(241),r(242),r(243),r(244),r(245),r(246),r(247),r(248),r(249),r(250),r(251),r(252),r(253),r(254),r(255),r(317),r(322),r(329),r(320),r(312),r(313),r(318),r(323),r(325),r(308),r(309),r(310),r(311),r(314),r(315),r(316),r(319),r(321),r(324),r(326),r(327),r(328),r(231),r(233),r(232),r(235),r(234),r(220),r(218),r(224),r(221),r(227),r(229),r(217),r(223),r(214),r(228),r(212),r(226),r(225),r(219),r(222),r(211),r(213),r(216),r(215),r(230),r(155),r(302),r(307),r(184),r(303),r(304),r(305),r(306),r(287),r(183),r(185),r(186),r(342),r(331),r(332),r(337),r(340),r(341),r(335),r(338),r(336),r(339),r(333),r(334),r(288),r(289),r(290),r(291),r(292),r(295),r(293),r(294),r(296),r(297),r(298),r(299),r(301),r(300),r(343),r(369),r(372),r(371),r(373),r(374),r(370),r(375),r(376),r(354),r(357),r(353),r(351),r(352),r(355),r(356),r(346),r(368),r(377),r(345),r(347),r(349),r(348),r(350),r(359),r(360),r(362),r(361),r(364),r(363),r(365),r(366),r(367),r(344),r(358),r(380),r(379),r(378),t.exports=r(52)},function(t,n){function r(t,n){if("string"==typeof n)return t.insertAdjacentHTML("afterend",n);var r=t.nextSibling;return r?t.parentNode.insertBefore(n,r):t.parentNode.appendChild(n)}t.exports=r},,,,,,,,,function(t,n,r){(function(n,r){!function(n){"use strict";function e(t,n,r,e){var i=n&&n.prototype instanceof o?n:o,u=Object.create(i.prototype),c=new p(e||[]);return u._invoke=s(t,r,c),u}function i(t,n,r){try{return{type:"normal",arg:t.call(n,r)}}catch(t){return{type:"throw",arg:t}}}function o(){}function u(){}function c(){}function f(t){["next","throw","return"].forEach(function(n){t[n]=function(t){return this._invoke(n,t)}})}function a(t){function n(r,e,o,u){var c=i(t[r],t,e);if("throw"!==c.type){var f=c.arg,a=f.value;return a&&"object"==typeof a&&m.call(a,"__await")?Promise.resolve(a.__await).then(function(t){n("next",t,o,u)},function(t){n("throw",t,o,u)}):Promise.resolve(a).then(function(t){f.value=t,o(f)},u)}u(c.arg)}function e(t,r){function e(){return new Promise(function(e,i){n(t,r,e,i)})}return o=o?o.then(e,e):e()}"object"==typeof r&&r.domain&&(n=r.domain.bind(n));var o;this._invoke=e}function s(t,n,r){var e=P;return function(o,u){if(e===F)throw new Error("Generator is already running");if(e===M){if("throw"===o)throw u;return y()}for(r.method=o,r.arg=u;;){var c=r.delegate;if(c){var f=l(c,r);if(f){if(f===A)continue;return f}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(e===P)throw e=M,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);e=F;var a=i(t,n,r);if("normal"===a.type){if(e=r.done?M:j,a.arg===A)continue;return{value:a.arg,done:r.done}}"throw"===a.type&&(e=M,r.method="throw",r.arg=a.arg)}}}function l(t,n){var r=t.iterator[n.method];if(r===g){if(n.delegate=null,"throw"===n.method){if(t.iterator.return&&(n.method="return",n.arg=g,l(t,n),"throw"===n.method))return A;n.method="throw",n.arg=new TypeError("The iterator does not provide a 'throw' method")}return A}var e=i(r,t.iterator,n.arg);if("throw"===e.type)return n.method="throw",n.arg=e.arg,n.delegate=null,A;var o=e.arg;return o?o.done?(n[t.resultName]=o.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=g),n.delegate=null,A):o:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,A)}function h(t){var n={tryLoc:t[0]};1 in t&&(n.catchLoc=t[1]),2 in t&&(n.finallyLoc=t[2],n.afterLoc=t[3]),this.tryEntries.push(n)}function v(t){var n=t.completion||{};n.type="normal",delete n.arg,t.completion=n}function p(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(h,this),this.reset(!0)}function d(t){if(t){var n=t[w];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,e=function n(){for(;++r<t.length;)if(m.call(t,r))return n.value=t[r],n.done=!1,n;return n.value=g,n.done=!0,n};return e.next=e}}return{next:y}}function y(){return{value:g,done:!0}}var g,b=Object.prototype,m=b.hasOwnProperty,x="function"==typeof Symbol?Symbol:{},w=x.iterator||"@@iterator",S=x.asyncIterator||"@@asyncIterator",_=x.toStringTag||"@@toStringTag",O="object"==typeof t,E=n.regeneratorRuntime;if(E)return void(O&&(t.exports=E));E=n.regeneratorRuntime=O?t.exports:{},E.wrap=e;var P="suspendedStart",j="suspendedYield",F="executing",M="completed",A={},N={};N[w]=function(){return this};var T=Object.getPrototypeOf,I=T&&T(T(d([])));I&&I!==b&&m.call(I,w)&&(N=I);var k=c.prototype=o.prototype=Object.create(N);u.prototype=k.constructor=c,c.constructor=u,c[_]=u.displayName="GeneratorFunction",E.isGeneratorFunction=function(t){var n="function"==typeof t&&t.constructor;return!!n&&(n===u||"GeneratorFunction"===(n.displayName||n.name))},E.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,c):(t.__proto__=c,_ in t||(t[_]="GeneratorFunction")),t.prototype=Object.create(k),t},E.awrap=function(t){return{__await:t}},f(a.prototype),a.prototype[S]=function(){return this},E.AsyncIterator=a,E.async=function(t,n,r,i){var o=new a(e(t,n,r,i));return E.isGeneratorFunction(n)?o:o.next().then(function(t){return t.done?t.value:o.next()})},f(k),k[_]="Generator",k.toString=function(){return"[object Generator]"},E.keys=function(t){var n=[];for(var r in t)n.push(r);return n.reverse(),function r(){for(;n.length;){var e=n.pop();if(e in t)return r.value=e,r.done=!1,r}return r.done=!0,r}},E.values=d,p.prototype={constructor:p,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=g,this.done=!1,this.delegate=null,this.method="next",this.arg=g,this.tryEntries.forEach(v),!t)for(var n in this)"t"===n.charAt(0)&&m.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=g)},stop:function(){this.done=!0;var t=this.tryEntries[0],n=t.completion;if("throw"===n.type)throw n.arg;return this.rval},dispatchException:function(t){function n(n,e){return o.type="throw",o.arg=t,r.next=n,e&&(r.method="next",r.arg=g),!!e}if(this.done)throw t;for(var r=this,e=this.tryEntries.length-1;e>=0;--e){var i=this.tryEntries[e],o=i.completion;if("root"===i.tryLoc)return n("end");if(i.tryLoc<=this.prev){var u=m.call(i,"catchLoc"),c=m.call(i,"finallyLoc");if(u&&c){if(this.prev<i.catchLoc)return n(i.catchLoc,!0);if(this.prev<i.finallyLoc)return n(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return n(i.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return n(i.finallyLoc)}}}},abrupt:function(t,n){for(var r=this.tryEntries.length-1;r>=0;--r){var e=this.tryEntries[r];if(e.tryLoc<=this.prev&&m.call(e,"finallyLoc")&&this.prev<e.finallyLoc){var i=e;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=n&&n<=i.finallyLoc&&(i=null);var o=i?i.completion:{};return o.type=t,o.arg=n,i?(this.method="next",this.next=i.finallyLoc,A):this.complete(o)},complete:function(t,n){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&n&&(this.next=n),A},finish:function(t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),v(r),A}},catch:function(t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc===t){var e=r.completion;if("throw"===e.type){var i=e.arg;v(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:d(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=g),A}}}("object"==typeof n?n:"object"==typeof window?window:"object"==typeof self?self:this)}).call(n,function(){return this}(),r(158))}])</script><script src="/./main.266c1c.js"></script><script>!function(){!function(e){var t=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(t),t.setAttribute("src",e)}("/slider.096dc6.js")}()</script>


    
<div class="tools-col" q-class="show:isShow,hide:isShow|isFalse" q-on="click:stop(e)">
  <div class="tools-nav header-menu">
    
    
      
      
      
    
      
      
      
    
      
      
      
    
    

    <ul style="width: 70%">
    
    
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'innerArchive')"><a href="javascript:void(0)" q-class="active:innerArchive">所有文章</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'friends')"><a href="javascript:void(0)" q-class="active:friends">友链</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'aboutme')"><a href="javascript:void(0)" q-class="active:aboutme">关于我</a></li>
      
        
    </ul>
  </div>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all" q-show="innerArchive">
        <div class="search-wrap">
          <input class="search-ipt" q-model="search" type="text" placeholder="find something…">
          <i class="icon-search icon" q-show="search|isEmptyStr"></i>
          <i class="icon-close icon" q-show="search|isNotEmptyStr" q-on="click:clearChose(e)"></i>
        </div>
        <div class="widget tagcloud search-tag">
          <p class="search-tag-wording">tag:</p>
          <label class="search-switch">
            <input type="checkbox" q-on="click:toggleTag(e)" q-attr="checked:showTags">
          </label>
          <ul class="article-tag-list" q-show="showTags">
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">intentflag</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">sort</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">activity</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">animation</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">svg</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">translate</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">decomplication</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">obfuscation</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">application</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">android_studio</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">shortkey</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">android_ui</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">book</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">broadcast</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">bugfix</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">code_collection</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">context</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">design model</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">mvp</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">observer</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">otto</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">eventbus</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">imageloader</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">handler</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">handle</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">image</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">intent</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">material_design</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">snack</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">nd</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">jni</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">ssl</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">notification</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">github</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">opensource</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">AliPay</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">pay</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">WXPay</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">project_build</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">listview</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">pulltorefresh</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">pulltorefreshlistview</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">screen-record</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">spannable</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">placeholder</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">androidstudio</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">gradle</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">textview</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">viewpager</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">pageradapter</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">webview</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">volley</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">chinese_weman</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">feminism</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">humanism</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">Einstein</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">感悟</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">ORMLite</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">GreenDao</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">database</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">mysql</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">贾樟柯</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">电影</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">music</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">markdown</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">iframe</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">saxophone</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">xpnet</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">http</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">https</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">socket</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">书单</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">史玉柱</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">fullstack</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">website</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">speech</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">google</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">hexo</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">iphone</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">templates</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">eclipse</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">sublime</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">tomcat</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">svn</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">maven</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">springmvc</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">sqlite</a>
              </li>
            
            <div class="clearfix"></div>
          </ul>
        </div>
        <ul class="search-ul">
          <p q-show="jsonFail" style="padding: 20px; font-size: 12px;">
            缺失模块。<br/>1、请确保node版本大于6.2<br/>2、在博客根目录（注意不是yilia根目录）执行以下命令：<br/> npm i hexo-generator-json-content --save<br/><br/>
            3、在根目录_config.yml里添加配置：
<pre style="font-size: 12px;" q-show="jsonFail">
  jsonContent:
    meta: false
    pages: false
    posts:
      title: true
      date: true
      path: true
      text: false
      raw: false
      content: false
      slug: false
      updated: false
      comments: false
      link: false
      permalink: false
      excerpt: false
      categories: false
      tags: true
</pre>
          </p>
          <li class="search-li" q-repeat="items" q-show="isShow">
            <a q-attr="href:path|urlformat" class="search-title"><i class="icon-quo-left icon"></i><span q-text="title"></span></a>
            <p class="search-time">
              <i class="icon-calendar icon"></i>
              <span q-text="date|dateformat"></span>
            </p>
            <p class="search-tag">
              <i class="icon-price-tags icon"></i>
              <span q-repeat="tags" q-on="click:choseTag(e, name)" q-text="name|tagformat"></span>
            </p>
          </li>
        </ul>
    	</section>
    

    
    	<section class="tools-section tools-section-friends" q-show="friends">
  		
        <ul class="search-ul">
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接1</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接2</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接3</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接4</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接5</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接6</a>
            </li>
          
        </ul>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me" q-show="aboutme">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">很惭愧&lt;br&gt;&lt;br&gt;只做了一点微小的工作&lt;br&gt;谢谢大家</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>